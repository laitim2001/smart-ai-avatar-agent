name: ç´¢å¼•ç¶­è­·è‡ªå‹•åŒ–

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'app/**'
      - 'components/**'
      - 'lib/**'
      - 'types/**'
      - 'agent-brain/**'
      - 'docs/**'
      - 'scripts/**'
      - '!PROJECT_INDEX.md'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'app/**'
      - 'components/**'
      - 'lib/**'
      - 'types/**'
      - 'agent-brain/**'
      - 'docs/**'
      - 'scripts/**'

  workflow_dispatch:

jobs:
  validate-index:
    name: é©—è­‰ç´¢å¼•å®Œæ•´æ€§
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: åŸ·è¡Œç´¢å¼•é©—è­‰
        id: validate
        run: |
          npm run validate-index
          echo "validation_result=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: æª¢æŸ¥é©—è­‰çµæžœ
        if: steps.validate.outputs.validation_result != '0'
        run: |
          echo "::warning::ç´¢å¼•é©—è­‰å¤±æ•—ï¼Œéœ€è¦æ›´æ–° PROJECT_INDEX.md"
          exit 0

  sync-index:
    name: åŒæ­¥ç´¢å¼•ä¸¦å»ºç«‹ PR
    runs-on: ubuntu-latest
    needs: validate-index
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: æª¢æŸ¥ç´¢å¼•æ˜¯å¦éœ€è¦æ›´æ–°
        id: check
        run: |
          npm run sync-index -- --dry-run > sync-output.txt 2>&1
          if grep -q "ç´¢å¼•å·²æ˜¯æœ€æ–°ç‹€æ…‹" sync-output.txt; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
          cat sync-output.txt

      - name: åŸ·è¡Œç´¢å¼•åŒæ­¥
        if: steps.check.outputs.needs_update == 'true'
        run: npm run sync-index

      - name: è¨­ç½® Git é…ç½®
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: å»ºç«‹åˆ†æ”¯ä¸¦æäº¤è®Šæ›´
        if: steps.check.outputs.needs_update == 'true'
        id: commit
        run: |
          BRANCH_NAME="auto-update-index-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git checkout -b $BRANCH_NAME
          git add PROJECT_INDEX.md

          git commit -m "$(cat <<'EOF'
          ðŸ¤– è‡ªå‹•æ›´æ–°å°ˆæ¡ˆç´¢å¼•

          è‡ªå‹•åŒæ­¥ PROJECT_INDEX.md èˆ‡æª”æ¡ˆç³»çµ±ç‹€æ…‹

          è®Šæ›´å…§å®¹ï¼š
          - æ›´æ–°æª”æ¡ˆç‹€æ…‹æ¨™è¨˜
          - æ›´æ–°æœ€å¾Œæ›´æ–°æ—¥æœŸ
          - æ›´æ–°ç‰ˆæœ¬è™Ÿ

          ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
          EOF
          )"

          git push origin $BRANCH_NAME

      - name: å»ºç«‹ Pull Request
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ¤– è‡ªå‹•æ›´æ–°å°ˆæ¡ˆç´¢å¼•" \
            --body "$(cat <<'EOF'
          ## ðŸ“‹ è‡ªå‹•ç´¢å¼•æ›´æ–°

          æ­¤ PR ç”± GitHub Actions è‡ªå‹•å»ºç«‹ï¼Œç”¨æ–¼åŒæ­¥ `PROJECT_INDEX.md` èˆ‡ç•¶å‰æª”æ¡ˆç³»çµ±ç‹€æ…‹ã€‚

          ### ðŸ”„ è®Šæ›´å…§å®¹
          - âœ… æ›´æ–°æª”æ¡ˆç‹€æ…‹æ¨™è¨˜ï¼ˆâ³ â†’ âœ…ï¼‰
          - ðŸ“… æ›´æ–°æœ€å¾Œæ›´æ–°æ—¥æœŸ
          - ðŸ”¢ æ›´æ–°ç‰ˆæœ¬è™Ÿ

          ### âœ… é©—è­‰æ­¥é©Ÿ
          - [x] è‡ªå‹•åŸ·è¡Œç´¢å¼•é©—è­‰
          - [x] è‡ªå‹•åŒæ­¥æª”æ¡ˆç‹€æ…‹
          - [ ] äººå·¥æª¢æŸ¥è®Šæ›´åˆç†æ€§

          ### ðŸ’¡ å¾ŒçºŒæ“ä½œ
          1. æª¢æŸ¥ `PROJECT_INDEX.md` çš„è®Šæ›´å…§å®¹
          2. ç¢ºèªæ‰€æœ‰æª”æ¡ˆç‹€æ…‹æ­£ç¢º
          3. åˆä½µæ­¤ PR ä»¥æ›´æ–°ç´¢å¼•

          ---
          ðŸ¤– ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
          EOF
          )" \
            --base main \
            --head ${{ steps.commit.outputs.branch_name }} \
            --label "documentation,automated"

  quality-check:
    name: ç´¢å¼•å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: åŸ·è¡Œå®Œæ•´é©—è­‰
        run: |
          echo "ðŸ“Š åŸ·è¡Œç´¢å¼•å“è³ªæª¢æŸ¥..."
          npm run validate-index

      - name: æª¢æŸ¥ç´¢å¼•æ˜¯å¦åŒæ­¥
        run: |
          echo "ðŸ” æª¢æŸ¥ç´¢å¼•åŒæ­¥ç‹€æ…‹..."
          npm run sync-index -- --dry-run

      - name: ç”Ÿæˆå“è³ªå ±å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š ç´¢å¼•å“è³ªå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… é©—è­‰çµæžœ" >> $GITHUB_STEP_SUMMARY
          npm run validate-index 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ åŒæ­¥ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          npm run sync-index -- --dry-run 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
