# Story 4.1: éŸ³è¨Šåˆ†æèˆ‡ Viseme æ•¸æ“šç”Ÿæˆ(ç°¡åŒ–ç‰ˆ)

## Status
Draft

---

## Story

**As a** é–‹ç™¼è€…,
**I want** åˆ†æ TTS éŸ³è¨Šç”¢ç”Ÿ viseme æ™‚é–“è»¸æ•¸æ“š,
**so that** å¯ä»¥é©…å‹• Avatar å˜´å‹å‹•ç•«ã€‚

---

## Acceptance Criteria

1. å»ºç«‹ `lib/three/lipsync.ts`ï¼Œå¯¦ä½œéŸ³è¨Šåˆ†æå‡½å¼
2. ä½¿ç”¨ Web Audio API `AnalyserNode` åˆ†æéŸ³è¨Šé »ç‡
3. å¯¦ä½œç°¡åŒ– viseme æ˜ å°„è¡¨ï¼šé«˜éŸ³é‡ â†’ `aa`(å¼µå˜´)ã€ä¸­éŸ³é‡ â†’ `E`(åŠé–‹)ã€ä½éŸ³é‡ â†’ `neutral`(é–‰å˜´)
4. ç”¢ç”Ÿ viseme æ™‚é–“è»¸æ•¸æ“šçµæ§‹ï¼š`VisemeData[] = [{ time: number, viseme: string, weight: number }]`
5. æ¯ 100ms ç”¢ç”Ÿä¸€å€‹ viseme æ•¸æ“šé»
6. æ¸¬è©¦ï¼šè¼¸å…¥éŸ³è¨Šæª”ï¼Œconsole.log é¡¯ç¤º viseme é™£åˆ—
7. ç›®æ¨™æº–ç¢ºåº¦ï¼š70%(é€éä¸»è§€è¦–è¦ºè©•ä¼°)

---

## Tasks / Subtasks

- [ ] **Task 1: å»ºç«‹ Viseme å‹åˆ¥å®šç¾©èˆ‡æ•¸æ“šçµæ§‹** (AC: 4)
  - [ ] å»ºç«‹ç›®éŒ„ `types/` (å¦‚å°šæœªå­˜åœ¨)
  - [ ] å»ºç«‹ `types/lipsync.ts` å®šç¾© Lip Sync ç›¸é—œå‹åˆ¥
  - [ ] å®šç¾© VisemeData ä»‹é¢ï¼š
    ```typescript
    /**
     * Viseme æ•¸æ“šé»
     * ç”¨æ–¼æè¿°æŸå€‹æ™‚é–“é»æ‡‰è©²é¡¯ç¤ºçš„å˜´å‹
     */
    export interface VisemeData {
      /** æ™‚é–“é»ï¼ˆç§’ï¼‰ï¼Œç›¸å°æ–¼éŸ³è¨Šé–‹å§‹æ™‚é–“ */
      time: number;
      /** Viseme éŸ³ç´ é¡å‹ */
      viseme: VisemeType;
      /** å˜´å‹æ¬Šé‡ï¼ˆ0-1ï¼‰ï¼Œæ§åˆ¶å˜´å‹é–‹åˆç¨‹åº¦ */
      weight: number;
    }

    /**
     * Viseme éŸ³ç´ é¡å‹ï¼ˆç°¡åŒ–ç‰ˆï¼‰
     * POC éšæ®µåƒ…æ”¯æ´åŸºç¤éŸ³ç´ åˆ†é¡
     */
    export type VisemeType = 'aa' | 'E' | 'I' | 'O' | 'U' | 'neutral';

    /**
     * éŸ³è¨Šåˆ†æé…ç½®
     */
    export interface AudioAnalysisConfig {
      /** FFT å¤§å°ï¼ˆå¿…é ˆç‚º 2 çš„å†ªæ¬¡æ–¹ï¼‰ */
      fftSize: number;
      /** å–æ¨£é–“éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œæ¯éš”å¤šä¹…ç”¢ç”Ÿä¸€å€‹ viseme æ•¸æ“šé» */
      sampleInterval: number;
      /** éŸ³é‡é–¾å€¼é…ç½® */
      volumeThresholds: {
        /** é«˜éŸ³é‡é–¾å€¼ï¼ˆ> æ­¤å€¼è¦–ç‚ºå¼µå˜´ aaï¼‰ */
        high: number;
        /** ä¸­éŸ³é‡é–¾å€¼ï¼ˆ> æ­¤å€¼è¦–ç‚ºåŠé–‹ Eï¼‰ */
        medium: number;
        /** ä½éŸ³é‡é–¾å€¼ï¼ˆ< æ­¤å€¼è¦–ç‚ºé–‰å˜´ neutralï¼‰ */
        low: number;
      };
    }
    ```
  - [ ] å®šç¾©é è¨­é…ç½®å¸¸æ•¸ï¼š
    ```typescript
    /**
     * é è¨­éŸ³è¨Šåˆ†æé…ç½®ï¼ˆPOC éšæ®µç°¡åŒ–ç‰ˆï¼‰
     */
    export const DEFAULT_AUDIO_ANALYSIS_CONFIG: AudioAnalysisConfig = {
      fftSize: 2048,              // FFT å¤§å°ï¼Œå½±éŸ¿é »ç‡è§£æåº¦
      sampleInterval: 100,        // 100ms å–æ¨£ä¸€æ¬¡ï¼ˆç¬¦åˆ AC è¦æ±‚ï¼‰
      volumeThresholds: {
        high: 0.6,                // > 60% éŸ³é‡è¦–ç‚ºå¼µå˜´
        medium: 0.3,              // > 30% éŸ³é‡è¦–ç‚ºåŠé–‹
        low: 0.1                  // < 10% éŸ³é‡è¦–ç‚ºé–‰å˜´
      }
    };
    ```
  - [ ] åŠ å…¥ JSDoc è¨»è§£èªªæ˜æ¯å€‹å‹åˆ¥ç”¨é€”
  - [ ] é©—è­‰å‹åˆ¥å®šç¾©ç„¡ TypeScript éŒ¯èª¤

- [ ] **Task 2: å¯¦ä½œéŸ³è¨Šåˆ†æåŸºç¤å‡½å¼** (AC: 1, 2)
  - [ ] å»ºç«‹ç›®éŒ„ `lib/three/` (å¦‚å°šæœªå­˜åœ¨)
  - [ ] å»ºç«‹ `lib/three/lipsync.ts` Lip Sync ä¸»å‡½å¼æª”
  - [ ] å¯¦ä½œ AudioContext èˆ‡ AnalyserNode åˆå§‹åŒ–ï¼š
    ```typescript
    import type { VisemeData, AudioAnalysisConfig } from '@/types/lipsync';
    import { DEFAULT_AUDIO_ANALYSIS_CONFIG } from '@/types/lipsync';

    /**
     * éŸ³è¨Šåˆ†æå™¨é¡åˆ¥
     * è² è²¬åˆ†æéŸ³è¨Šä¸¦ç”¢ç”Ÿ viseme æ™‚é–“è»¸æ•¸æ“š
     */
    export class AudioAnalyser {
      private audioContext: AudioContext;
      private analyser: AnalyserNode;
      private dataArray: Uint8Array;
      private config: AudioAnalysisConfig;

      constructor(config: Partial<AudioAnalysisConfig> = {}) {
        this.config = { ...DEFAULT_AUDIO_ANALYSIS_CONFIG, ...config };

        // åˆå§‹åŒ– AudioContext
        this.audioContext = new AudioContext();

        // å»ºç«‹ AnalyserNode
        this.analyser = this.audioContext.createAnalyser();
        this.analyser.fftSize = this.config.fftSize;

        // å»ºç«‹æ•¸æ“šé™£åˆ—ç”¨æ–¼å„²å­˜é »ç‡æ•¸æ“š
        const bufferLength = this.analyser.frequencyBinCount;
        this.dataArray = new Uint8Array(bufferLength);
      }

      /**
       * å–å¾— AudioContext å¯¦ä¾‹ï¼ˆä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰
       */
      getContext(): AudioContext {
        return this.audioContext;
      }

      /**
       * å–å¾— AnalyserNode å¯¦ä¾‹ï¼ˆä¾›å¤–éƒ¨é€£æ¥éŸ³è¨Šæºï¼‰
       */
      getAnalyser(): AnalyserNode {
        return this.analyser;
      }
    }
    ```
  - [ ] å¯¦ä½œéŸ³é‡è¨ˆç®—è¼”åŠ©å‡½å¼ï¼š
    ```typescript
    /**
     * è¨ˆç®—ç•¶å‰éŸ³é‡ï¼ˆ0-1 ç¯„åœï¼‰
     * ä½¿ç”¨æ™‚åŸŸæ•¸æ“šï¼ˆTime Domainï¼‰è¨ˆç®— RMS éŸ³é‡
     */
    private calculateVolume(): number {
      // å–å¾—æ™‚åŸŸæ•¸æ“š
      this.analyser.getByteTimeDomainData(this.dataArray);

      // è¨ˆç®— RMS (Root Mean Square) éŸ³é‡
      let sum = 0;
      for (let i = 0; i < this.dataArray.length; i++) {
        const normalized = (this.dataArray[i] - 128) / 128; // æ­£è¦åŒ–åˆ° -1~1
        sum += normalized * normalized;
      }
      const rms = Math.sqrt(sum / this.dataArray.length);

      return rms;
    }
    ```
  - [ ] æ¸¬è©¦ AudioContext èˆ‡ AnalyserNode æ­£ç¢ºåˆå§‹åŒ–
  - [ ] é©—è­‰éŸ³é‡è¨ˆç®—å‡½å¼è¿”å› 0-1 ç¯„åœæ•¸å€¼

- [ ] **Task 3: å¯¦ä½œç°¡åŒ– Viseme æ˜ å°„é‚è¼¯** (AC: 3)
  - [ ] å¯¦ä½œéŸ³é‡åˆ° Viseme æ˜ å°„å‡½å¼ï¼š
    ```typescript
    import type { VisemeType } from '@/types/lipsync';

    /**
     * æ ¹æ“šéŸ³é‡æ˜ å°„åˆ°å°æ‡‰çš„ Viseme éŸ³ç´ 
     * POC éšæ®µä½¿ç”¨ç°¡åŒ–æ˜ å°„ç­–ç•¥ï¼ˆåƒ…åŸºæ–¼éŸ³é‡å¤§å°ï¼‰
     *
     * @param volume - ç•¶å‰éŸ³é‡ï¼ˆ0-1 ç¯„åœï¼‰
     * @returns Viseme éŸ³ç´ é¡å‹èˆ‡æ¬Šé‡
     */
    private mapVolumeToViseme(volume: number): { viseme: VisemeType; weight: number } {
      const { volumeThresholds } = this.config;

      if (volume > volumeThresholds.high) {
        // é«˜éŸ³é‡ â†’ å¼µå˜´ï¼ˆaaï¼‰
        return {
          viseme: 'aa',
          weight: Math.min(volume, 1.0) // éŸ³é‡å³æ¬Šé‡ï¼Œä½†ä¸è¶…é 1.0
        };
      } else if (volume > volumeThresholds.medium) {
        // ä¸­éŸ³é‡ â†’ åŠé–‹ï¼ˆEï¼‰
        return {
          viseme: 'E',
          weight: (volume - volumeThresholds.medium) / (volumeThresholds.high - volumeThresholds.medium)
        };
      } else if (volume > volumeThresholds.low) {
        // ä½éŸ³é‡ â†’ å¾®é–‹ï¼ˆneutral éæ¸¡ï¼‰
        return {
          viseme: 'neutral',
          weight: volume / volumeThresholds.medium
        };
      } else {
        // æ¥µä½éŸ³é‡ â†’ é–‰å˜´
        return {
          viseme: 'neutral',
          weight: 0
        };
      }
    }
    ```
  - [ ] åŠ å…¥æ˜ å°„é‚è¼¯è¨»è§£èªªæ˜ç­–ç•¥
  - [ ] æ¸¬è©¦ä¸åŒéŸ³é‡å€¼çš„æ˜ å°„çµæœï¼š
    - [ ] volume = 0.8 â†’ aa, weight â‰ˆ 0.8
    - [ ] volume = 0.4 â†’ E, weight â‰ˆ 0.33
    - [ ] volume = 0.05 â†’ neutral, weight = 0
  - [ ] é©—è­‰æ¬Šé‡å€¼ç¯„åœåœ¨ 0-1 ä¹‹é–“

- [ ] **Task 4: å¯¦ä½œéŸ³è¨Šåˆ†æä¸»å‡½å¼ï¼ˆç”¢ç”Ÿ Viseme æ™‚é–“è»¸ï¼‰** (AC: 4, 5, 6)
  - [ ] å¯¦ä½œéŸ³è¨Šç·©è¡å€åˆ†æå‡½å¼ï¼š
    ```typescript
    /**
     * åˆ†æéŸ³è¨Šç·©è¡å€ä¸¦ç”¢ç”Ÿ Viseme æ™‚é–“è»¸æ•¸æ“š
     *
     * @param audioBuffer - Web Audio API AudioBuffer
     * @returns Viseme æ™‚é–“è»¸æ•¸æ“šé™£åˆ—
     */
    async analyseAudioBuffer(audioBuffer: AudioBuffer): Promise<VisemeData[]> {
      const visemeTimeline: VisemeData[] = [];
      const sampleIntervalSeconds = this.config.sampleInterval / 1000; // è½‰æ›ç‚ºç§’
      const duration = audioBuffer.duration;

      // å»ºç«‹é›¢ç·šéŸ³è¨Šä¸Šä¸‹æ–‡ï¼ˆç”¨æ–¼åˆ†æé éŒ„éŸ³è¨Šï¼‰
      const offlineContext = new OfflineAudioContext(
        audioBuffer.numberOfChannels,
        audioBuffer.length,
        audioBuffer.sampleRate
      );

      // å»ºç«‹éŸ³è¨Šæºä¸¦é€£æ¥åˆ°åˆ†æå™¨
      const source = offlineContext.createBufferSource();
      source.buffer = audioBuffer;

      const offlineAnalyser = offlineContext.createAnalyser();
      offlineAnalyser.fftSize = this.config.fftSize;

      source.connect(offlineAnalyser);
      offlineAnalyser.connect(offlineContext.destination);

      // æŒ‰ç…§å–æ¨£é–“éš”åˆ†æéŸ³è¨Š
      let currentTime = 0;
      const tempDataArray = new Uint8Array(offlineAnalyser.frequencyBinCount);

      while (currentTime < duration) {
        // è¨ˆç®—ç•¶å‰æ™‚é–“é»çš„éŸ³é‡
        // æ³¨æ„ï¼šOfflineAudioContext éœ€è¦ä½¿ç”¨ getByteTimeDomainData å³æ™‚ç²å–
        // POC éšæ®µç°¡åŒ–ï¼šä½¿ç”¨åŸå§‹ AudioBuffer æ•¸æ“šè¨ˆç®—éŸ³é‡
        const volume = this.calculateVolumeAtTime(audioBuffer, currentTime);

        // æ˜ å°„åˆ° Viseme
        const { viseme, weight } = this.mapVolumeToViseme(volume);

        // åŠ å…¥æ™‚é–“è»¸æ•¸æ“š
        visemeTimeline.push({
          time: currentTime,
          viseme,
          weight
        });

        currentTime += sampleIntervalSeconds;
      }

      console.log('[LipSync] Generated viseme timeline:', {
        totalDataPoints: visemeTimeline.length,
        duration: `${duration.toFixed(2)}s`,
        sampleInterval: `${this.config.sampleInterval}ms`
      });

      return visemeTimeline;
    }
    ```
  - [ ] å¯¦ä½œæ™‚é–“é»éŸ³é‡è¨ˆç®—è¼”åŠ©å‡½å¼ï¼š
    ```typescript
    /**
     * è¨ˆç®—ç‰¹å®šæ™‚é–“é»çš„éŸ³é‡
     * POC éšæ®µç°¡åŒ–å¯¦ä½œï¼šç›´æ¥åˆ†æ AudioBuffer åŸå§‹æ•¸æ“š
     *
     * @param audioBuffer - éŸ³è¨Šç·©è¡å€
     * @param time - æ™‚é–“é»ï¼ˆç§’ï¼‰
     * @returns éŸ³é‡å€¼ï¼ˆ0-1ï¼‰
     */
    private calculateVolumeAtTime(audioBuffer: AudioBuffer, time: number): number {
      const sampleRate = audioBuffer.sampleRate;
      const channelData = audioBuffer.getChannelData(0); // ä½¿ç”¨ç¬¬ä¸€å€‹è²é“

      // è¨ˆç®—æ™‚é–“é»å°æ‡‰çš„æ¨£æœ¬ç´¢å¼•
      const sampleIndex = Math.floor(time * sampleRate);

      // å–æ¨£æœ¬å‘¨åœçš„æ•¸æ“šè¨ˆç®— RMS éŸ³é‡ï¼ˆä½¿ç”¨ 100 å€‹æ¨£æœ¬çª—å£ï¼‰
      const windowSize = 100;
      const startIndex = Math.max(0, sampleIndex - windowSize / 2);
      const endIndex = Math.min(channelData.length, sampleIndex + windowSize / 2);

      let sum = 0;
      for (let i = startIndex; i < endIndex; i++) {
        sum += channelData[i] * channelData[i];
      }

      const rms = Math.sqrt(sum / (endIndex - startIndex));
      return Math.min(rms * 2, 1.0); // æ”¾å¤§ 2 å€ä»¥å¢åŠ æ•æ„Ÿåº¦ï¼Œä½†ä¸è¶…é 1.0
    }
    ```
  - [ ] åŠ å…¥ console.log è¨˜éŒ„åˆ†æé€²åº¦
  - [ ] æ¸¬è©¦éŸ³è¨Šåˆ†æå‡½å¼ï¼š
    - [ ] è¼¸å…¥ 3 ç§’éŸ³è¨Š â†’ ç”¢ç”Ÿç´„ 30 å€‹æ•¸æ“šé»ï¼ˆ100ms é–“éš”ï¼‰
    - [ ] é©—è­‰æ™‚é–“è»¸æ•¸æ“šçµæ§‹æ­£ç¢º
  - [ ] é©—è­‰ visemeTimeline é™£åˆ—æ ¼å¼ç¬¦åˆ VisemeData ä»‹é¢

- [ ] **Task 5: å»ºç«‹éŸ³è¨Šè¼‰å…¥èˆ‡åˆ†ææ•´åˆå‡½å¼** (AC: 6)
  - [ ] å¯¦ä½œå¾ URL è¼‰å…¥éŸ³è¨Šçš„è¼”åŠ©å‡½å¼ï¼š
    ```typescript
    /**
     * å¾ URL è¼‰å…¥éŸ³è¨Šä¸¦è§£ç¢¼ç‚º AudioBuffer
     *
     * @param audioUrl - éŸ³è¨Šæª”æ¡ˆ URLï¼ˆæ”¯æ´ MP3, WAV ç­‰ï¼‰
     * @returns AudioBuffer
     */
    async loadAudioFromUrl(audioUrl: string): Promise<AudioBuffer> {
      try {
        console.log('[LipSync] Loading audio from:', audioUrl);

        // Fetch éŸ³è¨Šæª”æ¡ˆ
        const response = await fetch(audioUrl);
        if (!response.ok) {
          throw new Error(`Failed to fetch audio: ${response.statusText}`);
        }

        // è½‰æ›ç‚º ArrayBuffer
        const arrayBuffer = await response.arrayBuffer();

        // è§£ç¢¼ç‚º AudioBuffer
        const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

        console.log('[LipSync] Audio loaded successfully:', {
          duration: `${audioBuffer.duration.toFixed(2)}s`,
          sampleRate: audioBuffer.sampleRate,
          channels: audioBuffer.numberOfChannels
        });

        return audioBuffer;
      } catch (error) {
        console.error('[LipSync] Failed to load audio:', error);
        throw error;
      }
    }
    ```
  - [ ] å»ºç«‹æ•´åˆå‡½å¼ï¼ˆè¼‰å…¥ + åˆ†æï¼‰ï¼š
    ```typescript
    /**
     * å¾ URL è¼‰å…¥éŸ³è¨Šä¸¦åˆ†æç”¢ç”Ÿ Viseme æ™‚é–“è»¸
     * é€™æ˜¯å°å¤–çš„ä¸»è¦ API å‡½å¼
     *
     * @param audioUrl - éŸ³è¨Šæª”æ¡ˆ URL
     * @returns Viseme æ™‚é–“è»¸æ•¸æ“šé™£åˆ—
     */
    async analyseAudioFromUrl(audioUrl: string): Promise<VisemeData[]> {
      const audioBuffer = await this.loadAudioFromUrl(audioUrl);
      return this.analyseAudioBuffer(audioBuffer);
    }
    ```
  - [ ] åŠ å…¥éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒè¨˜éŒ„
  - [ ] æ¸¬è©¦å¾ URL è¼‰å…¥éŸ³è¨Šä¸¦åˆ†æ
  - [ ] é©—è­‰å®Œæ•´æµç¨‹ç„¡éŒ¯èª¤

- [ ] **Task 6: å»ºç«‹æ¸¬è©¦è…³æœ¬èˆ‡ä¸»è§€è©•ä¼°** (AC: 6, 7)
  - [ ] å»ºç«‹æ¸¬è©¦ç›®éŒ„ `scripts/test/` (å¦‚å°šæœªå­˜åœ¨)
  - [ ] å»ºç«‹ `scripts/test/test-lipsync-analysis.ts` æ¸¬è©¦è…³æœ¬ï¼š
    ```typescript
    /**
     * Lip Sync éŸ³è¨Šåˆ†ææ¸¬è©¦è…³æœ¬
     * ç”¨æ–¼é©—è­‰ viseme æ•¸æ“šç”ŸæˆåŠŸèƒ½
     *
     * åŸ·è¡Œæ–¹å¼ï¼š
     * pnpm tsx scripts/test/test-lipsync-analysis.ts
     */

    import { AudioAnalyser } from '@/lib/three/lipsync';

    async function testAudioAnalysis() {
      console.log('=== Lip Sync Audio Analysis Test ===\n');

      // å»ºç«‹åˆ†æå™¨å¯¦ä¾‹
      const analyser = new AudioAnalyser();

      // æ¸¬è©¦éŸ³è¨Š URLï¼ˆä½¿ç”¨ Azure TTS ç”¢ç”Ÿçš„ç¯„ä¾‹éŸ³è¨Šï¼‰
      // æ³¨æ„ï¼šéœ€è¦æ›¿æ›ç‚ºå¯¦éš›å¯å­˜å–çš„éŸ³è¨Š URL
      const testAudioUrl = '/test-audio/sample.mp3';

      try {
        console.log('ğŸ“‚ Loading test audio...');
        const visemeTimeline = await analyser.analyseAudioFromUrl(testAudioUrl);

        console.log('\nâœ… Viseme Timeline Generated:');
        console.log(`   Total data points: ${visemeTimeline.length}`);
        console.log(`   Duration: ${visemeTimeline[visemeTimeline.length - 1]?.time.toFixed(2)}s`);
        console.log(`   Sample interval: 100ms\n`);

        // é¡¯ç¤ºå‰ 10 å€‹æ•¸æ“šé»
        console.log('ğŸ“Š First 10 Viseme Data Points:');
        visemeTimeline.slice(0, 10).forEach((data, index) => {
          console.log(`   [${index}] time: ${data.time.toFixed(2)}s, viseme: ${data.viseme.padEnd(7)}, weight: ${data.weight.toFixed(2)}`);
        });

        // çµ±è¨ˆ Viseme åˆ†å¸ƒ
        const visemeCounts: Record<string, number> = {};
        visemeTimeline.forEach((data) => {
          visemeCounts[data.viseme] = (visemeCounts[data.viseme] || 0) + 1;
        });

        console.log('\nğŸ“ˆ Viseme Distribution:');
        Object.entries(visemeCounts).forEach(([viseme, count]) => {
          const percentage = ((count / visemeTimeline.length) * 100).toFixed(1);
          console.log(`   ${viseme.padEnd(7)}: ${count.toString().padStart(3)} (${percentage}%)`);
        });

        console.log('\nâœ… Test completed successfully!');
        console.log('ğŸ‘ï¸  Please manually verify the viseme timeline matches audio content.');

      } catch (error) {
        console.error('\nâŒ Test failed:', error);
      }
    }

    // åŸ·è¡Œæ¸¬è©¦
    testAudioAnalysis();
    ```
  - [ ] æº–å‚™æ¸¬è©¦éŸ³è¨Šæª”æ¡ˆï¼ˆ3-5 ç§’ç¹ä¸­èªéŸ³ï¼‰
  - [ ] åŸ·è¡Œæ¸¬è©¦è…³æœ¬ï¼š`pnpm tsx scripts/test/test-lipsync-analysis.ts`
  - [ ] é©—è­‰ console è¼¸å‡ºï¼š
    - [ ] Viseme æ™‚é–“è»¸æ•¸æ“šæ­£ç¢ºç”¢ç”Ÿ
    - [ ] è³‡æ–™é»æ•¸é‡ç¬¦åˆé æœŸï¼ˆduration / 0.1ï¼‰
    - [ ] Viseme é¡å‹åˆ†å¸ƒåˆç†ï¼ˆaa, E, neutral éƒ½æœ‰å‡ºç¾ï¼‰
  - [ ] ä¸»è§€è¦–è¦ºè©•ä¼°æº–å‚™ï¼ˆStory 4.3 æ•´åˆ Avatar å¾Œé€²è¡Œï¼‰

- [ ] **Task 7: å„ªåŒ–èˆ‡èª¿æ ¡éŸ³é‡é–¾å€¼** (AC: 7)
  - [ ] æ¸¬è©¦å¤šå€‹éŸ³è¨Šæª”æ¡ˆä¸¦èª¿æ•´é–¾å€¼
  - [ ] å¯¦ä½œé–¾å€¼èª¿æ ¡è¼”åŠ©å‡½å¼ï¼š
    ```typescript
    /**
     * èª¿æ ¡éŸ³é‡é–¾å€¼é…ç½®
     * æ ¹æ“šå¯¦éš›éŸ³è¨Šç‰¹æ€§èª¿æ•´æœ€ä½³é–¾å€¼
     *
     * @param high - é«˜éŸ³é‡é–¾å€¼ï¼ˆé è¨­ 0.6ï¼‰
     * @param medium - ä¸­éŸ³é‡é–¾å€¼ï¼ˆé è¨­ 0.3ï¼‰
     * @param low - ä½éŸ³é‡é–¾å€¼ï¼ˆé è¨­ 0.1ï¼‰
     */
    updateVolumeThresholds(high: number, medium: number, low: number): void {
      this.config.volumeThresholds = { high, medium, low };
      console.log('[LipSync] Volume thresholds updated:', this.config.volumeThresholds);
    }
    ```
  - [ ] å»ºç«‹é–¾å€¼æ¸¬è©¦çŸ©é™£ï¼š
    - [ ] æ¸¬è©¦ high: 0.5, 0.6, 0.7
    - [ ] æ¸¬è©¦ medium: 0.2, 0.3, 0.4
    - [ ] æ¸¬è©¦ low: 0.05, 0.1, 0.15
  - [ ] é¸æ“‡æœ€ä½³é–¾å€¼çµ„åˆï¼ˆç›®æ¨™ï¼š70% è¦–è¦ºåŒ¹é…åº¦ï¼‰
  - [ ] æ›´æ–° DEFAULT_AUDIO_ANALYSIS_CONFIG ç‚ºæœ€ä½³å€¼
  - [ ] è¨˜éŒ„èª¿æ ¡éç¨‹èˆ‡çµæœæ–¼ Dev Notes

- [ ] **Task 8: å»ºç«‹å°å‡º API èˆ‡æ•´åˆæº–å‚™** (AC: 1, 4)
  - [ ] åœ¨ `lib/three/lipsync.ts` å°å‡ºä¸»è¦ APIï¼š
    ```typescript
    /**
     * ç°¡åŒ– APIï¼šåˆ†æéŸ³è¨Š URL ä¸¦ç”¢ç”Ÿ Viseme æ™‚é–“è»¸
     *
     * @param audioUrl - éŸ³è¨Šæª”æ¡ˆ URL
     * @param config - å¯é¸çš„åˆ†æé…ç½®
     * @returns Viseme æ™‚é–“è»¸æ•¸æ“šé™£åˆ—
     */
    export async function generateVisemeTimeline(
      audioUrl: string,
      config?: Partial<AudioAnalysisConfig>
    ): Promise<VisemeData[]> {
      const analyser = new AudioAnalyser(config);
      return analyser.analyseAudioFromUrl(audioUrl);
    }

    // å°å‡ºé¡åˆ¥ä¾›é€²éšä½¿ç”¨
    export { AudioAnalyser };
    ```
  - [ ] å»ºç«‹ barrel export `lib/three/index.ts`ï¼š
    ```typescript
    export * from './lipsync';
    // æœªä¾†æœƒåŠ å…¥å…¶ä»– Three.js ç›¸é—œæ¨¡çµ„
    ```
  - [ ] æ›´æ–° `types/index.ts` å°å‡º Lip Sync å‹åˆ¥ï¼š
    ```typescript
    export * from './lipsync';
    // å…¶ä»–å‹åˆ¥å°å‡º...
    ```
  - [ ] é©—è­‰å°å…¥è·¯å¾‘æ­£ç¢ºï¼š
    ```typescript
    // å…¶ä»–çµ„ä»¶å¯ä»¥é€™æ¨£ä½¿ç”¨
    import { generateVisemeTimeline } from '@/lib/three';
    import type { VisemeData } from '@/types';
    ```
  - [ ] å»ºç«‹ README èªªæ˜æ–‡ä»¶ `lib/three/README.md`ï¼š
    ```markdown
    # Lip Sync Library

    ## Usage

    ### Basic Usage
    \`\`\`typescript
    import { generateVisemeTimeline } from '@/lib/three';

    const audioUrl = '/audio/tts-output.mp3';
    const visemeTimeline = await generateVisemeTimeline(audioUrl);

    console.log(visemeTimeline);
    // [{ time: 0, viseme: 'neutral', weight: 0 }, ...]
    \`\`\`

    ### Advanced Usage
    \`\`\`typescript
    import { AudioAnalyser } from '@/lib/three';

    const analyser = new AudioAnalyser({
      sampleInterval: 50, // 50ms æ›´é«˜é »ç‡å–æ¨£
      volumeThresholds: {
        high: 0.7,
        medium: 0.4,
        low: 0.1
      }
    });

    const visemes = await analyser.analyseAudioFromUrl(audioUrl);
    \`\`\`
    ```
  - [ ] é©—è­‰æ–‡ä»¶æ¸…æ™°æ˜“æ‡‚

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

æ ¹æ“šæ¶æ§‹æ–‡ä»¶ï¼ŒEpic 4 çš„æª”æ¡ˆçµæ§‹æ‡‰å¦‚ä¸‹ï¼š

```
avatar-chat-poc/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ three/
â”‚       â”œâ”€â”€ lipsync.ts              # Lip Sync éŸ³è¨Šåˆ†æä¸»å‡½å¼ (æœ¬ Story)
â”‚       â”œâ”€â”€ animator.ts             # Avatar å‹•ç•«æ§åˆ¶å™¨ (Epic 2)
â”‚       â”œâ”€â”€ avatar-loader.ts        # Avatar æ¨¡å‹è¼‰å…¥å™¨ (Epic 2)
â”‚       â”œâ”€â”€ index.ts                # Barrel export
â”‚       â””â”€â”€ README.md               # Lip Sync ä½¿ç”¨æ–‡ä»¶
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ lipsync.ts                  # Lip Sync å‹åˆ¥å®šç¾© (æœ¬ Story)
â”‚   â”œâ”€â”€ avatar.ts                   # Avatar å‹åˆ¥å®šç¾© (Epic 2)
â”‚   â”œâ”€â”€ chat.ts                     # Chat å‹åˆ¥å®šç¾© (Epic 3)
â”‚   â””â”€â”€ index.ts                    # å‹åˆ¥çµ±ä¸€å°å‡º
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ AvatarModel.tsx         # Avatar æ¨¡å‹çµ„ä»¶ (Epic 2)
â”‚   â”‚   â””â”€â”€ LipSyncController.tsx   # Lip Sync æ§åˆ¶å™¨çµ„ä»¶ (Story 4.3)
â”‚   â””â”€â”€ chat/
â”‚       â””â”€â”€ ChatInterface.tsx       # å°è©±ä»‹é¢ (Epic 3)
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ audioStore.ts               # Audio ç‹€æ…‹ç®¡ç† (Epic 3)
â”‚   â””â”€â”€ avatarStore.ts              # Avatar ç‹€æ…‹ç®¡ç† (Epic 2, å°‡åŠ å…¥ visemes)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ test-lipsync-analysis.ts # Lip Sync æ¸¬è©¦è…³æœ¬ (æœ¬ Story)
â””â”€â”€ public/
    â””â”€â”€ test-audio/
        â””â”€â”€ sample.mp3              # æ¸¬è©¦éŸ³è¨Šæª”æ¡ˆ
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**Web Audio API æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **AudioContext**: éŸ³è¨Šè™•ç†ç’°å¢ƒï¼Œç®¡ç†éŸ³è¨Šç¯€é»åœ–
- **AnalyserNode**: æä¾›å³æ™‚é »ç‡èˆ‡æ™‚åŸŸåˆ†æåŠŸèƒ½
- **AudioBuffer**: è§£ç¢¼å¾Œçš„éŸ³è¨Šæ•¸æ“šï¼Œå¯ç”¨æ–¼é›¢ç·šåˆ†æ
- **OfflineAudioContext**: ç”¨æ–¼å¿«é€Ÿåˆ†æé éŒ„éŸ³è¨Šï¼ˆéå³æ™‚æ’­æ”¾ï¼‰

**éŸ³é‡è¨ˆç®—æ–¹æ³•ï¼ˆRMSï¼‰**ï¼š
```typescript
// RMS (Root Mean Square) éŸ³é‡è¨ˆç®—å…¬å¼
// 1. å°‡éŸ³è¨Šæ•¸æ“šæ­£è¦åŒ–åˆ° -1 ~ 1 ç¯„åœ
// 2. è¨ˆç®—å¹³æ–¹å’Œ
// 3. é™¤ä»¥æ¨£æœ¬æ•¸é‡
// 4. é–‹æ ¹è™Ÿ
const rms = Math.sqrt(sum / sampleCount);

// RMS å„ªé»ï¼š
// - åæ˜ éŸ³è¨Šèƒ½é‡å¤§å°ï¼ˆæ¯” peak æ›´ç©©å®šï¼‰
// - ç¬¦åˆäººè€³å°éŸ³é‡çš„æ„ŸçŸ¥
// - é©åˆèªéŸ³åˆ†æï¼ˆå¹³æ»‘è®ŠåŒ–ï¼‰
```

**Viseme ç°¡åŒ–æ˜ å°„ç­–ç•¥**ï¼š

POC éšæ®µä½¿ç”¨åŸºæ–¼éŸ³é‡çš„ç°¡åŒ–æ˜ å°„ï¼ˆè€ŒéçœŸå¯¦éŸ³ç´ åˆ†æï¼‰ï¼š

| éŸ³é‡ç¯„åœ | Viseme | å˜´å‹æè¿° | é©ç”¨å ´æ™¯ |
|---------|--------|---------|---------|
| > 0.6   | aa     | å¼µå˜´ï¼ˆå¤§é–‹ï¼‰ | é«˜éŸ³é‡éŸ³ç¯€ï¼ˆå¦‚ã€Œå•Šã€ã€Œå“ˆã€ï¼‰ |
| 0.3-0.6 | E      | åŠé–‹ | ä¸­éŸ³é‡éŸ³ç¯€ï¼ˆå¦‚ã€Œæ¬¸ã€ã€Œèª’ã€ï¼‰ |
| 0.1-0.3 | neutral | å¾®é–‹ | ä½éŸ³é‡éŸ³ç¯€ï¼ˆå¦‚ã€Œå—¯ã€ã€Œå‘£ã€ï¼‰ |
| < 0.1   | neutral | é–‰å˜´ | éœéŸ³æˆ–æ¥µä½éŸ³é‡ |

**ç‚ºä½• POC ä½¿ç”¨ç°¡åŒ–ç­–ç•¥ï¼Ÿ**
- âœ… å¿«é€Ÿå¯¦ç¾ï¼šç„¡éœ€è¤‡é›œéŸ³ç´ è­˜åˆ¥ç®—æ³•
- âœ… æˆæœ¬ä½ï¼šç„¡éœ€é¡å¤– APIï¼ˆå¦‚ Azure Speech Viseme Outputï¼‰
- âœ… 70% æº–ç¢ºåº¦å¯é”æˆï¼šå°æ–¼ POC æŠ€è¡“é©—è­‰è¶³å¤ 
- âš ï¸ é™åˆ¶ï¼šç„¡æ³•è­˜åˆ¥çœŸå¯¦éŸ³ç´ ï¼ˆå¦‚ p/b, f/v å·®ç•°ï¼‰
- ğŸ”„ æœªä¾†å„ªåŒ–ï¼šMVP éšæ®µå¯å‡ç´šç‚º Rhubarb Lip Sync æˆ– Azure Viseme API

**å–æ¨£é–“éš”é¸æ“‡ï¼ˆ100msï¼‰**ï¼š
```typescript
// ç‚ºä½•é¸æ“‡ 100msï¼Ÿ
// âœ… è¶³å¤ æµæš¢ï¼šäººçœ¼ç„¡æ³•å¯Ÿè¦º < 100ms çš„å˜´å‹è®ŠåŒ–
// âœ… æ•ˆèƒ½å¹³è¡¡ï¼šæ¯ç§’ 10 å€‹æ•¸æ“šé»ï¼Œå° GPU è² æ“”å°
// âœ… ç¬¦åˆèªéŸ³ç¯€å¥ï¼šä¸­æ–‡éŸ³ç¯€æŒçºŒæ™‚é–“é€šå¸¸ 100-300ms
// âš ï¸ æœªä¾†å¯èª¿æ•´ï¼šå¿«é€ŸèªéŸ³å¯é™è‡³ 50msï¼Œæ…¢é€ŸèªéŸ³å¯æå‡è‡³ 150ms

const sampleInterval = 100; // ms
const dataPointsPerSecond = 1000 / sampleInterval; // 10 points/sec
```

**AudioBuffer é›¢ç·šåˆ†æåŸç†**ï¼š
```typescript
// ç‚ºä½•ä½¿ç”¨é›¢ç·šåˆ†æè€Œéå³æ™‚åˆ†æï¼Ÿ
// âœ… é å…ˆè¨ˆç®—ï¼šTTS éŸ³è¨Šå·²å®Œæ•´ç”¢ç”Ÿï¼Œå¯æå‰åˆ†æ
// âœ… æº–ç¢ºåº¦é«˜ï¼šç„¡éœ€è™•ç†å³æ™‚ä¸²æµçš„æ™‚é–“å°é½Šå•é¡Œ
// âœ… æ•ˆèƒ½æ›´å¥½ï¼šä¸€æ¬¡æ€§åˆ†æå®Œæˆï¼Œä¸ä½”ç”¨æ’­æ”¾æ™‚ CPU
// âœ… å¯é‡è¤‡ä½¿ç”¨ï¼šviseme æ™‚é–“è»¸å¯å¿«å–ï¼Œé‡è¤‡æ’­æ”¾ç„¡éœ€é‡æ–°åˆ†æ

// æµç¨‹ï¼š
// 1. Fetch éŸ³è¨Š URL â†’ ArrayBuffer
// 2. decodeAudioData â†’ AudioBuffer
// 3. éæ­·æ¯å€‹å–æ¨£é»è¨ˆç®—éŸ³é‡
// 4. æ˜ å°„åˆ° Viseme â†’ æ™‚é–“è»¸æ•¸æ“š
// 5. å„²å­˜è‡³ audioStore ä¾›æ’­æ”¾æ™‚ä½¿ç”¨
```

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•å»ºç«‹ AudioAnalyser é¡åˆ¥è€Œéç´”å‡½å¼ï¼Ÿ**
   - âœ… å°è£ç‹€æ…‹ï¼šAudioContext, AnalyserNode éœ€è¦é‡è¤‡ä½¿ç”¨
   - âœ… é…ç½®å½ˆæ€§ï¼šå¯é€é constructor è‡ªè¨‚åˆ†æåƒæ•¸
   - âœ… æœªä¾†æ“´å±•ï¼šå¯åŠ å…¥å¿«å–ã€äº‹ä»¶ç›£è½ç­‰åŠŸèƒ½
   - âœ… æ¸¬è©¦å‹å–„ï¼šå¯ mock é¡åˆ¥å¯¦ä¾‹é€²è¡Œå–®å…ƒæ¸¬è©¦
   - âš ï¸ æ³¨æ„ï¼šéœ€è¦æ‰‹å‹•é‡‹æ”¾ AudioContext è³‡æºï¼ˆdispose æ–¹æ³•ï¼‰

2. **ç‚ºä½•ä¸ä½¿ç”¨ Azure Speech Viseme Outputï¼Ÿ**
   - âœ… æˆæœ¬è€ƒé‡ï¼šAzure Viseme API éœ€é¡å¤–è²»ç”¨
   - âœ… å»¶é²è€ƒé‡ï¼šéœ€é¡å¤– API è«‹æ±‚å¢åŠ å»¶é²
   - âœ… POC ç›®æ¨™ï¼š70% æº–ç¢ºåº¦å³å¯é©—è­‰å¯è¡Œæ€§
   - âœ… ç°¡åŒ–é–‹ç™¼ï¼šWeb Audio API åŸç”Ÿæ”¯æ´ï¼Œç„¡éœ€å¤–éƒ¨ä¾è³´
   - ğŸ”„ æœªä¾†å‡ç´šè·¯å¾‘ï¼šMVP éšæ®µå¯è©•ä¼° Azure Viseme æˆ– Rhubarb Lip Sync

3. **ç‚ºä½•æ¯ 100ms å–æ¨£è€Œéé€£çºŒåˆ†æï¼Ÿ**
   - âœ… æ•ˆèƒ½å¹³è¡¡ï¼šé€£çºŒåˆ†ææ¯å¹€ï¼ˆ60fpsï¼‰ç”¢ç”Ÿ 3600 å€‹æ•¸æ“šé»/åˆ†é˜ï¼Œéæ–¼é¾å¤§
   - âœ… è¦–è¦ºå¹³æ»‘ï¼š100ms é–“éš”è¶³ä»¥ç”¢ç”Ÿæµæš¢å‹•ç•«ï¼ˆäººçœ¼æ„ŸçŸ¥é–¾å€¼ ~80msï¼‰
   - âœ… æ•¸æ“šé‡æ§åˆ¶ï¼š1 åˆ†é˜éŸ³è¨Š â†’ 600 å€‹æ•¸æ“šé»ï¼Œå¯æ¥å—
   - âœ… æ’å€¼å‹å–„ï¼šStory 4.3 å¯ä½¿ç”¨ lerp åœ¨æ•¸æ“šé»é–“æ’å€¼

4. **ç‚ºä½•ä½¿ç”¨ RMS è€Œé Peak éŸ³é‡ï¼Ÿ**
   - âœ… å¹³æ»‘ç©©å®šï¼šRMS åæ˜ å¹³å‡èƒ½é‡ï¼Œä¸å—ç¬é–“å°–å³°å½±éŸ¿
   - âœ… ç¬¦åˆäººè€³ï¼šäººè€³å°éŸ³é‡çš„æ„ŸçŸ¥æ›´æ¥è¿‘ RMS è€Œé Peak
   - âœ… é©åˆèªéŸ³ï¼šèªéŸ³éŸ³é‡è®ŠåŒ–ç›¸å°å¹³ç·©ï¼ŒRMS æ›´èƒ½åæ˜ å¯¦éš›éŸ¿åº¦
   - âš ï¸ æ³¨æ„ï¼šéŸ³æ¨‚åˆ†æå¯èƒ½éœ€è¦ Peakï¼Œä½†æœ¬å°ˆæ¡ˆåƒ…è™•ç† TTS èªéŸ³

5. **ç‚ºä½•å®šç¾© VisemeType ç‚º string literal unionï¼Ÿ**
   - âœ… å‹åˆ¥å®‰å…¨ï¼šTypeScript ç·¨è­¯æ™‚æª¢æŸ¥ï¼Œé¿å…æ‹¼å¯«éŒ¯èª¤
   - âœ… IDE æ”¯æ´ï¼šè‡ªå‹•å®Œæˆæç¤ºå¯ç”¨çš„ Viseme é¡å‹
   - âœ… å¯æ“´å±•ï¼šæœªä¾†åŠ å…¥æ›´å¤šéŸ³ç´ ï¼ˆå¦‚ 'p', 'f', 'm'ï¼‰åªéœ€æ›´æ–°å‹åˆ¥
   - âœ… æ–‡æª”æ¸…æ™°ï¼šå‹åˆ¥å®šç¾©å³æ–‡æª”ï¼Œé–‹ç™¼è€…ä¸€ç›®äº†ç„¶

### Testing

**æ¸¬è©¦æ¡†æ¶**: æ‰‹å‹•æ¸¬è©¦ + TypeScript ç·¨è­¯æª¢æŸ¥ + æ¸¬è©¦è…³æœ¬ï¼ˆPOC éšæ®µï¼‰

**æ¸¬è©¦ç¯„åœ**:
1. âœ… AudioAnalyser é¡åˆ¥æ­£ç¢ºåˆå§‹åŒ–
2. âœ… éŸ³é‡è¨ˆç®—å‡½å¼è¿”å› 0-1 ç¯„åœ
3. âœ… Viseme æ˜ å°„é‚è¼¯æ­£ç¢ºï¼ˆä¸åŒéŸ³é‡å°æ‡‰æ­£ç¢ºéŸ³ç´ ï¼‰
4. âœ… éŸ³è¨Šè¼‰å…¥èˆ‡è§£ç¢¼ç„¡éŒ¯èª¤
5. âœ… Viseme æ™‚é–“è»¸æ•¸æ“šçµæ§‹æ­£ç¢º
6. âœ… å–æ¨£é–“éš”ç¬¦åˆ 100ms è¦æ±‚
7. âœ… console.log è¼¸å‡ºæ¸…æ™°æ˜“è®€
8. âœ… ä¸»è§€è¦–è¦ºè©•ä¼°ï¼ˆStory 4.3 æ•´åˆå¾Œé€²è¡Œï¼‰

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# 1. ç·¨è­¯ TypeScript æª¢æŸ¥å‹åˆ¥éŒ¯èª¤
pnpm build

# 2. åŸ·è¡Œæ¸¬è©¦è…³æœ¬
pnpm tsx scripts/test/test-lipsync-analysis.ts

# é æœŸè¼¸å‡ºï¼š
# === Lip Sync Audio Analysis Test ===
#
# ğŸ“‚ Loading test audio...
# [LipSync] Loading audio from: /test-audio/sample.mp3
# [LipSync] Audio loaded successfully: { duration: 3.24s, sampleRate: 22050, channels: 1 }
# [LipSync] Generated viseme timeline: { totalDataPoints: 32, duration: 3.20s, sampleInterval: 100ms }
#
# âœ… Viseme Timeline Generated:
#    Total data points: 32
#    Duration: 3.20s
#    Sample interval: 100ms
#
# ğŸ“Š First 10 Viseme Data Points:
#    [0] time: 0.00s, viseme: neutral, weight: 0.00
#    [1] time: 0.10s, viseme: E,       weight: 0.42
#    [2] time: 0.20s, viseme: aa,      weight: 0.78
#    ...
#
# ğŸ“ˆ Viseme Distribution:
#    neutral: 15 (46.9%)
#    E:       10 (31.2%)
#    aa:       7 (21.9%)
#
# âœ… Test completed successfully!
# ğŸ‘ï¸  Please manually verify the viseme timeline matches audio content.
```

**é©—è­‰æ¸…å–®**:
- [ ] TypeScript ç·¨è­¯ç„¡éŒ¯èª¤ï¼ˆ`pnpm build`ï¼‰
- [ ] æ¸¬è©¦è…³æœ¬æ­£å¸¸åŸ·è¡Œç„¡å´©æ½°
- [ ] Viseme æ™‚é–“è»¸æ•¸æ“šé»æ•¸é‡æ­£ç¢ºï¼ˆduration / 0.1ï¼‰
- [ ] Viseme é¡å‹åˆ†å¸ƒåˆç†ï¼ˆneutral, E, aa éƒ½æœ‰å‡ºç¾ï¼‰
- [ ] éŸ³é‡æ˜ å°„é‚è¼¯æ­£ç¢ºï¼ˆé«˜éŸ³é‡ â†’ aa, ä¸­éŸ³é‡ â†’ Eï¼‰
- [ ] console.log è¼¸å‡ºæ¸…æ™°ä¸”è³‡è¨Šå®Œæ•´
- [ ] å¯åŒ¯å…¥ä¸¦ä½¿ç”¨ `generateVisemeTimeline` å‡½å¼
- [ ] å‹åˆ¥å®šç¾©å¯æ­£ç¢ºå°å…¥ï¼ˆ`import type { VisemeData } from '@/types'`ï¼‰

### æ•ˆèƒ½è€ƒé‡

**è¨˜æ†¶é«”ä½¿ç”¨**:
- **AudioBuffer**: æ¯ç§’éŸ³è¨Šç´„ 44KBï¼ˆ22050Hz, Mono, 16-bitï¼‰
- **VisemeData é™£åˆ—**: æ¯åˆ†é˜éŸ³è¨Šç´„ 600 å€‹æ•¸æ“šé» Ã— 24 bytes â‰ˆ 14.4 KB
- **ç¸½è¨˜æ†¶é«”**: 1 åˆ†é˜éŸ³è¨Š < 3 MBï¼ˆAudioBuffer + Viseme Dataï¼‰
- âœ… å¯æ¥å—ç¯„åœï¼ˆPOC ç›®æ¨™ < 500 MB ç¸½è¨˜æ†¶é«”ï¼‰

**åˆ†ææ•ˆèƒ½**:
- **é›¢ç·šåˆ†ææ™‚é–“**: 3 ç§’éŸ³è¨Šç´„éœ€ 50-100ms åˆ†ææ™‚é–“
- **ç“¶é ¸**: `decodeAudioData` è§£ç¢¼æ™‚é–“ï¼ˆç´„ä½” 80%ï¼‰
- **å„ªåŒ–ç­–ç•¥**:
  - ä½¿ç”¨ä½ä½å…ƒç‡ TTS éŸ³è¨Šï¼ˆ16kbps MP3ï¼‰æ¸›å°‘è§£ç¢¼æ™‚é–“
  - å¿«å–å·²åˆ†æçš„ viseme æ™‚é–“è»¸ï¼ˆé¿å…é‡è¤‡åˆ†æï¼‰

**æœªä¾†å„ªåŒ–æ–¹å‘**ï¼ˆMVP éšæ®µï¼‰:
1. **Web Worker åˆ†æ**: å°‡éŸ³è¨Šåˆ†æç§»è‡³ Worker é¿å…é˜»å¡ä¸»åŸ·è¡Œç·’
2. **éŸ³è¨Šå¿«å–**: localStorage å¿«å–å¸¸ç”¨èªå¥çš„ viseme æ•¸æ“š
3. **å‹•æ…‹å–æ¨£**: æ ¹æ“šèªé€Ÿè‡ªå‹•èª¿æ•´å–æ¨£é–“éš”ï¼ˆå¿«é€ŸèªéŸ³ 50ms, æ…¢é€Ÿ 150msï¼‰
4. **GPU åŠ é€Ÿ**: ä½¿ç”¨ WebGL Shader åŠ é€ŸéŸ³é‡è¨ˆç®—ï¼ˆå¯¦é©—æ€§ï¼‰

### å®‰å…¨æ€§è€ƒé‡

**éŸ³è¨Šä¾†æºé©—è­‰**:
- âœ… åƒ…æ¥å—å…§éƒ¨ TTS API ç”¢ç”Ÿçš„éŸ³è¨Šï¼ˆ/api/tts è¿”å›ï¼‰
- âš ï¸ è‹¥é–‹æ”¾å¤–éƒ¨ URLï¼Œéœ€æª¢æŸ¥ CORS èˆ‡å…§å®¹å®‰å…¨ç­–ç•¥
- âœ… ä½¿ç”¨ `try-catch` æ•æ‰è¼‰å…¥éŒ¯èª¤ï¼Œé¿å…å´©æ½°

**è³‡æºé‡‹æ”¾**:
```typescript
// AudioContext éœ€æ‰‹å‹•é—œé–‰é¿å…è¨˜æ†¶é«”æ´©æ¼
export class AudioAnalyser {
  // ... existing code ...

  /**
   * é‡‹æ”¾ AudioContext è³‡æº
   * ä½¿ç”¨å®Œç•¢å¾Œå¿…é ˆå‘¼å«æ­¤æ–¹æ³•
   */
  dispose(): void {
    this.audioContext.close();
    console.log('[LipSync] AudioContext disposed');
  }
}
```

**éŒ¯èª¤è™•ç†**:
- âœ… æ‰€æœ‰ async å‡½å¼ä½¿ç”¨ try-catch
- âœ… è¼‰å…¥å¤±æ•—æ™‚æ‹‹å‡ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯
- âœ… console.error è¨˜éŒ„éŒ¯èª¤è©³æƒ…ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
- ğŸ”„ Story 4.5 å°‡å¯¦ä½œé™ç´šæ–¹æ¡ˆï¼ˆåˆ†æå¤±æ•—æ™‚è·³é Lip Syncï¼‰

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 1.1 å·²å®Œæˆï¼ˆNext.js å°ˆæ¡ˆå·²å»ºç«‹ï¼‰
- âœ… Story 3.5 å·²å®Œæˆï¼ˆTTS API å¯ç”¢ç”ŸéŸ³è¨Šæª”ï¼‰
- âœ… Story 3.6 å·²å®Œæˆï¼ˆWeb Audio API éŸ³è¨Šæ’­æ”¾ï¼‰
- âœ… TypeScript èˆ‡ ESLint å·²é…ç½®

**å¾ŒçºŒ Story ä¾è³´**:
- **Story 4.2**: æœƒä½¿ç”¨æœ¬ Story çš„ VisemeData å‹åˆ¥å®šç¾©
- **Story 4.3**: æœƒä½¿ç”¨ `generateVisemeTimeline` å‡½å¼ç”¢ç”Ÿæ•¸æ“š
- **Story 4.4**: æœƒèª¿æ•´æœ¬ Story çš„éŸ³é‡é–¾å€¼èˆ‡æ˜ å°„é‚è¼¯
- **Story 4.5**: æœƒç‚ºæœ¬ Story åŠ å…¥éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ

**é—œéµè·¯å¾‘**:
- æœ¬ Story æ˜¯ Epic 4 çš„åŸºç¤ï¼Œå¿…é ˆå„ªå…ˆå®Œæˆ
- Story 4.2ï¼ˆBlendshape æ§åˆ¶ï¼‰ä¾è³´æœ¬ Story çš„ Viseme å‹åˆ¥
- Story 4.3ï¼ˆLip Sync Controllerï¼‰ä¾è³´æœ¬ Story çš„åˆ†æå‡½å¼

**èˆ‡ Epic 3 æ•´åˆ**:
- æœ¬ Story ä½¿ç”¨ Epic 3 çš„ TTS API ç”¢ç”Ÿçš„éŸ³è¨Š
- audioStoreï¼ˆEpic 3ï¼‰æœªä¾†æœƒåŠ å…¥ visemes ç‹€æ…‹ï¼ˆStory 4.3ï¼‰
- å®Œæ•´æµç¨‹ï¼šChat API â†’ TTS API â†’ éŸ³è¨Šåˆ†æ â†’ Viseme æ•¸æ“š â†’ Avatar å˜´å‹

**å¤–éƒ¨ä¾è³´**:
- **Web Audio API**: ç€è¦½å™¨åŸç”Ÿ APIï¼ˆChrome/Edge/Safari æ”¯æ´ï¼‰
- **TypeScript**: å‹åˆ¥å®šç¾©èˆ‡ç·¨è­¯æª¢æŸ¥
- **ç„¡å¤–éƒ¨å¥—ä»¶**: æœ¬ Story ä¸å¼•å…¥ä»»ä½• npm å¥—ä»¶ï¼ˆä½¿ç”¨åŸç”Ÿ APIï¼‰

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 4.1 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
