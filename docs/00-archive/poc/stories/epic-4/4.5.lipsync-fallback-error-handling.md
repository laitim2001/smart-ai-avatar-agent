# Story 4.5: Lip Sync é™ç´šæ–¹æ¡ˆèˆ‡éŒ¯èª¤è™•ç†

## Status
Draft

---

## Story

**As a** é–‹ç™¼è€…,
**I want** ç•¶ Lip Sync å¤±æ•—æ™‚æœ‰å„ªé›…çš„é™ç´šæ–¹æ¡ˆ,
**so that** ä½¿ç”¨è€…ä»å¯æ­£å¸¸ä½¿ç”¨å°è©±åŠŸèƒ½ï¼ˆåƒ…ç„¡å˜´å‹ï¼‰ã€‚

---

## Acceptance Criteria

1. æ•æ‰ Lip Sync åˆ†æéŒ¯èª¤ï¼ˆå¦‚ï¼šéŸ³è¨Šæ ¼å¼ä¸æ”¯æ´ï¼‰
2. éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼šConsole è¨˜éŒ„éŒ¯èª¤ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰ã€éŸ³è¨Šæ­£å¸¸æ’­æ”¾ä½†ä¸é©…å‹•å˜´å‹ã€Avatar ä¿æŒå¾®ç¬‘è¡¨æƒ…ï¼ˆfallbackï¼‰
3. ä½¿ç”¨è€…ç„¡æ„ŸçŸ¥å´©æ½°ï¼Œå°è©±ç¹¼çºŒ
4. æä¾›è¨­å®šé¸é …ï¼šã€Œé—œé–‰ Lip Syncã€ï¼ˆç¯€çœæ•ˆèƒ½ï¼‰
5. æ¸¬è©¦ï¼šæ•…æ„å‚³å…¥éŒ¯èª¤éŸ³è¨Šï¼Œç³»çµ±ä¸å´©æ½°ï¼Œåƒ…è·³éå˜´å‹

---

## Tasks / Subtasks

- [ ] **Task 1: å»ºç«‹éŒ¯èª¤è™•ç†é¡å‹å®šç¾©** (AC: 1)
  - [ ] æ›´æ–° `types/lipsync.ts` åŠ å…¥éŒ¯èª¤é¡å‹
  - [ ] å®šç¾© Lip Sync éŒ¯èª¤é¡å‹ï¼š
    ```typescript
    /**
     * Lip Sync éŒ¯èª¤é¡å‹
     */
    export enum LipSyncErrorType {
      /** éŸ³è¨Šè¼‰å…¥å¤±æ•— */
      AUDIO_LOAD_FAILED = 'AUDIO_LOAD_FAILED',
      /** éŸ³è¨Šè§£ç¢¼å¤±æ•— */
      AUDIO_DECODE_FAILED = 'AUDIO_DECODE_FAILED',
      /** éŸ³è¨Šåˆ†æå¤±æ•— */
      AUDIO_ANALYSIS_FAILED = 'AUDIO_ANALYSIS_FAILED',
      /** Blendshape åˆå§‹åŒ–å¤±æ•— */
      BLENDSHAPE_INIT_FAILED = 'BLENDSHAPE_INIT_FAILED',
      /** Blendshape æ‡‰ç”¨å¤±æ•— */
      BLENDSHAPE_APPLY_FAILED = 'BLENDSHAPE_APPLY_FAILED',
      /** æœªçŸ¥éŒ¯èª¤ */
      UNKNOWN_ERROR = 'UNKNOWN_ERROR'
    }

    /**
     * Lip Sync éŒ¯èª¤è©³æƒ…
     */
    export interface LipSyncError {
      /** éŒ¯èª¤é¡å‹ */
      type: LipSyncErrorType;
      /** éŒ¯èª¤è¨Šæ¯ */
      message: string;
      /** åŸå§‹éŒ¯èª¤ç‰©ä»¶ */
      originalError?: Error;
      /** éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“ */
      timestamp: Date;
      /** æ˜¯å¦ç‚ºè‡´å‘½éŒ¯èª¤ï¼ˆéœ€å®Œå…¨é™ç´šï¼‰ */
      isFatal: boolean;
    }

    /**
     * Lip Sync é…ç½®ï¼ˆå«éŒ¯èª¤è™•ç†é¸é …ï¼‰
     */
    export interface LipSyncConfig {
      /** æ˜¯å¦å•Ÿç”¨ Lip Sync */
      enabled: boolean;
      /** éŒ¯èª¤æ™‚æ˜¯å¦è‡ªå‹•é™ç´š */
      autoFallback: boolean;
      /** é™ç´šæ™‚çš„ Avatar è¡¨æƒ… */
      fallbackExpression: VisemeType;
      /** æ˜¯å¦åœ¨ console è¨˜éŒ„éŒ¯èª¤ */
      logErrors: boolean;
      /** éŒ¯èª¤å›èª¿å‡½å¼ */
      onError?: (error: LipSyncError) => void;
    }

    /**
     * é è¨­ Lip Sync é…ç½®
     */
    export const DEFAULT_LIPSYNC_CONFIG: LipSyncConfig = {
      enabled: true,
      autoFallback: true,
      fallbackExpression: 'neutral', // é è¨­é–‰å˜´
      logErrors: true,
      onError: undefined
    };
    ```
  - [ ] åŠ å…¥ JSDoc è¨»è§£èªªæ˜éŒ¯èª¤è™•ç†ç­–ç•¥
  - [ ] é©—è­‰å‹åˆ¥å®šç¾©ç„¡ TypeScript éŒ¯èª¤

- [ ] **Task 2: æ›´æ–° AudioAnalyser åŠ å…¥éŒ¯èª¤è™•ç†** (AC: 1, 2)
  - [ ] é–‹å•Ÿ `lib/three/lipsync.ts`
  - [ ] åŒ…è£æ‰€æœ‰å¯èƒ½å¤±æ•—çš„æ“ä½œï¼š
    ```typescript
    import { LipSyncErrorType, type LipSyncError } from '@/types/lipsync';

    export class AudioAnalyser {
      // ... existing code ...

      /**
       * å¾ URL è¼‰å…¥éŸ³è¨Šä¸¦è§£ç¢¼ï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
       */
      async loadAudioFromUrl(audioUrl: string): Promise<AudioBuffer> {
        try {
          console.log('[LipSync] Loading audio from:', audioUrl);

          const response = await fetch(audioUrl);
          if (!response.ok) {
            throw this.createError(
              LipSyncErrorType.AUDIO_LOAD_FAILED,
              `Failed to fetch audio: ${response.statusText}`,
              true
            );
          }

          const arrayBuffer = await response.arrayBuffer();

          try {
            const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
            console.log('[LipSync] Audio loaded successfully');
            return audioBuffer;

          } catch (decodeError) {
            throw this.createError(
              LipSyncErrorType.AUDIO_DECODE_FAILED,
              'Failed to decode audio data (unsupported format?)',
              true,
              decodeError as Error
            );
          }

        } catch (error) {
          // é‡æ–°æ‹‹å‡ºå·²è™•ç†çš„éŒ¯èª¤
          if (this.isLipSyncError(error)) {
            throw error;
          }

          // è™•ç†æœªé æœŸçš„éŒ¯èª¤
          throw this.createError(
            LipSyncErrorType.UNKNOWN_ERROR,
            `Unexpected error: ${(error as Error).message}`,
            true,
            error as Error
          );
        }
      }

      /**
       * åˆ†æéŸ³è¨Šç·©è¡å€ï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
       */
      async analyseAudioBuffer(audioBuffer: AudioBuffer): Promise<VisemeData[]> {
        try {
          // ... existing analysis logic ...
          return visemeTimeline;

        } catch (error) {
          throw this.createError(
            LipSyncErrorType.AUDIO_ANALYSIS_FAILED,
            `Failed to analyse audio: ${(error as Error).message}`,
            false, // éè‡´å‘½ï¼Œå¯é™ç´š
            error as Error
          );
        }
      }

      /**
       * å»ºç«‹ Lip Sync éŒ¯èª¤ç‰©ä»¶
       */
      private createError(
        type: LipSyncErrorType,
        message: string,
        isFatal: boolean,
        originalError?: Error
      ): LipSyncError {
        return {
          type,
          message,
          originalError,
          timestamp: new Date(),
          isFatal
        };
      }

      /**
       * æª¢æŸ¥æ˜¯å¦ç‚º Lip Sync éŒ¯èª¤
       */
      private isLipSyncError(error: unknown): error is LipSyncError {
        return (
          typeof error === 'object' &&
          error !== null &&
          'type' in error &&
          'message' in error &&
          'isFatal' in error
        );
      }
    }
    ```
  - [ ] åŠ å…¥éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
  - [ ] æ¸¬è©¦éŒ¯èª¤æ‹‹å‡ºèˆ‡æ•æ‰æ©Ÿåˆ¶

- [ ] **Task 3: æ›´æ–° BlendshapeController åŠ å…¥éŒ¯èª¤è™•ç†** (AC: 2)
  - [ ] é–‹å•Ÿ `lib/three/blendshape-controller.ts`
  - [ ] åŠ å…¥å®‰å…¨æª¢æŸ¥èˆ‡éŒ¯èª¤è™•ç†ï¼š
    ```typescript
    export class BlendshapeController {
      // ... existing code ...

      /**
       * åˆå§‹åŒ–æ§åˆ¶å™¨ï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
       */
      initialize(avatarMesh: THREE.SkinnedMesh): boolean {
        try {
          if (!avatarMesh) {
            throw this.createError(
              LipSyncErrorType.BLENDSHAPE_INIT_FAILED,
              'Avatar mesh is null or undefined',
              true
            );
          }

          if (!avatarMesh.morphTargetDictionary || !avatarMesh.morphTargetInfluences) {
            throw this.createError(
              LipSyncErrorType.BLENDSHAPE_INIT_FAILED,
              'Avatar mesh does not have morph targets',
              true
            );
          }

          this.mesh = avatarMesh;
          this.morphTargetDictionary = avatarMesh.morphTargetDictionary;
          this.morphTargetInfluences = avatarMesh.morphTargetInfluences;

          console.log('[BlendshapeController] Initialized successfully');
          return true;

        } catch (error) {
          console.error('[BlendshapeController] Initialization failed:', error);
          return false;
        }
      }

      /**
       * æ‡‰ç”¨ Visemeï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
       */
      applySmoothVisemeWithEasing(
        viseme: VisemeType,
        targetWeight: number,
        transitionDuration: number = 50
      ): void {
        try {
          if (!this.mesh || !this.morphTargetDictionary || !this.morphTargetInfluences) {
            throw this.createError(
              LipSyncErrorType.BLENDSHAPE_APPLY_FAILED,
              'Controller not initialized',
              false
            );
          }

          // ... existing viseme application logic ...

        } catch (error) {
          // éœé»˜å¤±æ•—ï¼Œä¸ä¸­æ–·å‹•ç•«å¾ªç’°
          console.warn('[BlendshapeController] Failed to apply viseme:', error);
        }
      }

      /**
       * å»ºç«‹ Lip Sync éŒ¯èª¤ç‰©ä»¶ï¼ˆèˆ‡ AudioAnalyser ç›¸åŒï¼‰
       */
      private createError(
        type: LipSyncErrorType,
        message: string,
        isFatal: boolean
      ): LipSyncError {
        return {
          type,
          message,
          timestamp: new Date(),
          isFatal
        };
      }
    }
    ```
  - [ ] æ¸¬è©¦ blendshape éŒ¯èª¤è™•ç†é‚è¼¯

- [ ] **Task 4: æ›´æ–° LipSyncController å¯¦ä½œé™ç´šæ–¹æ¡ˆ** (AC: 2, 3)
  - [ ] é–‹å•Ÿ `components/avatar/LipSyncController.tsx`
  - [ ] åŠ å…¥é™ç´šç‹€æ…‹ç®¡ç†ï¼š
    ```typescript
    import { DEFAULT_LIPSYNC_CONFIG, type LipSyncConfig, type LipSyncError } from '@/types/lipsync';

    interface LipSyncControllerProps {
      avatarMeshRef: React.MutableRefObject<THREE.SkinnedMesh | null>;
      enabled?: boolean;
      config?: Partial<LipSyncConfig>; // æ–°å¢é…ç½®é¸é …
    }

    export default function LipSyncController({
      avatarMeshRef,
      enabled = true,
      config: userConfig = {}
    }: LipSyncControllerProps) {
      const config = { ...DEFAULT_LIPSYNC_CONFIG, ...userConfig };

      // é™ç´šç‹€æ…‹ï¼ˆç•¶éŒ¯èª¤ç™¼ç”Ÿæ™‚è¨­ç‚º trueï¼‰
      const [isFallbackMode, setIsFallbackMode] = useState(false);

      const {
        applyVisemeWithEasing,
        updateTransitions,
        initializeController,
        applyViseme
      } = useBlendshapeController();

      // ... existing code ...

      // éŒ¯èª¤è™•ç†å‡½å¼
      const handleLipSyncError = useCallback((error: LipSyncError) => {
        if (config.logErrors) {
          console.error('[LipSyncController] Error occurred:', {
            type: error.type,
            message: error.message,
            timestamp: error.timestamp,
            isFatal: error.isFatal
          });
        }

        // å‘¼å«ä½¿ç”¨è€…æä¾›çš„éŒ¯èª¤å›èª¿
        config.onError?.(error);

        // è‹¥ç‚ºè‡´å‘½éŒ¯èª¤ï¼Œå•Ÿç”¨é™ç´šæ¨¡å¼
        if (error.isFatal && config.autoFallback) {
          console.warn('[LipSyncController] Entering fallback mode (Lip Sync disabled)');
          setIsFallbackMode(true);

          // è¨­å®š Avatar ç‚ºé™ç´šè¡¨æƒ…ï¼ˆé è¨­ neutralï¼‰
          applyViseme(config.fallbackExpression, 0.2); // å¾®ç¬‘ï¼ˆweight 0.2ï¼‰
        }

      }, [config, applyViseme]);

      // åˆå§‹åŒ–ï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
      useEffect(() => {
        if (avatarMeshRef.current && enabled && !isFallbackMode) {
          const success = initializeController(avatarMeshRef.current);

          if (!success) {
            handleLipSyncError({
              type: LipSyncErrorType.BLENDSHAPE_INIT_FAILED,
              message: 'Failed to initialize blendshape controller',
              timestamp: new Date(),
              isFatal: true
            });
          }
        }
      }, [avatarMeshRef, enabled, isFallbackMode, initializeController, handleLipSyncError]);

      // æ¯å¹€æ›´æ–°é‚è¼¯ï¼ˆå«é™ç´šæª¢æŸ¥ï¼‰
      useFrame(() => {
        if (!enabled || isFallbackMode) {
          return; // é™ç´šæ¨¡å¼ä¸‹ä¸åŸ·è¡Œ Lip Sync
        }

        try {
          // 1. æ›´æ–° Easing éæ¸¡å‹•ç•«
          updateTransitions();

          // 2. Lip Sync åŒæ­¥é‚è¼¯
          if (isPlaying && audioContext && visemeTimeline.length > 0) {
            const currentPlaybackTime = audioContext.currentTime - playbackStartTime;
            const viseme = findVisemeAtTime(visemeTimeline, currentPlaybackTime, currentIndexRef.current);

            if (viseme) {
              applyVisemeWithEasing(viseme.viseme, viseme.weight, 50);

              const newIndex = visemeTimeline.findIndex(v => v === viseme);
              if (newIndex !== -1) {
                currentIndexRef.current = newIndex;
              }
            }
          }

        } catch (error) {
          handleLipSyncError({
            type: LipSyncErrorType.BLENDSHAPE_APPLY_FAILED,
            message: `Failed to apply lip sync: ${(error as Error).message}`,
            originalError: error as Error,
            timestamp: new Date(),
            isFatal: false // éè‡´å‘½ï¼Œä¸‹ä¸€å¹€ç¹¼çºŒå˜—è©¦
          });
        }
      });

      return null;
    }
    ```
  - [ ] æ¸¬è©¦é™ç´šæ¨¡å¼è§¸ç™¼èˆ‡æ¢å¾©

- [ ] **Task 5: æ›´æ–° playTTSWithLipSync åŠ å…¥éŒ¯èª¤è™•ç†** (AC: 1, 2, 3)
  - [ ] é–‹å•Ÿ `lib/api/chat.ts`
  - [ ] åŒ…è£ Viseme åˆ†æéŒ¯èª¤è™•ç†ï¼š
    ```typescript
    export async function playTTSWithLipSync(text: string) {
      try {
        console.log('[TTS] Generating speech...', text);

        // 1. å‘¼å« TTS API
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!response.ok) {
          throw new Error('TTS API failed');
        }

        // 2. å–å¾—éŸ³è¨Š Blob
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        // 3. åˆ†æéŸ³è¨Šç”¢ç”Ÿ Viseme æ™‚é–“è»¸ï¼ˆå«éŒ¯èª¤è™•ç†ï¼‰
        let visemeTimeline: VisemeData[] = [];
        let lipSyncEnabled = true;

        try {
          console.log('[TTS] Analysing audio for visemes...');
          visemeTimeline = await generateVisemeTimeline(audioUrl);

          console.log('[TTS] Viseme timeline generated:', {
            dataPoints: visemeTimeline.length
          });

        } catch (error) {
          console.warn('[TTS] Viseme analysis failed, playing audio only:', error);
          lipSyncEnabled = false; // é™ç´šï¼šåƒ…æ’­æ”¾éŸ³è¨Šï¼Œç„¡ Lip Sync

          // è¨­å®šç©ºçš„ viseme æ™‚é–“è»¸ï¼ˆLipSyncController æœƒé€²å…¥é™ç´šæ¨¡å¼ï¼‰
          visemeTimeline = [];
        }

        // 4. å°‡ Viseme æ™‚é–“è»¸å„²å­˜åˆ° audioStoreï¼ˆå³ä½¿ç‚ºç©ºé™£åˆ—ï¼‰
        useAudioStore.getState().setVisemeTimeline(visemeTimeline);

        // 5. è¼‰å…¥ä¸¦æ’­æ”¾éŸ³è¨Šï¼ˆç„¡è«– Lip Sync æ˜¯å¦æˆåŠŸï¼‰
        const audioContext = new AudioContext();
        const arrayBuffer = await audioBlob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // 6. æ’­æ”¾éŸ³è¨Š
        useAudioStore.getState().playAudio(audioBuffer);

        if (lipSyncEnabled) {
          console.log('[TTS] Playback started with Lip Sync');
        } else {
          console.log('[TTS] Playback started (Lip Sync disabled due to error)');
        }

      } catch (error) {
        console.error('[TTS] Failed to play TTS:', error);

        // TTS å®Œå…¨å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤ä¾›ä¸Šå±¤è™•ç†
        throw error;
      }
    }
    ```
  - [ ] æ¸¬è©¦ Viseme åˆ†æå¤±æ•—æ™‚çš„é™ç´šè¡Œç‚º

- [ ] **Task 6: å»ºç«‹ Lip Sync è¨­å®š UI** (AC: 4)
  - [ ] å»ºç«‹ `components/settings/LipSyncSettings.tsx` è¨­å®šçµ„ä»¶
  - [ ] å¯¦ä½œè¨­å®šä»‹é¢ï¼š
    ```typescript
    'use client';

    import { useState } from 'react';
    import { DEFAULT_LIPSYNC_CONFIG, type LipSyncConfig } from '@/types/lipsync';

    interface LipSyncSettingsProps {
      initialConfig?: Partial<LipSyncConfig>;
      onChange?: (config: LipSyncConfig) => void;
    }

    export default function LipSyncSettings({
      initialConfig = {},
      onChange
    }: LipSyncSettingsProps) {
      const [config, setConfig] = useState<LipSyncConfig>({
        ...DEFAULT_LIPSYNC_CONFIG,
        ...initialConfig
      });

      const handleToggle = (key: keyof LipSyncConfig) => {
        const newConfig = { ...config, [key]: !config[key] };
        setConfig(newConfig);
        onChange?.(newConfig);
      };

      return (
        <div className="bg-white rounded-lg shadow p-6 space-y-4">
          <h3 className="text-lg font-semibold text-gray-900">
            Lip Sync è¨­å®š
          </h3>

          {/* å•Ÿç”¨/é—œé–‰ Lip Sync */}
          <div className="flex items-center justify-between">
            <div>
              <label className="text-sm font-medium text-gray-700">
                å•Ÿç”¨ Lip Sync
              </label>
              <p className="text-xs text-gray-500">
                é—œé–‰ä»¥ç¯€çœæ•ˆèƒ½ï¼ˆAvatar ä¿æŒå¾®ç¬‘ï¼‰
              </p>
            </div>
            <button
              onClick={() => handleToggle('enabled')}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                config.enabled ? 'bg-blue-600' : 'bg-gray-200'
              }`}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                  config.enabled ? 'translate-x-6' : 'translate-x-1'
                }`}
              />
            </button>
          </div>

          {/* è‡ªå‹•é™ç´š */}
          <div className="flex items-center justify-between">
            <div>
              <label className="text-sm font-medium text-gray-700">
                è‡ªå‹•é™ç´š
              </label>
              <p className="text-xs text-gray-500">
                éŒ¯èª¤ç™¼ç”Ÿæ™‚è‡ªå‹•é—œé–‰ Lip Sync
              </p>
            </div>
            <button
              onClick={() => handleToggle('autoFallback')}
              disabled={!config.enabled}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                config.autoFallback && config.enabled
                  ? 'bg-blue-600'
                  : 'bg-gray-200'
              } ${!config.enabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                  config.autoFallback && config.enabled ? 'translate-x-6' : 'translate-x-1'
                }`}
              />
            </button>
          </div>

          {/* Debug æ—¥èªŒ */}
          <div className="flex items-center justify-between">
            <div>
              <label className="text-sm font-medium text-gray-700">
                Console éŒ¯èª¤æ—¥èªŒ
              </label>
              <p className="text-xs text-gray-500">
                åœ¨ Console é¡¯ç¤º Lip Sync éŒ¯èª¤ï¼ˆé–‹ç™¼ç”¨ï¼‰
              </p>
            </div>
            <button
              onClick={() => handleToggle('logErrors')}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                config.logErrors ? 'bg-blue-600' : 'bg-gray-200'
              }`}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                  config.logErrors ? 'translate-x-6' : 'translate-x-1'
                }`}
              />
            </button>
          </div>

          {/* ç•¶å‰ç‹€æ…‹é¡¯ç¤º */}
          <div className="mt-6 pt-4 border-t border-gray-200">
            <div className="text-sm text-gray-600 space-y-1">
              <p>
                ç‹€æ…‹: <span className={`font-medium ${config.enabled ? 'text-green-600' : 'text-gray-400'}`}>
                  {config.enabled ? 'âœ“ å•Ÿç”¨' : 'âœ— é—œé–‰'}
                </span>
              </p>
              <p className="text-xs text-gray-500">
                é—œé–‰ Lip Sync å¯æ¸›å°‘ CPU ä½¿ç”¨ç´„ 5%
              </p>
            </div>
          </div>
        </div>
      );
    }
    ```
  - [ ] æ•´åˆåˆ°ä¸»é é¢æˆ–è¨­å®šé é¢
  - [ ] æ¸¬è©¦è¨­å®šè®Šæ›´ç«‹å³ç”Ÿæ•ˆ

- [ ] **Task 7: å»ºç«‹éŒ¯èª¤æ¸¬è©¦å·¥å…·** (AC: 5)
  - [ ] å»ºç«‹ `scripts/test/test-lipsync-errors.ts` éŒ¯èª¤æ¸¬è©¦è…³æœ¬
  - [ ] å¯¦ä½œéŒ¯èª¤æ¨¡æ“¬ï¼š
    ```typescript
    /**
     * Lip Sync éŒ¯èª¤è™•ç†æ¸¬è©¦è…³æœ¬
     * ç”¨æ–¼é©—è­‰é™ç´šæ–¹æ¡ˆæ˜¯å¦æ­£å¸¸é‹ä½œ
     */

    import { generateVisemeTimeline } from '@/lib/three/lipsync';

    async function testLipSyncErrorHandling() {
      console.log('=== Lip Sync Error Handling Test ===\n');

      // æ¸¬è©¦ 1ï¼šéŒ¯èª¤çš„éŸ³è¨Š URL
      console.log('Test 1: Invalid audio URL');
      try {
        await generateVisemeTimeline('https://invalid-url.com/audio.mp3');
        console.log('âŒ FAIL: Should have thrown error');
      } catch (error) {
        console.log('âœ… PASS: Error caught:', error);
      }

      // æ¸¬è©¦ 2ï¼šä¸æ”¯æ´çš„éŸ³è¨Šæ ¼å¼
      console.log('\nTest 2: Unsupported audio format');
      try {
        // æ¨¡æ“¬ä¸æ”¯æ´çš„æ ¼å¼ï¼ˆå¦‚ .wav æœªæ­£ç¢ºç·¨ç¢¼ï¼‰
        const invalidBlob = new Blob(['invalid audio data'], { type: 'audio/wav' });
        const invalidUrl = URL.createObjectURL(invalidBlob);

        await generateVisemeTimeline(invalidUrl);
        console.log('âŒ FAIL: Should have thrown error');
      } catch (error) {
        console.log('âœ… PASS: Error caught:', error);
      }

      // æ¸¬è©¦ 3ï¼šç©ºéŸ³è¨Šæª”æ¡ˆ
      console.log('\nTest 3: Empty audio file');
      try {
        const emptyBlob = new Blob([], { type: 'audio/mp3' });
        const emptyUrl = URL.createObjectURL(emptyBlob);

        await generateVisemeTimeline(emptyUrl);
        console.log('âŒ FAIL: Should have thrown error');
      } catch (error) {
        console.log('âœ… PASS: Error caught:', error);
      }

      console.log('\n=== All Error Tests Completed ===');
    }

    // åŸ·è¡Œæ¸¬è©¦
    testLipSyncErrorHandling();
    ```
  - [ ] åŸ·è¡Œæ¸¬è©¦è…³æœ¬ï¼š`pnpm tsx scripts/test/test-lipsync-errors.ts`
  - [ ] é©—è­‰æ‰€æœ‰éŒ¯èª¤æ­£ç¢ºæ‹‹å‡ºèˆ‡æ•æ‰

- [ ] **Task 8: ç«¯åˆ°ç«¯é™ç´šæ¸¬è©¦** (AC: 2, 3, 5)
  - [ ] æº–å‚™æ¸¬è©¦å ´æ™¯ï¼š
    ```bash
    # æ¸¬è©¦å ´æ™¯ 1ï¼šæ¨¡æ“¬ç¶²è·¯éŒ¯èª¤
    # æ–¹æ³•ï¼šä¿®æ”¹ TTS API è¿”å› 404

    # æ¸¬è©¦å ´æ™¯ 2ï¼šæ¨¡æ“¬éŸ³è¨Šè§£ç¢¼éŒ¯èª¤
    # æ–¹æ³•ï¼šå‚³å…¥æå£çš„éŸ³è¨Šæª”æ¡ˆ

    # æ¸¬è©¦å ´æ™¯ 3ï¼šæ¨¡æ“¬ Blendshape åˆå§‹åŒ–å¤±æ•—
    # æ–¹æ³•ï¼šä½¿ç”¨ç„¡ morph targets çš„ Avatar æ¨¡å‹
    ```
  - [ ] åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦ï¼š
    ```bash
    pnpm dev

    # æ¸¬è©¦æ­¥é©Ÿï¼š
    1. è§¸ç™¼éŒ¯èª¤ï¼ˆå¦‚ä¿®æ”¹ TTS APIï¼‰
    2. è§€å¯Ÿ Console éŒ¯èª¤æ—¥èªŒ
    3. ç¢ºèªéŸ³è¨Šä»æ­£å¸¸æ’­æ”¾
    4. ç¢ºèª Avatar ä¿æŒé™ç´šè¡¨æƒ…ï¼ˆneutral/å¾®ç¬‘ï¼‰
    5. ç¢ºèªå°è©±åŠŸèƒ½æœªä¸­æ–·
    6. ç¢ºèªç„¡é é¢å´©æ½°æˆ–ç™½å±
    ```
  - [ ] è¨˜éŒ„æ¸¬è©¦çµæœï¼š
    ```markdown
    # Lip Sync é™ç´šæ¸¬è©¦çµæœ

    ## æ¸¬è©¦å ´æ™¯ 1ï¼šç¶²è·¯éŒ¯èª¤
    - âœ… Console è¨˜éŒ„éŒ¯èª¤
    - âœ… éŸ³è¨Šæ­£å¸¸æ’­æ”¾ï¼ˆç„¡ Lip Syncï¼‰
    - âœ… Avatar ä¿æŒ neutral è¡¨æƒ…
    - âœ… å°è©±åŠŸèƒ½ç¹¼çºŒ

    ## æ¸¬è©¦å ´æ™¯ 2ï¼šéŸ³è¨Šè§£ç¢¼å¤±æ•—
    - âœ… Console è¨˜éŒ„éŒ¯èª¤
    - âœ… é™ç´šç‚ºç´”å°è©±ï¼ˆç„¡éŸ³è¨Šç„¡ Lip Syncï¼‰
    - âœ… ä½¿ç”¨è€…æ”¶åˆ°å‹å–„éŒ¯èª¤æç¤º

    ## æ¸¬è©¦å ´æ™¯ 3ï¼šBlendshape åˆå§‹åŒ–å¤±æ•—
    - âœ… Console è¨˜éŒ„éŒ¯èª¤
    - âœ… éŸ³è¨Šæ­£å¸¸æ’­æ”¾
    - âœ… Avatar éœæ­¢ï¼ˆç„¡ä»»ä½•å‹•ç•«ï¼‰
    - âœ… å°è©±åŠŸèƒ½ç¹¼çºŒ
    ```
  - [ ] é©—è­‰æ‰€æœ‰é™ç´šå ´æ™¯ä½¿ç”¨è€…é«”é©—ç„¡å´©æ½°

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

```
avatar-chat-poc/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ lipsync.ts                        # æ›´æ–°éŒ¯èª¤å‹åˆ¥ (æœ¬ Story)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ three/
â”‚   â”‚   â”œâ”€â”€ lipsync.ts                    # æ›´æ–°éŒ¯èª¤è™•ç† (æœ¬ Story)
â”‚   â”‚   â””â”€â”€ blendshape-controller.ts      # æ›´æ–°éŒ¯èª¤è™•ç† (æœ¬ Story)
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ chat.ts                       # æ›´æ–° TTS éŒ¯èª¤è™•ç† (æœ¬ Story)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â””â”€â”€ LipSyncController.tsx         # å¯¦ä½œé™ç´šæ–¹æ¡ˆ (æœ¬ Story)
â”‚   â””â”€â”€ settings/
â”‚       â””â”€â”€ LipSyncSettings.tsx           # è¨­å®š UI (æœ¬ Story)
â””â”€â”€ scripts/
    â””â”€â”€ test/
        â””â”€â”€ test-lipsync-errors.ts        # éŒ¯èª¤æ¸¬è©¦è…³æœ¬ (æœ¬ Story)
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**éŒ¯èª¤è™•ç†ç­–ç•¥**ï¼š

```typescript
// ä¸‰å±¤éŒ¯èª¤è™•ç†æ¶æ§‹

// Layer 1: åº•å±¤å‡½å¼ï¼ˆæ‹‹å‡º LipSyncErrorï¼‰
async function loadAudio(url) {
  if (invalid) {
    throw { type: 'AUDIO_LOAD_FAILED', isFatal: true };
  }
}

// Layer 2: æ•´åˆå‡½å¼ï¼ˆæ•æ‰ä¸¦é™ç´šï¼‰
async function playTTSWithLipSync(text) {
  try {
    visemes = await analyseAudio(audio);
  } catch (error) {
    console.warn('Viseme failed, playing audio only');
    visemes = []; // é™ç´š
  }
}

// Layer 3: UI çµ„ä»¶ï¼ˆé¡¯ç¤ºé™ç´šç‹€æ…‹ï¼‰
function LipSyncController() {
  if (isFallbackMode) {
    return; // è·³é Lip Sync é‚è¼¯
  }
}
```

**é™ç´šæ¨¡å¼é¡å‹**ï¼š

| éŒ¯èª¤é¡å‹ | é™ç´šç­–ç•¥ | ä½¿ç”¨è€…é«”é©— |
|---------|---------|-----------|
| éŸ³è¨Šè¼‰å…¥å¤±æ•— | é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ | ç„¡éŸ³è¨Šç„¡ Lip Sync |
| éŸ³è¨Šè§£ç¢¼å¤±æ•— | æ’­æ”¾å¤±æ•—æç¤º | åƒ…æ–‡å­—å°è©± |
| Viseme åˆ†æå¤±æ•— | æ’­æ”¾éŸ³è¨Š | æœ‰éŸ³è¨Šç„¡ Lip Sync |
| Blendshape åˆå§‹åŒ–å¤±æ•— | Avatar éœæ­¢ | æœ‰éŸ³è¨Šç„¡å‹•ç•« |
| Blendshape æ‡‰ç”¨å¤±æ•— | ç¹¼çºŒå˜—è©¦ | å¯èƒ½æœ‰æ–·æ–·çºŒçºŒçš„ Lip Sync |

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•éœ€è¦å¤šå±¤éŒ¯èª¤è™•ç†ï¼Ÿ**
   - âœ… å½ˆæ€§é™ç´šï¼šä¸åŒå±¤ç´šéŒ¯èª¤æœ‰ä¸åŒé™ç´šç­–ç•¥
   - âœ… ä½¿ç”¨è€…é«”é©—ï¼šç¢ºä¿éƒ¨åˆ†åŠŸèƒ½å¤±æ•—ä¸å½±éŸ¿æ•´é«”
   - âœ… Debug å‹å–„ï¼šæ¯å±¤è¨˜éŒ„éŒ¯èª¤ä¾¿æ–¼æ’æŸ¥
   - âœ… æ¼¸é€²å¼å¢å¼·ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆéŸ³è¨Šï¼‰å„ªå…ˆä¿è­‰

2. **ç‚ºä½•ä½¿ç”¨ isFatal æ¨™è¨˜ï¼Ÿ**
   - âœ… å€åˆ†åš´é‡æ€§ï¼šè‡´å‘½éŒ¯èª¤éœ€å®Œå…¨é™ç´šï¼Œéè‡´å‘½å¯é‡è©¦
   - âœ… è‡ªå‹•æ±ºç­–ï¼šç³»çµ±è‡ªå‹•åˆ¤æ–·æ˜¯å¦é€²å…¥é™ç´šæ¨¡å¼
   - âœ… å½ˆæ€§è™•ç†ï¼šé–‹ç™¼è€…å¯è‡ªè¨‚è‡´å‘½æ€§åˆ¤æ–·é‚è¼¯
   - ğŸ“Š ç¯„ä¾‹ï¼šéŸ³è¨Šè¼‰å…¥å¤±æ•—=è‡´å‘½ï¼Œå–®å¹€ blendshape å¤±æ•—=éè‡´å‘½

3. **ç‚ºä½•æä¾›æ‰‹å‹•é—œé–‰ Lip Sync é¸é …ï¼Ÿ**
   - âœ… æ•ˆèƒ½å„ªåŒ–ï¼šä½éšè£ç½®å¯é—œé–‰ç¯€çœ CPU
   - âœ… ä½¿ç”¨è€…é¸æ“‡ï¼šéƒ¨åˆ†ä½¿ç”¨è€…å¯èƒ½ä¸å–œæ­¡ Lip Sync
   - âœ… Debug å·¥å…·ï¼šé–‹ç™¼æ™‚å¯å¿«é€Ÿé—œé–‰æ’æŸ¥å•é¡Œ
   - âœ… é™ç´šé è¦½ï¼šæ¸¬è©¦é™ç´šæ¨¡å¼ UI

### Testing

**æ¸¬è©¦æ¡†æ¶**: æ‰‹å‹•éŒ¯èª¤æ¨¡æ“¬æ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
1. âœ… éŸ³è¨Šè¼‰å…¥éŒ¯èª¤æ•æ‰
2. âœ… éŸ³è¨Šè§£ç¢¼éŒ¯èª¤æ•æ‰
3. âœ… Viseme åˆ†æéŒ¯èª¤æ•æ‰
4. âœ… Blendshape åˆå§‹åŒ–éŒ¯èª¤æ•æ‰
5. âœ… é™ç´šæ¨¡å¼è‡ªå‹•å•Ÿç”¨
6. âœ… ä½¿ç”¨è€…é«”é©—ç„¡å´©æ½°

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# 1. å–®å…ƒæ¸¬è©¦ï¼ˆéŒ¯èª¤æ‹‹å‡ºï¼‰
pnpm tsx scripts/test/test-lipsync-errors.ts

# 2. ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆé™ç´šè¡Œç‚ºï¼‰
pnpm dev
# æ‰‹å‹•è§¸ç™¼å„ç¨®éŒ¯èª¤å ´æ™¯
# é©—è­‰é™ç´šè¡Œç‚ºç¬¦åˆé æœŸ

# 3. è¨­å®š UI æ¸¬è©¦
# åˆ‡æ› Lip Sync é–‹é—œ
# é©—è­‰ç«‹å³ç”Ÿæ•ˆ
```

**é©—è­‰æ¸…å–®**:
- [ ] æ‰€æœ‰éŒ¯èª¤é¡å‹æ­£ç¢ºæ‹‹å‡º
- [ ] éŒ¯èª¤æ—¥èªŒæ¸…æ™°æ˜“æ‡‚
- [ ] é™ç´šæ¨¡å¼æ­£ç¢ºè§¸ç™¼
- [ ] éŸ³è¨Šæ’­æ”¾ä¸å—å½±éŸ¿
- [ ] Avatar ä¿æŒé™ç´šè¡¨æƒ…
- [ ] å°è©±åŠŸèƒ½ç¹¼çºŒé‹ä½œ
- [ ] ç„¡é é¢å´©æ½°æˆ–ç™½å±

### æ•ˆèƒ½è€ƒé‡

**é™ç´šæ¨¡å¼æ•ˆèƒ½æå‡**:
- **CPU ä½¿ç”¨**: -5%ï¼ˆé—œé–‰ Lip Syncï¼‰
- **è¨˜æ†¶é«”**: -10MBï¼ˆç„¡ Viseme æ•¸æ“šï¼‰
- **FPS**: +2-5ï¼ˆç„¡ blendshape è¨ˆç®—ï¼‰

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 4.1-4.4ï¼ˆæ‰€æœ‰ Lip Sync åŠŸèƒ½ï¼‰

**å¾ŒçºŒä½¿ç”¨**:
- Epic 5 çš„éŒ¯èª¤è™•ç†æœƒåƒè€ƒæœ¬ Story çš„é™ç´šç­–ç•¥

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 4.5 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
