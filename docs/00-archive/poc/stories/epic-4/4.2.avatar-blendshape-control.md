# Story 4.2: Avatar Blendshape æ§åˆ¶èˆ‡å˜´å‹é©…å‹•

## Status
Draft

---

## Story

**As a** é–‹ç™¼è€…,
**I want** å°‡ viseme æ•¸æ“šæ˜ å°„åˆ° Avatar çš„ blendshapesï¼Œæ§åˆ¶å˜´å‹è®ŠåŒ–,
**so that** Avatar çš„å˜´å‹å¯ä»¥æ ¹æ“šèªéŸ³å‹•æ…‹è®ŠåŒ–ã€‚

---

## Acceptance Criteria

1. è­˜åˆ¥ Ready Player Me Avatar çš„å˜´å‹ blendshapesï¼ˆå¦‚ï¼š`mouthOpen`, `mouthSmile` ç­‰ï¼‰
2. å»ºç«‹ viseme åˆ° blendshape çš„æ˜ å°„å‡½å¼ï¼š`applyViseme(mesh, viseme, weight)`
3. å¯¦ä½œ blendshape æ¬Šé‡æ§åˆ¶ï¼š`aa` â†’ `mouthOpen` (weight 1.0)ã€`E` â†’ `mouthOpen` (weight 0.5)ã€`neutral` â†’ æ‰€æœ‰å˜´å‹ blendshape (weight 0)
4. ä½¿ç”¨ `useFrame` hook å³æ™‚æ›´æ–° blendshape
5. æ¸¬è©¦ï¼šæ‰‹å‹•è¨­å®š visemeï¼ŒAvatar å˜´å‹æ­£ç¢ºè®ŠåŒ–
6. å˜´å‹è®ŠåŒ–æµæš¢ç„¡æŠ–å‹•

---

## Tasks / Subtasks

- [ ] **Task 1: åˆ†æ Ready Player Me Avatar Blendshape çµæ§‹** (AC: 1)
  - [ ] å»ºç«‹æ¸¬è©¦è…³æœ¬ `scripts/test/inspect-avatar-blendshapes.ts`
  - [ ] å¯¦ä½œ Avatar æ¨¡å‹è¼‰å…¥èˆ‡ blendshape æª¢æŸ¥ï¼š
    ```typescript
    /**
     * æª¢æŸ¥ Ready Player Me Avatar å¯ç”¨çš„ Blendshapes
     * ç”¨æ–¼è­˜åˆ¥å˜´å‹æ§åˆ¶çš„ morph targets
     */

    import * as THREE from 'three';
    import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';

    async function inspectAvatarBlendshapes() {
      console.log('=== Avatar Blendshape Inspector ===\n');

      const loader = new GLTFLoader();

      // è¼‰å…¥æ¸¬è©¦ Avatar æ¨¡å‹ï¼ˆä½¿ç”¨ Story 2.2 çš„é è¨­ Avatarï¼‰
      const avatarUrl = 'https://models.readyplayer.me/[YOUR_AVATAR_ID].glb';

      try {
        console.log('ğŸ“‚ Loading Avatar model...');
        const gltf = await loader.loadAsync(avatarUrl);

        console.log('âœ… Avatar loaded successfully\n');

        // éæ­·å ´æ™¯ä¸­çš„æ‰€æœ‰ Mesh
        gltf.scene.traverse((child) => {
          if (child instanceof THREE.SkinnedMesh && child.morphTargetDictionary) {
            console.log(`ğŸ“¦ Found SkinnedMesh: ${child.name}`);
            console.log(`   Morph Targets Count: ${Object.keys(child.morphTargetDictionary).length}\n`);

            // åˆ—å‡ºæ‰€æœ‰ morph targetsï¼ˆblendshapesï¼‰
            console.log('ğŸ­ Available Blendshapes:');
            Object.entries(child.morphTargetDictionary).forEach(([name, index]) => {
              console.log(`   [${index}] ${name}`);
            });

            // ç‰¹åˆ¥æ¨™è¨»å˜´å‹ç›¸é—œçš„ blendshapes
            console.log('\nğŸ‘„ Mouth-Related Blendshapes:');
            const mouthBlendshapes = Object.keys(child.morphTargetDictionary).filter(
              name => name.toLowerCase().includes('mouth') ||
                      name.toLowerCase().includes('jaw') ||
                      name.toLowerCase().includes('lips')
            );

            if (mouthBlendshapes.length > 0) {
              mouthBlendshapes.forEach(name => {
                const index = child.morphTargetDictionary[name];
                console.log(`   âœ“ ${name} (index: ${index})`);
              });
            } else {
              console.log('   âš ï¸  No mouth-related blendshapes found!');
            }

            console.log('\n');
          }
        });

      } catch (error) {
        console.error('âŒ Failed to load Avatar:', error);
      }
    }

    // åŸ·è¡Œæª¢æŸ¥
    inspectAvatarBlendshapes();
    ```
  - [ ] åŸ·è¡Œè…³æœ¬ï¼š`pnpm tsx scripts/test/inspect-avatar-blendshapes.ts`
  - [ ] è¨˜éŒ„æ‰€æœ‰å˜´å‹ç›¸é—œ blendshape åç¨±ï¼ˆé æœŸï¼š`mouthOpen`, `mouthSmile`, `mouthPucker`, `jawOpen` ç­‰ï¼‰
  - [ ] å»ºç«‹ blendshape åç¨±å°ç…§è¡¨æ–¼ Dev Notes

- [ ] **Task 2: å»ºç«‹ Blendshape å‹åˆ¥å®šç¾©èˆ‡æ˜ å°„è¡¨** (AC: 2, 3)
  - [ ] æ›´æ–° `types/lipsync.ts` åŠ å…¥ blendshape å‹åˆ¥
  - [ ] å®šç¾© Blendshape æ˜ å°„ä»‹é¢ï¼š
    ```typescript
    /**
     * Avatar Blendshape åç¨±ï¼ˆReady Player Me æ¨™æº–ï¼‰
     * å¯¦éš›å¯ç”¨åç¨±éœ€é€éæ¨¡å‹æª¢æŸ¥ç¢ºèª
     */
    export interface AvatarBlendshapes {
      /** å˜´å·´é–‹åˆï¼ˆä¸»è¦æ§åˆ¶ï¼‰ */
      mouthOpen?: number;
      /** å¾®ç¬‘ */
      mouthSmile?: number;
      /** å˜Ÿå˜´ */
      mouthPucker?: number;
      /** ä¸‹å·´é–‹åˆ */
      jawOpen?: number;
      /** å˜´è§’å‘å·¦ */
      mouthLeft?: number;
      /** å˜´è§’å‘å³ */
      mouthRight?: number;
      /** å˜´å”‡ä¸Šæ² */
      mouthRollUpper?: number;
      /** å˜´å”‡ä¸‹æ² */
      mouthRollLower?: number;
    }

    /**
     * Viseme åˆ° Blendshape çš„æ˜ å°„è¦å‰‡
     * å®šç¾©æ¯å€‹ Viseme å¦‚ä½•å½±éŸ¿ä¸åŒçš„ blendshapes
     */
    export interface VisemeBlendshapeMap {
      viseme: VisemeType;
      blendshapes: {
        blendshapeName: keyof AvatarBlendshapes;
        weightMultiplier: number; // 0-1ï¼Œæ§åˆ¶è©² blendshape çš„å¼·åº¦æ¯”ä¾‹
      }[];
      description: string; // å˜´å‹æè¿°
    }
    ```
  - [ ] å®šç¾©é è¨­ Viseme æ˜ å°„è¡¨å¸¸æ•¸ï¼š
    ```typescript
    /**
     * POC éšæ®µç°¡åŒ–çš„ Viseme æ˜ å°„è¡¨
     * å®šç¾©æ¯å€‹ Viseme å¦‚ä½•é©…å‹• Avatar blendshapes
     */
    export const DEFAULT_VISEME_BLENDSHAPE_MAP: VisemeBlendshapeMap[] = [
      {
        viseme: 'aa',
        blendshapes: [
          { blendshapeName: 'mouthOpen', weightMultiplier: 1.0 },
          { blendshapeName: 'jawOpen', weightMultiplier: 0.8 }
        ],
        description: 'å¼µå˜´ï¼ˆå•Šã€å“ˆï¼‰'
      },
      {
        viseme: 'E',
        blendshapes: [
          { blendshapeName: 'mouthOpen', weightMultiplier: 0.5 },
          { blendshapeName: 'jawOpen', weightMultiplier: 0.3 }
        ],
        description: 'åŠé–‹ï¼ˆæ¬¸ã€èª’ï¼‰'
      },
      {
        viseme: 'I',
        blendshapes: [
          { blendshapeName: 'mouthSmile', weightMultiplier: 0.6 },
          { blendshapeName: 'mouthOpen', weightMultiplier: 0.2 }
        ],
        description: 'å¾®ç¬‘åŠé–‹ï¼ˆä¸€ã€è¡£ï¼‰'
      },
      {
        viseme: 'O',
        blendshapes: [
          { blendshapeName: 'mouthPucker', weightMultiplier: 0.7 },
          { blendshapeName: 'mouthOpen', weightMultiplier: 0.4 }
        ],
        description: 'å˜Ÿå˜´ï¼ˆå–”ã€æ­ï¼‰'
      },
      {
        viseme: 'U',
        blendshapes: [
          { blendshapeName: 'mouthPucker', weightMultiplier: 0.8 },
          { blendshapeName: 'mouthOpen', weightMultiplier: 0.3 }
        ],
        description: 'å˜Ÿå˜´ç·Šç¸®ï¼ˆçƒã€å—šï¼‰'
      },
      {
        viseme: 'neutral',
        blendshapes: [
          { blendshapeName: 'mouthOpen', weightMultiplier: 0.0 },
          { blendshapeName: 'mouthSmile', weightMultiplier: 0.0 },
          { blendshapeName: 'mouthPucker', weightMultiplier: 0.0 },
          { blendshapeName: 'jawOpen', weightMultiplier: 0.0 }
        ],
        description: 'é–‰å˜´ï¼ˆéœéŸ³ï¼‰'
      }
    ];
    ```
  - [ ] åŠ å…¥ JSDoc è¨»è§£èªªæ˜æ˜ å°„é‚è¼¯
  - [ ] é©—è­‰å‹åˆ¥å®šç¾©ç„¡ TypeScript éŒ¯èª¤

- [ ] **Task 3: å¯¦ä½œ Blendshape æ§åˆ¶æ ¸å¿ƒå‡½å¼** (AC: 2, 3)
  - [ ] å»ºç«‹ `lib/three/blendshape-controller.ts` æª”æ¡ˆ
  - [ ] å¯¦ä½œ Blendshape æ§åˆ¶å™¨é¡åˆ¥ï¼š
    ```typescript
    import * as THREE from 'three';
    import type { VisemeType, VisemeBlendshapeMap, AvatarBlendshapes } from '@/types/lipsync';
    import { DEFAULT_VISEME_BLENDSHAPE_MAP } from '@/types/lipsync';

    /**
     * Avatar Blendshape æ§åˆ¶å™¨
     * è² è²¬å°‡ Viseme æ•¸æ“šæ˜ å°„ä¸¦æ‡‰ç”¨åˆ° Avatar æ¨¡å‹çš„ blendshapes
     */
    export class BlendshapeController {
      private mesh: THREE.SkinnedMesh | null = null;
      private morphTargetDictionary: Record<string, number> | null = null;
      private morphTargetInfluences: number[] | null = null;
      private visemeMap: VisemeBlendshapeMap[];

      constructor(visemeMap: VisemeBlendshapeMap[] = DEFAULT_VISEME_BLENDSHAPE_MAP) {
        this.visemeMap = visemeMap;
      }

      /**
       * åˆå§‹åŒ–æ§åˆ¶å™¨ï¼Œç¶å®š Avatar Mesh
       *
       * @param avatarMesh - Avatar çš„ SkinnedMeshï¼ˆåŒ…å« morph targetsï¼‰
       * @returns æ˜¯å¦æˆåŠŸåˆå§‹åŒ–
       */
      initialize(avatarMesh: THREE.SkinnedMesh): boolean {
        if (!avatarMesh.morphTargetDictionary || !avatarMesh.morphTargetInfluences) {
          console.error('[BlendshapeController] Avatar mesh does not have morph targets');
          return false;
        }

        this.mesh = avatarMesh;
        this.morphTargetDictionary = avatarMesh.morphTargetDictionary;
        this.morphTargetInfluences = avatarMesh.morphTargetInfluences;

        console.log('[BlendshapeController] Initialized with morph targets:', {
          totalTargets: Object.keys(this.morphTargetDictionary).length,
          availableMouthTargets: this.getAvailableMouthBlendshapes()
        });

        return true;
      }

      /**
       * å–å¾—å¯ç”¨çš„å˜´å‹ blendshape åˆ—è¡¨
       */
      private getAvailableMouthBlendshapes(): string[] {
        if (!this.morphTargetDictionary) return [];

        return Object.keys(this.morphTargetDictionary).filter(
          name => name.toLowerCase().includes('mouth') ||
                  name.toLowerCase().includes('jaw') ||
                  name.toLowerCase().includes('lips')
        );
      }

      /**
       * æ‡‰ç”¨ Viseme åˆ° Avatar blendshapes
       *
       * @param viseme - Viseme é¡å‹
       * @param weight - Viseme æ¬Šé‡ï¼ˆ0-1ï¼‰
       */
      applyViseme(viseme: VisemeType, weight: number): void {
        if (!this.mesh || !this.morphTargetDictionary || !this.morphTargetInfluences) {
          console.warn('[BlendshapeController] Controller not initialized');
          return;
        }

        // æ‰¾åˆ°å°æ‡‰çš„ Viseme æ˜ å°„è¦å‰‡
        const mapping = this.visemeMap.find(m => m.viseme === viseme);
        if (!mapping) {
          console.warn(`[BlendshapeController] No mapping found for viseme: ${viseme}`);
          return;
        }

        // æ‡‰ç”¨æ¯å€‹ blendshape
        mapping.blendshapes.forEach(({ blendshapeName, weightMultiplier }) => {
          const blendshapeIndex = this.morphTargetDictionary![blendshapeName];

          if (blendshapeIndex !== undefined) {
            // è¨ˆç®—æœ€çµ‚æ¬Šé‡ï¼šviseme weight Ã— blendshape multiplier
            const finalWeight = weight * weightMultiplier;
            this.morphTargetInfluences![blendshapeIndex] = Math.max(0, Math.min(1, finalWeight));
          }
        });
      }

      /**
       * é‡ç½®æ‰€æœ‰å˜´å‹ blendshapes åˆ° neutral ç‹€æ…‹
       */
      resetMouthBlendshapes(): void {
        this.applyViseme('neutral', 0);
      }
    }
    ```
  - [ ] åŠ å…¥å‹åˆ¥æª¢æŸ¥èˆ‡éŒ¯èª¤è™•ç†
  - [ ] é©—è­‰ blendshape æ¬Šé‡ç¯„åœï¼ˆ0-1ï¼‰
  - [ ] æ¸¬è©¦æ§åˆ¶å™¨åˆå§‹åŒ–èˆ‡æ‡‰ç”¨ viseme åŠŸèƒ½

- [ ] **Task 4: å»ºç«‹ React Hook å°è£ Blendshape æ§åˆ¶** (AC: 4)
  - [ ] å»ºç«‹ `hooks/useBlendshapeController.ts` è‡ªè¨‚ Hook
  - [ ] å¯¦ä½œ Hook é‚è¼¯ï¼š
    ```typescript
    import { useRef, useCallback } from 'react';
    import type { VisemeType } from '@/types/lipsync';
    import { BlendshapeController } from '@/lib/three/blendshape-controller';
    import type * as THREE from 'three';

    /**
     * Blendshape æ§åˆ¶å™¨ Hook
     * æä¾›ç°¡åŒ–çš„ API ç”¨æ–¼ React çµ„ä»¶ä¸­æ§åˆ¶ Avatar å˜´å‹
     */
    export function useBlendshapeController() {
      const controllerRef = useRef<BlendshapeController | null>(null);

      /**
       * åˆå§‹åŒ–æ§åˆ¶å™¨ï¼ˆåœ¨ Avatar è¼‰å…¥å¾Œå‘¼å«ï¼‰
       */
      const initializeController = useCallback((avatarMesh: THREE.SkinnedMesh) => {
        if (!controllerRef.current) {
          controllerRef.current = new BlendshapeController();
        }

        const success = controllerRef.current.initialize(avatarMesh);

        if (success) {
          console.log('[useBlendshapeController] Controller initialized');
        } else {
          console.error('[useBlendshapeController] Failed to initialize controller');
        }

        return success;
      }, []);

      /**
       * æ‡‰ç”¨ Viseme
       */
      const applyViseme = useCallback((viseme: VisemeType, weight: number) => {
        if (controllerRef.current) {
          controllerRef.current.applyViseme(viseme, weight);
        } else {
          console.warn('[useBlendshapeController] Controller not initialized yet');
        }
      }, []);

      /**
       * é‡ç½®å˜´å‹åˆ° neutral
       */
      const resetMouth = useCallback(() => {
        if (controllerRef.current) {
          controllerRef.current.resetMouthBlendshapes();
        }
      }, []);

      return {
        initializeController,
        applyViseme,
        resetMouth
      };
    }
    ```
  - [ ] åŠ å…¥ useCallback å„ªåŒ–æ•ˆèƒ½
  - [ ] åŠ å…¥ JSDoc è¨»è§£èªªæ˜ç”¨æ³•
  - [ ] é©—è­‰ Hook å¯åœ¨çµ„ä»¶ä¸­æ­£å¸¸ä½¿ç”¨

- [ ] **Task 5: æ›´æ–° AvatarModel çµ„ä»¶æ•´åˆ Blendshape æ§åˆ¶** (AC: 5)
  - [ ] é–‹å•Ÿ `components/avatar/AvatarModel.tsx`ï¼ˆEpic 2 å»ºç«‹ï¼‰
  - [ ] æ•´åˆ useBlendshapeController Hookï¼š
    ```typescript
    'use client';

    import { useRef, useEffect } from 'react';
    import { useGLTF } from '@react-three/drei';
    import { useBlendshapeController } from '@/hooks/useBlendshapeController';
    import type { VisemeType } from '@/types/lipsync';
    import type * as THREE from 'three';

    interface AvatarModelProps {
      avatarUrl: string;
      /** ç•¶å‰è¦é¡¯ç¤ºçš„ Visemeï¼ˆæ¸¬è©¦ç”¨ï¼‰ */
      currentViseme?: VisemeType;
      /** Viseme æ¬Šé‡ï¼ˆæ¸¬è©¦ç”¨ï¼‰ */
      visemeWeight?: number;
    }

    export default function AvatarModel({
      avatarUrl,
      currentViseme = 'neutral',
      visemeWeight = 0
    }: AvatarModelProps) {
      const { scene } = useGLTF(avatarUrl);
      const { initializeController, applyViseme } = useBlendshapeController();
      const meshRef = useRef<THREE.SkinnedMesh | null>(null);

      // åˆå§‹åŒ– Blendshape æ§åˆ¶å™¨
      useEffect(() => {
        if (scene) {
          // æ‰¾åˆ° Avatar çš„ SkinnedMesh
          scene.traverse((child) => {
            if (child instanceof THREE.SkinnedMesh && child.morphTargetDictionary) {
              meshRef.current = child;
              initializeController(child);
            }
          });
        }
      }, [scene, initializeController]);

      // æ‡‰ç”¨ Visemeï¼ˆæ¸¬è©¦ç”¨ï¼Œå¯¦éš›æœƒç”± LipSyncController æ§åˆ¶ï¼‰
      useEffect(() => {
        if (meshRef.current && currentViseme) {
          applyViseme(currentViseme, visemeWeight);
        }
      }, [currentViseme, visemeWeight, applyViseme]);

      return <primitive object={scene} />;
    }
    ```
  - [ ] åŠ å…¥ currentViseme èˆ‡ visemeWeight propsï¼ˆæ¸¬è©¦ç”¨ï¼‰
  - [ ] æ¸¬è©¦çµ„ä»¶å¯æ­£ç¢ºåˆå§‹åŒ–æ§åˆ¶å™¨
  - [ ] é©—è­‰ TypeScript å‹åˆ¥ç„¡éŒ¯èª¤

- [ ] **Task 6: å»ºç«‹æ¸¬è©¦ä»‹é¢é©—è­‰å˜´å‹æ§åˆ¶** (AC: 5, 6)
  - [ ] å»ºç«‹æ¸¬è©¦é é¢ `app/test-lipsync/page.tsx`
  - [ ] å¯¦ä½œäº’å‹•æ¸¬è©¦ä»‹é¢ï¼š
    ```typescript
    'use client';

    import { useState } from 'react';
    import { Canvas } from '@react-three/fiber';
    import { OrbitControls } from '@react-three/drei';
    import AvatarModel from '@/components/avatar/AvatarModel';
    import type { VisemeType } from '@/types/lipsync';

    export default function TestLipSyncPage() {
      const [currentViseme, setCurrentViseme] = useState<VisemeType>('neutral');
      const [visemeWeight, setVisemeWeight] = useState(0.5);

      const visemes: VisemeType[] = ['neutral', 'aa', 'E', 'I', 'O', 'U'];
      const avatarUrl = 'https://models.readyplayer.me/[YOUR_AVATAR_ID].glb';

      return (
        <div className="flex h-screen">
          {/* å·¦å´ï¼š3D Avatar */}
          <div className="flex-1 bg-gray-900">
            <Canvas camera={{ position: [0, 1.5, 2], fov: 50 }}>
              <ambientLight intensity={0.5} />
              <directionalLight position={[5, 5, 5]} intensity={1} />
              <AvatarModel
                avatarUrl={avatarUrl}
                currentViseme={currentViseme}
                visemeWeight={visemeWeight}
              />
              <OrbitControls />
            </Canvas>
          </div>

          {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
          <div className="w-96 bg-white p-6 space-y-6">
            <h1 className="text-2xl font-bold text-gray-900">
              Lip Sync Blendshape Test
            </h1>

            {/* Viseme é¸æ“‡ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Viseme Type
              </label>
              <div className="grid grid-cols-3 gap-2">
                {visemes.map(viseme => (
                  <button
                    key={viseme}
                    onClick={() => setCurrentViseme(viseme)}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      currentViseme === viseme
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {viseme}
                  </button>
                ))}
              </div>
            </div>

            {/* Weight æ»‘æ¡¿ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Viseme Weight: {visemeWeight.toFixed(2)}
              </label>
              <input
                type="range"
                min="0"
                max="1"
                step="0.01"
                value={visemeWeight}
                onChange={(e) => setVisemeWeight(parseFloat(e.target.value))}
                className="w-full"
              />
            </div>

            {/* ç•¶å‰ç‹€æ…‹é¡¯ç¤º */}
            <div className="bg-gray-100 p-4 rounded-lg">
              <h3 className="text-sm font-medium text-gray-700 mb-2">
                Current State
              </h3>
              <div className="text-sm text-gray-600 space-y-1">
                <p>Viseme: <span className="font-mono text-blue-600">{currentViseme}</span></p>
                <p>Weight: <span className="font-mono text-blue-600">{visemeWeight.toFixed(2)}</span></p>
              </div>
            </div>

            {/* æ¸¬è©¦æç¤º */}
            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
              <h3 className="text-sm font-medium text-blue-900 mb-2">
                æ¸¬è©¦æç¤º
              </h3>
              <ul className="text-xs text-blue-700 space-y-1">
                <li>â€¢ é»æ“Šä¸åŒ Viseme è§€å¯Ÿå˜´å‹è®ŠåŒ–</li>
                <li>â€¢ èª¿æ•´ Weight æ»‘æ¡¿è§€å¯Ÿå˜´å‹é–‹åˆç¨‹åº¦</li>
                <li>â€¢ aa: å¼µå˜´æœ€å¤§ï¼ŒO/U: å˜Ÿå˜´ï¼ŒE: åŠé–‹</li>
                <li>â€¢ neutral: é–‰å˜´ï¼ˆæ‰€æœ‰ blendshape æ­¸é›¶ï¼‰</li>
              </ul>
            </div>
          </div>
        </div>
      );
    }
    ```
  - [ ] åŸ·è¡Œ `pnpm dev` å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
  - [ ] é–‹å•Ÿ `http://localhost:3000/test-lipsync`
  - [ ] æ¸¬è©¦æ‰€æœ‰ Viseme é¡å‹ï¼š
    - [ ] neutral: é–‰å˜´ï¼ˆæ‰€æœ‰ blendshape = 0ï¼‰
    - [ ] aa: å¼µå˜´æœ€å¤§ï¼ˆmouthOpen â‰ˆ 1.0ï¼‰
    - [ ] E: åŠé–‹ï¼ˆmouthOpen â‰ˆ 0.5ï¼‰
    - [ ] O: å˜Ÿå˜´ï¼ˆmouthPucker â‰ˆ 0.7ï¼‰
    - [ ] U: å˜Ÿå˜´ç·Šç¸®ï¼ˆmouthPucker â‰ˆ 0.8ï¼‰
  - [ ] æ¸¬è©¦ Weight æ»‘æ¡¿èª¿æ•´å˜´å‹é–‹åˆç¨‹åº¦
  - [ ] é©—è­‰å˜´å‹è®ŠåŒ–æµæš¢ç„¡æŠ–å‹•ï¼ˆAC 6ï¼‰

- [ ] **Task 7: å„ªåŒ– Blendshape éæ¸¡å¹³æ»‘åº¦** (AC: 6)
  - [ ] åœ¨ BlendshapeController åŠ å…¥æ’å€¼ï¼ˆlerpï¼‰é‚è¼¯ï¼š
    ```typescript
    /**
     * å¹³æ»‘æ‡‰ç”¨ Visemeï¼ˆä½¿ç”¨ç·šæ€§æ’å€¼ï¼‰
     * é¿å… blendshape çªè®Šé€ æˆæŠ–å‹•
     *
     * @param viseme - Viseme é¡å‹
     * @param targetWeight - ç›®æ¨™æ¬Šé‡
     * @param lerpFactor - æ’å€¼å› å­ï¼ˆ0-1ï¼‰ï¼Œè¶Šå°è¶Šå¹³æ»‘ï¼Œé è¨­ 0.3
     */
    applySmoothViseme(viseme: VisemeType, targetWeight: number, lerpFactor: number = 0.3): void {
      if (!this.mesh || !this.morphTargetDictionary || !this.morphTargetInfluences) {
        return;
      }

      const mapping = this.visemeMap.find(m => m.viseme === viseme);
      if (!mapping) return;

      mapping.blendshapes.forEach(({ blendshapeName, weightMultiplier }) => {
        const blendshapeIndex = this.morphTargetDictionary![blendshapeName];

        if (blendshapeIndex !== undefined) {
          const currentWeight = this.morphTargetInfluences![blendshapeIndex];
          const targetFinalWeight = targetWeight * weightMultiplier;

          // ç·šæ€§æ’å€¼ï¼ˆlerpï¼‰
          const newWeight = currentWeight + (targetFinalWeight - currentWeight) * lerpFactor;

          this.morphTargetInfluences![blendshapeIndex] = Math.max(0, Math.min(1, newWeight));
        }
      });
    }
    ```
  - [ ] æ›´æ–° useBlendshapeController Hook æä¾›å¹³æ»‘ç‰ˆæœ¬ï¼š
    ```typescript
    const applySmoothViseme = useCallback((viseme: VisemeType, weight: number, lerpFactor?: number) => {
      if (controllerRef.current) {
        controllerRef.current.applySmoothViseme(viseme, weight, lerpFactor);
      }
    }, []);

    return {
      initializeController,
      applyViseme,
      applySmoothViseme, // æ–°å¢å¹³æ»‘ç‰ˆæœ¬
      resetMouth
    };
    ```
  - [ ] åœ¨æ¸¬è©¦ä»‹é¢åŠ å…¥å¹³æ»‘é–‹é—œï¼š
    ```typescript
    const [useSmooth, setUseSmooth] = useState(true);

    useEffect(() => {
      if (meshRef.current && currentViseme) {
        if (useSmooth) {
          applySmoothViseme(currentViseme, visemeWeight);
        } else {
          applyViseme(currentViseme, visemeWeight);
        }
      }
    }, [currentViseme, visemeWeight, useSmooth, applyViseme, applySmoothViseme]);
    ```
  - [ ] æ¸¬è©¦å¹³æ»‘èˆ‡éå¹³æ»‘æ¨¡å¼å·®ç•°
  - [ ] èª¿æ•´ lerpFactor æ‰¾åˆ°æœ€ä½³å€¼ï¼ˆé è¨­ 0.3ï¼‰
  - [ ] é©—è­‰å¿«é€Ÿåˆ‡æ› Viseme æ™‚ç„¡æŠ–å‹•

- [ ] **Task 8: å»ºç«‹å–®å…ƒæ¸¬è©¦èˆ‡æ–‡æª”** (AC: 1-6)
  - [ ] å»ºç«‹æ¸¬è©¦æª”æ¡ˆ `lib/three/__tests__/blendshape-controller.test.ts`
  - [ ] å¯¦ä½œåŸºæœ¬å–®å…ƒæ¸¬è©¦ï¼š
    ```typescript
    import { describe, it, expect, beforeEach } from 'vitest';
    import { BlendshapeController } from '../blendshape-controller';
    import * as THREE from 'three';

    describe('BlendshapeController', () => {
      let controller: BlendshapeController;
      let mockMesh: THREE.SkinnedMesh;

      beforeEach(() => {
        controller = new BlendshapeController();

        // å»ºç«‹ mock SkinnedMesh
        const geometry = new THREE.BufferGeometry();
        const material = new THREE.MeshBasicMaterial();
        mockMesh = new THREE.SkinnedMesh(geometry, material);

        // è¨­å®š mock morph targets
        mockMesh.morphTargetDictionary = {
          'mouthOpen': 0,
          'mouthSmile': 1,
          'mouthPucker': 2,
          'jawOpen': 3
        };
        mockMesh.morphTargetInfluences = [0, 0, 0, 0];
      });

      it('should initialize successfully with valid mesh', () => {
        const success = controller.initialize(mockMesh);
        expect(success).toBe(true);
      });

      it('should apply aa viseme correctly', () => {
        controller.initialize(mockMesh);
        controller.applyViseme('aa', 1.0);

        expect(mockMesh.morphTargetInfluences![0]).toBeCloseTo(1.0, 1); // mouthOpen
        expect(mockMesh.morphTargetInfluences![3]).toBeCloseTo(0.8, 1); // jawOpen
      });

      it('should apply neutral viseme (reset all to 0)', () => {
        controller.initialize(mockMesh);
        controller.applyViseme('aa', 1.0);
        controller.applyViseme('neutral', 0);

        expect(mockMesh.morphTargetInfluences![0]).toBe(0);
        expect(mockMesh.morphTargetInfluences![1]).toBe(0);
        expect(mockMesh.morphTargetInfluences![2]).toBe(0);
        expect(mockMesh.morphTargetInfluences![3]).toBe(0);
      });

      it('should clamp weight to 0-1 range', () => {
        controller.initialize(mockMesh);
        controller.applyViseme('aa', 1.5); // è¶…é 1.0

        expect(mockMesh.morphTargetInfluences![0]).toBeLessThanOrEqual(1.0);
      });
    });
    ```
  - [ ] åŸ·è¡Œæ¸¬è©¦ï¼š`pnpm test blendshape-controller`
  - [ ] ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé
  - [ ] æ›´æ–° `lib/three/README.md` åŠ å…¥ Blendshape æ§åˆ¶å™¨æ–‡æª”ï¼š
    ```markdown
    ## Blendshape Controller

    ### Basic Usage
    \`\`\`typescript
    import { BlendshapeController } from '@/lib/three/blendshape-controller';

    const controller = new BlendshapeController();
    controller.initialize(avatarMesh); // SkinnedMesh with morph targets

    // Apply viseme
    controller.applyViseme('aa', 1.0); // å¼µå˜´
    controller.applyViseme('E', 0.5);  // åŠé–‹
    controller.applyViseme('neutral', 0); // é–‰å˜´
    \`\`\`

    ### Smooth Transitions
    \`\`\`typescript
    // ä½¿ç”¨å¹³æ»‘éæ¸¡é¿å…æŠ–å‹•
    controller.applySmoothViseme('aa', 1.0, 0.3);
    \`\`\`

    ### Available Visemes
    - `aa`: å¼µå˜´ï¼ˆå•Šã€å“ˆï¼‰â†’ mouthOpen: 1.0
    - `E`: åŠé–‹ï¼ˆæ¬¸ã€èª’ï¼‰â†’ mouthOpen: 0.5
    - `I`: å¾®ç¬‘åŠé–‹ï¼ˆä¸€ã€è¡£ï¼‰â†’ mouthSmile: 0.6
    - `O`: å˜Ÿå˜´ï¼ˆå–”ã€æ­ï¼‰â†’ mouthPucker: 0.7
    - `U`: å˜Ÿå˜´ç·Šç¸®ï¼ˆçƒã€å—šï¼‰â†’ mouthPucker: 0.8
    - `neutral`: é–‰å˜´ï¼ˆéœéŸ³ï¼‰â†’ all: 0
    ```
  - [ ] é©—è­‰æ–‡æª”æ¸…æ™°æ˜“æ‡‚

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

æ ¹æ“šæ¶æ§‹æ–‡ä»¶ï¼ŒStory 4.2 çš„æª”æ¡ˆçµæ§‹ï¼š

```
avatar-chat-poc/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ three/
â”‚       â”œâ”€â”€ blendshape-controller.ts    # Blendshape æ§åˆ¶å™¨ (æœ¬ Story)
â”‚       â”œâ”€â”€ lipsync.ts                  # éŸ³è¨Šåˆ†æ (Story 4.1)
â”‚       â”œâ”€â”€ __tests__/
â”‚       â”‚   â””â”€â”€ blendshape-controller.test.ts # å–®å…ƒæ¸¬è©¦
â”‚       â”œâ”€â”€ index.ts                    # Barrel export
â”‚       â””â”€â”€ README.md                   # æ–‡æª”æ›´æ–°
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useBlendshapeController.ts      # React Hook å°è£ (æœ¬ Story)
â”œâ”€â”€ types/
â”‚   â””â”€â”€ lipsync.ts                      # å‹åˆ¥å®šç¾©æ›´æ–° (æœ¬ Story)
â”œâ”€â”€ components/
â”‚   â””â”€â”€ avatar/
â”‚       â””â”€â”€ AvatarModel.tsx             # æ›´æ–°æ•´åˆ blendshape æ§åˆ¶
â”œâ”€â”€ app/
â”‚   â””â”€â”€ test-lipsync/
â”‚       â””â”€â”€ page.tsx                    # æ¸¬è©¦é é¢ (æœ¬ Story)
â””â”€â”€ scripts/
    â””â”€â”€ test/
        â””â”€â”€ inspect-avatar-blendshapes.ts # Avatar æª¢æŸ¥è…³æœ¬
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**Three.js Morph Targetsï¼ˆBlendshapesï¼‰åŸç†**ï¼š

```typescript
// Three.js ä¸­çš„ Morph Target ç³»çµ±
interface SkinnedMesh {
  morphTargetDictionary: Record<string, number>; // åç¨± â†’ ç´¢å¼•æ˜ å°„
  morphTargetInfluences: number[];                // æ¬Šé‡é™£åˆ—ï¼ˆ0-1ï¼‰
}

// ç¯„ä¾‹ï¼š
mesh.morphTargetDictionary = {
  'mouthOpen': 0,    // ç´¢å¼• 0
  'mouthSmile': 1    // ç´¢å¼• 1
};

mesh.morphTargetInfluences = [0.5, 0.3]; // mouthOpen: 50%, mouthSmile: 30%

// æ¬Šé‡æ§åˆ¶ï¼š
// 0 = åŸå§‹ç‹€æ…‹ï¼ˆç„¡è®Šå½¢ï¼‰
// 1 = å®Œå…¨è®Šå½¢ï¼ˆ100% blendshape æ•ˆæœï¼‰
// 0.5 = 50% è®Šå½¢
```

**Viseme åˆ° Blendshape æ˜ å°„ç­–ç•¥**ï¼š

POC éšæ®µç°¡åŒ–æ˜ å°„ï¼ˆä¸€å€‹ Viseme å¯å½±éŸ¿å¤šå€‹ Blendshapesï¼‰ï¼š

| Viseme | ä¸»è¦ Blendshape | æ¬¡è¦ Blendshape | æ•ˆæœ |
|--------|----------------|----------------|------|
| aa     | mouthOpen (1.0) | jawOpen (0.8) | å¤§å¼µå˜´ |
| E      | mouthOpen (0.5) | jawOpen (0.3) | åŠé–‹ |
| I      | mouthSmile (0.6) | mouthOpen (0.2) | å¾®ç¬‘åŠé–‹ |
| O      | mouthPucker (0.7) | mouthOpen (0.4) | å˜Ÿå˜´åœ“å½¢ |
| U      | mouthPucker (0.8) | mouthOpen (0.3) | å˜Ÿå˜´ç·Šç¸® |
| neutral | æ‰€æœ‰ (0.0) | - | é–‰å˜´éœæ­¢ |

**ç‚ºä½•éœ€è¦å¤šå€‹ Blendshape çµ„åˆï¼Ÿ**
- âœ… æ›´è‡ªç„¶ï¼šå–®ä¸€ blendshape ç„¡æ³•å®Œæ•´æ¨¡æ“¬çœŸå¯¦å˜´å‹
- âœ… æ›´ç´°ç·»ï¼šçµ„åˆå¤šå€‹ blendshape å¯ç”¢ç”Ÿæ›´è±å¯Œçš„è¡¨æƒ…
- âœ… ç¬¦åˆäººé¡å˜´å‹ï¼šä¾‹å¦‚ã€Œå•Šã€éœ€è¦å¼µå˜´ + å¼µä¸‹å·´
- âš ï¸ è¤‡é›œåº¦å¢åŠ ï¼šéœ€è¦ç²¾ç¢ºèª¿æ ¡æ¯å€‹ blendshape çš„æ¬Šé‡æ¯”ä¾‹

**ç·šæ€§æ’å€¼ï¼ˆLerpï¼‰å¹³æ»‘éæ¸¡åŸç†**ï¼š

```typescript
// Lerp å…¬å¼ï¼šnewValue = currentValue + (targetValue - currentValue) * factor
// factor = 0.3 è¡¨ç¤ºæ¯å¹€ç§»å‹• 30% çš„è·é›¢

// ç¯„ä¾‹ï¼š
// Frame 1: current = 0.0,  target = 1.0 â†’ new = 0.0 + (1.0 - 0.0) * 0.3 = 0.3
// Frame 2: current = 0.3,  target = 1.0 â†’ new = 0.3 + (1.0 - 0.3) * 0.3 = 0.51
// Frame 3: current = 0.51, target = 1.0 â†’ new = 0.51 + (1.0 - 0.51) * 0.3 = 0.657
// ...æ¼¸é€²å¼æ¥è¿‘ 1.0

// ç‚ºä½•éœ€è¦ Lerpï¼Ÿ
// âœ… å¹³æ»‘éæ¸¡ï¼šé¿å… blendshape çªè®Šé€ æˆæŠ–å‹•
// âœ… è‡ªç„¶å‹•ç•«ï¼šäººé¡å˜´å‹è®ŠåŒ–ä¸æ˜¯ç¬é–“çš„
// âœ… æ•ˆèƒ½å¹³è¡¡ï¼šæ¯å¹€è¨ˆç®—ç°¡å–®ï¼ˆä¸€æ¬¡ä¹˜æ³•åŠ æ³•ï¼‰
// âš ï¸ å»¶é²æ„Ÿï¼šfactor è¶Šå°è¶Šå¹³æ»‘ä½†åæ‡‰è¶Šæ…¢ï¼Œéœ€èª¿æ ¡å¹³è¡¡
```

**Ready Player Me Blendshape å‘½åæ…£ä¾‹**ï¼š

æ ¹æ“š Ready Player Me æ–‡æª”ï¼Œæ¨™æº– blendshape åç¨±ï¼š

```typescript
// å˜´å‹ç›¸é—œï¼ˆMouthï¼‰
- mouthOpen        // å˜´å·´é–‹åˆï¼ˆä¸Šä¸‹ï¼‰
- mouthSmile       // å¾®ç¬‘ï¼ˆå˜´è§’ä¸Šæšï¼‰
- mouthFrown       // çšºçœ‰ï¼ˆå˜´è§’ä¸‹å‚ï¼‰
- mouthPucker      // å˜Ÿå˜´ï¼ˆå‘å‰çªå‡ºï¼‰
- mouthLeft        // å˜´è§’å‘å·¦
- mouthRight       // å˜´è§’å‘å³
- mouthRollUpper   // ä¸Šå˜´å”‡å…§æ²
- mouthRollLower   // ä¸‹å˜´å”‡å…§æ²

// ä¸‹å·´ç›¸é—œï¼ˆJawï¼‰
- jawOpen          // ä¸‹å·´é–‹åˆ
- jawForward       // ä¸‹å·´å‰ä¼¸
- jawLeft          // ä¸‹å·´å‘å·¦
- jawRight         // ä¸‹å·´å‘å³
```

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•å»ºç«‹ç¨ç«‹çš„ BlendshapeController é¡åˆ¥ï¼Ÿ**
   - âœ… é—œæ³¨é»åˆ†é›¢ï¼šéŸ³è¨Šåˆ†æï¼ˆStory 4.1ï¼‰èˆ‡ blendshape æ§åˆ¶è§£è€¦
   - âœ… å¯é‡è¤‡ä½¿ç”¨ï¼šä¸åŒå‹•ç•«ç³»çµ±éƒ½å¯ä½¿ç”¨ï¼ˆå¦‚æ‰‹å‹•è¡¨æƒ…æ§åˆ¶ï¼‰
   - âœ… æ˜“æ–¼æ¸¬è©¦ï¼šå¯ mock SkinnedMesh é€²è¡Œå–®å…ƒæ¸¬è©¦
   - âœ… ç‹€æ…‹å°è£ï¼šmorphTargetDictionary èˆ‡ influences é›†ä¸­ç®¡ç†
   - ğŸ”„ æœªä¾†æ“´å±•ï¼šå¯åŠ å…¥è¡¨æƒ…é è¨­ï¼ˆpresetï¼‰ã€å‹•ç•«æ™‚é–“è»¸ç­‰åŠŸèƒ½

2. **ç‚ºä½•ä½¿ç”¨æ˜ å°„è¡¨ï¼ˆMapï¼‰è€Œéç¡¬ç·¨ç¢¼ï¼Ÿ**
   - âœ… é…ç½®å½ˆæ€§ï¼šå¯é€é constructor å‚³å…¥è‡ªè¨‚æ˜ å°„è¡¨
   - âœ… æ˜“æ–¼èª¿æ ¡ï¼šä¿®æ”¹æ˜ å°„è¡¨ç„¡éœ€æ”¹å‹•ç¨‹å¼é‚è¼¯
   - âœ… å¤š Avatar æ”¯æ´ï¼šä¸åŒ Avatar å¯èƒ½æœ‰ä¸åŒ blendshape åç¨±
   - âœ… A/B æ¸¬è©¦ï¼šå¯æ¸¬è©¦ä¸åŒæ˜ å°„ç­–ç•¥æ‰¾åˆ°æœ€ä½³æ•ˆæœ
   - ğŸ“ å‹åˆ¥å®‰å…¨ï¼šTypeScript ç¢ºä¿æ˜ å°„è¡¨çµæ§‹æ­£ç¢º

3. **ç‚ºä½•éœ€è¦ useBlendshapeController Hookï¼Ÿ**
   - âœ… React æ•´åˆï¼šå°è£ ref èˆ‡ callbackï¼Œç¬¦åˆ React Hooks æ¨¡å¼
   - âœ… ç”Ÿå‘½é€±æœŸç®¡ç†ï¼šè‡ªå‹•è™•ç† controller åˆå§‹åŒ–èˆ‡æ¸…ç†
   - âœ… æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ useCallback é¿å…ä¸å¿…è¦é‡æ¸²æŸ“
   - âœ… æ˜“æ–¼ä½¿ç”¨ï¼šçµ„ä»¶ä¸­ç›´æ¥å‘¼å«ï¼Œç„¡éœ€æ‰‹å‹•ç®¡ç† controller å¯¦ä¾‹
   - âš ï¸ æ³¨æ„ï¼šStory 4.3 çš„ LipSyncController æœƒä½¿ç”¨æ­¤ Hook

4. **ç‚ºä½•éœ€è¦å¹³æ»‘éæ¸¡ï¼ˆLerpï¼‰ï¼Ÿ**
   - âœ… è¦–è¦ºæµæš¢ï¼šäººçœ¼å°çªè®Šæ•æ„Ÿï¼Œlerp æä¾›è‡ªç„¶éæ¸¡
   - âœ… é¿å…æŠ–å‹•ï¼šå¿«é€Ÿåˆ‡æ› viseme æ™‚ï¼Œlerp å¹³æ»‘åŒ–æ¬Šé‡è®ŠåŒ–
   - âœ… æ¨¡æ“¬çœŸå¯¦ï¼šäººé¡å˜´å‹è®ŠåŒ–æœ‰æ…£æ€§ï¼Œä¸æ˜¯ç¬é–“çš„
   - âœ… å¯èª¿æ ¡ï¼šlerpFactor å¯æ ¹æ“šéœ€æ±‚èª¿æ•´ï¼ˆå¿«é€Ÿ vs å¹³æ»‘ï¼‰
   - âš ï¸ å»¶é²æ„Ÿï¼šéå°çš„ factor æœƒå°è‡´åæ‡‰æ…¢ï¼Œéœ€å¹³è¡¡ï¼ˆé è¨­ 0.3ï¼‰

5. **ç‚ºä½•å»ºç«‹æ¸¬è©¦é é¢è€Œéåƒ…å–®å…ƒæ¸¬è©¦ï¼Ÿ**
   - âœ… è¦–è¦ºé©—è­‰ï¼šblendshape æ•ˆæœéœ€è¦è¦–è¦ºç¢ºèªï¼Œå–®å…ƒæ¸¬è©¦ä¸è¶³
   - âœ… äº’å‹•èª¿æ ¡ï¼šæ»‘æ¡¿å³æ™‚èª¿æ•´æ¬Šé‡ï¼Œå¿«é€Ÿæ‰¾åˆ°æœ€ä½³å€¼
   - âœ… Bug æ’æŸ¥ï¼šè¦–è¦ºåŒ–å•é¡Œæ›´æ˜“ç™¼ç¾ï¼ˆå¦‚ blendshape åç¨±éŒ¯èª¤ï¼‰
   - âœ… æ–‡æª”åƒ¹å€¼ï¼šæ¸¬è©¦é é¢æœ¬èº«æ˜¯æ´»æ–‡æª”ï¼ˆlive documentationï¼‰
   - ğŸ”„ æœªä¾†ä¿ç•™ï¼šMVP éšæ®µå¯ä½œç‚ºé–‹ç™¼å·¥å…·æˆ– Demo ä½¿ç”¨

### Testing

**æ¸¬è©¦æ¡†æ¶**: Vitestï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰+ æ‰‹å‹•è¦–è¦ºæ¸¬è©¦ï¼ˆæ¸¬è©¦é é¢ï¼‰

**æ¸¬è©¦ç¯„åœ**:
1. âœ… BlendshapeController æ­£ç¢ºåˆå§‹åŒ–
2. âœ… æ‰€æœ‰ Viseme é¡å‹æ­£ç¢ºæ˜ å°„åˆ° blendshapes
3. âœ… æ¬Šé‡å€¼æ­£ç¢ºé™åˆ¶åœ¨ 0-1 ç¯„åœ
4. âœ… neutral Viseme é‡ç½®æ‰€æœ‰ blendshapes åˆ° 0
5. âœ… å¹³æ»‘éæ¸¡ï¼ˆlerpï¼‰åŠŸèƒ½æ­£å¸¸
6. âœ… å¿«é€Ÿåˆ‡æ› Viseme ç„¡æŠ–å‹•
7. âœ… æ¸¬è©¦é é¢æ‰€æœ‰æ§åˆ¶é …æ­£å¸¸é‹ä½œ

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# 1. å–®å…ƒæ¸¬è©¦
pnpm test blendshape-controller

# é æœŸè¼¸å‡ºï¼š
# âœ“ should initialize successfully with valid mesh
# âœ“ should apply aa viseme correctly
# âœ“ should apply neutral viseme (reset all to 0)
# âœ“ should clamp weight to 0-1 range

# 2. è¦–è¦ºæ¸¬è©¦
pnpm dev
# ç€è¦½å™¨é–‹å•Ÿ http://localhost:3000/test-lipsync

# æ¸¬è©¦é …ç›®ï¼š
1. é»æ“Š aa â†’ å˜´å·´å¤§å¼µ
2. é»æ“Š E â†’ å˜´å·´åŠé–‹
3. é»æ“Š O â†’ å˜´å·´å˜Ÿèµ·ï¼ˆåœ“å½¢ï¼‰
4. é»æ“Š U â†’ å˜´å·´å˜Ÿèµ·ï¼ˆæ›´ç·Šï¼‰
5. é»æ“Š neutral â†’ å˜´å·´é–‰åˆ
6. èª¿æ•´ Weight æ»‘æ¡¿ â†’ å˜´å‹é–‹åˆç¨‹åº¦å¹³æ»‘è®ŠåŒ–
7. å¿«é€Ÿåˆ‡æ›ä¸åŒ Viseme â†’ éæ¸¡æµæš¢ç„¡æŠ–å‹•
```

**é©—è­‰æ¸…å–®**:
- [ ] å–®å…ƒæ¸¬è©¦å…¨éƒ¨é€šéï¼ˆ`pnpm test`ï¼‰
- [ ] Avatar blendshapes æ­£ç¢ºè­˜åˆ¥ï¼ˆinspect è…³æœ¬è¼¸å‡ºï¼‰
- [ ] æ‰€æœ‰ Viseme é¡å‹å˜´å‹æ­£ç¢ºï¼ˆè¦–è¦ºç¢ºèªï¼‰
- [ ] Weight æ»‘æ¡¿èª¿æ•´å¹³æ»‘ç„¡è·³èº
- [ ] å¿«é€Ÿåˆ‡æ› Viseme ç„¡æŠ–å‹•ï¼ˆé–‹å•Ÿ/é—œé–‰ smooth å°æ¯”ï¼‰
- [ ] console.log è¼¸å‡ºæ¸…æ™°ï¼ˆcontroller åˆå§‹åŒ–è¨Šæ¯ï¼‰
- [ ] TypeScript ç·¨è­¯ç„¡éŒ¯èª¤ï¼ˆ`pnpm build`ï¼‰

### æ•ˆèƒ½è€ƒé‡

**Blendshape æ›´æ–°æ•ˆèƒ½**:
- **æ¯å¹€æ“ä½œ**: ä¿®æ”¹ morphTargetInfluences é™£åˆ—ï¼ˆç´” CPU æ“ä½œï¼‰
- **GPU å½±éŸ¿**: Three.js è‡ªå‹•ä¸Šå‚³è‡³ GPUï¼Œç„¡éœ€æ‰‹å‹•ç®¡ç†
- **æ•ˆèƒ½æˆæœ¬**: æ¯å€‹ blendshape ç´„ 0.01msï¼ˆ60fps ä¸‹å¯æ¥å—ï¼‰
- **æœ€ä½³åŒ–**: åƒ…æ›´æ–°å¿…è¦çš„ blendshapesï¼Œé¿å…å…¨é‡æ›´æ–°

**è¨˜æ†¶é«”ä½¿ç”¨**:
- **Controller å¯¦ä¾‹**: < 1KBï¼ˆåƒ…å„²å­˜ ref èˆ‡æ˜ å°„è¡¨ï¼‰
- **Morph Target æ•¸æ“š**: ç”± Three.js ç®¡ç†ï¼Œè‡ªå‹•é‡‹æ”¾
- **ç„¡è¨˜æ†¶é«”æ´©æ¼**: useRef ç¢ºä¿ controller ç”Ÿå‘½é€±æœŸæ­£ç¢º

**æœªä¾†å„ªåŒ–æ–¹å‘**ï¼ˆMVP éšæ®µï¼‰:
1. **æ‰¹é‡æ›´æ–°**: ç´¯ç©å¤šå€‹ viseme è®Šæ›´ï¼Œä¸€æ¬¡æ›´æ–° influences
2. **Delta æª¢æŸ¥**: åƒ…åœ¨æ¬Šé‡è®ŠåŒ– > é–¾å€¼æ™‚æ›´æ–°ï¼ˆé¿å…å¾®å°æŠ–å‹•ï¼‰
3. **WebWorker**: å°‡ lerp è¨ˆç®—ç§»è‡³ Workerï¼ˆå¯¦é©—æ€§ï¼‰
4. **Shader å„ªåŒ–**: è‡ªè¨‚ Shader æ¸›å°‘ morph target è¨ˆç®—ï¼ˆé€²éšï¼‰

### å®‰å…¨æ€§è€ƒé‡

**å‹åˆ¥å®‰å…¨**:
- âœ… TypeScript åš´æ ¼æ¨¡å¼æª¢æŸ¥æ‰€æœ‰å‹åˆ¥
- âœ… Viseme é¡å‹ä½¿ç”¨ string literal unionï¼ˆé¿å…æ‹¼å¯«éŒ¯èª¤ï¼‰
- âœ… Blendshape åç¨±é€é dictionary æª¢æŸ¥ï¼ˆé¿å…ä¸å­˜åœ¨çš„åç¨±ï¼‰

**éŒ¯èª¤è™•ç†**:
```typescript
// 1. åˆå§‹åŒ–æª¢æŸ¥
if (!mesh.morphTargetDictionary) {
  console.error('Avatar does not have morph targets');
  return false;
}

// 2. æ˜ å°„æª¢æŸ¥
const mapping = this.visemeMap.find(m => m.viseme === viseme);
if (!mapping) {
  console.warn(`No mapping for viseme: ${viseme}`);
  return; // éœé»˜å¤±æ•—ï¼Œä¸å½±éŸ¿å…¶ä»–å‹•ç•«
}

// 3. Blendshape å­˜åœ¨æ€§æª¢æŸ¥
if (blendshapeIndex !== undefined) {
  // åƒ…æ›´æ–°å­˜åœ¨çš„ blendshape
}
```

**é™ç´šæ–¹æ¡ˆ**:
- âœ… è‹¥ Avatar ç„¡ morph targetsï¼Œcontroller åˆå§‹åŒ–å¤±æ•—ä½†ä¸å´©æ½°
- âœ… è‹¥ blendshape åç¨±ä¸å­˜åœ¨ï¼Œè·³éè©² blendshape
- âœ… Story 4.5 å°‡å¯¦ä½œå®Œæ•´é™ç´šæ–¹æ¡ˆï¼ˆç„¡ blendshape æ™‚åƒ…æ’­æ”¾éŸ³è¨Šï¼‰

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 2.2 å·²å®Œæˆï¼ˆAvatar æ¨¡å‹å·²è¼‰å…¥ï¼‰
- âœ… Story 4.1 å·²å®Œæˆï¼ˆViseme å‹åˆ¥å®šç¾©ï¼‰
- âœ… Three.js èˆ‡ React Three Fiber å·²å®‰è£

**å¾ŒçºŒ Story ä¾è³´**:
- **Story 4.3**: æœƒä½¿ç”¨ useBlendshapeController Hook æ•´åˆ Lip Sync
- **Story 4.4**: æœƒèª¿æ•´ viseme æ˜ å°„è¡¨èˆ‡ lerp factor
- **Story 4.5**: æœƒç‚º blendshape æ§åˆ¶åŠ å…¥éŒ¯èª¤è™•ç†

**é—œéµè·¯å¾‘**:
- æœ¬ Story æ˜¯ Lip Sync çš„æ ¸å¿ƒï¼Œå¿…é ˆåœ¨ Story 4.3 å‰å®Œæˆ
- Story 4.3ï¼ˆLip Sync Controllerï¼‰ä¾è³´æœ¬ Story çš„ blendshape æ§åˆ¶
- Story 4.4ï¼ˆè¦–è¦ºå„ªåŒ–ï¼‰ä¾è³´æœ¬ Story çš„æ˜ å°„è¡¨èˆ‡å¹³æ»‘é‚è¼¯

**èˆ‡å…¶ä»– Epic æ•´åˆ**:
- ä½¿ç”¨ Epic 2 çš„ AvatarModel çµ„ä»¶
- ä½¿ç”¨ Story 4.1 çš„ VisemeType å‹åˆ¥å®šç¾©
- æœªä¾† Story 4.3 æœƒæ•´åˆ Epic 3 çš„ audioStore

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 4.2 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
