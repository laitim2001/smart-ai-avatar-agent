# Story 2.5: Avatar é¸æ“‡åŠŸèƒ½èˆ‡åˆ‡æ›

## Status
Approved

---

## Story

**As a** ä½¿ç”¨è€…,
**I want** èƒ½å¤ é¸æ“‡èˆ‡åˆ‡æ›ä¸åŒçš„ 3D Avatarï¼Œ
**so that** å¯ä»¥è‡ªè¨‚èŠå¤©åŠ©ç†çš„å¤–è§€ï¼Œæå‡å€‹äººåŒ–é«”é©—ã€‚

---

## Acceptance Criteria

1. å»ºç«‹ `components/avatar/AvatarSelector.tsx` çµ„ä»¶ï¼Œé¡¯ç¤º 3 å€‹ Avatar é è¦½å¡ç‰‡
2. æ¯å€‹å¡ç‰‡é¡¯ç¤º Avatar ç¸®åœ–ã€åç¨±ã€èˆ‡ã€Œé¸æ“‡ã€æŒ‰éˆ•
3. ç•¶å‰é¸ä¸­çš„ Avatar å¡ç‰‡æœ‰è¦–è¦ºæ¨™è¨˜ï¼ˆé‚Šæ¡†é«˜äº®ï¼‰
4. é»æ“Šã€Œé¸æ“‡ã€æŒ‰éˆ•å¾Œï¼Œå ´æ™¯ä¸­çš„ Avatar æ¨¡å‹åˆ‡æ›ç‚ºæ–°çš„ Avatar
5. ä½¿ç”¨ Zustand ç®¡ç† Avatar é¸æ“‡ç‹€æ…‹ï¼ˆå…¨åŸŸç‹€æ…‹ç®¡ç†ï¼‰
6. Avatar åˆ‡æ›æ™‚æœ‰æ·¡å…¥æ·¡å‡ºéæ¸¡æ•ˆæœï¼ˆfade transitionï¼‰
7. åœ¨é é¢å³å´åŠ å…¥ã€ŒChange Avatarã€æŒ‰éˆ•ï¼Œé»æ“Šå¾Œé¡¯ç¤º/éš±è— Selector
8. Selector ä½¿ç”¨éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œæ”¯æ´æ¡Œé¢èˆ‡è¡Œå‹•è£ç½®

---

## Tasks / Subtasks

- [ ] **Task 1: å®‰è£ Zustand ç‹€æ…‹ç®¡ç†** (AC: 5)
  - [ ] åŸ·è¡Œ `pnpm add zustand`ï¼ˆç‰ˆæœ¬ 4.5+ï¼‰
  - [ ] é©—è­‰ `package.json` å·²æ–°å¢ zustand ä¾è³´
  - [ ] åŸ·è¡Œ `pnpm install` ç¢ºä¿å®‰è£æˆåŠŸ

- [ ] **Task 2: å»ºç«‹ Avatar Storeï¼ˆZustandï¼‰** (AC: 5)
  - [ ] å»ºç«‹ç›®éŒ„ `stores/`ï¼ˆå¦‚å°šæœªå­˜åœ¨ï¼‰
  - [ ] å»ºç«‹ `stores/avatarStore.ts` æª”æ¡ˆ
  - [ ] å¯¦ä½œ Zustand Storeï¼š
    ```typescript
    import { create } from 'zustand';
    import { AVATAR_URLS } from '@/lib/avatar/constants';

    export interface AvatarState {
      currentAvatarId: string;
      currentAvatarUrl: string;
      isSelectorOpen: boolean;
      setAvatar: (avatarId: string) => void;
      toggleSelector: () => void;
    }

    // Avatar æ¸…å–®
    export const AVATARS = [
      {
        id: 'avatar1',
        name: 'Alex',
        url: AVATAR_URLS.avatar1,
        thumbnail: '/avatars/alex-thumb.jpg',  // å¾ŒçºŒåŠ å…¥
      },
      {
        id: 'avatar2',
        name: 'Jordan',
        url: AVATAR_URLS.avatar2,
        thumbnail: '/avatars/jordan-thumb.jpg',
      },
      {
        id: 'avatar3',
        name: 'Casey',
        url: AVATAR_URLS.avatar3,
        thumbnail: '/avatars/casey-thumb.jpg',
      },
    ];

    export const useAvatarStore = create<AvatarState>((set) => ({
      currentAvatarId: 'avatar1',
      currentAvatarUrl: AVATAR_URLS.avatar1,
      isSelectorOpen: false,

      setAvatar: (avatarId: string) => {
        const avatar = AVATARS.find((a) => a.id === avatarId);
        if (avatar) {
          set({
            currentAvatarId: avatarId,
            currentAvatarUrl: avatar.url,
          });
        }
      },

      toggleSelector: () => {
        set((state) => ({ isSelectorOpen: !state.isSelectorOpen }));
      },
    }));
    ```
  - [ ] åŠ å…¥ TypeScript å‹åˆ¥å®šç¾©èˆ‡ JSDoc è¨»è§£

- [ ] **Task 3: æ›´æ–° lib/avatar/constants.ts** (AC: 1)
  - [ ] é–‹å•Ÿ `lib/avatar/constants.ts`
  - [ ] ç¢ºä¿ AVATAR_URLS åŒ…å« 3 å€‹ Avatar URLï¼š
    ```typescript
    export const AVATAR_URLS = {
      avatar1: 'https://models.readyplayer.me/{id1}.glb',
      avatar2: 'https://models.readyplayer.me/{id2}.glb',
      avatar3: 'https://models.readyplayer.me/{id3}.glb',
    } as const;
    ```
  - [ ] æ›¿æ›ç‚ºå¯¦éš›çš„ Ready Player Me Avatar URL

- [ ] **Task 4: å»ºç«‹ AvatarSelector çµ„ä»¶** (AC: 1, 2, 3)
  - [ ] å»ºç«‹ `components/avatar/AvatarSelector.tsx` æª”æ¡ˆ
  - [ ] å¯¦ä½œ Selector UIï¼š
    ```typescript
    'use client';

    import { useAvatarStore, AVATARS } from '@/stores/avatarStore';
    import { useState } from 'react';

    export default function AvatarSelector() {
      const { currentAvatarId, setAvatar, isSelectorOpen, toggleSelector } = useAvatarStore();

      if (!isSelectorOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-slate-800 rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">Choose Your Avatar</h2>
              <button
                onClick={toggleSelector}
                className="text-gray-400 hover:text-white transition-colors"
                aria-label="Close avatar selector"
              >
                âœ•
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {AVATARS.map((avatar) => {
                const isSelected = currentAvatarId === avatar.id;

                return (
                  <div
                    key={avatar.id}
                    className={`
                      bg-slate-700 rounded-lg p-4 cursor-pointer transition-all
                      ${isSelected ? 'ring-4 ring-blue-500 shadow-xl' : 'hover:bg-slate-600'}
                    `}
                    onClick={() => setAvatar(avatar.id)}
                  >
                    {/* Avatar ç¸®åœ–ï¼ˆæš«æ™‚ä½¿ç”¨ placeholderï¼‰*/}
                    <div className="aspect-square bg-slate-600 rounded-lg mb-3 flex items-center justify-center">
                      <span className="text-6xl">{avatar.id === 'avatar1' ? 'ğŸ‘¨' : avatar.id === 'avatar2' ? 'ğŸ‘©' : 'ğŸ§‘'}</span>
                    </div>

                    {/* Avatar åç¨± */}
                    <h3 className="text-lg font-semibold text-white text-center mb-2">
                      {avatar.name}
                    </h3>

                    {/* é¸æ“‡æŒ‰éˆ• */}
                    <button
                      className={`
                        w-full py-2 rounded-md font-medium transition-colors
                        ${
                          isSelected
                            ? 'bg-blue-500 text-white'
                            : 'bg-slate-600 text-gray-300 hover:bg-slate-500'
                        }
                      `}
                      onClick={(e) => {
                        e.stopPropagation();
                        setAvatar(avatar.id);
                        toggleSelector();
                      }}
                    >
                      {isSelected ? 'âœ“ Selected' : 'Select'}
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }
    ```

- [ ] **Task 5: å»ºç«‹ã€ŒChange Avatarã€è§¸ç™¼æŒ‰éˆ•** (AC: 7)
  - [ ] å»ºç«‹ `components/avatar/AvatarChangeButton.tsx` æª”æ¡ˆ
  - [ ] å¯¦ä½œè§¸ç™¼æŒ‰éˆ•ï¼š
    ```typescript
    'use client';

    import { useAvatarStore } from '@/stores/avatarStore';

    export default function AvatarChangeButton() {
      const toggleSelector = useAvatarStore((state) => state.toggleSelector);

      return (
        <button
          onClick={toggleSelector}
          className="fixed top-6 right-6 z-40 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow-lg transition-colors font-medium"
          aria-label="Change avatar"
        >
          ğŸ­ Change Avatar
        </button>
      );
    }
    ```

- [ ] **Task 6: æ•´åˆ Zustand Store è‡³ AvatarCanvas** (AC: 4, 5)
  - [ ] é–‹å•Ÿ `components/avatar/AvatarCanvas.tsx`
  - [ ] å¼•å…¥ useAvatarStore Hook
  - [ ] ä½¿ç”¨ Store ä¸­çš„ currentAvatarUrlï¼š
    ```typescript
    import { useAvatarStore } from '@/stores/avatarStore';

    export default function AvatarCanvas() {
      const currentAvatarUrl = useAvatarStore((state) => state.currentAvatarUrl);
      const avatarModelRef = useRef<AvatarModelHandle>(null);

      return (
        <div className="relative w-full h-screen">
          <Canvas>
            {/* ... å ´æ™¯å…§å®¹ */}
            <Suspense fallback={<AvatarLoader />}>
              <AvatarModel
                key={currentAvatarUrl}  // å¼·åˆ¶é‡æ–°è¼‰å…¥
                ref={avatarModelRef}
                modelUrl={currentAvatarUrl}
                position={[0, -1, 0]}
                scale={1}
              />
            </Suspense>
          </Canvas>

          {/* æ§åˆ¶é¢æ¿ */}
          <AvatarControlPanel avatarRef={avatarModelRef} />
        </div>
      );
    }
    ```

- [ ] **Task 7: å¯¦ä½œæ·¡å…¥æ·¡å‡ºéæ¸¡æ•ˆæœ** (AC: 6)
  - [ ] åœ¨ AvatarModel çµ„ä»¶ä¸­åŠ å…¥ opacity å‹•ç•«
  - [ ] æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ React Three Fiber çš„ useSpringï¼ˆéœ€å®‰è£ @react-spring/threeï¼‰
  - [ ] æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ CSS opacity + React ç‹€æ…‹ï¼ˆè¼ƒç°¡å–®ï¼‰
  - [ ] å¯¦ä½œæ–¹æ¡ˆ 2ï¼ˆæ¨è–¦ï¼‰ï¼š
    ```typescript
    // components/avatar/AvatarCanvas.tsx
    const [isTransitioning, setIsTransitioning] = useState(false);

    useEffect(() => {
      // Avatar URL è®Šæ›´æ™‚è§¸ç™¼éæ¸¡
      setIsTransitioning(true);
      const timer = setTimeout(() => {
        setIsTransitioning(false);
      }, 300); // 300ms æ·¡å…¥

      return () => clearTimeout(timer);
    }, [currentAvatarUrl]);

    return (
      <Canvas className={`transition-opacity duration-300 ${isTransitioning ? 'opacity-0' : 'opacity-100'}`}>
        {/* ... */}
      </Canvas>
    );
    ```
  - [ ] æ¸¬è©¦éæ¸¡æ•ˆæœå¹³æ»‘åº¦

- [ ] **Task 8: æ•´åˆæ‰€æœ‰çµ„ä»¶è‡³ä¸»é é¢** (AC: 7, 8)
  - [ ] é–‹å•Ÿ `app/page.tsx`
  - [ ] å¼•å…¥ AvatarSelector èˆ‡ AvatarChangeButton
  - [ ] æ›´æ–°é é¢çµæ§‹ï¼š
    ```typescript
    import AvatarCanvas from '@/components/avatar/AvatarCanvas';
    import AvatarSelector from '@/components/avatar/AvatarSelector';
    import AvatarChangeButton from '@/components/avatar/AvatarChangeButton';

    export default function Home() {
      return (
        <main className="relative flex min-h-screen flex-col">
          {/* 3D å ´æ™¯ */}
          <AvatarCanvas />

          {/* Change Avatar æŒ‰éˆ• */}
          <AvatarChangeButton />

          {/* Avatar é¸æ“‡å™¨ï¼ˆModalï¼‰*/}
          <AvatarSelector />
        </main>
      );
    }
    ```

- [ ] **Task 9: éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´** (AC: 8)
  - [ ] æ¸¬è©¦ Selector åœ¨ä¸åŒè¢å¹•å°ºå¯¸çš„é¡¯ç¤º
  - [ ] èª¿æ•´ Tailwind CSS æ–·é»ï¼š
    ```typescript
    // æ¡Œé¢ç‰ˆï¼š3 æ¬„
    className="grid grid-cols-1 md:grid-cols-3 gap-4"

    // å¹³æ¿ç‰ˆï¼š2 æ¬„
    className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"

    // è¡Œå‹•ç‰ˆï¼š1 æ¬„ï¼ˆé è¨­ï¼‰
    ```
  - [ ] æ¸¬è©¦è¡Œå‹•è£ç½®è§¸æ§æ“ä½œ
  - [ ] ç¢ºä¿æŒ‰éˆ•èˆ‡å¡ç‰‡å¤§å°é©åˆè§¸æ§ï¼ˆâ‰¥44px é«˜åº¦ï¼‰

- [ ] **Task 10: Avatar åˆ‡æ›åŠŸèƒ½æ¸¬è©¦** (AC: 4, 5, 6)
  - [ ] åŸ·è¡Œ `pnpm dev`ï¼Œé–‹å•Ÿé é¢
  - [ ] é»æ“Šã€ŒğŸ­ Change Avatarã€æŒ‰éˆ•
  - [ ] é©—è­‰ä»¥ä¸‹é …ç›®ï¼š
    - âœ… Selector Modal é¡¯ç¤º
    - âœ… 3 å€‹ Avatar å¡ç‰‡æ­£ç¢ºé¡¯ç¤º
    - âœ… ç•¶å‰ Avatar æœ‰é«˜äº®é‚Šæ¡†
    - âœ… é»æ“Šå…¶ä»– Avatar å¡ç‰‡
    - âœ… å ´æ™¯ä¸­ Avatar åˆ‡æ›ç‚ºæ–°çš„æ¨¡å‹
    - âœ… åˆ‡æ›éç¨‹æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ
    - âœ… Selector è‡ªå‹•é—œé–‰
  - [ ] æ¸¬è©¦å¿«é€Ÿé€£çºŒåˆ‡æ›ï¼ˆ3 æ¬¡ï¼‰
  - [ ] é©—è­‰ Avatar å‹•ç•«ï¼ˆå‘¼å¸ã€çœ¨çœ¼ï¼‰åœ¨åˆ‡æ›å¾Œæ­£å¸¸é‹ä½œ

- [ ] **Task 11: ç‹€æ…‹æŒä¹…åŒ–ï¼ˆé¸åšï¼‰** (AC: 5)
  - [ ] ä½¿ç”¨ localStorage å„²å­˜ä½¿ç”¨è€…é¸æ“‡ï¼š
    ```typescript
    // stores/avatarStore.ts
    import { create } from 'zustand';
    import { persist } from 'zustand/middleware';

    export const useAvatarStore = create<AvatarState>()(
      persist(
        (set) => ({
          // ... store é‚è¼¯
        }),
        {
          name: 'avatar-storage',  // localStorage key
        }
      )
    );
    ```
  - [ ] æ¸¬è©¦é‡æ–°æ•´ç†é é¢ï¼ŒAvatar é¸æ“‡æ˜¯å¦ä¿ç•™

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

Epic 2 Story 2.5 å®Œæˆå¾Œçš„æª”æ¡ˆçµæ§‹ï¼š

```
avatar-chat-poc/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ avatar/
â”‚       â”œâ”€â”€ AvatarCanvas.tsx        # æ›´æ–°ï¼šä½¿ç”¨ Zustand Store
â”‚       â”œâ”€â”€ AvatarModel.tsx
â”‚       â”œâ”€â”€ AvatarSelector.tsx      # æ–°å¢ï¼šAvatar é¸æ“‡å™¨ UI
â”‚       â”œâ”€â”€ AvatarChangeButton.tsx  # æ–°å¢ï¼šè§¸ç™¼æŒ‰éˆ•
â”‚       â”œâ”€â”€ AvatarControlPanel.tsx
â”‚       â”œâ”€â”€ AvatarLoadingState.tsx
â”‚       â””â”€â”€ hooks/
â”‚           â””â”€â”€ useAvatarAnimation.ts
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ avatarStore.ts              # æ–°å¢ï¼šZustand å…¨åŸŸç‹€æ…‹
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ avatar/
â”‚       â”œâ”€â”€ loaders.ts
â”‚       â”œâ”€â”€ constants.ts            # æ›´æ–°ï¼š3 å€‹ Avatar URLs
â”‚       â””â”€â”€ animations.ts
â”œâ”€â”€ types/
â”‚   â””â”€â”€ avatar.ts
â””â”€â”€ app/
    â””â”€â”€ page.tsx                    # æ›´æ–°ï¼šæ•´åˆæ‰€æœ‰ Avatar çµ„ä»¶
```

### Zustand ç‹€æ…‹ç®¡ç†èªªæ˜

**ç‚ºä½•é¸æ“‡ Zustandï¼Ÿ**
- âœ… è¼•é‡ç´šï¼ˆ1KB gzippedï¼‰
- âœ… ç„¡ Provider åŒ…è£¹éœ€æ±‚ï¼ˆç°¡åŒ–æ¶æ§‹ï¼‰
- âœ… TypeScript åŸç”Ÿæ”¯æ´
- âœ… æ”¯æ´ Middlewareï¼ˆå¦‚ persistï¼‰
- âœ… æ€§èƒ½å„ªç•°ï¼ˆé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ï¼‰
- âœ… å­¸ç¿’æ›²ç·šå¹³ç·©

**èˆ‡å…¶ä»–ç‹€æ…‹ç®¡ç†æ¯”è¼ƒ**:
| ç‰¹æ€§ | Zustand | Redux | Context API |
|------|---------|-------|-------------|
| å¤§å° | 1KB | 7KB+ | 0KB (å…§å»º) |
| è¨­å®šè¤‡é›œåº¦ | ä½ | é«˜ | ä¸­ |
| Provider éœ€æ±‚ | âŒ | âœ… | âœ… |
| æ•ˆèƒ½ | å„ª | å„ª | ä¸­ï¼ˆæ˜“é‡æ¸²æŸ“ï¼‰ |
| Middleware | âœ… | âœ… | âŒ |

**åŸºæœ¬ç”¨æ³•**:
```typescript
// å»ºç«‹ Store
const useStore = create((set) => ({
  value: 0,
  increment: () => set((state) => ({ value: state.value + 1 })),
}));

// ä½¿ç”¨ Storeï¼ˆçµ„ä»¶ï¼‰
const value = useStore((state) => state.value);
const increment = useStore((state) => state.increment);

// é¸æ“‡æ€§è¨‚é–±ï¼ˆå„ªåŒ–æ•ˆèƒ½ï¼‰
const value = useStore((state) => state.value);  // åªè¨‚é–± value
```

**Persist Middleware**:
```typescript
// è‡ªå‹•å„²å­˜è‡³ localStorage
persist(
  (set) => ({ /* store é‚è¼¯ */ }),
  { name: 'storage-key' }
);

// çµæœ
localStorage.getItem('storage-key');
// {"state": {"currentAvatarId": "avatar2", ...}}
```

### Avatar åˆ‡æ›æ©Ÿåˆ¶è¨­è¨ˆ

**åˆ‡æ›æµç¨‹**:
```
ä½¿ç”¨è€…é»æ“Šã€ŒChange Avatarã€
    â†“
é¡¯ç¤º AvatarSelector Modal
    â†“
ä½¿ç”¨è€…é¸æ“‡æ–° Avatar
    â†“
setAvatar(newAvatarId) â†’ Zustand Store æ›´æ–°
    â†“
currentAvatarUrl è®Šæ›´ â†’ React é‡æ–°æ¸²æŸ“
    â†“
AvatarModel çµ„ä»¶ key è®Šæ›´ â†’ å¼·åˆ¶é‡æ–°æ›è¼‰
    â†“
useGLTF è¼‰å…¥æ–°æ¨¡å‹ â†’ Suspense é¡¯ç¤º Loader
    â†“
æ–° Avatar æ¸²æŸ“å®Œæˆ
    â†“
æ·¡å…¥æ·¡å‡ºéæ¸¡æ•ˆæœ
```

**å¼·åˆ¶é‡æ–°æ›è¼‰åŸç†**:
```typescript
// key è®Šæ›´ â†’ React é‡æ–°å»ºç«‹çµ„ä»¶å¯¦ä¾‹
<AvatarModel
  key={currentAvatarUrl}  // æ¯æ¬¡ URL è®Šæ›´ï¼Œkey ä¹Ÿè®Šæ›´
  modelUrl={currentAvatarUrl}
/>

// æ•ˆæœ
Avatar1 è¼‰å…¥ â†’ key="url1" â†’ çµ„ä»¶ A
Avatar2 é¸æ“‡ â†’ key="url2" â†’ çµ„ä»¶ A å¸è¼‰ï¼Œçµ„ä»¶ B æ›è¼‰
```

**ç‚ºä½•ä¸ä½¿ç”¨ useEffect åˆ‡æ›ï¼Ÿ**
```typescript
// ä¸æ¨è–¦ï¼ˆæœƒæœ‰å¿«å–å•é¡Œï¼‰
useEffect(() => {
  loadNewAvatar(currentAvatarUrl);
}, [currentAvatarUrl]);

// æ¨è–¦ï¼ˆåˆ©ç”¨ React key æ©Ÿåˆ¶ï¼‰
<AvatarModel key={currentAvatarUrl} ... />
```

### æ·¡å…¥æ·¡å‡ºéæ¸¡æ•ˆæœ

**æ–¹æ¡ˆæ¯”è¼ƒ**:
| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | æ¨è–¦åº¦ |
|------|------|------|--------|
| CSS Opacity | ç°¡å–®ã€æ•ˆèƒ½å¥½ | Canvas æ•´é«”æ·¡å…¥æ·¡å‡º | â­â­â­ |
| React Spring | å‹•ç•«æµæš¢ã€å½ˆæ€§ | éœ€è¦é¡å¤–ä¾è³´ | â­â­ |
| Three.js Opacity | é‡å°æ¨¡å‹æ·¡å…¥æ·¡å‡º | è¤‡é›œã€æ•ˆèƒ½è¼ƒå·® | â­ |

**å¯¦ä½œæ–¹æ¡ˆ 1: CSS Opacityï¼ˆæ¨è–¦ï¼‰**
```typescript
const [isTransitioning, setIsTransitioning] = useState(false);

useEffect(() => {
  setIsTransitioning(true);
  setTimeout(() => setIsTransitioning(false), 300);
}, [currentAvatarUrl]);

<Canvas className={`transition-opacity duration-300 ${isTransitioning ? 'opacity-0' : 'opacity-100'}`}>
```

**å¯¦ä½œæ–¹æ¡ˆ 2: React Springï¼ˆé€²éšï¼‰**
```typescript
import { useSpring, animated } from '@react-spring/three';

const AnimatedGroup = animated('group');
const springs = useSpring({
  opacity: isTransitioning ? 0 : 1,
  config: { duration: 300 },
});

<AnimatedGroup material-opacity={springs.opacity}>
  <primitive object={scene} />
</AnimatedGroup>
```

### UI/UX è¨­è¨ˆè€ƒé‡

**Modal è¨­è¨ˆåŸå‰‡**:
- èƒŒæ™¯é®ç½©ï¼ˆbackdropï¼‰ï¼šåŠé€æ˜é»‘è‰² + æ¨¡ç³Šæ•ˆæœ
- å…§å®¹å€åŸŸï¼šæ·±è‰²å¡ç‰‡ï¼ˆé…åˆ 3D å ´æ™¯ï¼‰
- é—œé–‰æ©Ÿåˆ¶ï¼šX æŒ‰éˆ• + é»æ“ŠèƒŒæ™¯é—œé–‰ï¼ˆå¯é¸ï¼‰
- å‹•ç•«ï¼šæ·¡å…¥æ·¡å‡º + Scale è®ŠåŒ–ï¼ˆå¯é¸ï¼‰

**å¡ç‰‡é¸æ“‡è¦–è¦ºå›é¥‹**:
```typescript
// æœªé¸ä¸­
className="bg-slate-700 hover:bg-slate-600"

// å·²é¸ä¸­
className="bg-slate-700 ring-4 ring-blue-500 shadow-xl"

// æ‡¸æµ®æ•ˆæœ
className="transition-all hover:scale-105"
```

**è§¸æ§å‹å–„è¨­è¨ˆ**:
- æŒ‰éˆ•æœ€å°é«˜åº¦ï¼š44pxï¼ˆApple å»ºè­°ï¼‰
- å¡ç‰‡é–“è·ï¼šâ‰¥16pxï¼ˆé¿å…èª¤è§¸ï¼‰
- é»æ“Šå€åŸŸï¼šæ•´å¼µå¡ç‰‡å¯é»æ“Šï¼ˆä¸åªæŒ‰éˆ•ï¼‰

**å¯è¨ªå•æ€§ï¼ˆAccessibilityï¼‰**:
```typescript
// èªç¾©åŒ– HTML
<button aria-label="Close avatar selector">
<div role="dialog" aria-modal="true">

// éµç›¤å°èˆª
<button
  onKeyDown={(e) => {
    if (e.key === 'Escape') toggleSelector();
  }}
>
```

### éŸ¿æ‡‰å¼è¨­è¨ˆç­–ç•¥

**Tailwind CSS æ–·é»**:
```typescript
// è¡Œå‹•ç‰ˆï¼ˆ<640pxï¼‰
className="grid grid-cols-1"

// å¹³æ¿ç‰ˆï¼ˆ640px-768pxï¼‰
className="sm:grid-cols-2"

// æ¡Œé¢ç‰ˆï¼ˆ>768pxï¼‰
className="md:grid-cols-3"
```

**æ¸¬è©¦è£ç½®æ¸…å–®**:
- iPhone SE (375px)
- iPhone 12 Pro (390px)
- iPad (768px)
- iPad Pro (1024px)
- Desktop (1920px)

**è¡Œå‹•ç‰ˆå„ªåŒ–**:
```typescript
// Modal å…¨è¢å¹•
className="fixed inset-0 md:inset-auto md:max-w-2xl"

// å­—é«”å¤§å°èª¿æ•´
className="text-sm md:text-base"

// é–“è·ç¸®å°
className="gap-3 md:gap-4"
```

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•ä½¿ç”¨ Modal è€Œé Sidebarï¼Ÿ**
   - âœ… èšç„¦ä½¿ç”¨è€…æ³¨æ„åŠ›
   - âœ… ä¸ä½”ç”¨å ´æ™¯ç©ºé–“
   - âœ… è¡Œå‹•è£ç½®å‹å–„
   - âŒ Sidebar æœƒé®æ“‹ Avatar

2. **ç‚ºä½•ä½¿ç”¨å…¨åŸŸç‹€æ…‹ï¼ˆZustandï¼‰è€Œé Propsï¼Ÿ**
   ```typescript
   // Props å‚³éï¼ˆä¸æ¨è–¦ï¼‰
   <Page>
     <AvatarCanvas currentAvatar={avatar}>
       <AvatarModel avatar={avatar} />
     </AvatarCanvas>
     <AvatarSelector setAvatar={setAvatar} />
   </Page>

   // Zustandï¼ˆæ¨è–¦ï¼‰
   const avatar = useAvatarStore((state) => state.currentAvatarUrl);
   // ä»»ä½•çµ„ä»¶éƒ½å¯ç›´æ¥å­˜å–ï¼Œç„¡éœ€ Props drilling
   ```

3. **Avatar ç¸®åœ–ç­–ç•¥**:
   - POC éšæ®µï¼šä½¿ç”¨ Emoji placeholderï¼ˆğŸ‘¨ğŸ‘©ğŸ§‘ï¼‰
   - æœªä¾†å„ªåŒ–ï¼š
     - æ–¹æ¡ˆ 1ï¼šReady Player Me API å–å¾—ç¸®åœ–
     - æ–¹æ¡ˆ 2ï¼šThree.js æ¸²æŸ“ç¸®åœ–ï¼ˆè¤‡é›œï¼‰
     - æ–¹æ¡ˆ 3ï¼šæ‰‹å‹•æˆªåœ–ä¸¦ä¸Šå‚³

4. **ç‹€æ…‹æŒä¹…åŒ–æ±ºç­–**:
   - ä½¿ç”¨ persist middleware å„²å­˜ä½¿ç”¨è€…é¸æ“‡
   - localStorage å„²å­˜ Avatar IDï¼ˆä¸å„²å­˜ URLï¼‰
   - é‡æ–°æ•´ç†é é¢å¾Œä¿ç•™é¸æ“‡

### Testing

**æ¸¬è©¦æ¡†æ¶**: æ‰‹å‹•æ¸¬è©¦ + äº’å‹•æ¸¬è©¦ + éŸ¿æ‡‰å¼æ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
1. âœ… Zustand Store æ­£ç¢ºç®¡ç†ç‹€æ…‹
2. âœ… Avatar Selector UI æ­£ç¢ºé¡¯ç¤º
3. âœ… Change Avatar æŒ‰éˆ•å¯è§¸ç™¼ Selector
4. âœ… å¡ç‰‡é¸ä¸­è¦–è¦ºå›é¥‹æ­£ç¢º
5. âœ… Avatar åˆ‡æ›åŠŸèƒ½æ­£å¸¸
6. âœ… æ·¡å…¥æ·¡å‡ºéæ¸¡æ•ˆæœå¹³æ»‘
7. âœ… éŸ¿æ‡‰å¼è¨­è¨ˆåœ¨å„è£ç½®æ­£å¸¸
8. âœ… ç‹€æ…‹æŒä¹…åŒ–åŠŸèƒ½æ­£å¸¸

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
pnpm dev

# ç€è¦½å™¨é–‹å•Ÿ
http://localhost:3000

# æ¸¬è©¦é …ç›®
1. é»æ“Šã€ŒChange Avatarã€æŒ‰éˆ•
2. é©—è­‰ Selector Modal é¡¯ç¤º
3. è§€å¯Ÿ 3 å€‹ Avatar å¡ç‰‡
4. é»æ“Šä¸åŒ Avatar å¡ç‰‡
5. è§€å¯Ÿå ´æ™¯ä¸­ Avatar åˆ‡æ›
6. æ¸¬è©¦æ·¡å…¥æ·¡å‡ºæ•ˆæœ
7. é‡æ–°æ•´ç†é é¢ï¼Œé©—è­‰é¸æ“‡ä¿ç•™
8. èª¿æ•´ç€è¦½å™¨è¦–çª—å¤§å°ï¼Œæ¸¬è©¦éŸ¿æ‡‰å¼
```

**é©—è­‰æ¸…å–®**:
- [ ] Zustand Store å®‰è£æˆåŠŸ
- [ ] Change Avatar æŒ‰éˆ•é¡¯ç¤ºåœ¨å³ä¸Šè§’
- [ ] é»æ“ŠæŒ‰éˆ•é¡¯ç¤º Selector Modal
- [ ] Modal èƒŒæ™¯æœ‰é®ç½©èˆ‡æ¨¡ç³Šæ•ˆæœ
- [ ] 3 å€‹ Avatar å¡ç‰‡æ­£ç¢ºé¡¯ç¤º
- [ ] ç•¶å‰ Avatar æœ‰è—è‰²é‚Šæ¡†é«˜äº®
- [ ] é»æ“Šå¡ç‰‡åˆ‡æ› Avatar
- [ ] åˆ‡æ›éç¨‹æœ‰æ·¡å…¥æ·¡å‡ºæ•ˆæœ
- [ ] åˆ‡æ›å¾Œå‹•ç•«ï¼ˆå‘¼å¸ã€çœ¨çœ¼ï¼‰æ­£å¸¸
- [ ] X æŒ‰éˆ•å¯é—œé–‰ Selector
- [ ] é‡æ–°æ•´ç†å¾Œ Avatar é¸æ“‡ä¿ç•™
- [ ] è¡Œå‹•è£ç½®ç‰ˆé¢æ­£å¸¸é¡¯ç¤º

### å·²çŸ¥å•é¡Œèˆ‡æ³¨æ„äº‹é …

**æ•ˆèƒ½è€ƒé‡**:
- âš ï¸ åˆ‡æ› Avatar éœ€é‡æ–°è¼‰å…¥ GLBï¼ˆ2-5 ç§’ï¼‰
- âš ï¸ é »ç¹åˆ‡æ›æœƒå¢åŠ ç¶²è·¯æµé‡
- è§£æ±ºæ–¹æ¡ˆï¼šuseGLTF å…§å»ºå¿«å–æ©Ÿåˆ¶

**ç¸®åœ–é¡¯ç¤º**:
- âš ï¸ ç•¶å‰ä½¿ç”¨ Emoji placeholder
- âš ï¸ æ­£å¼ç‰ˆéœ€å¯¦ä½œçœŸå¯¦ Avatar ç¸®åœ–
- è§£æ±ºæ–¹æ¡ˆï¼šReady Player Me API æˆ–æ‰‹å‹•æˆªåœ–

**ç‹€æ…‹åŒæ­¥**:
- âš ï¸ å¦‚å¤šå€‹è¦–çª—é–‹å•Ÿï¼Œç‹€æ…‹ä¸æœƒåŒæ­¥
- è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ localStorage äº‹ä»¶ç›£è½ï¼ˆé€²éšï¼‰

**å¿«å–ç®¡ç†**:
- âš ï¸ é•·æ™‚é–“ä½¿ç”¨å¯èƒ½ä½”ç”¨å¤§é‡è¨˜æ†¶é«”ï¼ˆå¤šå€‹ Avatar å¿«å–ï¼‰
- è§£æ±ºæ–¹æ¡ˆï¼šå®šæœŸæ¸…ç† useGLTF å¿«å–ï¼ˆæ­£å¼ç‰ˆï¼‰

### æ•ˆèƒ½å„ªåŒ–å»ºè­°

**å„ªåŒ– 1: é è¼‰å…¥ Avatar**
```typescript
// é å…ˆè¼‰å…¥æ‰€æœ‰ Avatarï¼Œæ¸›å°‘åˆ‡æ›ç­‰å¾…
import { preloadAvatar } from '@/components/avatar/AvatarModel';

useEffect(() => {
  AVATARS.forEach((avatar) => {
    preloadAvatar(avatar.url);
  });
}, []);
```

**å„ªåŒ– 2: ç¸®åœ–å¿«å–**
```typescript
// ä½¿ç”¨ Next.js Image çµ„ä»¶å„ªåŒ–ç¸®åœ–è¼‰å…¥
import Image from 'next/image';

<Image
  src={avatar.thumbnail}
  alt={avatar.name}
  width={200}
  height={200}
  className="rounded-lg"
/>
```

**å„ªåŒ– 3: è™›æ“¬åŒ–åˆ—è¡¨**
```typescript
// å¦‚ Avatar æ•¸é‡ > 10ï¼Œä½¿ç”¨è™›æ“¬åŒ–åˆ—è¡¨
import { useVirtualizer } from '@tanstack/react-virtual';

// åªæ¸²æŸ“å¯è¦‹çš„å¡ç‰‡ï¼Œæå‡æ•ˆèƒ½
```

**å„ªåŒ– 4: è¨˜æ†¶é«”ç®¡ç†**
```typescript
// å®šæœŸæ¸…ç† useGLTF å¿«å–
import { useGLTF } from '@react-three/drei';

// æ¸…ç†æ‰€æœ‰å¿«å–
useGLTF.clear();

// æ¸…ç†ç‰¹å®šæ¨¡å‹
useGLTF.clear(modelUrl);
```

### æœªä¾†æ“´å±•æ–¹å‘

**é€²éšåŠŸèƒ½**:
1. **Avatar è‡ªè¨‚**:
   - æ•´åˆ Ready Player Me Creator
   - å…è¨±ä½¿ç”¨è€…å»ºç«‹è‡ªå·±çš„ Avatar
   - å„²å­˜è‡ªè¨‚ Avatar URL

2. **Avatar åˆ†é¡**:
   - åˆ†é¡ï¼šç”·æ€§ã€å¥³æ€§ã€ä¸­æ€§ã€å¡é€š
   - æ¨™ç±¤ï¼šä¼‘é–’ã€æ­£å¼ã€ç§‘æŠ€ã€è—è¡“
   - æœå°‹èˆ‡ç¯©é¸åŠŸèƒ½

3. **Avatar é è¦½**:
   - æ‡¸æµ®æ™‚é¡¯ç¤º 3D é è¦½ï¼ˆTooltipï¼‰
   - ä½¿ç”¨ç¸®å°ç‰ˆ Three.js å ´æ™¯
   - é¡¯ç¤º Avatar å‹•ç•«é è¦½

4. **ç¤¾äº¤åŠŸèƒ½**:
   - åˆ†äº« Avatar è¨­å®š
   - Avatar æ”¶è—å¤¾
   - ç†±é–€ Avatar æ’è¡Œ

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 2.1 å·²å®Œæˆï¼ˆThree.js å ´æ™¯ï¼‰
- âœ… Story 2.2 å·²å®Œæˆï¼ˆAvatar æ¨¡å‹è¼‰å…¥ï¼‰
- âœ… Story 2.3 å·²å®Œæˆï¼ˆå¾…æ©Ÿå‹•ç•«ï¼‰
- âœ… Story 2.4 å·²å®Œæˆï¼ˆè¡¨æƒ…æ§åˆ¶ï¼‰
- âœ… è‡³å°‘ 3 å€‹ Ready Player Me Avatar GLB URL

**å¾ŒçºŒ Epic ä¾è³´**:
- Epic 3 (Lip Sync): æœƒä½¿ç”¨ç›¸åŒçš„ Avatar
- Epic 4 (æƒ…ç·’ç³»çµ±): æœƒæ ¹æ“šæƒ…ç·’åˆ‡æ›è¡¨æƒ…
- Epic 5 (è¨˜æ†¶åŠŸèƒ½): æœƒè¨˜æ†¶ä½¿ç”¨è€…åå¥½ Avatar

**Epic 2 å®Œæˆæ¨™æº–**:
- âœ… æ‰€æœ‰ 5 å€‹ Stories å®Œæˆ
- âœ… Avatar å¯æ­£å¸¸æ¸²æŸ“èˆ‡åˆ‡æ›
- âœ… å¾…æ©Ÿå‹•ç•«èˆ‡è¡¨æƒ…æ§åˆ¶æ­£å¸¸é‹ä½œ
- âœ… UI äº’å‹•æµæš¢ç„¡ Bug
- âœ… æ•ˆèƒ½é”æ¨™ï¼ˆâ‰¥30 FPSï¼‰

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 2.5 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
