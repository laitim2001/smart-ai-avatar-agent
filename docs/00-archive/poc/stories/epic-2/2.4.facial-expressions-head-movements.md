# Story 2.4: Avatar åŸºæœ¬è¡¨æƒ…èˆ‡é ­éƒ¨å‹•ä½œ

## Status
Approved

---

## Story

**As a** é–‹ç™¼è€…,
**I want** å¯¦ä½œ Avatar çš„åŸºæœ¬è¡¨æƒ…æ§åˆ¶ï¼ˆå¾®ç¬‘ï¼‰èˆ‡é ­éƒ¨å‹•ä½œï¼ˆé»é ­ï¼‰ï¼Œ
**so that** Avatar å¯ä»¥è¡¨é”æƒ…ç·’èˆ‡å›æ‡‰ï¼Œæå‡äº’å‹•é«”é©—ã€‚

---

## Acceptance Criteria

1. åˆ†æ Ready Player Me Avatar å¯ç”¨çš„ Blendshapes æ¸…å–®
2. å¯¦ä½œå¾®ç¬‘è¡¨æƒ…ï¼šä½¿ç”¨ `mouthSmile` Blendshapeï¼ˆå€¼ 0-1ï¼‰
3. å¯¦ä½œé»é ­å‹•ä½œï¼šæ§åˆ¶é ­éƒ¨éª¨æ¶ï¼ˆHead boneï¼‰çš„ X è»¸æ—‹è½‰
4. å»ºç«‹ `useAvatarAnimation` Hook çš„æ“´å±•ï¼Œæ”¯æ´è¡¨æƒ…èˆ‡å‹•ä½œæ§åˆ¶
5. å»ºç«‹æ¸¬è©¦ UIï¼šåŠ å…¥ã€Œå¾®ç¬‘ã€èˆ‡ã€Œé»é ­ã€æŒ‰éˆ•ï¼Œé»æ“Šå¾Œè§¸ç™¼å°æ‡‰å‹•ç•«
6. å‹•ç•«åŸ·è¡Œæ™‚é–“ï¼šå¾®ç¬‘ 0.5 ç§’ï¼Œé»é ­ 1 ç§’ï¼ˆä¸€æ¬¡å®Œæ•´é»é ­ï¼‰
7. å‹•ç•«ä½¿ç”¨ Ease æ›²ç·šï¼Œå¹³æ»‘è‡ªç„¶
8. å‹•ç•«å¯èˆ‡å¾…æ©Ÿå‹•ç•«ä¸¦å­˜ï¼ˆä¸äº’ç›¸è¦†è“‹ï¼‰

---

## Tasks / Subtasks

- [ ] **Task 1: åˆ†æ Avatar Blendshapes** (AC: 1)
  - [ ] é–‹å•Ÿ Chrome DevTools Console
  - [ ] åœ¨ `AvatarModel` çµ„ä»¶çš„ onLoad å›èª¿ä¸­åŠ å…¥é™¤éŒ¯ç¨‹å¼ç¢¼ï¼š
    ```typescript
    onLoad={(model) => {
      const headMesh = model.getObjectByName('Wolf3D_Head') as SkinnedMesh;
      if (headMesh?.morphTargetDictionary) {
        console.log('Available Blendshapes:', Object.keys(headMesh.morphTargetDictionary));
      }
    }}
    ```
  - [ ] è¨˜éŒ„æ‰€æœ‰å¯ç”¨çš„ Blendshape åç¨±
  - [ ] æ‰¾å‡ºä»¥ä¸‹é—œéµ Blendshapesï¼š
    - `mouthSmile`: å¾®ç¬‘
    - `mouthFrown`: çšºçœ‰
    - `eyesWide`: çœå¤§çœ¼ç›
    - `browInnerUp`: æšçœ‰
  - [ ] å»ºç«‹ Blendshape æ–‡ä»¶ï¼š
    ```typescript
    // lib/avatar/constants.ts
    export const BLENDSHAPES = {
      SMILE: 'mouthSmile',
      FROWN: 'mouthFrown',
      EYES_WIDE: 'eyesWide',
      BROW_UP: 'browInnerUp',
      EYES_CLOSED: 'eyesClosed',
    } as const;
    ```

- [ ] **Task 2: æ“´å±•å‹•ç•«å·¥å…·å‡½å¼** (AC: 2, 3, 6, 7)
  - [ ] é–‹å•Ÿ `lib/avatar/animations.ts`
  - [ ] åŠ å…¥è¡¨æƒ…å‹•ç•«æ§åˆ¶å™¨ï¼š
    ```typescript
    /**
     * è¡¨æƒ…å‹•ç•«æ§åˆ¶å™¨
     */
    export class ExpressionController {
      private targetValue: number = 0;
      private currentValue: number = 0;
      private animationDuration: number = 0.5;
      private startTime: number = 0;
      private isAnimating: boolean = false;

      /**
       * è§¸ç™¼è¡¨æƒ…å‹•ç•«
       * @param value - ç›®æ¨™å€¼ (0-1)
       * @param duration - å‹•ç•«æ™‚é•·ï¼ˆç§’ï¼‰
       */
      trigger(value: number, duration: number = 0.5) {
        this.targetValue = value;
        this.animationDuration = duration;
        this.startTime = performance.now() / 1000;
        this.isAnimating = true;
      }

      /**
       * æ›´æ–°è¡¨æƒ…å€¼ä¸¦è¿”å›ç•¶å‰å€¼
       * @param currentTime - ç•¶å‰æ™‚é–“ï¼ˆç§’ï¼‰
       * @returns ç•¶å‰ Blendshape å€¼ (0-1)
       */
      update(currentTime: number): number {
        if (!this.isAnimating) {
          return this.currentValue;
        }

        const elapsed = currentTime - this.startTime;
        const progress = Math.min(elapsed / this.animationDuration, 1);

        // Ease-In-Out æ›²ç·š
        const easedProgress = this.easeInOutCubic(progress);
        this.currentValue = this.currentValue + (this.targetValue - this.currentValue) * easedProgress;

        if (progress >= 1) {
          this.isAnimating = false;
          this.currentValue = this.targetValue;
        }

        return this.currentValue;
      }

      private easeInOutCubic(t: number): number {
        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
      }
    }
    ```
  - [ ] åŠ å…¥é ­éƒ¨å‹•ä½œæ§åˆ¶å™¨ï¼š
    ```typescript
    /**
     * é ­éƒ¨é»é ­å‹•ç•«æ§åˆ¶å™¨
     */
    export class HeadNodController {
      private isNodding: boolean = false;
      private nodStartTime: number = 0;
      private nodDuration: number = 1.0;

      /**
       * è§¸ç™¼é»é ­å‹•ç•«
       * @param duration - é»é ­æ™‚é•·ï¼ˆç§’ï¼‰
       */
      trigger(duration: number = 1.0) {
        this.isNodding = true;
        this.nodStartTime = performance.now() / 1000;
        this.nodDuration = duration;
      }

      /**
       * æ›´æ–°é»é ­å‹•ç•«ä¸¦è¿”å›é ­éƒ¨æ—‹è½‰è§’åº¦
       * @param currentTime - ç•¶å‰æ™‚é–“ï¼ˆç§’ï¼‰
       * @returns X è»¸æ—‹è½‰è§’åº¦ï¼ˆå¼§åº¦ï¼‰
       */
      update(currentTime: number): number {
        if (!this.isNodding) {
          return 0;
        }

        const elapsed = currentTime - this.nodStartTime;
        const progress = elapsed / this.nodDuration;

        if (progress >= 1) {
          this.isNodding = false;
          return 0;
        }

        // æ­£å¼¦æ³¢æ¨¡æ“¬é»é ­ï¼ˆå‘ä¸‹å†å‘ä¸Šï¼‰
        const angle = Math.sin(progress * Math.PI) * 0.3; // æœ€å¤§ 0.3 å¼§åº¦ï¼ˆç´„17åº¦ï¼‰
        return angle;
      }
    }
    ```

- [ ] **Task 3: æ“´å±• useAvatarAnimation Hook** (AC: 4, 8)
  - [ ] é–‹å•Ÿ `components/avatar/hooks/useAvatarAnimation.ts`
  - [ ] åŠ å…¥è¡¨æƒ…èˆ‡é ­éƒ¨å‹•ä½œæ”¯æ´ï¼š
    ```typescript
    import { ExpressionController, HeadNodController } from '@/lib/avatar/animations';
    import { BLENDSHAPES } from '@/lib/avatar/constants';

    export function useAvatarAnimation(avatarRef: React.RefObject<Group>) {
      const blinkController = useRef(new BlinkController());
      const smileController = useRef(new ExpressionController());
      const headNodController = useRef(new HeadNodController());

      // å°å¤–æš´éœ²æ§åˆ¶å‡½å¼
      const controls = {
        smile: (intensity: number = 1.0, duration: number = 0.5) => {
          smileController.current.trigger(intensity, duration);
        },
        nod: (duration: number = 1.0) => {
          headNodController.current.trigger(duration);
        },
      };

      useFrame((state) => {
        if (!avatarRef.current) return;

        const time = state.clock.getElapsedTime();

        // 1. å‘¼å¸å‹•ç•«ï¼ˆStory 2.3ï¼‰
        // ... ä¿ç•™åŸæœ‰ç¨‹å¼ç¢¼

        // 2. çœ¨çœ¼å‹•ç•«ï¼ˆStory 2.3ï¼‰
        // ... ä¿ç•™åŸæœ‰ç¨‹å¼ç¢¼

        // 3. å¾®ç¬‘è¡¨æƒ…å‹•ç•«ï¼ˆæ–°å¢ï¼‰
        const headMesh = avatarRef.current.getObjectByName('Wolf3D_Head') as SkinnedMesh;
        if (headMesh?.morphTargetDictionary && headMesh.morphTargetInfluences) {
          const smileIndex = headMesh.morphTargetDictionary[BLENDSHAPES.SMILE];
          if (smileIndex !== undefined) {
            const smileValue = smileController.current.update(time);
            headMesh.morphTargetInfluences[smileIndex] = smileValue;
          }
        }

        // 4. é»é ­å‹•ä½œï¼ˆæ–°å¢ï¼‰
        const headBone = avatarRef.current.getObjectByName('Head');
        if (headBone) {
          const nodAngle = headNodController.current.update(time);
          headBone.rotation.x = nodAngle;
        }
      });

      return controls;
    }
    ```
  - [ ] æ›´æ–° Hook å›å‚³å€¼å‹åˆ¥ï¼š
    ```typescript
    // types/avatar.ts
    export interface AvatarAnimationControls {
      smile: (intensity?: number, duration?: number) => void;
      nod: (duration?: number) => void;
    }
    ```

- [ ] **Task 4: æ›´æ–° AvatarModel çµ„ä»¶** (AC: 4)
  - [ ] é–‹å•Ÿ `components/avatar/AvatarModel.tsx`
  - [ ] ä¿®æ”¹ useAvatarAnimation å‘¼å«ï¼Œå–å¾—æ§åˆ¶å‡½å¼ï¼š
    ```typescript
    const animationControls = useAvatarAnimation(avatarRef);

    // é€é useImperativeHandle æš´éœ²æ§åˆ¶å‡½å¼ï¼ˆä¾›çˆ¶çµ„ä»¶ä½¿ç”¨ï¼‰
    useImperativeHandle(ref, () => ({
      smile: animationControls.smile,
      nod: animationControls.nod,
    }));
    ```
  - [ ] æ›´æ–° AvatarModelProps å‹åˆ¥ï¼Œæ”¯æ´ refï¼š
    ```typescript
    export interface AvatarModelProps {
      // ... åŸæœ‰ props
    }

    export interface AvatarModelHandle {
      smile: (intensity?: number, duration?: number) => void;
      nod: (duration?: number) => void;
    }
    ```
  - [ ] ä½¿ç”¨ forwardRef åŒ…è£çµ„ä»¶ï¼š
    ```typescript
    const AvatarModel = forwardRef<AvatarModelHandle, AvatarModelProps>((props, ref) => {
      // ... çµ„ä»¶é‚è¼¯
    });
    ```

- [ ] **Task 5: å»ºç«‹æ¸¬è©¦ UI æ§åˆ¶é¢æ¿** (AC: 5)
  - [ ] å»ºç«‹ `components/avatar/AvatarControlPanel.tsx` æª”æ¡ˆ
  - [ ] å¯¦ä½œæ§åˆ¶é¢æ¿ UIï¼š
    ```typescript
    'use client';

    import { AvatarModelHandle } from './AvatarModel';

    interface AvatarControlPanelProps {
      avatarRef: React.RefObject<AvatarModelHandle>;
    }

    export default function AvatarControlPanel({ avatarRef }: AvatarControlPanelProps) {
      const handleSmile = () => {
        avatarRef.current?.smile(1.0, 0.5);
      };

      const handleNod = () => {
        avatarRef.current?.nod(1.0);
      };

      return (
        <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-10">
          <div className="bg-slate-800/80 backdrop-blur-sm border border-slate-600 rounded-lg p-4 shadow-xl">
            <h3 className="text-white text-sm font-semibold mb-3">Avatar Controls</h3>
            <div className="flex gap-3">
              <button
                onClick={handleSmile}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors text-sm font-medium"
              >
                ğŸ˜Š Smile
              </button>
              <button
                onClick={handleNod}
                className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors text-sm font-medium"
              >
                ğŸ‘ Nod
              </button>
            </div>
          </div>
        </div>
      );
    }
    ```

- [ ] **Task 6: æ•´åˆæ§åˆ¶é¢æ¿è‡³å ´æ™¯** (AC: 5)
  - [ ] é–‹å•Ÿ `components/avatar/AvatarCanvas.tsx`
  - [ ] å»ºç«‹ AvatarModel çš„ refï¼š
    ```typescript
    import { useRef } from 'react';
    import { AvatarModelHandle } from './AvatarModel';
    import AvatarControlPanel from './AvatarControlPanel';

    export default function AvatarCanvas() {
      const avatarModelRef = useRef<AvatarModelHandle>(null);

      return (
        <div className="relative w-full h-screen">
          <Canvas>
            {/* ... å ´æ™¯å…§å®¹ */}
            <AvatarModel ref={avatarModelRef} modelUrl={currentAvatar} />
          </Canvas>

          <AvatarControlPanel avatarRef={avatarModelRef} />
        </div>
      );
    }
    ```

- [ ] **Task 7: æ¸¬è©¦è¡¨æƒ…å‹•ç•«** (AC: 2, 6, 7)
  - [ ] åŸ·è¡Œ `pnpm dev`ï¼Œé–‹å•Ÿ Avatar å ´æ™¯
  - [ ] é»æ“Šã€ŒğŸ˜Š Smileã€æŒ‰éˆ•
  - [ ] é©—è­‰ä»¥ä¸‹é …ç›®ï¼š
    - âœ… Avatar å˜´è§’å‘ä¸Šç¿¹èµ·ï¼ˆå¾®ç¬‘ï¼‰
    - âœ… å‹•ç•«æ™‚é•·ç´„ 0.5 ç§’
    - âœ… å‹•ç•«å¹³æ»‘è‡ªç„¶ï¼ˆEase-In-Out æ›²ç·šï¼‰
    - âœ… å¾®ç¬‘å¾Œå¯æ¢å¾©åˆ°ä¸­æ€§è¡¨æƒ…
  - [ ] æ¸¬è©¦ä¸åŒå¾®ç¬‘å¼·åº¦ï¼š
    ```typescript
    avatarRef.current?.smile(0.5, 0.5); // æ·ºç¬‘
    avatarRef.current?.smile(1.0, 0.5); // å¤§ç¬‘
    ```
  - [ ] ä½¿ç”¨ OrbitControls å¾ä¸åŒè§’åº¦æª¢è¦–è¡¨æƒ…
  - [ ] è¨˜éŒ„æœ€ä½³åƒæ•¸å€¼

- [ ] **Task 8: æ¸¬è©¦é»é ­å‹•ç•«** (AC: 3, 6, 7)
  - [ ] é»æ“Šã€ŒğŸ‘ Nodã€æŒ‰éˆ•
  - [ ] é©—è­‰ä»¥ä¸‹é …ç›®ï¼š
    - âœ… Avatar é ­éƒ¨å‘ä¸‹é»é ­å†å›åˆ°åŸä½
    - âœ… å‹•ç•«æ™‚é•·ç´„ 1 ç§’
    - âœ… é»é ­å¹…åº¦é©ä¸­ï¼ˆç´„ 15-20 åº¦ï¼‰
    - âœ… å‹•ç•«ä½¿ç”¨æ­£å¼¦æ³¢ï¼Œå¹³æ»‘è‡ªç„¶
  - [ ] å¾å´é¢è§€å¯Ÿé»é ­å‹•ä½œï¼ˆä½¿ç”¨ OrbitControlsï¼‰
  - [ ] æ¸¬è©¦é€£çºŒé»é ­ï¼š
    - é€£çºŒé»æ“Š 3 æ¬¡ã€ŒNodã€æŒ‰éˆ•
    - é©—è­‰å‹•ç•«ä¸æœƒç´¯åŠ æˆ–è¡çª
  - [ ] å¦‚é»é ­éå¤§/éå°ï¼Œèª¿æ•´ `angle` åƒæ•¸ï¼ˆ0.2-0.4 å¼§åº¦ï¼‰

- [ ] **Task 9: å‹•ç•«ä¸¦å­˜æ¸¬è©¦** (AC: 8)
  - [ ] åŒæ™‚è§¸ç™¼å¾®ç¬‘èˆ‡é»é ­ï¼š
    - é»æ“Šã€ŒSmileã€æŒ‰éˆ•
    - ç«‹å³é»æ“Šã€ŒNodã€æŒ‰éˆ•
  - [ ] é©—è­‰ä»¥ä¸‹é …ç›®ï¼š
    - âœ… å…©å€‹å‹•ç•«åŒæ™‚æ’­æ”¾
    - âœ… å‹•ç•«ä¸äº’ç›¸å¹²æ“¾
    - âœ… å¾…æ©Ÿå‹•ç•«ï¼ˆå‘¼å¸ã€çœ¨çœ¼ï¼‰æŒçºŒæ’­æ”¾
  - [ ] æ¸¬è©¦å‹•ç•«å„ªå…ˆç´šï¼š
    - å¾…æ©Ÿå‹•ç•«ä¸æœƒè¦†è“‹è¡¨æƒ…å‹•ç•«
    - è¡¨æƒ…å‹•ç•«å®Œæˆå¾Œä¸å½±éŸ¿å¾…æ©Ÿå‹•ç•«
  - [ ] è¨˜éŒ„ä»»ä½•å‹•ç•«è¡çªå•é¡Œ

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

Epic 2 Story 2.4 å®Œæˆå¾Œçš„æª”æ¡ˆçµæ§‹ï¼š

```
avatar-chat-poc/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ avatar/
â”‚       â”œâ”€â”€ AvatarCanvas.tsx        # æ›´æ–°ï¼šæ•´åˆæ§åˆ¶é¢æ¿èˆ‡ ref
â”‚       â”œâ”€â”€ AvatarModel.tsx         # æ›´æ–°ï¼šforwardRef æš´éœ²æ§åˆ¶å‡½å¼
â”‚       â”œâ”€â”€ AvatarControlPanel.tsx  # æ–°å¢ï¼šæ¸¬è©¦ UI æ§åˆ¶é¢æ¿
â”‚       â”œâ”€â”€ AvatarLoadingState.tsx
â”‚       â””â”€â”€ hooks/
â”‚           â””â”€â”€ useAvatarAnimation.ts  # æ›´æ–°ï¼šåŠ å…¥è¡¨æƒ…èˆ‡é ­éƒ¨å‹•ä½œ
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ avatar/
â”‚       â”œâ”€â”€ loaders.ts
â”‚       â”œâ”€â”€ constants.ts            # æ›´æ–°ï¼šåŠ å…¥ BLENDSHAPES å¸¸æ•¸
â”‚       â””â”€â”€ animations.ts           # æ›´æ–°ï¼šåŠ å…¥ ExpressionController, HeadNodController
â””â”€â”€ types/
    â””â”€â”€ avatar.ts                   # æ›´æ–°ï¼šåŠ å…¥ AvatarAnimationControls å‹åˆ¥
```

### Blendshapes æŠ€è¡“è©³è§£

**Blendshapes å·¥ä½œåŸç†**:
- Blendshapesï¼ˆè®Šå½¢ç›®æ¨™ï¼‰æ˜¯é å®šç¾©çš„é ‚é»è®Šå½¢
- æ¯å€‹ Blendshape å„²å­˜ä¸€çµ„é ‚é»ä½ç½®åç§»é‡
- å€¼ç¯„åœ 0-1ï¼š0 = åŸºç¤å½¢ç‹€ï¼Œ1 = å®Œå…¨è®Šå½¢
- å¯åŒæ™‚æ··åˆå¤šå€‹ Blendshapesï¼ˆå¦‚å¾®ç¬‘ + çœ¨çœ¼ï¼‰

**Ready Player Me å¸¸è¦‹ Blendshapes**:
| Blendshape åç¨± | åŠŸèƒ½ | å€¼ç¯„åœ | ç”¨é€” |
|----------------|------|--------|------|
| `eyesClosed` | é–‰çœ¼ | 0-1 | çœ¨çœ¼ã€ç¡çœ  |
| `mouthSmile` | å¾®ç¬‘ | 0-1 | æ„‰å¿«ã€å‹å¥½ |
| `mouthFrown` | çšºçœ‰ | 0-1 | ä¸æ»¿ã€å›°æƒ‘ |
| `eyesWide` | çœå¤§çœ¼ç› | 0-1 | é©šè¨ã€å°ˆæ³¨ |
| `browInnerUp` | æšçœ‰ | 0-1 | å¥½å¥‡ã€ç–‘å• |
| `mouthOpen` | å¼µå˜´ | 0-1 | èªªè©±ã€é©šè¨ |

**Blendshape æ··åˆæ•¸å­¸**:
```typescript
// å–®ä¸€ Blendshape
finalVertex = baseVertex + (targetVertex - baseVertex) * blendshapeValue;

// å¤šå€‹ Blendshapes æ··åˆ
finalVertex = baseVertex
  + (smile_target - baseVertex) * smileValue
  + (eyesClosed_target - baseVertex) * eyesClosedValue;

// ç¯„ä¾‹ï¼šå¾®ç¬‘ + çœ¨çœ¼
smileValue = 0.8;      // 80% å¾®ç¬‘
eyesClosedValue = 1.0; // 100% é–‰çœ¼
çµæœï¼šAvatar é–‰çœ¼å¾®ç¬‘
```

### è¡¨æƒ…å‹•ç•«æ§åˆ¶å™¨è¨­è¨ˆ

**ç‚ºä½•ä½¿ç”¨ ExpressionControllerï¼Ÿ**
- âœ… çµ±ä¸€ç®¡ç†è¡¨æƒ…å‹•ç•«ç‹€æ…‹
- âœ… æ”¯æ´å¹³æ»‘éæ¸¡ï¼ˆEase-In-Outï¼‰
- âœ… å¯æ“´å±•æ”¯æ´æ›´å¤šè¡¨æƒ…
- âœ… é¿å…ç›´æ¥ä¿®æ”¹ Blendshape å€¼ï¼ˆæ›´å®‰å…¨ï¼‰

**å‹•ç•«ç‹€æ…‹æ©Ÿ**:
```
[éœæ­¢] ---(trigger)---> [å‹•ç•«ä¸­]
                           â†“
                    (duration ç§’å¾Œ)
                           â†“
                        [å®Œæˆ]
```

**Ease-In-Out Cubic æ›²ç·š**:
```typescript
// ç·šæ€§è®ŠåŒ–ï¼ˆç”Ÿç¡¬ï¼‰
value = progress;

// Ease-In-Out Cubicï¼ˆå¹³æ»‘ï¼‰
if (progress < 0.5) {
  value = 4 * progress^3;         // åŠ é€Ÿ
} else {
  value = 1 - (-2 * progress + 2)^3 / 2;  // æ¸›é€Ÿ
}

// æ•ˆæœæ¯”è¼ƒ
æ™‚é–“:   0%    25%    50%    75%    100%
ç·šæ€§:   0     0.25   0.5    0.75   1.0
Cubic:  0     0.0625 0.5    0.9375 1.0
        (æ…¢)  (å¿«)   (ä¸­)   (å¿«)   (æ…¢)
```

### é ­éƒ¨é»é ­å‹•ç•«è¨­è¨ˆ

**é»é ­å‹•ä½œåŸç†**:
- æ§åˆ¶ Head éª¨æ¶çš„ X è»¸æ—‹è½‰ï¼ˆRotation.xï¼‰
- æ­£å€¼ = é ­å‘ä¸‹ï¼Œè² å€¼ = é ­å‘ä¸Š
- ä½¿ç”¨æ­£å¼¦æ³¢æ¨¡æ“¬è‡ªç„¶é»é ­ï¼ˆå‘ä¸‹å†å‘ä¸Šï¼‰

**é»é ­æ•¸å­¸**:
```typescript
// æ­£å¼¦æ³¢å…¬å¼
angle = sin(progress * Ï€) * maxAngle;

// åƒæ•¸èªªæ˜
progress: 0-1ï¼ˆå‹•ç•«é€²åº¦ï¼‰
Ï€: 180åº¦ï¼ˆåŠå€‹é€±æœŸï¼‰
maxAngle: 0.3 å¼§åº¦ï¼ˆç´„ 17 åº¦ï¼‰

// æ•ˆæœ
progress = 0.0 â†’ angle = 0.0   (èµ·å§‹ä½ç½®)
progress = 0.5 â†’ angle = 0.3   (æœ€ä½é»ï¼Œå‘ä¸‹)
progress = 1.0 â†’ angle = 0.0   (å›åˆ°åŸä½)
```

**ç‚ºä½•ä½¿ç”¨æ­£å¼¦æ³¢ï¼Ÿ**
- âœ… å¹³æ»‘çš„åŠ é€Ÿèˆ‡æ¸›é€Ÿ
- âœ… è‡ªå‹•å›åˆ°åŸé»ï¼ˆç„¡éœ€é¡å¤–è™•ç†ï¼‰
- âœ… ç¬¦åˆäººé«”è‡ªç„¶å‹•ä½œæ›²ç·š
- âœ… æ•¸å­¸å…¬å¼ç°¡å–®ï¼Œæ•ˆèƒ½é«˜

**é»é ­å¹…åº¦èª¿æ ¡**:
| è§’åº¦ï¼ˆå¼§åº¦ï¼‰ | è§’åº¦ï¼ˆåº¦ï¼‰ | æ•ˆæœ | ç”¨é€” |
|------------|----------|------|------|
| 0.2 | 11Â° | å¾®é»é ­ | è¼•å¾®èªåŒ |
| 0.3 | 17Â° | æ¨™æº–é»é ­ | ä¸€èˆ¬å›æ‡‰ |
| 0.4 | 23Â° | å¤§å¹…é»é ­ | å¼·çƒˆèªåŒ |
| 0.5 | 29Â° | èª‡å¼µé»é ­ | æˆ²åŠ‡åŒ–æ•ˆæœ |

### forwardRef èˆ‡ useImperativeHandle èªªæ˜

**ç‚ºä½•ä½¿ç”¨ forwardRefï¼Ÿ**
- React é è¨­ä¸å…è¨±é€é ref å­˜å–å­çµ„ä»¶
- forwardRef å…è¨±çˆ¶çµ„ä»¶å–å¾—å­çµ„ä»¶çš„ ref
- ç”¨æ–¼æš´éœ²å­çµ„ä»¶çš„æ–¹æ³•çµ¦çˆ¶çµ„ä»¶

**åŸºæœ¬ç”¨æ³•**:
```typescript
// å­çµ„ä»¶ï¼ˆAvatarModelï¼‰
const AvatarModel = forwardRef<AvatarModelHandle, AvatarModelProps>((props, ref) => {
  useImperativeHandle(ref, () => ({
    smile: () => { /* å¾®ç¬‘é‚è¼¯ */ },
    nod: () => { /* é»é ­é‚è¼¯ */ },
  }));

  return <group>...</group>;
});

// çˆ¶çµ„ä»¶ï¼ˆAvatarCanvasï¼‰
const avatarRef = useRef<AvatarModelHandle>(null);
<AvatarModel ref={avatarRef} />;
avatarRef.current?.smile();  // å‘¼å«å­çµ„ä»¶æ–¹æ³•
```

**å‹åˆ¥å®šç¾©**:
```typescript
// å®šç¾©æš´éœ²çš„æ–¹æ³•ä»‹é¢
export interface AvatarModelHandle {
  smile: (intensity?: number, duration?: number) => void;
  nod: (duration?: number) => void;
}

// Props å‹åˆ¥ï¼ˆä¸åŒ…å« refï¼‰
export interface AvatarModelProps {
  modelUrl: string;
  // ...
}

// forwardRef å‹åˆ¥åƒæ•¸
// <Handleå‹åˆ¥, Propså‹åˆ¥>
forwardRef<AvatarModelHandle, AvatarModelProps>
```

### å‹•ç•«ä¸¦å­˜æ©Ÿåˆ¶

**å¤šå‹•ç•«ä¸¦å­˜ç­–ç•¥**:
1. **ç¨ç«‹æ§åˆ¶å™¨**ï¼šæ¯å€‹å‹•ç•«ä½¿ç”¨ç¨ç«‹çš„ Controller
2. **ä¸åŒä½œç”¨åŸŸ**ï¼š
   - å‘¼å¸ â†’ Spine2 ç¯€é» Scale
   - çœ¨çœ¼ â†’ eyesClosed Blendshape
   - å¾®ç¬‘ â†’ mouthSmile Blendshape
   - é»é ­ â†’ Head ç¯€é» Rotation
3. **ç„¡è¡çªè¨­è¨ˆ**ï¼šä¸åŒå‹•ç•«æ“ä½œä¸åŒå±¬æ€§ï¼Œè‡ªç„¶ä¸¦å­˜

**æ½›åœ¨è¡çªè™•ç†**:
```typescript
// å•é¡Œï¼šçœ¨çœ¼èˆ‡å¾®ç¬‘å¯èƒ½åŒæ™‚ä¿®æ”¹è‡‰éƒ¨ Mesh
// è§£æ±ºï¼šä½¿ç”¨ä¸åŒçš„ Blendshapes

// æ­£ç¢ºï¼ˆç„¡è¡çªï¼‰
morphTargetInfluences[eyesClosedIndex] = 1.0;  // çœ¨çœ¼
morphTargetInfluences[mouthSmileIndex] = 0.8;  // å¾®ç¬‘

// éŒ¯èª¤ï¼ˆè¡çªï¼‰
// å¦‚æœå…©å€‹å‹•ç•«éƒ½ä¿®æ”¹ mouthSmileï¼Œéœ€è¦å‹•ç•«å„ªå…ˆç´šç³»çµ±
```

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•ä½¿ç”¨å‘½ä»¤å¼æ§åˆ¶ï¼ˆImperativeï¼‰ï¼Ÿ**
   ```typescript
   // å‘½ä»¤å¼ï¼ˆæ¨è–¦ï¼‰
   avatarRef.current?.smile();

   // å®£å‘Šå¼ï¼ˆä¸æ¨è–¦ï¼‰
   <AvatarModel isSmiling={true} />
   ```
   - âœ… å‹•ç•«è§¸ç™¼æ™‚æ©Ÿæ›´æ˜ç¢º
   - âœ… é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
   - âœ… æ›´ç¬¦åˆå‹•ç•«æ§åˆ¶ç›´è¦º
   - âœ… æœªä¾†æ•´åˆ LLM æ›´å®¹æ˜“

2. **å‹•ç•«æ§åˆ¶å™¨è¨­è¨ˆæ¨¡å¼**:
   - ä½¿ç”¨ Class å°è£ç‹€æ…‹èˆ‡é‚è¼¯
   - ä½¿ç”¨ useRef é¿å…é‡æ–°å»ºç«‹
   - æä¾› trigger/update åˆ†é›¢ä»‹é¢
   - æ”¯æ´åƒæ•¸åŒ–é…ç½®ï¼ˆduration, intensityï¼‰

3. **æ¸¬è©¦ UI çš„è§’è‰²**:
   - POC éšæ®µï¼šé©—è­‰å‹•ç•«åŠŸèƒ½
   - é–‹ç™¼éšæ®µï¼šå¿«é€Ÿæ¸¬è©¦èˆ‡èª¿æ ¡
   - æ­£å¼ç‰ˆï¼šå¯ç§»é™¤æˆ–ä¿ç•™ç‚ºé–‹ç™¼å·¥å…·
   - æœªä¾†ï¼šç”± LLM/æƒ…ç·’ç³»çµ±è§¸ç™¼å‹•ç•«

4. **æ“´å±•æ€§è€ƒé‡**:
   ```typescript
   // ç•¶å‰è¨­è¨ˆï¼ˆ2å€‹å‹•ä½œï¼‰
   controls = { smile, nod };

   // æœªä¾†æ“´å±•ï¼ˆæ›´å¤šè¡¨æƒ…ï¼‰
   controls = {
     smile, frown, surprise, angry, sad,  // è¡¨æƒ…
     nod, shake, tilt,                    // é ­éƒ¨å‹•ä½œ
     wave, point, thumbsUp,               // æ‰‹éƒ¨å‹•ä½œï¼ˆEpic 4+ï¼‰
   };
   ```

### æ¸¬è©¦æ§åˆ¶é¢æ¿è¨­è¨ˆ

**UI è¨­è¨ˆåŸå‰‡**:
- ä½æ–¼å ´æ™¯åº•éƒ¨ï¼Œä¸é®æ“‹ Avatar
- åŠé€æ˜èƒŒæ™¯ï¼ˆbackdrop-blurï¼‰ä¿æŒå°ˆæ¥­æ„Ÿ
- æŒ‰éˆ•ä½¿ç”¨ Emoji å¢å¼·è¦–è¦ºè­˜åˆ¥
- æ‡¸æµ®æ•ˆæœï¼ˆhoverï¼‰æä¾›å³æ™‚å›é¥‹

**å¯è¨ªå•æ€§è€ƒé‡**:
```typescript
<button
  onClick={handleSmile}
  aria-label="Trigger smile animation"  // è¢å¹•é–±è®€å™¨
  className="..."
>
  ğŸ˜Š Smile
</button>
```

**æœªä¾†æ“´å±•**:
```typescript
// æ»‘æ¡¿æ§åˆ¶è¡¨æƒ…å¼·åº¦
<input
  type="range"
  min="0"
  max="1"
  step="0.1"
  value={smileIntensity}
  onChange={(e) => avatarRef.current?.smile(parseFloat(e.target.value))}
/>

// è¡¨æƒ…é è¨­çµ„åˆ
<button onClick={() => {
  avatarRef.current?.smile(0.8);
  avatarRef.current?.eyesWide(0.5);
}}>
  ğŸ˜ƒ Happy
</button>
```

### Testing

**æ¸¬è©¦æ¡†æ¶**: æ‰‹å‹•æ¸¬è©¦ + è¦–è¦ºé©—è­‰ + äº’å‹•æ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
1. âœ… å¯ç”¨ Blendshapes æ­£ç¢ºè­˜åˆ¥
2. âœ… å¾®ç¬‘å‹•ç•«æ­£ç¢ºæ’­æ”¾
3. âœ… é»é ­å‹•ç•«æ­£ç¢ºæ’­æ”¾
4. âœ… å‹•ç•«æ™‚é•·ç¬¦åˆè¦æ ¼
5. âœ… å‹•ç•«ä½¿ç”¨ Ease æ›²ç·š
6. âœ… å‹•ç•«å¯èˆ‡å¾…æ©Ÿå‹•ç•«ä¸¦å­˜
7. âœ… UI æ§åˆ¶é¢æ¿æ­£å¸¸é‹ä½œ
8. âœ… é€£çºŒè§¸ç™¼å‹•ç•«ç„¡è¡çª

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
pnpm dev

# ç€è¦½å™¨é–‹å•Ÿ
http://localhost:3000

# æ¸¬è©¦é …ç›®
1. é–‹å•Ÿ DevTools Consoleï¼Œæª¢è¦– Available Blendshapes
2. é»æ“Šã€ŒğŸ˜Š Smileã€æŒ‰éˆ•ï¼Œè§€å¯Ÿå˜´è§’è®ŠåŒ–
3. é»æ“Šã€ŒğŸ‘ Nodã€æŒ‰éˆ•ï¼Œè§€å¯Ÿé ­éƒ¨é»é ­
4. ä½¿ç”¨ OrbitControls å¾ä¸åŒè§’åº¦æª¢è¦–å‹•ç•«
5. åŒæ™‚é»æ“Šå…©å€‹æŒ‰éˆ•ï¼Œæ¸¬è©¦ä¸¦å­˜
6. é€£çºŒé»æ“Š 5 æ¬¡ã€ŒSmileã€ï¼Œæª¢æŸ¥æ˜¯å¦ç´¯åŠ 
```

**é©—è­‰æ¸…å–®**:
- [ ] Console é¡¯ç¤º Blendshapes æ¸…å–®
- [ ] å¾®ç¬‘å‹•ç•«å˜´è§’å‘ä¸Šç¿¹èµ·
- [ ] é»é ­å‹•ç•«é ­éƒ¨å‘ä¸‹å†å›å¾©
- [ ] å¾®ç¬‘æ™‚é•·ç´„ 0.5 ç§’
- [ ] é»é ­æ™‚é•·ç´„ 1 ç§’
- [ ] å‹•ç•«å¹³æ»‘ç„¡æŠ–å‹•
- [ ] å¾®ç¬‘èˆ‡é»é ­å¯åŒæ™‚æ’­æ”¾
- [ ] å¾…æ©Ÿå‹•ç•«ï¼ˆå‘¼å¸ã€çœ¨çœ¼ï¼‰æŒçºŒé‹ä½œ
- [ ] æ§åˆ¶é¢æ¿æŒ‰éˆ•å¯æ­£å¸¸é»æ“Š
- [ ] Console ç„¡éŒ¯èª¤è¨Šæ¯

### å·²çŸ¥å•é¡Œèˆ‡æ³¨æ„äº‹é …

**Blendshape ç›¸å®¹æ€§**:
- âš ï¸ ä¸åŒ Ready Player Me Avatar å¯èƒ½æœ‰ä¸åŒ Blendshapes
- âš ï¸ æŸäº› Avatar å¯èƒ½ç¼ºå°‘ `mouthSmile` Blendshape
- âš ï¸ Blendshape åç¨±å¯èƒ½å› æ¨¡å‹è€Œç•°

**å®¹éŒ¯è™•ç†**:
```typescript
// æª¢æŸ¥ Blendshape æ˜¯å¦å­˜åœ¨
const smileIndex = headMesh.morphTargetDictionary?.[BLENDSHAPES.SMILE];
if (smileIndex === undefined) {
  console.warn('mouthSmile Blendshape not found');
  return; // è·³éå‹•ç•«
}
```

**å‹•ç•«è¡çªé¢¨éšª**:
- ç•¶å‰è¨­è¨ˆï¼šå‹•ç•«ç¨ç«‹ï¼Œç„¡è¡çª
- æœªä¾†é¢¨éšªï¼šLip Sync å¯èƒ½èˆ‡è¡¨æƒ…å‹•ç•«è¡çª
- è§£æ±ºæ–¹æ¡ˆï¼šéœ€è¦å‹•ç•«å„ªå…ˆç´šç³»çµ±ï¼ˆEpic 3ï¼‰

**æ•ˆèƒ½å½±éŸ¿**:
- æ¯å€‹å‹•ç•«æ§åˆ¶å™¨å¢åŠ å°‘é‡ CPU æˆæœ¬
- å¤šå€‹å‹•ç•«ä¸¦å­˜ä¸æœƒé¡¯è‘—å½±éŸ¿æ•ˆèƒ½
- FPS æ‡‰ä¿æŒ â‰¥ 30

### æ•ˆèƒ½å„ªåŒ–å»ºè­°

**å„ªåŒ– 1: æ¢ä»¶æ›´æ–°**
```typescript
// åªåœ¨å‹•ç•«ä¸­æ›´æ–°
if (smileController.current.isAnimating) {
  const value = smileController.current.update(time);
  morphTargetInfluences[smileIndex] = value;
}
// éœæ­¢æ™‚è·³éæ›´æ–°
```

**å„ªåŒ– 2: æ‰¹æ¬¡æ›´æ–°**
```typescript
// ä¸€æ¬¡æ›´æ–°å¤šå€‹ Blendshapes
const updates = {
  [smileIndex]: smileValue,
  [eyesClosedIndex]: blinkValue,
};
Object.entries(updates).forEach(([index, value]) => {
  morphTargetInfluences[index] = value;
});
```

**å„ªåŒ– 3: é¿å…é‡è¤‡æŸ¥æ‰¾**
```typescript
// å¿«å– Blendshape ç´¢å¼•
const blendshapeIndices = useRef<Record<string, number>>({});

useEffect(() => {
  if (headMesh?.morphTargetDictionary) {
    blendshapeIndices.current = {
      smile: headMesh.morphTargetDictionary[BLENDSHAPES.SMILE],
      eyesClosed: headMesh.morphTargetDictionary[BLENDSHAPES.EYES_CLOSED],
    };
  }
}, [scene]);
```

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 2.1 å·²å®Œæˆï¼ˆThree.js å ´æ™¯ï¼‰
- âœ… Story 2.2 å·²å®Œæˆï¼ˆAvatar æ¨¡å‹ï¼‰
- âœ… Story 2.3 å·²å®Œæˆï¼ˆå¾…æ©Ÿå‹•ç•«ç³»çµ±ï¼‰
- âœ… Avatar åŒ…å« mouthSmile Blendshape èˆ‡ Head éª¨æ¶

**å¾ŒçºŒ Story ä¾è³´**:
- Story 2.5: æœƒä½¿ç”¨ç›¸åŒçš„å‹•ç•«æ§åˆ¶æ©Ÿåˆ¶
- Epic 3 (Lip Sync): éœ€è¦æ•´åˆè¡¨æƒ…å‹•ç•«ç³»çµ±
- Epic 4 (æƒ…ç·’ç³»çµ±): æœƒè‡ªå‹•è§¸ç™¼è¡¨æƒ…å‹•ç•«

**æŠ€è¡“å‚µå‹™**:
- [ ] æœªä¾†éœ€å¯¦ä½œå‹•ç•«å„ªå…ˆç´šç³»çµ±
- [ ] æœªä¾†éœ€æ”¯æ´è¡¨æƒ…æ··åˆï¼ˆå¦‚å¾®ç¬‘+é©šè¨ï¼‰
- [ ] æœªä¾†éœ€åŠ å…¥å‹•ç•«é è¨­çµ„åˆ
- [ ] æ­£å¼ç‰ˆéœ€ç§»é™¤æˆ–éš±è—æ¸¬è©¦ UI

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 2.4 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
