# Story 1.5: GitHub Actions CI/CD 與 Azure 部署設定

## Status
Draft

---

## Story

**As a** 開發者,
**I want** 建立 CI/CD 流程,實現自動化部署至 Azure Static Web Apps,
**so that** 程式碼變更可以自動測試與部署。

---

## Acceptance Criteria

1. 在 Azure Portal 建立 Azure Static Web Apps 資源
2. 將專案推送至 GitHub repository
3. 在 `.github/workflows/azure-static-web-apps.yml` 建立 GitHub Actions 工作流程
4. 工作流程包含: Lint → Build → Deploy 步驟
5. 在 Azure Portal 配置環境變數(AZURE_OPENAI_API_KEY 等)
6. 推送程式碼至 `main` 分支,自動觸發部署
7. 部署成功後,Azure Static Web Apps URL 可正常存取首頁
8. `/api/health` API 在雲端環境正常運作

---

## Tasks / Subtasks

- [ ] **Task 1: Azure Static Web Apps 資源建立** (AC: 1)
  - [ ] 登入 Azure Portal (https://portal.azure.com)
  - [ ] 點擊「Create a resource」→ 搜尋「Static Web Apps」
  - [ ] 建立資源配置:
    - **Subscription**: 選擇訂閱
    - **Resource Group**: 建立新群組 `rg-avatar-chat-poc`
    - **Name**: `avatar-chat-poc`
    - **Plan type**: Free (POC 階段)
    - **Region**: East Asia (最接近目標使用者)
    - **Deployment source**: GitHub (稍後連結)
  - [ ] 點擊「Review + create」→「Create」
  - [ ] 等待資源建立完成(約 1-2 分鐘)
  - [ ] 記錄以下資訊:
    - Static Web Apps URL: `https://avatar-chat-poc.azurestaticapps.net`
    - Deployment Token (後續 GitHub Actions 需要)

- [ ] **Task 2: GitHub Repository 建立與推送** (AC: 2)
  - [ ] 在 GitHub 建立新 repository:
    - Repository name: `avatar-chat-poc`
    - Visibility: Private (POC 階段)
    - 不要初始化 README (本地已有)
  - [ ] 設定本地 Git remote:
    ```bash
    git remote add origin https://github.com/<your-username>/avatar-chat-poc.git
    ```
  - [ ] 推送程式碼至 GitHub:
    ```bash
    git branch -M main
    git push -u origin main
    ```
  - [ ] 驗證 GitHub 上可看到所有檔案

- [ ] **Task 3: GitHub Actions Workflow 建立** (AC: 3, 4)
  - [ ] 建立 `.github/workflows/` 目錄
  - [ ] 建立 `.github/workflows/azure-static-web-apps.yml` 檔案
  - [ ] 實作 CI/CD 工作流程:
    ```yaml
    name: Azure Static Web Apps CI/CD

    on:
      push:
        branches:
          - main
      pull_request:
        types: [opened, synchronize, reopened, closed]
        branches:
          - main

    jobs:
      build_and_deploy_job:
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
        runs-on: ubuntu-latest
        name: Build and Deploy Job
        steps:
          - name: Checkout code
            uses: actions/checkout@v3
            with:
              submodules: true

          - name: Setup Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '18'
              cache: 'pnpm'

          - name: Install pnpm
            uses: pnpm/action-setup@v2
            with:
              version: 8

          - name: Install dependencies
            run: pnpm install --frozen-lockfile

          - name: Run ESLint
            run: pnpm lint

          - name: Run TypeScript check
            run: pnpm exec tsc --noEmit

          - name: Build project
            run: pnpm build
            env:
              # Public env variables (if any)
              NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}

          - name: Deploy to Azure Static Web Apps
            id: builddeploy
            uses: Azure/static-web-apps-deploy@v1
            with:
              azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
              repo_token: ${{ secrets.GITHUB_TOKEN }}
              action: "upload"
              app_location: "/"
              api_location: ""
              output_location: ".next"
            env:
              # Azure service credentials (backend only)
              AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
              AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
              AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
              AZURE_SPEECH_KEY: ${{ secrets.AZURE_SPEECH_KEY }}
              AZURE_SPEECH_REGION: ${{ secrets.AZURE_SPEECH_REGION }}

      close_pull_request_job:
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        runs-on: ubuntu-latest
        name: Close Pull Request Job
        steps:
          - name: Close Pull Request
            id: closepullrequest
            uses: Azure/static-web-apps-deploy@v1
            with:
              azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
              action: "close"
    ```
  - [ ] 驗證 YAML 語法正確(使用 YAML validator)
  - [ ] Commit workflow 檔案:
    ```bash
    git add .github/workflows/azure-static-web-apps.yml
    git commit -m "feat: 加入 Azure Static Web Apps CI/CD workflow"
    ```

- [ ] **Task 4: GitHub Secrets 配置** (AC: 5)
  - [ ] 在 GitHub Repository 設定 Secrets:
    - Settings → Secrets and variables → Actions → New repository secret
  - [ ] 加入以下 Secrets:
    1. `AZURE_STATIC_WEB_APPS_API_TOKEN`
       - 值: 從 Azure Portal 取得 (Static Web Apps → Overview → Manage deployment token)
    2. `AZURE_OPENAI_API_KEY`
       - 值: 從 Story 1.2 取得的 Azure OpenAI Key
    3. `AZURE_OPENAI_ENDPOINT`
       - 值: `https://<your-resource>.openai.azure.com/`
    4. `AZURE_OPENAI_DEPLOYMENT`
       - 值: `gpt-4-turbo`
    5. `AZURE_SPEECH_KEY`
       - 值: 從 Story 1.2 取得的 Azure Speech Key
    6. `AZURE_SPEECH_REGION`
       - 值: `eastasia`
  - [ ] 驗證所有 Secrets 已正確加入

- [ ] **Task 5: Azure 環境變數配置** (AC: 5)
  - [ ] 在 Azure Portal 配置環境變數:
    - Static Web Apps → Configuration → Application settings
  - [ ] 加入以下環境變數:
    ```
    AZURE_OPENAI_API_KEY = <your_key>
    AZURE_OPENAI_ENDPOINT = https://<your-resource>.openai.azure.com/
    AZURE_OPENAI_DEPLOYMENT = gpt-4-turbo
    AZURE_SPEECH_KEY = <your_speech_key>
    AZURE_SPEECH_REGION = eastasia
    NODE_ENV = production
    ```
  - [ ] 點擊「Save」儲存配置
  - [ ] 注意: 環境變數變更需要重新部署才會生效

- [ ] **Task 6: 首次部署觸發與驗證** (AC: 6, 7, 8)
  - [ ] 推送 workflow 檔案至 GitHub:
    ```bash
    git push origin main
    ```
  - [ ] 在 GitHub Actions 頁面查看部署進度:
    - Repository → Actions → 查看 workflow run
  - [ ] 等待部署完成(約 5-10 分鐘):
    - ✅ Lint check passed
    - ✅ TypeScript check passed
    - ✅ Build succeeded
    - ✅ Deploy to Azure succeeded
  - [ ] 驗證部署結果:
    1. 開啟 Azure Static Web Apps URL: `https://avatar-chat-poc.azurestaticapps.net`
    2. 驗證首頁正常顯示(與本地相同)
    3. 測試 Health API: `https://avatar-chat-poc.azurestaticapps.net/api/health`
    4. 驗證返回 JSON:
       ```json
       {
         "success": true,
         "data": {
           "status": "ok",
           "timestamp": "2025-10-14T10:00:00.000Z",
           "version": "1.0.0"
         },
         "timestamp": "2025-10-14T10:00:00.000Z"
       }
       ```
  - [ ] 檢查 Azure Portal 部署日誌(如有錯誤)
  - [ ] 截圖成功部署的頁面

- [ ] **Task 7: PR Preview 部署測試**(進階功能)
  - [ ] 建立測試分支:
    ```bash
    git checkout -b feature/test-pr-preview
    ```
  - [ ] 修改 `app/page.tsx`,加入測試文字「PR Preview Test」
  - [ ] Commit 並 push:
    ```bash
    git add app/page.tsx
    git commit -m "test: PR preview deployment"
    git push origin feature/test-pr-preview
    ```
  - [ ] 在 GitHub 建立 Pull Request:
    - Base: `main`
    - Compare: `feature/test-pr-preview`
  - [ ] 等待 GitHub Actions 自動建立 Preview 環境
  - [ ] 在 PR 評論中找到 Preview URL (由 Azure bot 自動評論)
  - [ ] 驗證 Preview 環境正常運作
  - [ ] 關閉 PR (不合併),驗證 Preview 環境自動刪除
  - [ ] 刪除測試分支

- [ ] **Task 8: 部署文件與 README 更新** (AC: 7)
  - [ ] 更新 `README.md`,加入部署資訊:
    ```markdown
    ## 部署

    ### 生產環境
    - **URL**: https://avatar-chat-poc.azurestaticapps.net
    - **平台**: Azure Static Web Apps
    - **部署方式**: GitHub Actions 自動部署

    ### 部署流程
    1. 推送程式碼至 `main` 分支
    2. GitHub Actions 自動觸發
    3. 執行 Lint → TypeScript Check → Build
    4. 部署至 Azure Static Web Apps
    5. 約 5-10 分鐘完成

    ### 手動部署 (緊急情況)
    ```bash
    # 安裝 Azure Static Web Apps CLI
    pnpm add -g @azure/static-web-apps-cli

    # 登入 Azure
    az login

    # 部署
    swa deploy --app-location . --output-location .next --deployment-token <token>
    ```

    ### 環境變數管理
    - 本地開發: `.env.local`
    - Azure 生產: Azure Portal → Configuration → Application settings
    - GitHub Actions: Repository Secrets
    ```
  - [ ] 建立 `docs/deployment-guide.md` 詳細部署指南
  - [ ] 文件包含:
    - Azure 資源建立步驟
    - GitHub Actions 配置說明
    - 環境變數設定
    - 常見部署問題排除
    - Rollback 策略

- [ ] **Task 9: 監控與日誌設定** (選做,建議完成)
  - [ ] 在 Azure Portal 啟用 Application Insights:
    - Static Web Apps → Monitoring → Application Insights → Create new
  - [ ] 配置基本 Alert:
    - Alert on HTTP 5xx errors (> 5 errors in 5 minutes)
    - Alert on deployment failures
  - [ ] 測試日誌記錄:
    - 觸發一次錯誤(故意修改程式碼)
    - 在 Application Insights 查看錯誤日誌
  - [ ] 建立 Azure Dashboard 顯示關鍵指標:
    - Request count
    - Response time (P95)
    - Error rate
    - Deployment history

---

## Dev Notes

### 相關來源樹 (Source Tree)

根據架構文件,CI/CD 的檔案結構應如下:

```
avatar-chat-poc/
├── .github/
│   └── workflows/
│       └── azure-static-web-apps.yml    # ✅ CI/CD Workflow (Task 3)
│
├── docs/
│   └── deployment-guide.md              # ✅ 部署指南 (Task 8)
│
└── README.md                             # ✅ 更新部署資訊 (Task 8)
```

### Azure Static Web Apps 架構

**部署模型**:
```
GitHub Repository (main branch)
    ↓ push event
GitHub Actions Workflow
    ↓ build & test
Build Artifacts (.next/)
    ↓ deploy
Azure Static Web Apps (CDN + Functions)
    ↓ serve
Global Users
```

**關鍵特性**:
- ✅ **Global CDN**: 自動部署至全球 Edge 節點
- ✅ **PR Previews**: 每個 PR 自動建立預覽環境
- ✅ **Serverless Functions**: Next.js API Routes 自動轉換為 Azure Functions
- ✅ **Custom Domains**: 支援自訂網域(未來 MVP)
- ✅ **Free Tier**: 100 GB bandwidth/month,免費 SSL

### GitHub Actions Workflow 詳解

**Trigger 規則**:
```yaml
on:
  push:
    branches: [main]           # main 分支推送觸發部署
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]           # PR 觸發預覽環境
```

**Build Pipeline**:
1. **Checkout**: 取得程式碼
2. **Setup Node.js**: 安裝 Node.js 18 + 快取依賴
3. **Install pnpm**: 安裝 pnpm 8
4. **Install**: `pnpm install --frozen-lockfile` (精確安裝)
5. **Lint**: ESLint 檢查程式碼品質
6. **Type Check**: TypeScript 編譯檢查
7. **Build**: Next.js 建置(`pnpm build`)
8. **Deploy**: 上傳至 Azure Static Web Apps

**為何使用 `pnpm install --frozen-lockfile` 而非 `pnpm install`？**
- ✅ 根據 `pnpm-lock.yaml` 精確安裝
- ✅ 速度更快(跳過某些檢查)
- ✅ 適合 CI 環境(可重現性)
- ✅ 如果 lockfile 過期則會失敗(確保一致性)

**環境變數處理**:
- **Public Env (前端)**: `NEXT_PUBLIC_*` 變數在 build 時注入
- **Private Env (後端)**: Azure 服務金鑰在 deploy 時注入
- **Security**: 敏感資訊使用 GitHub Secrets,不寫入 workflow

### 部署策略

**部署流程**:
1. **Build Locally**: GitHub Actions runner 執行 `pnpm build`
2. **Upload Artifacts**: 將 `.next/` 目錄上傳至 Azure
3. **Azure Processing**: Azure 處理 Serverless Functions
4. **CDN Distribution**: 內容分發至全球 CDN
5. **Health Check**: Azure 自動驗證部署成功

**Rollback 策略**:
- **方法 1 (推薦)**: Revert Git commit → 推送 → 自動重新部署
  ```bash
  git revert HEAD
  git push origin main
  ```
- **方法 2**: 在 Azure Portal 切換至前一個部署版本
  - Static Web Apps → Deployments → 選擇版本 → Activate

**Blue-Green Deployment (未來)**:
- POC 階段: 直接部署至生產
- MVP 階段: 使用 Azure Deployment Slots (Staging → Production)

### 技術決策

1. **為何使用 Azure Static Web Apps 而非 Vercel/Netlify？**
   - ✅ PRD 明確要求部署至 Azure
   - ✅ 與 Azure OpenAI/Speech 同平台(簡化管理)
   - ✅ 企業級支援與 SLA
   - ✅ 成本透明(與其他 Azure 服務統一計費)

2. **為何使用 GitHub Actions 而非 Azure DevOps Pipelines？**
   - ✅ 程式碼與 CI/CD 同平台(簡化管理)
   - ✅ GitHub Actions 生態系豐富
   - ✅ 免費額度充足(2,000 分鐘/月)
   - ✅ 團隊熟悉度高

3. **為何 Lint/TypeCheck 在 CI,而非 Git Hooks？**
   - ✅ Git Hooks 可繞過(force commit)
   - ✅ CI 是「最後一道防線」
   - ✅ 團隊協作時 CI 更可靠
   - ✅ 可選: 加入 Git Hooks 作為「第一道防線」

4. **為何使用 Secrets 而非 `.env` 檔案？**
   - ✅ 安全性: `.env` 檔案不應提交至 Git
   - ✅ 分離: 不同環境使用不同金鑰
   - ✅ 權限控制: 僅管理員可存取 Secrets
   - ✅ 審計: GitHub Secrets 有存取日誌

### Testing

**測試範圍**:
1. ✅ GitHub Actions Workflow 語法驗證
2. ✅ 部署成功測試(首次部署)
3. ✅ Health API 雲端環境測試
4. ✅ PR Preview 環境測試
5. ✅ Rollback 流程測試

**測試執行方式**:
```bash
# 本地模擬 GitHub Actions (使用 act)
pnpm add -g act
act push

# Azure Static Web Apps CLI 本地測試
pnpm add -g @azure/static-web-apps-cli
swa start .next --api-location api
```

### 效能考量

**部署時間**:
- Checkout + Setup: ~30s
- Install dependencies: ~1min (with cache)
- Lint + TypeCheck: ~30s
- Build: ~2min
- Deploy to Azure: ~2min
- **Total**: ~6min (首次), ~4min (後續,有快取)

**優化策略**:
- ✅ 使用 `pnpm install --frozen-lockfile` + cache (節省 1-2min)
- ✅ 並行執行 Lint & TypeCheck (未來優化)
- ✅ 增量建置(Next.js 13+ 支援)

**Bandwidth 考量**:
- POC 階段預估流量: < 10 GB/month
- Free Tier: 100 GB/month
- 超出費用: $0.20/GB

### 安全性

**Secrets 管理**:
- ✅ GitHub Secrets 加密儲存
- ✅ Secrets 不出現在日誌中
- ✅ 定期輪換金鑰(建議每 90 天)
- ✅ 使用 Azure Key Vault (未來 MVP)

**部署安全**:
- ✅ HTTPS 強制啟用
- ✅ Azure Static Web Apps 自動提供 SSL
- ✅ 環境變數僅在後端可存取
- ✅ API Routes 不暴露金鑰

**存取控制** (未來 MVP):
- Azure AD 整合
- IP 白名單
- 自訂認證

### 監控與日誌

**關鍵指標**:
- **Deployment Success Rate**: > 95%
- **Build Time**: < 6min (P95)
- **API Response Time**: < 2s (P95)
- **Error Rate**: < 1%

**Alert 規則** (建議配置):
```yaml
alerts:
  - name: "部署失敗"
    condition: "Deployment failed"
    action: "Email + Slack notification"

  - name: "API 錯誤率高"
    condition: "HTTP 5xx > 5 errors in 5 minutes"
    action: "Email alert"

  - name: "回應時間過慢"
    condition: "P95 response time > 5s"
    action: "Slack notification"
```

### 依賴關係

**前置條件**:
- ✅ Story 1.1 已完成 (Next.js 專案已初始化)
- ✅ Story 1.2 已完成 (Azure 服務已註冊)
- ✅ Story 1.4 已完成 (Health API 可用於驗證)
- ✅ GitHub 帳號已建立
- ✅ Azure 訂閱已啟用

**外部依賴**:
- GitHub Actions runners (GitHub 提供)
- Azure Static Web Apps (Azure 提供)
- Node.js 18 (GitHub Actions 提供)

**後續 Story 依賴**:
- 所有後續 Stories 都會使用此 CI/CD 流程
- Story 5.5: 生產部署會基於此流程擴展

### 常見問題排除

**問題 1: 部署失敗 - "Build failed"**
- **檢查**: GitHub Actions logs
- **常見原因**: TypeScript 錯誤、缺少依賴
- **解決**: 本地執行 `pnpm build`,修正錯誤

**問題 2: API 在雲端返回 500**
- **檢查**: Azure Application Insights logs
- **常見原因**: 環境變數未設定
- **解決**: 在 Azure Portal 檢查環境變數配置

**問題 3: PR Preview 未建立**
- **檢查**: GitHub Actions workflow 是否觸發
- **常見原因**: Workflow 配置錯誤
- **解決**: 檢查 `on.pull_request` 設定

**問題 4: 部署成功但頁面 404**
- **檢查**: Azure Static Web Apps routes 配置
- **常見原因**: `output_location` 路徑錯誤
- **解決**: 確認 workflow 中 `output_location: ".next"`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 建立 Story 1.5 草稿 | SM Agent |

---

## Dev Agent Record

*(此部分由 Dev Agent 在實作時填寫)*

### Agent Model Used
_待填寫_

### Debug Log References
_待填寫_

### Completion Notes List
_待填寫_

### File List
_待填寫_

---

## QA Results

*(此部分由 QA Agent 在審核時填寫)*

_待填寫_
