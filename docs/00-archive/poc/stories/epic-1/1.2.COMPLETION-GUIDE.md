# Story 1.2 å®ŒæˆæŒ‡å—

**Story ç‹€æ…‹**: âœ… ç¨‹å¼ç¢¼å¯¦æ–½å®Œæˆ
**å¾…ç”¨æˆ¶æ“ä½œ**: Azure Portal è¨»å†Šèˆ‡é‡‘é‘°é…ç½®
**æœ€å¾Œæ›´æ–°**: 2025-10-15

---

## ğŸ“‹ å·²å®Œæˆé …ç›®

### âœ… 1. Azure SDK å®‰è£

å·²å®‰è£ä»¥ä¸‹å¥—ä»¶ï¼š

```json
{
  "@azure/openai": "^2.0.0",
  "microsoft-cognitiveservices-speech-sdk": "^1.46.0",
  "dotenv": "^17.2.3",
  "tsx": "^4.20.6"
}
```

### âœ… 2. Azure å®¢æˆ¶ç«¯å°è£

#### `lib/azure/openai.ts`
- âœ… OpenAI å®¢æˆ¶ç«¯å·¥å» å‡½æ•¸ï¼š`getOpenAIClient()`
- âœ… é…ç½®é©—è­‰ï¼š`isConfigured()`
- âœ… å®‰å…¨é…ç½®æ‘˜è¦ï¼š`getConfigSummary()`
- âœ… ç’°å¢ƒè®Šæ•¸æª¢æŸ¥èˆ‡å‹å¥½éŒ¯èª¤è¨Šæ¯
- âœ… JSDoc å®Œæ•´æ–‡æª”è¨»é‡‹

#### `lib/azure/speech.ts`
- âœ… Speech SDK é…ç½®å‡½æ•¸ï¼š`getSpeechConfig()`
- âœ… TTS é…ç½®ï¼š`getTTSConfig()`
- âœ… STT é…ç½®ï¼š`getSTTConfig()`
- âœ… é è¨­ç¹é«”ä¸­æ–‡èªéŸ³ï¼š`zh-TW-HsiaoChenNeural`
- âœ… å¯ç”¨èªéŸ³åˆ—è¡¨ï¼š`AVAILABLE_ZH_TW_VOICES`
- âœ… é…ç½®é©—è­‰èˆ‡æ‘˜è¦åŠŸèƒ½

### âœ… 3. ç’°å¢ƒè®Šæ•¸é…ç½®

#### `.env.local.example`
- âœ… å®Œæ•´çš„ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
- âœ… è©³ç´°çš„å–å¾—æ–¹å¼èªªæ˜
- âœ… é…ç½®æª¢æŸ¥æ¸…å–®
- âœ… å®‰å…¨æç¤º

**å¿…å¡«ç’°å¢ƒè®Šæ•¸**ï¼š
```bash
# Azure OpenAI
AZURE_OPENAI_ENDPOINT=https://your-resource-name.openai.azure.com/
AZURE_OPENAI_API_KEY=your_openai_api_key_here
AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo

# Azure Speech Services
AZURE_SPEECH_KEY=your_speech_api_key_here
AZURE_SPEECH_REGION=eastasia
```

### âœ… 4. æ¸¬è©¦å·¥å…·

#### `scripts/test-azure.ts`
- âœ… ç’°å¢ƒè®Šæ•¸å®Œæ•´æ€§æª¢æŸ¥
- âœ… Azure OpenAI é€£æ¥æ¸¬è©¦
- âœ… Azure Speech Services é…ç½®é©—è­‰
- âœ… å‹å¥½çš„éŒ¯èª¤è¨Šæ¯å’Œé™¤éŒ¯æç¤º

**åŸ·è¡Œæ–¹å¼**ï¼š
```bash
npm run test:azure
```

#### `app/api/health/route.ts`
- âœ… å¥åº·æª¢æŸ¥ API ç«¯é»
- âœ… é…ç½®ç‹€æ…‹æª¢æŸ¥ï¼ˆä¸æš´éœ²æ•æ„Ÿè³‡è¨Šï¼‰

**æ¸¬è©¦æ–¹å¼**ï¼š
```bash
curl http://localhost:3004/api/health
```

### âœ… 5. NPM è…³æœ¬

å·²æ·»åŠ åˆ° `package.json`ï¼š
```json
{
  "scripts": {
    "test:azure": "tsx scripts/test-azure.ts"
  }
}
```

---

## ğŸ¯ ç”¨æˆ¶å¾…å®Œæˆæ“ä½œ

### æ­¥é©Ÿ 1: Azure OpenAI è¨»å†Š

1. å‰å¾€ [Azure Portal](https://portal.azure.com)
2. å‰µå»º Azure OpenAI è³‡æº
   - å€åŸŸï¼š**East US**ï¼ˆGPT-4 Turbo å¯ç”¨æ€§æœ€ä½³ï¼‰
   - å®šåƒ¹å±¤ï¼šStandard S0
3. éƒ¨ç½²æ¨¡å‹ï¼š
   - å‰å¾€ Azure OpenAI Studio
   - å‰µå»ºéƒ¨ç½²ï¼š`gpt-4-turbo`
4. ç²å–æ†‘è­‰ï¼š
   - å‰å¾€ã€Œé‡‘é‘°å’Œç«¯é»ã€é é¢
   - è¤‡è£½ã€Œç«¯é»ã€å’Œã€Œé‡‘é‘° 1ã€

### æ­¥é©Ÿ 2: Azure Speech Services è¨»å†Š

1. å‰å¾€ [Azure Portal](https://portal.azure.com)
2. å‰µå»º Azure èªçŸ¥æœå‹™ Speech è³‡æº
   - å€åŸŸï¼š**East Asia**ï¼ˆæœ€ä½³ç¹é«”ä¸­æ–‡èªéŸ³è³ªé‡ï¼‰
   - å®šåƒ¹å±¤ï¼šStandard S0
3. ç²å–æ†‘è­‰ï¼š
   - å‰å¾€ã€Œé‡‘é‘°å’Œç«¯é»ã€é é¢
   - è¤‡è£½ã€Œå€åŸŸã€å’Œã€Œé‡‘é‘° 1ã€

### æ­¥é©Ÿ 3: é…ç½®ç’°å¢ƒè®Šæ•¸

1. è¤‡è£½ç¯„ä¾‹æª”æ¡ˆï¼š
   ```bash
   cp .env.local.example .env.local
   ```

2. ç·¨è¼¯ `.env.local`ï¼Œå¡«å…¥ä½ çš„ Azure æ†‘è­‰ï¼š
   ```bash
   AZURE_OPENAI_ENDPOINT=https://your-actual-resource.openai.azure.com/
   AZURE_OPENAI_API_KEY=ä½ çš„å¯¦éš›é‡‘é‘°
   AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo

   AZURE_SPEECH_KEY=ä½ çš„å¯¦éš›é‡‘é‘°
   AZURE_SPEECH_REGION=eastasia
   ```

### æ­¥é©Ÿ 4: é©—è­‰é…ç½®

1. é‡å•Ÿé–‹ç™¼ä¼ºæœå™¨ï¼š
   ```bash
   npm run dev
   ```

2. æ¸¬è©¦ Azure é€£æ¥ï¼š
   ```bash
   npm run test:azure
   ```

   **é æœŸè¼¸å‡º**ï¼š
   ```
   ğŸš€ é–‹å§‹æ¸¬è©¦ Azure æœå‹™é€£æ¥...

   âœ… æ‰€æœ‰ç’°å¢ƒè®Šæ•¸å·²é…ç½®
   âœ… Azure OpenAI é€£æ¥æˆåŠŸï¼
   âœ… Azure Speech Services é…ç½®æˆåŠŸï¼

   ğŸ‰ æ‰€æœ‰ Azure æœå‹™æ¸¬è©¦é€šéï¼
   ```

3. æª¢æŸ¥å¥åº·æª¢æŸ¥ APIï¼š
   ```bash
   curl http://localhost:3004/api/health
   ```

   **é æœŸè¼¸å‡º**ï¼š
   ```json
   {
     "status": "ok",
     "services": {
       "openai": { "configured": true },
       "speech": { "configured": true }
     }
   }
   ```

---

## ğŸ“š ä½¿ç”¨ç¯„ä¾‹

### Azure OpenAI ä½¿ç”¨

```typescript
import { getOpenAIClient, DEPLOYMENT_NAME } from '@/lib/azure/openai'

// åˆå§‹åŒ–å®¢æˆ¶ç«¯
const client = getOpenAIClient()

// ç™¼é€å°è©±è«‹æ±‚
const response = await client.getChatCompletions(DEPLOYMENT_NAME, [
  {
    role: 'system',
    content: 'ä½ æ˜¯ä¸€å€‹å‹å–„çš„ AI åŠ©æ‰‹ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚'
  },
  {
    role: 'user',
    content: 'ä½ å¥½ï¼'
  }
])

const reply = response.choices[0]?.message?.content
console.log(reply)
```

### Azure Speech ä½¿ç”¨

```typescript
import { getSpeechConfig, DEFAULT_VOICE } from '@/lib/azure/speech'
import * as sdk from 'microsoft-cognitiveservices-speech-sdk'

// TTSï¼ˆæ–‡å­—è½‰èªéŸ³ï¼‰
const config = getSpeechConfig()
const synthesizer = new sdk.SpeechSynthesizer(config)

await synthesizer.speakTextAsync('ä½ å¥½ï¼Œæˆ‘æ˜¯ AI Avatarï¼')

// STTï¼ˆèªéŸ³è½‰æ–‡å­—ï¼‰
const recognizer = new sdk.SpeechRecognizer(config)
// ... èªéŸ³è­˜åˆ¥é‚è¼¯
```

---

## âœ… Story 1.2 é©—æ”¶æ¨™æº–æª¢æŸ¥

| é©—æ”¶æ¨™æº– | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| Azure OpenAI è³‡æºå‰µå»º | â³ å¾…ç”¨æˆ¶æ“ä½œ | éœ€åœ¨ Azure Portal è¨»å†Š |
| Azure Speech è³‡æºå‰µå»º | â³ å¾…ç”¨æˆ¶æ“ä½œ | éœ€åœ¨ Azure Portal è¨»å†Š |
| Azure SDK å®‰è£ | âœ… å®Œæˆ | @azure/openai, speech-sdk |
| OpenAI å®¢æˆ¶ç«¯å°è£ | âœ… å®Œæˆ | lib/azure/openai.ts |
| Speech å®¢æˆ¶ç«¯å°è£ | âœ… å®Œæˆ | lib/azure/speech.ts |
| ç’°å¢ƒè®Šæ•¸é…ç½® | âœ… å®Œæˆ | .env.local.example |
| æ¸¬è©¦è…³æœ¬ | âœ… å®Œæˆ | scripts/test-azure.ts |
| å¥åº·æª¢æŸ¥ API | âœ… å®Œæˆ | /api/health |

---

## ğŸ”§ æ•…éšœæ’é™¤

### å•é¡Œ 1: æ¸¬è©¦è…³æœ¬é¡¯ç¤ºã€Œé…ç½®ä¸å®Œæ•´ã€

**åŸå› **ï¼š`.env.local` æª”æ¡ˆæœªå‰µå»ºæˆ–ç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºå¡«å…¥

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª `.env.local` æª”æ¡ˆå­˜åœ¨
2. æª¢æŸ¥æ‰€æœ‰å¿…å¡«è®Šæ•¸æ˜¯å¦å·²å¡«å…¥
3. ç¢ºèªæ²’æœ‰å¤šé¤˜çš„ç©ºæ ¼æˆ–å¼•è™Ÿ

### å•é¡Œ 2: OpenAI API è¿”å› 401 éŒ¯èª¤

**åŸå› **ï¼šAPI é‡‘é‘°ç„¡æ•ˆæˆ–ç«¯é»éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª API é‡‘é‘°è¤‡è£½æ­£ç¢ºï¼ˆ32 å­—å…ƒåå…­é€²åˆ¶ï¼‰
2. ç¢ºèªç«¯é»æ ¼å¼ï¼š`https://resource-name.openai.azure.com/`
3. æª¢æŸ¥ Azure è¨‚é–±æ˜¯å¦è™•æ–¼æ´»å‹•ç‹€æ…‹
4. å˜—è©¦åœ¨ Azure Portal é‡æ–°ç”Ÿæˆé‡‘é‘°

### å•é¡Œ 3: Speech SDK åˆå§‹åŒ–å¤±æ•—

**åŸå› **ï¼šå€åŸŸè¨­å®šéŒ¯èª¤æˆ–è¨‚é–±é‡‘é‘°ç„¡æ•ˆ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªå€åŸŸç‚ºå°å¯«è‹±æ–‡ï¼ˆä¾‹å¦‚ï¼š`eastasia`ï¼Œä¸æ˜¯ `East Asia`ï¼‰
2. ç¢ºèªè¨‚é–±é‡‘é‘°è¤‡è£½æ­£ç¢º
3. æª¢æŸ¥ç¶²è·¯é€£æ¥

---

## ğŸ“ ä¸‹ä¸€æ­¥

Story 1.2 ç¨‹å¼ç¢¼å¯¦æ–½å®Œæˆå¾Œï¼Œç”¨æˆ¶éœ€è¦ï¼š

1. **ç«‹å³**ï¼šè¨»å†Š Azure æœå‹™ä¸¦å¡«å…¥é‡‘é‘°ï¼ˆæœ¬ Storyï¼‰
2. **Story 1.3**ï¼šUI çµ„ä»¶é–‹ç™¼ï¼ˆå¯ä¸¦è¡Œé€²è¡Œï¼‰
3. **Story 1.4**ï¼šå°ˆæ¡ˆæ–‡æª”å®Œå–„

---

**ç¶­è­·è€…**: AI Assistant
**æœ€å¾Œæ›´æ–°**: 2025-10-15
**ç›¸é—œæ–‡æª”**:
- [Story 1.2 éœ€æ±‚](./1.2.azure-services-setup.md)
- [ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹](../../.env.local.example)
- [AI Assistant Guide](../../AI_ASSISTANT_GUIDE.md)
