# Story 5.5: Azure Static Web Apps 生產部署

**Epic**: Epic 5 - Polish & Deployment
**Story ID**: 5.5
**Story 名稱**: Azure Static Web Apps 生產部署
**優先順序**: High
**預估時間**: 6 小時
**狀態**: Draft

---

## 📋 Story 描述

### User Story
**As a** Product Owner
**I want** 應用程式部署到 Azure Static Web Apps 生產環境
**So that** 使用者可以透過公開 URL 存取應用程式，並享有 Azure 的全球 CDN 加速

### Business Value
- **全球可用性**: Azure CDN 提供全球低延遲存取（<100ms）
- **自動化部署**: GitHub Actions CI/CD 自動部署，無需手動操作
- **成本效益**: Static Web Apps Free tier 足夠 POC 使用（100GB bandwidth/月）
- **HTTPS 支援**: 自動提供免費 SSL 憑證
- **Custom Domain**: 支援自訂網域（未來擴展）

### Technical Context
- **Platform**: Azure Static Web Apps
- **Framework**: Next.js 14 (Static Export)
- **CI/CD**: GitHub Actions
- **CDN**: Azure 全球 CDN
- **API**: Azure Functions (Serverless, TTS API proxy)

---

## ✅ Acceptance Criteria

### Functional Requirements
1. **Azure Static Web Apps 建立**:
   - [ ] 在 Azure Portal 建立 Static Web Apps 資源
   - [ ] 選擇 Free tier
   - [ ] 連結 GitHub repository
   - [ ] 設定 build configuration (Next.js)

2. **CI/CD Pipeline**:
   - [ ] GitHub Actions workflow 自動部署
   - [ ] Push to `main` 觸發部署
   - [ ] Build 成功後自動發佈
   - [ ] Preview URL 顯示部署狀態

3. **Environment Variables**:
   - [ ] Azure TTS API Key 設定在 Azure Portal
   - [ ] Next.js 環境變數正確載入
   - [ ] 生產環境與開發環境分離

4. **Production URL 可存取**:
   - [ ] 應用程式透過 Azure URL 正常運作
   - [ ] 所有功能正常（3D Avatar, TTS, Lip Sync）
   - [ ] HTTPS 正常啟用
   - [ ] 全球 CDN 加速生效

### Non-Functional Requirements
1. **部署速度**: Build + Deploy ≤ 5 分鐘
2. **可用性**: Uptime ≥ 99.9%
3. **效能**: Global latency ≤ 100ms
4. **成本**: Free tier 範圍內（POC 階段）

---

## 🏗️ Technical Design

### Azure Static Web Apps Architecture

```
┌─────────────────────────────────────────────────────────┐
│                  GitHub Repository                       │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Push to main branch                              │  │
│  └────────────────────┬──────────────────────────────┘  │
│                       │                                  │
│                       ↓                                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  GitHub Actions Workflow                          │  │
│  │  1. Checkout code                                 │  │
│  │  2. Install dependencies (npm install)            │  │
│  │  3. Build Next.js (npm run build)                 │  │
│  │  4. Deploy to Azure Static Web Apps               │  │
│  └────────────────────┬──────────────────────────────┘  │
└────────────────────────┼──────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────┐
│           Azure Static Web Apps                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Static Content (HTML, CSS, JS)                   │  │
│  │  - Next.js static export                          │  │
│  │  - Optimized bundles                              │  │
│  │  - Cached on Azure CDN                            │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Azure Functions (Optional)                       │  │
│  │  - TTS API proxy (hide API key)                   │  │
│  │  - Server-side logic                              │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Environment Variables                            │  │
│  │  - AZURE_TTS_API_KEY (secret)                     │  │
│  │  - NEXT_PUBLIC_API_URL                            │  │
│  └───────────────────────────────────────────────────┘  │
└────────────────────────┬──────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────┐
│              Azure Global CDN                            │
│  - Edge locations worldwide                              │
│  - Automatic SSL/TLS                                     │
│  - <100ms latency globally                               │
└────────────────────────┬──────────────────────────────────┘
                         │
                         ↓
                   🌍 End Users
```

### Next.js Static Export Configuration

```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export', // Enable static export
  images: {
    unoptimized: true, // Required for static export
  },
  trailingSlash: true, // Better for static hosting
};

module.exports = nextConfig;
```

### GitHub Actions Workflow Structure

```yaml
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - Checkout code
      - Setup Node.js
      - Install dependencies
      - Build Next.js
      - Deploy to Azure
```

---

## 📝 Tasks

### Task 1: 設定 Next.js 靜態匯出

**描述**: 設定 Next.js 為靜態匯出模式，適配 Azure Static Web Apps

**檔案**: `next.config.js`, `package.json`

**程式碼實作 (next.config.js)**:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export', // Enable static HTML export

  images: {
    unoptimized: true, // Disable Image Optimization API (not supported in static export)
  },

  trailingSlash: true, // Add trailing slash to all paths (better for static hosting)

  // Environment variables (client-side only with NEXT_PUBLIC_ prefix)
  env: {
    NEXT_PUBLIC_AZURE_TTS_REGION: process.env.NEXT_PUBLIC_AZURE_TTS_REGION || 'eastus',
  },

  // Disable server-side features not supported in static export
  reactStrictMode: true,
  swcMinify: true,
};

module.exports = nextConfig;
```

**程式碼實作 (package.json scripts)**:
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "export": "next build && next export",
    "test": "jest",
    "test:e2e": "playwright test"
  }
}
```

**驗證靜態匯出**:
```bash
# Build static export
npm run build

# Check output directory
ls -la out/

# Should see:
# - index.html
# - _next/ (static assets)
# - Static HTML pages
```

**驗證方式**:
- [ ] `npm run build` 成功執行
- [ ] `out/` 目錄包含靜態檔案
- [ ] 使用 `npx serve out` 本地測試正常
- [ ] 所有頁面可正常存取

---

### Task 2: 在 Azure Portal 建立 Static Web Apps

**描述**: 在 Azure Portal 建立 Static Web Apps 資源並連結 GitHub

**步驟**:

1. **登入 Azure Portal**:
   - URL: https://portal.azure.com
   - 使用 Microsoft 帳號登入

2. **建立 Static Web Apps**:
   - 點擊「Create a resource」
   - 搜尋「Static Web Apps」
   - 點擊「Create」

3. **基本設定**:
   ```
   Subscription: [Your Azure Subscription]
   Resource Group: smart-ai-avatar-rg (新建)
   Name: smart-ai-avatar-app
   Plan Type: Free
   Region: East Asia (或就近區域)
   ```

4. **部署細節**:
   ```
   Source: GitHub
   Organization: [Your GitHub Username]
   Repository: smart-ai-avatar-agent
   Branch: main
   Build Presets: Next.js
   ```

5. **Build 設定**:
   ```
   App location: /
   Api location: (留空，暫不使用 Azure Functions)
   Output location: out
   ```

6. **點擊「Review + Create」→「Create」**

7. **等待部署完成** (約 2-3 分鐘)

**預期結果**:
- Static Web Apps 資源建立成功
- GitHub repository 自動新增 `.github/workflows/azure-static-web-apps-*.yml`
- 顯示 Production URL (例如: `https://gentle-sea-0a1b2c3d4.5.azurestaticapps.net`)

**驗證方式**:
- [ ] Azure Portal 顯示 Static Web Apps 資源
- [ ] GitHub repository 出現 workflow 檔案
- [ ] Production URL 可存取（初次部署可能需等待）

---

### Task 3: 設定 GitHub Actions Workflow

**描述**: 檢查並優化自動生成的 GitHub Actions workflow

**檔案**: `.github/workflows/azure-static-web-apps-<random-id>.yml`

**程式碼實作**:
```yaml
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test
        continue-on-error: false

      - name: Build Next.js
        run: npm run build
        env:
          NEXT_PUBLIC_AZURE_TTS_REGION: ${{ secrets.AZURE_TTS_REGION }}

      - name: Deploy to Azure Static Web Apps
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: "" # Optional: Azure Functions location
          output_location: "out"

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"
```

**優化要點**:
1. **新增 Node.js 版本指定** (18.x)
2. **新增 npm cache** (加速 build)
3. **新增測試步驟** (確保品質)
4. **新增環境變數傳遞** (NEXT_PUBLIC_*)

**驗證方式**:
- [ ] Push to main 觸發 workflow
- [ ] Build 步驟成功
- [ ] Deploy 步驟成功
- [ ] Production URL 更新

---

### Task 4: 設定 Azure Environment Variables

**描述**: 在 Azure Portal 設定環境變數（API Keys, Secrets）

**步驟**:

1. **前往 Static Web Apps 資源**:
   - Azure Portal → Resource Groups → smart-ai-avatar-rg
   - 點擊 smart-ai-avatar-app

2. **設定 Environment Variables**:
   - 左側選單 → Configuration
   - 點擊「Application settings」
   - 新增以下變數:

   ```
   Name: AZURE_TTS_API_KEY
   Value: [Your Azure Speech Service Key]

   Name: NEXT_PUBLIC_AZURE_TTS_REGION
   Value: eastus (或您的區域)
   ```

3. **儲存設定**:
   - 點擊「Save」
   - 等待設定套用

4. **重新部署**:
   - 返回 GitHub repository
   - 觸發重新部署（推送 commit 或手動 trigger）

**安全性注意事項**:
- ⚠️ **不要** 將 API Key 寫入程式碼
- ⚠️ **不要** 將 Secrets 提交到 GitHub
- ✅ 使用 `NEXT_PUBLIC_` prefix 的變數會打包到前端（僅用於非敏感資訊）
- ✅ 無 `NEXT_PUBLIC_` prefix 的變數僅在 build time 可用

**API Key 安全方案** (POC vs Production):

**POC 階段** (目前):
```typescript
// 直接在前端呼叫 Azure TTS API (API Key 暴露風險)
const response = await fetch(
  `https://${region}.tts.speech.microsoft.com/cognitiveservices/v1`,
  {
    headers: {
      'Ocp-Apim-Subscription-Key': process.env.NEXT_PUBLIC_AZURE_TTS_API_KEY,
    },
  }
);
```

**Production 階段** (建議):
```typescript
// 透過 Azure Functions proxy 隱藏 API Key
const response = await fetch('/api/tts', {
  method: 'POST',
  body: JSON.stringify({ text: 'Hello' }),
});

// Azure Functions (api/tts.ts) 在 server-side 呼叫 Azure TTS
// API Key 儲存在 Azure Functions App Settings，不暴露給前端
```

**驗證方式**:
- [ ] Environment variables 正確設定
- [ ] 應用程式可存取環境變數
- [ ] TTS API 正常運作
- [ ] 無 API Key 暴露在前端 bundle（檢查 Network tab）

---

### Task 5: 驗證生產環境部署

**描述**: 完整測試生產環境功能

**測試清單**:

1. **存取 Production URL**:
   ```
   URL: https://<your-app>.azurestaticapps.net
   ```

2. **功能測試**:
   - [ ] 首頁正常載入
   - [ ] 3D Avatar 正常渲染
   - [ ] TTS 語音生成正常
   - [ ] Lip Sync 動畫同步
   - [ ] 聊天介面互動正常
   - [ ] 錯誤處理正常（Network offline, API fail）

3. **效能測試**:
   - [ ] Lighthouse Score:
     - Performance: ≥80
     - Accessibility: ≥90
     - Best Practices: ≥90
     - SEO: ≥80
   - [ ] FPS ≥30 (3D scene)
   - [ ] First Contentful Paint ≤1.5s
   - [ ] Largest Contentful Paint ≤2.5s

4. **跨瀏覽器測試**:
   - [ ] Chrome (Desktop + Mobile)
   - [ ] Safari (Desktop + iOS)
   - [ ] Edge
   - [ ] Firefox

5. **HTTPS 驗證**:
   - [ ] HTTPS 正常啟用
   - [ ] SSL 憑證有效
   - [ ] 無 Mixed Content 警告

6. **CDN 驗證**:
   - [ ] 檢查 Response Headers:
     ```
     x-azure-ref: [CDN reference]
     x-cache: HIT (CDN cache 生效)
     ```
   - [ ] 全球延遲 ≤100ms (使用 pingdom.com 測試)

**驗證工具**:
```bash
# Lighthouse CI
npm install -g @lhci/cli
lhci autorun --collect.url=https://<your-app>.azurestaticapps.net

# Check HTTPS
curl -I https://<your-app>.azurestaticapps.net

# Check CDN headers
curl -I https://<your-app>.azurestaticapps.net | grep x-azure
```

**驗證方式**:
- [ ] 所有功能測試通過
- [ ] Lighthouse Score 達標
- [ ] 跨瀏覽器測試通過
- [ ] HTTPS 與 CDN 正常運作

---

### Task 6: 設定 Custom Domain (Optional)

**描述**: 設定自訂網域（如 avatar.example.com）

**步驟**:

1. **購買網域** (如果尚未擁有):
   - 使用 Namecheap, GoDaddy, Google Domains 等

2. **在 Azure Portal 新增 Custom Domain**:
   - Static Web Apps → Custom domains
   - 點擊「Add」
   - 輸入網域名稱: `avatar.example.com`
   - 選擇驗證方式: CNAME or TXT record

3. **設定 DNS Records**:
   ```
   Type: CNAME
   Name: avatar
   Value: <your-app>.azurestaticapps.net
   TTL: 3600
   ```

4. **驗證網域**:
   - 返回 Azure Portal
   - 點擊「Validate」
   - 等待 DNS propagation (最多 48 小時)

5. **啟用 HTTPS**:
   - Azure 自動提供免費 SSL 憑證
   - 等待憑證配置完成 (約 5-10 分鐘)

**驗證方式**:
- [ ] Custom domain 正常解析
- [ ] HTTPS 正常啟用
- [ ] 應用程式透過 custom domain 可存取

---

### Task 7: 建立部署文件

**描述**: 撰寫部署流程文件，供團隊參考

**檔案**: `docs/deployment/azure-static-web-apps.md`

**程式碼實作**:
```markdown
# Azure Static Web Apps 部署指南

## 前置需求

- Azure 帳號（免費試用或付費）
- GitHub 帳號
- Node.js 18+
- Azure CLI (optional)

---

## 首次部署流程

### 1. 設定 Next.js 靜態匯出

編輯 `next.config.js`:
\`\`\`javascript
const nextConfig = {
  output: 'export',
  images: { unoptimized: true },
  trailingSlash: true,
};
module.exports = nextConfig;
\`\`\`

### 2. 在 Azure Portal 建立 Static Web Apps

1. 前往 https://portal.azure.com
2. 建立 Static Web Apps 資源:
   - Name: smart-ai-avatar-app
   - Plan: Free
   - Region: East Asia
   - Source: GitHub
   - Repository: smart-ai-avatar-agent
   - Branch: main
   - Build Preset: Next.js
   - Output location: out

3. 點擊「Create」並等待部署完成

### 3. 設定 Environment Variables

1. Azure Portal → Static Web Apps → Configuration
2. 新增 Application settings:
   \`\`\`
   AZURE_TTS_API_KEY: [Your Azure Speech Key]
   NEXT_PUBLIC_AZURE_TTS_REGION: eastus
   \`\`\`

### 4. 驗證部署

1. 取得 Production URL (例如: `https://gentle-sea-xyz.azurestaticapps.net`)
2. 測試所有功能:
   - 3D Avatar 渲染
   - TTS 語音生成
   - Lip Sync 動畫
3. 執行 Lighthouse 測試

---

## 日常部署流程

### 自動部署 (推薦)

Push to `main` branch 自動觸發部署:
\`\`\`bash
git add .
git commit -m "feat: add new feature"
git push origin main
\`\`\`

GitHub Actions 自動執行:
1. Install dependencies
2. Run tests
3. Build Next.js
4. Deploy to Azure

### 手動部署

使用 Azure CLI:
\`\`\`bash
# 安裝 Azure CLI
npm install -g @azure/static-web-apps-cli

# 登入
az login

# 部署
swa deploy --app-name smart-ai-avatar-app
\`\`\`

---

## 環境管理

### Production Environment
- Branch: `main`
- URL: https://<app-name>.azurestaticapps.net
- Auto-deploy: Enabled

### Staging Environment (Optional)
- Branch: `develop`
- URL: https://<app-name>-staging.azurestaticapps.net
- Auto-deploy: Enabled

### Preview Environments
- Pull Requests 自動建立 preview URLs
- URL 格式: `https://<app-name>-<pr-number>.azurestaticapps.net`

---

## 監控與除錯

### 查看部署日誌

1. GitHub → Actions → 最新 workflow run
2. 展開 "Build and Deploy Job"
3. 檢查各步驟日誌

### 查看應用程式日誌

Azure Portal → Static Web Apps → Logs (Application Insights)

### 常見問題

**Q: Build 失敗，顯示 "Module not found"**
A: 檢查 `package.json` dependencies 是否完整，執行 `npm ci` 確保本地可 build

**Q: 部署成功但頁面空白**
A: 檢查 `output_location` 是否設定為 `out`，確認 `next.config.js` 有 `output: 'export'`

**Q: TTS API 無法呼叫**
A: 檢查 Azure Portal → Configuration → Application settings，確認 `AZURE_TTS_API_KEY` 已設定

**Q: CORS 錯誤**
A: Azure Static Web Apps 預設支援 CORS，檢查 API endpoint 是否正確

---

## 成本估算

### Free Tier 限制
- 100 GB bandwidth/月
- 2 custom domains
- Staging environments: 3

### 預估成本 (POC 階段)
- Static Web Apps: NT$ 0 (Free tier)
- Azure TTS API: ~NT$ 100/月 (以 10,000 requests 計)
- **Total: ~NT$ 100/月**

### 升級至 Standard (生產環境)
- Static Web Apps Standard: NT$ 270/月
- 無 bandwidth 限制
- Unlimited custom domains
- 更多 staging environments

---

## 安全性最佳實踐

1. **API Key 管理**:
   - ⚠️ 不要將 API Key 寫入程式碼
   - ✅ 使用 Azure Portal Application settings
   - ✅ 使用 GitHub Secrets for CI/CD

2. **HTTPS**:
   - ✅ Azure 自動啟用 HTTPS
   - ✅ 定期檢查 SSL 憑證有效期

3. **存取控制**:
   - ✅ 設定 Azure RBAC (Role-Based Access Control)
   - ✅ 限制 GitHub repository 存取權限

---

## 回滾 (Rollback)

### 方法 1: GitHub Revert
\`\`\`bash
# Revert 最新 commit
git revert HEAD
git push origin main
\`\`\`

### 方法 2: Azure Portal
1. Static Web Apps → Deployments
2. 選擇先前的成功部署
3. 點擊「Activate」

---

## 參考資料

- [Azure Static Web Apps 官方文件](https://learn.microsoft.com/azure/static-web-apps/)
- [Next.js Static Export](https://nextjs.org/docs/app/building-your-application/deploying/static-exports)
- [GitHub Actions for Azure](https://github.com/Azure/actions)
```

**驗證方式**:
- [ ] 文件內容完整清晰
- [ ] 步驟可重現執行
- [ ] 包含故障排除指南
- [ ] 團隊成員可依文件部署

---

### Task 8: 設定 Monitoring 與 Alerts (Optional)

**描述**: 設定 Azure Application Insights 監控應用程式健康度

**步驟**:

1. **啟用 Application Insights**:
   - Azure Portal → Static Web Apps → Application Insights
   - 點擊「Enable」
   - 選擇或建立 Application Insights resource

2. **設定 Alerts**:
   - Application Insights → Alerts
   - 建立 Alert rule:
     ```
     Condition: Failed requests > 10 in 5 minutes
     Action: Send email to admin
     ```

3. **查看 Metrics**:
   - Application Insights → Metrics
   - 可查看:
     - Request count
     - Response time
     - Failed requests
     - Availability

4. **設定 Availability Test**:
   - Application Insights → Availability
   - 建立 URL ping test:
     ```
     Test name: Homepage availability
     URL: https://<your-app>.azurestaticapps.net
     Frequency: 5 minutes
     Locations: 5 global locations
     ```

**驗證方式**:
- [ ] Application Insights 正常收集資料
- [ ] Alerts 可正常觸發
- [ ] Availability test 正常執行
- [ ] Metrics dashboard 顯示正常

---

## 📊 Dev Notes

### Static Export Limitations

**不支援的 Next.js 功能**:
- ❌ Server-Side Rendering (SSR)
- ❌ API Routes (`pages/api/*`)
- ❌ Image Optimization API
- ❌ Incremental Static Regeneration (ISR)
- ❌ Dynamic routes with `getServerSideProps`

**支援的功能**:
- ✅ Static Site Generation (SSG)
- ✅ Client-Side Rendering (CSR)
- ✅ Dynamic routes with `getStaticPaths`
- ✅ Client-side data fetching
- ✅ All React features

**本專案使用**:
- ✅ Static pages (SSG)
- ✅ Client-side data fetching (TTS API)
- ✅ Client-side 3D rendering (Three.js)

### Azure Static Web Apps vs Vercel

| Feature | Azure SWA | Vercel |
|---------|-----------|--------|
| **Pricing (Free)** | 100GB/月 | 100GB/月 |
| **Build Minutes** | Unlimited | 6000 min/月 |
| **Custom Domains** | 2 (Free) | Unlimited |
| **SSR Support** | Limited (Functions) | ✅ Full |
| **Global CDN** | ✅ Azure CDN | ✅ Vercel Edge |
| **CI/CD** | GitHub Actions | Built-in |
| **Learning Curve** | Medium | Easy |

**為何選擇 Azure**:
- ✅ Azure ecosystem integration (TTS API 同平台)
- ✅ Free tier 足夠 POC
- ✅ 企業級安全性與合規性
- ✅ GitHub Actions 靈活性高

**何時選擇 Vercel**:
- 需要 SSR/ISR
- 更簡單的部署流程
- 不需要 Azure 整合

### Environment Variables Best Practices

**前端可見變數** (NEXT_PUBLIC_*):
```typescript
// ✅ 可以暴露給前端
NEXT_PUBLIC_API_URL=https://api.example.com
NEXT_PUBLIC_REGION=eastus

// 使用
const apiUrl = process.env.NEXT_PUBLIC_API_URL;
```

**後端專用變數**:
```typescript
// ⚠️ 不應暴露給前端
AZURE_TTS_API_KEY=xxx
DATABASE_CONNECTION_STRING=xxx

// 僅在 build time 可用 (不會打包到前端)
const apiKey = process.env.AZURE_TTS_API_KEY;
```

**安全方案演進**:

**POC 階段** (可接受暴露 API Key):
- API Key 使用 `NEXT_PUBLIC_*` prefix
- 設定 Azure TTS API 存取限制 (IP whitelist)
- 監控 API 使用量

**Production 階段** (建議):
- 建立 Azure Functions proxy
- API Key 儲存在 Azure Functions App Settings
- 前端僅呼叫 `/api/tts` endpoint

### CI/CD Optimization

**加速 Build 技巧**:

1. **npm cache**:
   ```yaml
   - uses: actions/setup-node@v3
     with:
       cache: 'npm'
   ```

2. **Dependency caching**:
   ```yaml
   - uses: actions/cache@v3
     with:
       path: ~/.npm
       key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
   ```

3. **Parallel testing**:
   ```yaml
   - run: npm run test -- --maxWorkers=2
   ```

4. **Skip redundant steps**:
   ```yaml
   - run: npm run build
     if: github.event_name == 'push'
   ```

**預期效果**:
- Build time: 5 min → 3 min (-40%)
- Deploy time: 2 min → 1.5 min (-25%)

---

## 🧪 Testing Strategy

### Pre-Deployment Testing

**Local Testing**:
```bash
# Build static export
npm run build

# Test with local server
npx serve out

# Open http://localhost:3000
# Test all features
```

**Staging Testing**:
```bash
# Create staging branch
git checkout -b staging

# Push to staging (creates preview URL)
git push origin staging

# Test on preview URL
```

### Post-Deployment Testing

**Smoke Tests** (快速驗證):
- [ ] Homepage loads
- [ ] 3D Avatar renders
- [ ] TTS API responds
- [ ] No console errors

**Full Regression Tests**:
- [ ] Execute Playwright E2E tests against production URL
```bash
PLAYWRIGHT_BASE_URL=https://<your-app>.azurestaticapps.net npm run test:e2e
```

**Performance Tests**:
```bash
# Lighthouse CI
lhci autorun --collect.url=https://<your-app>.azurestaticapps.net

# Expected scores:
# Performance: ≥80
# Accessibility: ≥90
# Best Practices: ≥90
# SEO: ≥80
```

---

## 📈 Success Metrics

### 量化指標

1. **部署成功率**: ≥95% (自動部署)
2. **Build 時間**: ≤5 分鐘
3. **Uptime**: ≥99.9%
4. **Global Latency**: ≤100ms (CDN)
5. **Lighthouse Performance**: ≥80

### 質化指標

1. **開發者體驗**: "Push to deploy 流程順暢"
2. **使用者體驗**: "全球存取速度快，無延遲"
3. **維護性**: "回滾與監控機制完善"

---

## 🔗 Dependencies

### Epic Dependencies
- **Depends on**:
  - All Epic 2-4 Stories (完整功能才可部署)
  - Story 5.1 (Performance optimization)
  - Story 5.4 (Browser compatibility)

### Story Dependencies
- **Must Complete Before**:
  - Story 5.6 (Technical Validation) - 生產環境測試結果
  - Story 5.7 (Documentation) - 部署文件

### External Dependencies
- Azure account with active subscription
- GitHub repository with Actions enabled
- Azure Speech Service API Key
- Node.js 18+

---

## 📦 Deliverables

1. **Configuration**:
   - `next.config.js` (static export) ✅
   - `.github/workflows/azure-static-web-apps-*.yml` ✅

2. **Azure Resources**:
   - Static Web Apps resource (smart-ai-avatar-app) ✅
   - Application Insights (optional) ✅

3. **Documentation**:
   - `docs/deployment/azure-static-web-apps.md` ✅
   - Environment variables documentation ✅

4. **Production URL**:
   - https://<your-app>.azurestaticapps.net ✅

---

## ✅ Definition of Done

- [ ] Next.js 設定為靜態匯出模式
- [ ] Azure Static Web Apps 資源建立成功
- [ ] GitHub Actions workflow 正常運作
- [ ] Environment variables 正確設定
- [ ] Production URL 可存取且所有功能正常
- [ ] HTTPS 正常啟用
- [ ] Global CDN 生效（x-azure-ref header 存在）
- [ ] Lighthouse Performance score ≥80
- [ ] 跨瀏覽器測試通過（Chrome, Safari, Edge, Firefox）
- [ ] Playwright E2E tests 通過（production URL）
- [ ] 部署文件完整齊全
- [ ] Monitoring 設定完成（Application Insights）
- [ ] Code review 通過

---

## 📚 References

- [Azure Static Web Apps Documentation](https://learn.microsoft.com/azure/static-web-apps/)
- [Next.js Static Export](https://nextjs.org/docs/app/building-your-application/deploying/static-exports)
- [GitHub Actions for Azure](https://github.com/Azure/static-web-apps-deploy)
- [Azure Static Web Apps CLI](https://azure.github.io/static-web-apps-cli/)
- [Application Insights](https://learn.microsoft.com/azure/azure-monitor/app/app-insights-overview)

---

**Story 建立日期**: 2025-10-14
**最後更新**: 2025-10-14
**INVEST Score**: ⭐⭐⭐⭐⭐⭐ (6/6)
- ✅ Independent: 可獨立開發與部署
- ✅ Negotiable: 部署平台、Custom domain 可選
- ✅ Valuable: 實現應用程式公開存取，展示 POC 成果
- ✅ Estimable: 6 小時預估時間合理
- ✅ Small: 範圍明確，可在一個 Sprint 內完成
- ✅ Testable: 可透過 Production URL 驗證所有功能
