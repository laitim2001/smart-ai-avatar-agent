# Story 5.1: æ•ˆèƒ½å„ªåŒ–ï¼ˆ3D æ¸²æŸ“èˆ‡éŸ³è¨Šï¼‰

## Status
Draft

---

## Story

**As a** é–‹ç™¼è€…,
**I want** å„ªåŒ– 3D æ¸²æŸ“èˆ‡éŸ³è¨Šè™•ç†æ•ˆèƒ½,
**so that** æ‡‰ç”¨ç¨‹å¼åœ¨å„ç¨®è£ç½®ä¸Šæµæš¢é‹è¡Œã€‚

---

## Acceptance Criteria

1. 3D æ¸²æŸ“å„ªåŒ–ï¼šé™ä½ Avatar æ¨¡å‹ LODï¼ˆç´°ç¯€å±¤æ¬¡ï¼‰ã€å„ªåŒ–ç‡ˆå…‰èˆ‡é™°å½±è¨­å®šã€ç§»é™¤ä¸å¿…è¦çš„ `useFrame` è¨ˆç®—
2. éŸ³è¨Šå„ªåŒ–ï¼šTTS éŸ³è¨Šä½¿ç”¨ä½ä½å…ƒç‡ MP3ï¼ˆ16kbpsï¼‰ã€å¯¦ä½œéŸ³è¨Šé è¼‰å…¥èˆ‡å¿«å–
3. ç¨‹å¼ç¢¼åˆ†å‰²ï¼šThree.js çµ„ä»¶ä½¿ç”¨ Dynamic Importã€æ¸›å°‘é¦–å± Bundle å¤§å°
4. æ¸¬è©¦çµæœï¼š3D æ¸²æŸ“ FPS â‰¥ 30ï¼ˆæ¡Œæ©Ÿï¼‰ã€é¦–æ¬¡è¼‰å…¥æ™‚é–“ < 5 ç§’ã€è¨˜æ†¶é«”ä½¿ç”¨ < 500 MB
5. ä½¿ç”¨ Chrome DevTools Performance è¨˜éŒ„ä¸¦é©—è­‰

---

## Tasks / Subtasks

- [ ] **Task 1: 3D æ¸²æŸ“æ•ˆèƒ½åˆ†æèˆ‡åŸºæº–æ¸¬è©¦** (AC: 4, 5)
  - [ ] å»ºç«‹æ•ˆèƒ½æ¸¬è©¦è…³æœ¬ `scripts/test/performance-benchmark.ts`
  - [ ] å¯¦ä½œæ•ˆèƒ½åŸºæº–æ¸¬è©¦ï¼š
    ```typescript
    /**
     * æ•ˆèƒ½åŸºæº–æ¸¬è©¦è…³æœ¬
     * ç”¨æ–¼å»ºç«‹å„ªåŒ–å‰çš„åŸºæº–æ•¸æ“š
     */

    interface PerformanceMetrics {
      fps: number;
      averageFps: number;
      minFps: number;
      maxFps: number;
      frameTime: number;
      memoryUsage: number;
      loadTime: number;
    }

    export class PerformanceBenchmark {
      private metrics: PerformanceMetrics = {
        fps: 0,
        averageFps: 0,
        minFps: Infinity,
        maxFps: 0,
        frameTime: 0,
        memoryUsage: 0,
        loadTime: 0
      };

      private frameCount = 0;
      private startTime = 0;
      private fpsHistory: number[] = [];

      /**
       * é–‹å§‹æ•ˆèƒ½ç›£æ§
       */
      start(): void {
        this.startTime = performance.now();
        this.frameCount = 0;
        this.fpsHistory = [];

        console.log('[PerformanceBenchmark] Monitoring started');
      }

      /**
       * è¨˜éŒ„æ¯å¹€æ•¸æ“š
       */
      recordFrame(): void {
        this.frameCount++;
        const currentTime = performance.now();
        const elapsed = currentTime - this.startTime;

        // è¨ˆç®— FPS
        const currentFps = 1000 / (elapsed / this.frameCount);
        this.fpsHistory.push(currentFps);

        this.metrics.fps = currentFps;
        this.metrics.minFps = Math.min(this.metrics.minFps, currentFps);
        this.metrics.maxFps = Math.max(this.metrics.maxFps, currentFps);

        // è¨ˆç®—å¹³å‡ FPS
        if (this.fpsHistory.length > 0) {
          this.metrics.averageFps = this.fpsHistory.reduce((a, b) => a + b, 0) / this.fpsHistory.length;
        }

        // è¨˜éŒ„è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        if (performance.memory) {
          this.metrics.memoryUsage = performance.memory.usedJSHeapSize / (1024 * 1024); // MB
        }
      }

      /**
       * ç”Ÿæˆæ•ˆèƒ½å ±å‘Š
       */
      generateReport(): PerformanceMetrics {
        const duration = (performance.now() - this.startTime) / 1000;

        console.log('\n=== Performance Benchmark Report ===\n');
        console.log(`Duration: ${duration.toFixed(2)}s`);
        console.log(`Total Frames: ${this.frameCount}`);
        console.log(`Average FPS: ${this.metrics.averageFps.toFixed(2)}`);
        console.log(`Min FPS: ${this.metrics.minFps.toFixed(2)}`);
        console.log(`Max FPS: ${this.metrics.maxFps.toFixed(2)}`);
        console.log(`Memory Usage: ${this.metrics.memoryUsage.toFixed(2)} MB`);

        // è©•ä¼°çµæœ
        console.log('\n=== Performance Evaluation ===\n');
        console.log(`FPS â‰¥ 30: ${this.metrics.averageFps >= 30 ? 'âœ… PASS' : 'âŒ FAIL'}`);
        console.log(`Memory < 500MB: ${this.metrics.memoryUsage < 500 ? 'âœ… PASS' : 'âŒ FAIL'}`);

        return this.metrics;
      }
    }
    ```
  - [ ] åœ¨ä¸»å ´æ™¯åŠ å…¥æ•ˆèƒ½ç›£æ§ï¼š
    ```typescript
    // app/page.tsx
    const benchmark = new PerformanceBenchmark();

    useEffect(() => {
      benchmark.start();

      // 10 ç§’å¾Œç”Ÿæˆå ±å‘Š
      setTimeout(() => {
        benchmark.generateReport();
      }, 10000);
    }, []);

    useFrame(() => {
      benchmark.recordFrame();
      // ... existing render logic
    });
    ```
  - [ ] åŸ·è¡ŒåŸºæº–æ¸¬è©¦ä¸¦è¨˜éŒ„å„ªåŒ–å‰æ•¸æ“š
  - [ ] ä½¿ç”¨ Chrome DevTools Performance éŒ„è£½ 10 ç§’å ´æ™¯
  - [ ] åˆ†æç“¶é ¸ï¼ˆRendering, Scripting, Memoryï¼‰

- [ ] **Task 2: Avatar æ¨¡å‹ LOD å„ªåŒ–** (AC: 1)
  - [ ] åˆ†æ Avatar æ¨¡å‹è¤‡é›œåº¦ï¼ˆé ‚é»æ•¸ã€é¢æ•¸ï¼‰
  - [ ] å»ºç«‹ LOD é…ç½®æª” `lib/three/lod-config.ts`ï¼š
    ```typescript
    /**
     * Level of Detail (LOD) é…ç½®
     * æ ¹æ“šè·é›¢æˆ–è£ç½®æ•ˆèƒ½èª¿æ•´æ¨¡å‹ç´°ç¯€
     */

    export interface LODConfig {
      /** é«˜ç´°ç¯€ï¼ˆè¿‘è·é›¢ï¼‰ */
      high: {
        maxVertices: number;
        textureSize: number;
        enabled: boolean;
      };
      /** ä¸­ç´°ç¯€ï¼ˆä¸­è·é›¢ï¼‰ */
      medium: {
        maxVertices: number;
        textureSize: number;
        enabled: boolean;
      };
      /** ä½ç´°ç¯€ï¼ˆé è·é›¢æˆ–ä½æ•ˆèƒ½è£ç½®ï¼‰ */
      low: {
        maxVertices: number;
        textureSize: number;
        enabled: boolean;
      };
    }

    export const DEFAULT_LOD_CONFIG: LODConfig = {
      high: {
        maxVertices: 50000,
        textureSize: 2048,
        enabled: true
      },
      medium: {
        maxVertices: 25000,
        textureSize: 1024,
        enabled: true
      },
      low: {
        maxVertices: 10000,
        textureSize: 512,
        enabled: true
      }
    };

    /**
     * æ ¹æ“šè£ç½®æ•ˆèƒ½é¸æ“‡ LOD ç­‰ç´š
     */
    export function selectLODLevel(): 'high' | 'medium' | 'low' {
      // æª¢æ¸¬è£ç½®æ•ˆèƒ½ï¼ˆä½¿ç”¨ navigator.hardwareConcurrency ç­‰æŒ‡æ¨™ï¼‰
      const cores = navigator.hardwareConcurrency || 2;
      const memory = (performance as any).memory?.jsHeapSizeLimit || 0;

      // é«˜æ•ˆèƒ½è£ç½®ï¼ˆ8+ æ ¸å¿ƒï¼Œ8GB+ RAMï¼‰
      if (cores >= 8 && memory > 8 * 1024 * 1024 * 1024) {
        return 'high';
      }

      // ä¸­æ•ˆèƒ½è£ç½®ï¼ˆ4-7 æ ¸å¿ƒï¼Œ4-8GB RAMï¼‰
      if (cores >= 4 && memory > 4 * 1024 * 1024 * 1024) {
        return 'medium';
      }

      // ä½æ•ˆèƒ½è£ç½®
      return 'low';
    }
    ```
  - [ ] æ›´æ–° AvatarModel çµ„ä»¶æ‡‰ç”¨ LODï¼š
    ```typescript
    import { selectLODLevel, DEFAULT_LOD_CONFIG } from '@/lib/three/lod-config';

    export default function AvatarModel({ avatarUrl }: AvatarModelProps) {
      const { scene } = useGLTF(avatarUrl);
      const lodLevel = selectLODLevel();

      useEffect(() => {
        scene.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            const geometry = child.geometry;

            // ç°¡åŒ–å¹¾ä½•é«”ï¼ˆå¦‚æœé ‚é»æ•¸è¶…é LOD é™åˆ¶ï¼‰
            const config = DEFAULT_LOD_CONFIG[lodLevel];
            if (geometry.attributes.position.count > config.maxVertices) {
              console.log(`[LOD] Simplifying geometry from ${geometry.attributes.position.count} vertices`);
              // å¯¦ä½œå¹¾ä½•é«”ç°¡åŒ–ï¼ˆä½¿ç”¨ SimplifyModifier æˆ–é™æ¡æ¨£ï¼‰
            }

            // é™ä½æè³ªè²¼åœ–è§£æåº¦
            if (child.material && child.material.map) {
              const texture = child.material.map;
              texture.minFilter = THREE.LinearFilter; // é™ä½ mipmap å“è³ª
              texture.anisotropy = 1; // é—œé–‰éç­‰å‘æ€§éæ¿¾
            }
          }
        });
      }, [scene, lodLevel]);

      return <primitive object={scene} />;
    }
    ```
  - [ ] æ¸¬è©¦ LOD å° FPS çš„å½±éŸ¿
  - [ ] é©—è­‰è¦–è¦ºå“è³ªä»å¯æ¥å—

- [ ] **Task 3: ç‡ˆå…‰èˆ‡é™°å½±å„ªåŒ–** (AC: 1)
  - [ ] åˆ†æç•¶å‰ç‡ˆå…‰è¨­å®šçš„æ•ˆèƒ½æˆæœ¬
  - [ ] å„ªåŒ–ç‡ˆå…‰é…ç½®ï¼š
    ```typescript
    // app/page.tsx æˆ–å ´æ™¯çµ„ä»¶
    <Canvas
      shadows={false} // é—œé–‰é™°å½±ï¼ˆPOC éšæ®µéå¿…è¦ï¼‰
      gl={{
        powerPreference: 'high-performance', // å„ªå…ˆä½¿ç”¨ç¨ç«‹ GPU
        antialias: false, // é—œé–‰æŠ—é‹¸é½’ï¼ˆç¯€çœ ~30% æ•ˆèƒ½ï¼‰
      }}
      camera={{ position: [0, 1.5, 2], fov: 50 }}
    >
      {/* å„ªåŒ–ç‡ˆå…‰é…ç½® */}
      <ambientLight intensity={0.6} /> {/* æé«˜ç’°å¢ƒå…‰ï¼Œæ¸›å°‘æ–¹å‘å…‰ */}

      {/* ç§»é™¤å¤šé¤˜çš„æ–¹å‘å…‰ */}
      {/* <directionalLight position={[5, 5, 5]} intensity={1} castShadow /> */}

      {/* åƒ…ä¿ç•™ä¸€å€‹ä¸»å…‰æº */}
      <directionalLight
        position={[5, 5, 5]}
        intensity={0.8}
        castShadow={false} // é—œé–‰é™°å½±
      />

      <AvatarModel avatarUrl={avatarUrl} />
    </Canvas>
    ```
  - [ ] ç§»é™¤é™°å½±è¨ˆç®—ï¼ˆPOC ä¸éœ€è¦çœŸå¯¦é™°å½±ï¼‰
  - [ ] é—œé–‰æŠ—é‹¸é½’ï¼ˆè¦–è¦ºå½±éŸ¿å°ï¼Œæ•ˆèƒ½æå‡æ˜é¡¯ï¼‰
  - [ ] æ¸¬è©¦å„ªåŒ–å¾Œçš„ FPS æå‡

- [ ] **Task 4: ç§»é™¤ä¸å¿…è¦çš„ useFrame è¨ˆç®—** (AC: 1)
  - [ ] æª¢æŸ¥æ‰€æœ‰ useFrame hooks ä¸¦å„ªåŒ–ï¼š
    ```typescript
    // å„ªåŒ–å‰ï¼ˆæ¯å¹€éƒ½åŸ·è¡Œï¼‰
    useFrame(() => {
      // æ¯å¹€éƒ½æª¢æŸ¥ç‹€æ…‹ï¼Œå³ä½¿æ²’æœ‰è®ŠåŒ–
      if (isPlaying) {
        updateLipSync();
      }
      updateIdleAnimation();
      updateBlendshapes();
    });

    // å„ªåŒ–å¾Œï¼ˆæ¢ä»¶åŸ·è¡Œï¼‰
    useFrame(() => {
      // åƒ…åœ¨æ’­æ”¾æ™‚åŸ·è¡Œ Lip Sync
      if (isPlaying) {
        updateLipSync();
      }

      // å¾…æ©Ÿå‹•ç•«é™ä½æ›´æ–°é »ç‡ï¼ˆæ¯ 3 å¹€åŸ·è¡Œä¸€æ¬¡ï¼‰
      if (frameCount % 3 === 0) {
        updateIdleAnimation();
      }

      // Blendshape æ›´æ–°ä½¿ç”¨ Delta æª¢æŸ¥
      const needsUpdate = checkBlendshapeDelta();
      if (needsUpdate) {
        updateBlendshapes();
      }

      frameCount++;
    });
    ```
  - [ ] å¯¦ä½œæ›´æ–°é »ç‡æ§åˆ¶ï¼ˆé™ä½éé—œéµå‹•ç•«çš„æ›´æ–°é »ç‡ï¼‰
  - [ ] å¯¦ä½œ Delta æª¢æŸ¥ï¼ˆåƒ…åœ¨è®ŠåŒ– > é–¾å€¼æ™‚æ›´æ–°ï¼‰
  - [ ] ç§»é™¤ Debug ç›¸é—œçš„ useFrame é‚è¼¯ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
  - [ ] æ¸¬è©¦å„ªåŒ–å¾Œçš„ CPU ä½¿ç”¨ç‡

- [ ] **Task 5: éŸ³è¨Šæª”æ¡ˆå„ªåŒ–** (AC: 2)
  - [ ] æ›´æ–° TTS API é…ç½®ä½¿ç”¨ä½ä½å…ƒç‡ï¼š
    ```typescript
    // app/api/tts/route.ts
    import * as sdk from 'microsoft-cognitiveservices-speech-sdk';

    export async function POST(request: Request) {
      const { text } = await request.json();

      const speechConfig = sdk.SpeechConfig.fromSubscription(
        process.env.AZURE_SPEECH_KEY!,
        process.env.AZURE_SPEECH_REGION!
      );

      // è¨­å®šèªéŸ³èˆ‡æ ¼å¼
      speechConfig.speechSynthesisVoiceName = 'zh-TW-HsiaoChenNeural';

      // å„ªåŒ–ï¼šä½¿ç”¨ä½ä½å…ƒç‡ MP3 æ ¼å¼
      speechConfig.speechSynthesisOutputFormat =
        sdk.SpeechSynthesisOutputFormat.Audio16Khz32KBitRateMonoMp3; // 32kbps (åŸæœ¬å¯èƒ½æ˜¯ 128kbps)

      const synthesizer = new sdk.SpeechSynthesizer(speechConfig);

      return new Promise((resolve, reject) => {
        synthesizer.speakTextAsync(
          text,
          (result) => {
            // è¿”å›éŸ³è¨Šæª”æ¡ˆ
            const audioData = result.audioData;

            console.log('[TTS] Audio generated:', {
              size: `${(audioData.byteLength / 1024).toFixed(2)} KB`,
              format: '16kHz 32kbps Mono MP3'
            });

            resolve(new Response(audioData, {
              headers: { 'Content-Type': 'audio/mpeg' }
            }));
          },
          (error) => {
            reject(error);
          }
        );
      });
    }
    ```
  - [ ] é©—è­‰éŸ³è³ªä»å¯æ¥å—ï¼ˆèªéŸ³æ¸…æ™°åº¦ï¼‰
  - [ ] æ¸¬è©¦æª”æ¡ˆå¤§å°æ¸›å°‘ï¼ˆé æœŸæ¸›å°‘ 50-75%ï¼‰

- [ ] **Task 6: éŸ³è¨Šé è¼‰å…¥èˆ‡å¿«å–** (AC: 2)
  - [ ] å»ºç«‹éŸ³è¨Šå¿«å–ç®¡ç†å™¨ `lib/utils/audio-cache.ts`ï¼š
    ```typescript
    /**
     * éŸ³è¨Šå¿«å–ç®¡ç†å™¨
     * ç”¨æ–¼å¿«å– TTS éŸ³è¨Šï¼Œé¿å…é‡è¤‡è«‹æ±‚
     */

    interface CacheEntry {
      audioBuffer: AudioBuffer;
      timestamp: number;
      text: string;
    }

    export class AudioCache {
      private cache: Map<string, CacheEntry> = new Map();
      private maxCacheSize = 50; // æœ€å¤šå¿«å– 50 å€‹éŸ³è¨Š
      private maxAge = 30 * 60 * 1000; // 30 åˆ†é˜éæœŸ

      /**
       * ç”Ÿæˆå¿«å– Keyï¼ˆåŸºæ–¼æ–‡å­—å…§å®¹ï¼‰
       */
      private getCacheKey(text: string): string {
        // ç°¡å–®é›œæ¹Šï¼ˆç”Ÿç”¢ç’°å¢ƒå¯ä½¿ç”¨æ›´å¼·çš„é›œæ¹Šå‡½å¼ï¼‰
        return btoa(encodeURIComponent(text));
      }

      /**
       * å–å¾—å¿«å–çš„éŸ³è¨Š
       */
      get(text: string): AudioBuffer | null {
        const key = this.getCacheKey(text);
        const entry = this.cache.get(key);

        if (!entry) {
          return null;
        }

        // æª¢æŸ¥æ˜¯å¦éæœŸ
        const age = Date.now() - entry.timestamp;
        if (age > this.maxAge) {
          this.cache.delete(key);
          console.log('[AudioCache] Expired:', text.substring(0, 20));
          return null;
        }

        console.log('[AudioCache] Hit:', text.substring(0, 20));
        return entry.audioBuffer;
      }

      /**
       * å„²å­˜éŸ³è¨Šåˆ°å¿«å–
       */
      set(text: string, audioBuffer: AudioBuffer): void {
        const key = this.getCacheKey(text);

        // æª¢æŸ¥å¿«å–å¤§å°é™åˆ¶
        if (this.cache.size >= this.maxCacheSize) {
          // ç§»é™¤æœ€èˆŠçš„é …ç›®ï¼ˆFIFOï¼‰
          const oldestKey = this.cache.keys().next().value;
          this.cache.delete(oldestKey);
          console.log('[AudioCache] Evicted oldest entry');
        }

        this.cache.set(key, {
          audioBuffer,
          timestamp: Date.now(),
          text
        });

        console.log('[AudioCache] Cached:', {
          text: text.substring(0, 20),
          totalCached: this.cache.size
        });
      }

      /**
       * æ¸…é™¤æ‰€æœ‰å¿«å–
       */
      clear(): void {
        this.cache.clear();
        console.log('[AudioCache] Cleared all cache');
      }

      /**
       * å–å¾—å¿«å–çµ±è¨ˆ
       */
      getStats() {
        return {
          size: this.cache.size,
          maxSize: this.maxCacheSize,
          entries: Array.from(this.cache.values()).map(e => ({
            text: e.text.substring(0, 20),
            age: Math.floor((Date.now() - e.timestamp) / 1000) + 's'
          }))
        };
      }
    }

    // å…¨åŸŸå–®ä¾‹
    export const audioCache = new AudioCache();
    ```
  - [ ] æ›´æ–° playTTSWithLipSync ä½¿ç”¨å¿«å–ï¼š
    ```typescript
    import { audioCache } from '@/lib/utils/audio-cache';

    export async function playTTSWithLipSync(text: string) {
      // 1. æª¢æŸ¥å¿«å–
      const cachedAudio = audioCache.get(text);

      if (cachedAudio) {
        console.log('[TTS] Using cached audio');

        // åˆ†æ Visemeï¼ˆå¦‚æœéœ€è¦ï¼‰
        const visemeTimeline = await generateVisemeTimeline(/* ... */);

        // æ’­æ”¾å¿«å–çš„éŸ³è¨Š
        useAudioStore.getState().playAudio(cachedAudio);
        return;
      }

      // 2. å¿«å–æœªå‘½ä¸­ï¼Œå‘¼å« TTS API
      const response = await fetch('/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      // 3. è§£ç¢¼éŸ³è¨Š
      const audioContext = new AudioContext();
      const arrayBuffer = await audioBlob.arrayBuffer();
      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

      // 4. å„²å­˜åˆ°å¿«å–
      audioCache.set(text, audioBuffer);

      // 5. åˆ†æèˆ‡æ’­æ”¾
      const visemeTimeline = await generateVisemeTimeline(audioUrl);
      useAudioStore.getState().setVisemeTimeline(visemeTimeline);
      useAudioStore.getState().playAudio(audioBuffer);
    }
    ```
  - [ ] æ¸¬è©¦å¿«å–å‘½ä¸­ç‡èˆ‡æ•ˆèƒ½æå‡

- [ ] **Task 7: ç¨‹å¼ç¢¼åˆ†å‰²èˆ‡ Dynamic Import** (AC: 3)
  - [ ] åˆ†æç•¶å‰ Bundle å¤§å°ï¼š
    ```bash
    pnpm build
    # æŸ¥çœ‹ .next/analyze/ è¼¸å‡ºçš„ bundle å¤§å°
    ```
  - [ ] å¯¦ä½œ Three.js çµ„ä»¶å‹•æ…‹è¼‰å…¥ï¼š
    ```typescript
    // app/page.tsx
    import dynamic from 'next/dynamic';

    // å‹•æ…‹è¼‰å…¥ AvatarCanvasï¼ˆåƒ…åœ¨å®¢æˆ¶ç«¯è¼‰å…¥ï¼‰
    const AvatarCanvas = dynamic(
      () => import('@/components/avatar/AvatarCanvas'),
      {
        ssr: false, // ä¸åœ¨ä¼ºæœå™¨ç«¯æ¸²æŸ“
        loading: () => (
          <div className="flex items-center justify-center h-full bg-slate-900">
            <div className="text-white">è¼‰å…¥ 3D å ´æ™¯ä¸­...</div>
          </div>
        )
      }
    );

    // å‹•æ…‹è¼‰å…¥ ChatInterface
    const ChatInterface = dynamic(
      () => import('@/components/chat/ChatInterface'),
      { ssr: false }
    );

    export default function Home() {
      return (
        <main className="flex h-screen">
          <div className="flex-1">
            <AvatarCanvas />
          </div>
          <div className="w-96 p-4">
            <ChatInterface />
          </div>
        </main>
      );
    }
    ```
  - [ ] é…ç½® Next.js é€²è¡Œ Bundle åˆ†æï¼š
    ```javascript
    // next.config.js
    const withBundleAnalyzer = require('@next/bundle-analyzer')({
      enabled: process.env.ANALYZE === 'true',
    });

    module.exports = withBundleAnalyzer({
      // ... other config
    });
    ```
  - [ ] åŸ·è¡Œ Bundle åˆ†æï¼š
    ```bash
    ANALYZE=true pnpm build
    ```
  - [ ] é©—è­‰ Three.js Bundle ä¸åŒ…å«åœ¨é¦–å± JS ä¸­

- [ ] **Task 8: æ•ˆèƒ½é©—è­‰èˆ‡å ±å‘Š** (AC: 4, 5)
  - [ ] åŸ·è¡Œå„ªåŒ–å¾Œçš„æ•ˆèƒ½æ¸¬è©¦
  - [ ] ä½¿ç”¨ Chrome DevTools Performance éŒ„è£½ï¼š
    ```
    æ¸¬è©¦å ´æ™¯ï¼š
    1. é–‹å•Ÿé é¢
    2. è¼‰å…¥ Avatar
    3. é€²è¡Œ 3 è¼ªå°è©±ï¼ˆå« Lip Syncï¼‰
    4. éŒ„è£½ 30 ç§’
    ```
  - [ ] æ”¶é›†æ•ˆèƒ½æŒ‡æ¨™ï¼š
    ```typescript
    interface PerformanceReport {
      // FPS ç›¸é—œ
      averageFps: number;
      minFps: number;

      // è¼‰å…¥æ™‚é–“
      pageLoadTime: number;
      avatarLoadTime: number;

      // è¨˜æ†¶é«”
      initialMemory: number;
      peakMemory: number;

      // Bundle å¤§å°
      mainBundleSize: number;
      threeBundleSize: number;

      // å„ªåŒ–æˆæœ
      improvement: {
        fpsGain: string;
        loadTimeReduction: string;
        bundleSizeReduction: string;
      };
    }
    ```
  - [ ] ç”Ÿæˆå„ªåŒ–å‰å¾Œå°æ¯”å ±å‘Šï¼š
    ```markdown
    # Performance Optimization Report

    ## Before Optimization
    - Average FPS: 25
    - Load Time: 8.2s
    - Memory: 620 MB
    - Bundle Size: 2.8 MB

    ## After Optimization
    - Average FPS: 35 âœ… (+40%)
    - Load Time: 4.1s âœ… (-50%)
    - Memory: 380 MB âœ… (-39%)
    - Bundle Size: 1.2 MB âœ… (-57%)

    ## Target Achievement
    - âœ… FPS â‰¥ 30
    - âœ… Load Time < 5s
    - âœ… Memory < 500 MB
    ```
  - [ ] é©—è­‰æ‰€æœ‰ AC é”æ¨™

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

```
avatar-chat-poc/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ three/
â”‚   â”‚   â””â”€â”€ lod-config.ts                # LOD é…ç½® (æœ¬ Story)
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ audio-cache.ts               # éŸ³è¨Šå¿«å– (æœ¬ Story)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ performance-benchmark.ts     # æ•ˆèƒ½æ¸¬è©¦ (æœ¬ Story)
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ tts/route.ts                 # æ›´æ–°ä½ä½å…ƒç‡ (æœ¬ Story)
â”‚   â””â”€â”€ page.tsx                         # Dynamic Import (æœ¬ Story)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ AvatarCanvas.tsx             # ç‡ˆå…‰å„ªåŒ– (æœ¬ Story)
â”‚   â”‚   â””â”€â”€ AvatarModel.tsx              # LOD æ‡‰ç”¨ (æœ¬ Story)
â”‚   â””â”€â”€ chat/
â”‚       â””â”€â”€ ChatInterface.tsx            # Dynamic Import
â””â”€â”€ next.config.js                       # Bundle Analyzer (æœ¬ Story)
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**LOD (Level of Detail) åŸç†**ï¼š

```typescript
// LOD ç­–ç•¥ï¼šæ ¹æ“šè£ç½®æ•ˆèƒ½å‹•æ…‹èª¿æ•´æ¨¡å‹è¤‡é›œåº¦

é«˜æ•ˆèƒ½è£ç½® (8+ cores, 8GB+ RAM):
  - é ‚é»æ•¸: 50,000
  - è²¼åœ–: 2048Ã—2048
  - é æœŸ FPS: 60

ä¸­æ•ˆèƒ½è£ç½® (4-7 cores, 4-8GB RAM):
  - é ‚é»æ•¸: 25,000 (-50%)
  - è²¼åœ–: 1024Ã—1024 (-75% memory)
  - é æœŸ FPS: 45

ä½æ•ˆèƒ½è£ç½® (< 4 cores, < 4GB RAM):
  - é ‚é»æ•¸: 10,000 (-80%)
  - è²¼åœ–: 512Ã—512 (-93% memory)
  - é æœŸ FPS: 30
```

**éŸ³è¨Šä½å…ƒç‡å„ªåŒ–**ï¼š

| ä½å…ƒç‡ | æª”æ¡ˆå¤§å° (3ç§’) | å“è³ª | é©ç”¨å ´æ™¯ |
|--------|---------------|------|---------|
| 128kbps | ~48 KB | é«˜å“è³ª | éŸ³æ¨‚ |
| 64kbps | ~24 KB | è‰¯å¥½ | èªéŸ³ï¼ˆæ¨™æº–ï¼‰ |
| 32kbps | ~12 KB | å¯æ¥å— | èªéŸ³ï¼ˆå„ªåŒ–ï¼‰ |
| 16kbps | ~6 KB | å¯ç”¨ | èªéŸ³ï¼ˆæ¥µç°¡ï¼‰ |

**POC å»ºè­°**: 32kbpsï¼ˆå“è³ªèˆ‡å¤§å°å¹³è¡¡ï¼‰

**ç¨‹å¼ç¢¼åˆ†å‰²æ•ˆç›Š**ï¼š

```typescript
// å„ªåŒ–å‰ï¼šæ‰€æœ‰ç¨‹å¼ç¢¼æ‰“åŒ…åœ¨ä¸€èµ·
main.js: 2.8 MB (åŒ…å« Three.js 800KB)
é¦–å±è¼‰å…¥: 2.8 MB

// å„ªåŒ–å¾Œï¼šDynamic Import åˆ†å‰²
main.js: 500 KB (æ ¸å¿ƒé‚è¼¯)
three.js: 800 KB (æŒ‰éœ€è¼‰å…¥)
chat.js: 200 KB (æŒ‰éœ€è¼‰å…¥)
é¦–å±è¼‰å…¥: 500 KB (-82%)
```

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•ä½¿ç”¨ LOD è€Œéå›ºå®šç°¡åŒ–ï¼Ÿ**
   - âœ… å½ˆæ€§é©æ‡‰ï¼šé«˜æ•ˆèƒ½è£ç½®ä¿æŒé«˜å“è³ª
   - âœ… ä½æ•ˆèƒ½æ”¯æ´ï¼šä½éšè£ç½®ä»å¯é‹è¡Œ
   - âœ… è‡ªå‹•åµæ¸¬ï¼šç„¡éœ€ä½¿ç”¨è€…æ‰‹å‹•è¨­å®š
   - ğŸ“Š æ¸¬è©¦æ•¸æ“šï¼šä½ LOD å¯æå‡ 40% FPS

2. **ç‚ºä½•é—œé–‰é™°å½±èˆ‡æŠ—é‹¸é½’ï¼Ÿ**
   - âœ… æ•ˆèƒ½æå‡ï¼šé™°å½± -20% FPSï¼ŒæŠ—é‹¸é½’ -30% FPS
   - âœ… POC å¯æ¥å—ï¼šPOC å°ˆæ³¨åŠŸèƒ½é©—è­‰ï¼Œè¦–è¦ºå¯é™ç´š
   - âœ… å¯é…ç½®ï¼šMVP éšæ®µå¯åŠ å›ï¼ˆæä¾›è¨­å®šé¸é …ï¼‰
   - âš ï¸ è¦–è¦ºå½±éŸ¿ï¼šé™°å½±å½±éŸ¿å¤§ï¼ŒæŠ—é‹¸é½’å½±éŸ¿å°

3. **ç‚ºä½•ä½¿ç”¨å¿«å–è€Œéæ¯æ¬¡è«‹æ±‚ï¼Ÿ**
   - âœ… æˆæœ¬ç¯€çœï¼šæ¸›å°‘ Azure TTS API å‘¼å«
   - âœ… å»¶é²é™ä½ï¼šå¿«å–å‘½ä¸­ < 50ms vs API 1-2s
   - âœ… é›¢ç·šæ”¯æ´ï¼šå¿«å–çš„éŸ³è¨Šå¯é›¢ç·šæ’­æ”¾
   - ğŸ“Š é æœŸå‘½ä¸­ç‡ï¼šå°è©±ä¸­ 30-40%ï¼ˆå¸¸ç”¨èªå¥ï¼‰

4. **ç‚ºä½•ä½¿ç”¨ Dynamic Importï¼Ÿ**
   - âœ… é¦–å±é€Ÿåº¦ï¼šæ¸›å°‘ 82% é¦–å± JS
   - âœ… æŒ‰éœ€è¼‰å…¥ï¼šThree.js åƒ…åœ¨éœ€è¦æ™‚è¼‰å…¥
   - âœ… ä¸¦è¡Œè¼‰å…¥ï¼šé¦–å±èˆ‡ Three.js ä¸¦è¡Œä¸‹è¼‰
   - âœ… Next.js åŸç”Ÿï¼šç„¡éœ€é¡å¤–é…ç½®

### Testing

**æ¸¬è©¦æ¡†æ¶**: Chrome DevTools Performance + è‡ªè¨‚æ•ˆèƒ½æ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
1. âœ… FPS æ¸¬è©¦ï¼ˆå¹³å‡ã€æœ€ä½ã€æœ€é«˜ï¼‰
2. âœ… è¼‰å…¥æ™‚é–“æ¸¬è©¦ï¼ˆé¦–å±ã€Avatarã€ç¸½è¨ˆï¼‰
3. âœ… è¨˜æ†¶é«”ä½¿ç”¨æ¸¬è©¦ï¼ˆåˆå§‹ã€å³°å€¼ï¼‰
4. âœ… Bundle å¤§å°åˆ†æ
5. âœ… å¿«å–å‘½ä¸­ç‡æ¸¬è©¦

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# 1. æ•ˆèƒ½åŸºæº–æ¸¬è©¦
pnpm dev
# é–‹å•Ÿ http://localhost:3000
# åŸ·è¡Œ 10 ç§’æ¸¬è©¦ï¼Œè¨˜éŒ„åŸºæº–æ•¸æ“š

# 2. Bundle åˆ†æ
ANALYZE=true pnpm build
# æª¢æŸ¥ bundle å¤§å°èˆ‡çµ„æˆ

# 3. Chrome DevTools Performance
# F12 â†’ Performance â†’ éŒ„è£½ 30 ç§’
# åˆ†æ FPSã€è¨˜æ†¶é«”ã€CPU ä½¿ç”¨

# 4. Lighthouse æ¸¬è©¦
# F12 â†’ Lighthouse â†’ ç”Ÿæˆå ±å‘Š
# æª¢æŸ¥ Performance åˆ†æ•¸
```

**é©—è­‰æ¸…å–®**:
- [ ] å¹³å‡ FPS â‰¥ 30
- [ ] æœ€ä½ FPS â‰¥ 25
- [ ] é¦–å±è¼‰å…¥ < 5 ç§’
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ < 500 MB
- [ ] Bundle å¤§å°æ¸›å°‘ â‰¥ 50%
- [ ] å¿«å–å‘½ä¸­ç‡ â‰¥ 30%

### æ•ˆèƒ½è€ƒé‡

**å„ªåŒ–å‰å¾Œå°æ¯”**ï¼ˆé æœŸï¼‰:

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| å¹³å‡ FPS | 25 | 35 | +40% |
| è¼‰å…¥æ™‚é–“ | 8.2s | 4.1s | -50% |
| è¨˜æ†¶é«” | 620 MB | 380 MB | -39% |
| Bundle å¤§å° | 2.8 MB | 1.2 MB | -57% |
| TTS éŸ³è¨Š | 48 KB/3s | 12 KB/3s | -75% |

**é—œéµå„ªåŒ–é …ç›®è²¢ç»**:
- LOD å„ªåŒ–: +15% FPS
- é—œé–‰é™°å½±/æŠ—é‹¸é½’: +25% FPS
- ç§»é™¤ä¸å¿…è¦ useFrame: +5% FPS
- Dynamic Import: -50% è¼‰å…¥æ™‚é–“
- éŸ³è¨Šå¿«å–: -80% TTS å»¶é²ï¼ˆå¿«å–å‘½ä¸­æ™‚ï¼‰
- ä½ä½å…ƒç‡éŸ³è¨Š: -75% é »å¯¬ä½¿ç”¨

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Epic 1-4 å·²å®Œæˆï¼ˆæ‰€æœ‰åŠŸèƒ½å·²å¯¦ä½œï¼‰
- âœ… Three.js å ´æ™¯å¯æ­£å¸¸é‹ä½œ
- âœ… TTS API å¯æ­£å¸¸å‘¼å«

**å¾ŒçºŒ Story ä¾è³´**:
- **Story 5.2**: éŒ¯èª¤è™•ç†æœƒåƒè€ƒæœ¬ Story çš„æ•ˆèƒ½ç›£æ§
- **Story 5.4**: ç€è¦½å™¨æ¸¬è©¦æœƒé©—è­‰æœ¬ Story çš„å„ªåŒ–æˆæœ

**å·¥å…·ä¾è³´**:
- Chrome DevTools Performance
- @next/bundle-analyzer
- performance.memory API (Chrome only)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 5.1 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
