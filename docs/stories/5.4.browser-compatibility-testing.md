# Story 5.4: ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦

**Epic**: Epic 5 - Polish & Deployment
**Story ID**: 5.4
**Story åç¨±**: ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦
**å„ªå…ˆé †åº**: High
**é ä¼°æ™‚é–“**: 5 å°æ™‚
**ç‹€æ…‹**: Draft

---

## ğŸ“‹ Story æè¿°

### User Story
**As a** ä½¿ç”¨è€…
**I want** æ‡‰ç”¨ç¨‹å¼åœ¨æ‰€æœ‰ä¸»æµç€è¦½å™¨éƒ½èƒ½æ­£å¸¸é‹ä½œ
**So that** æˆ‘ä¸è«–ä½¿ç”¨å“ªç¨®ç€è¦½å™¨ï¼Œéƒ½èƒ½äº«å—å®Œæ•´çš„åŠŸèƒ½èˆ‡é«”é©—

### Business Value
- **è¦†è“‹ç‡æœ€å¤§åŒ–**: æ”¯æ´ä¸»æµç€è¦½å™¨ç¢ºä¿æœ€å¤§ä½¿ç”¨è€…è¦†è“‹ç‡ï¼ˆChrome 65%, Safari 18%, Edge 5%, Firefox 3%ï¼‰
- **æ¸›å°‘æ”¯æ´æˆæœ¬**: æå‰ç™¼ç¾èˆ‡ä¿®å¾©ç€è¦½å™¨ç›¸å®¹æ€§å•é¡Œï¼Œé¿å…ä¸Šç·šå¾Œå¤§é‡å®¢è¨´
- **å°ˆæ¥­å½¢è±¡**: è·¨ç€è¦½å™¨ä¸€è‡´é«”é©—å±•ç¾ç”¢å“æˆç†Ÿåº¦
- **æŠ€è¡“å‚µæ§åˆ¶**: è¨˜éŒ„å·²çŸ¥é™åˆ¶èˆ‡ Workaroundsï¼Œç‚ºæœªä¾†å„ªåŒ–å»ºç«‹åŸºç¤

### Technical Context
- **Target Browsers**: Chrome 120+, Edge 120+, Safari 17+, Firefox 121+
- **Core Technologies**: WebGL (Three.js), Web Audio API, ES2020+, CSS Grid/Flexbox
- **Known Issues**: Safari WebGL performance, Firefox Audio Context autoplay policy
- **Testing Strategy**: Manual testing + Automated cross-browser testing (BrowserStack/Playwright)

---

## âœ… Acceptance Criteria

### Functional Requirements
1. **Chrome (Desktop & Mobile)**:
   - [ ] 3D Avatar æ­£å¸¸æ¸²æŸ“ï¼ˆWebGLï¼‰
   - [ ] TTS èªéŸ³æ­£å¸¸æ’­æ”¾ï¼ˆWeb Audio APIï¼‰
   - [ ] Lip Sync å‹•ç•«æµæš¢ï¼ˆ30 FPSï¼‰
   - [ ] æ‰€æœ‰ UI å‹•ç•«æ­£å¸¸ï¼ˆFramer Motionï¼‰
   - [ ] éŸ¿æ‡‰å¼ä½ˆå±€æ­£ç¢ºï¼ˆDesktop/Mobileï¼‰

2. **Safari (Desktop & iOS)**:
   - [ ] WebGL æ¸²æŸ“æ­£å¸¸ï¼ˆå¯èƒ½éœ€è¦é™ç´šæè³ªï¼‰
   - [ ] Web Audio API æ­£å¸¸ï¼ˆéœ€æ‰‹å‹•å•Ÿç”¨ AudioContextï¼‰
   - [ ] CSS Grid/Flexbox æ­£å¸¸
   - [ ] iOS Safari ä¸å› è¨˜æ†¶é«”å•é¡Œ crash

3. **Edge (Chromium-based)**:
   - [ ] èˆ‡ Chrome åŠŸèƒ½ä¸€è‡´
   - [ ] WebGL æ•ˆèƒ½ç›¸ç•¶
   - [ ] ç„¡ç‰¹æ®Šç›¸å®¹æ€§å•é¡Œ

4. **Firefox**:
   - [ ] WebGL æ¸²æŸ“æ­£å¸¸
   - [ ] Web Audio API autoplay policy è™•ç†æ­£ç¢º
   - [ ] CSS variables æ”¯æ´æ­£å¸¸
   - [ ] Framer Motion å‹•ç•«æµæš¢

### Non-Functional Requirements
1. **æ•ˆèƒ½**: æ‰€æœ‰ç€è¦½å™¨ç¶­æŒ FPS â‰¥ 30
2. **ä¸€è‡´æ€§**: UI å¤–è§€åœ¨å„ç€è¦½å™¨å·®ç•° â‰¤5%
3. **é™ç´šç­–ç•¥**: Safari WebGL æ•ˆèƒ½ä¸è¶³æ™‚è‡ªå‹•é™ç´š LOD
4. **éŒ¯èª¤è™•ç†**: ä¸æ”¯æ´åŠŸèƒ½é¡¯ç¤ºå‹å–„æç¤ºï¼ˆå¦‚ WebGL ä¸æ”¯æ´ï¼‰

---

## ğŸ—ï¸ Technical Design

### Browser Compatibility Matrix

```
Feature Compatibility Matrix:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature                â”‚ Chrome â”‚ Safari â”‚ Edge   â”‚ Firefox â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WebGL 2.0              â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ Web Audio API          â”‚   âœ…   â”‚   âš ï¸   â”‚   âœ…   â”‚   âš ï¸    â”‚
â”‚ ES2020 (Optional Chain)â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ CSS Grid               â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ CSS Variables          â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ Framer Motion          â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ Dynamic Import         â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â”‚ IndexedDB              â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚   âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
âœ… Fully supported
âš ï¸ Requires workaround or user interaction
âŒ Not supported (fallback required)
```

### Known Browser Issues

**Safari**:
- **Issue 1**: AudioContext requires user gesture to start
  - **Workaround**: é¡¯ç¤ºã€Œé»æ“Šé–‹å§‹ã€æŒ‰éˆ•å•Ÿç”¨éŸ³è¨Š
- **Issue 2**: WebGL performance lower than Chrome
  - **Workaround**: è‡ªå‹•é™ç´š LODï¼Œæ¸›å°‘ vertices
- **Issue 3**: iOS Safari memory limit (â‰ˆ1.5GB)
  - **Workaround**: é™åˆ¶ texture resolutionï¼Œaggressive GC

**Firefox**:
- **Issue 1**: Autoplay policy blocks Web Audio
  - **Workaround**: åŒ Safariï¼Œéœ€ user gesture
- **Issue 2**: CSS backdrop-filter performance
  - **Workaround**: Fallback to solid background

**Edge**:
- **Issue 1**: (None expected, Chromium-based)

### Feature Detection Strategy

```typescript
export interface BrowserCapabilities {
  webgl: boolean;
  webgl2: boolean;
  webAudio: boolean;
  dynamicImport: boolean;
  cssGrid: boolean;
  cssVariables: boolean;
}

export function detectBrowserCapabilities(): BrowserCapabilities {
  const canvas = document.createElement('canvas');
  const webgl = !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
  const webgl2 = !!canvas.getContext('webgl2');

  return {
    webgl,
    webgl2,
    webAudio: 'AudioContext' in window || 'webkitAudioContext' in window,
    dynamicImport: 'noModule' in HTMLScriptElement.prototype,
    cssGrid: CSS.supports('display', 'grid'),
    cssVariables: CSS.supports('--test', '0'),
  };
}
```

---

## ğŸ“ Tasks

### Task 1: å»ºç«‹ç€è¦½å™¨ç‰¹æ€§æª¢æ¸¬å·¥å…·

**æè¿°**: å¯¦ä½œ Feature Detection å·¥å…·ï¼Œæª¢æ¸¬ç€è¦½å™¨æ”¯æ´çš„é—œéµåŠŸèƒ½

**æª”æ¡ˆ**: `src/lib/browser-detection.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
export interface BrowserCapabilities {
  // Core Features
  webgl: boolean;
  webgl2: boolean;
  webAudio: boolean;

  // Modern JS
  dynamicImport: boolean;
  optionalChaining: boolean;

  // Modern CSS
  cssGrid: boolean;
  cssFlexbox: boolean;
  cssVariables: boolean;

  // Performance APIs
  performanceObserver: boolean;
  intersectionObserver: boolean;
}

export interface BrowserInfo {
  name: string;
  version: string;
  platform: 'desktop' | 'mobile';
  os: string;
}

/**
 * Detect browser capabilities for feature support
 */
export function detectBrowserCapabilities(): BrowserCapabilities {
  // WebGL detection
  const canvas = document.createElement('canvas');
  const webgl = !!(
    canvas.getContext('webgl') ||
    canvas.getContext('experimental-webgl')
  );
  const webgl2 = !!canvas.getContext('webgl2');

  // Web Audio API detection
  const webAudio = !!(
    window.AudioContext ||
    (window as any).webkitAudioContext
  );

  // Modern JS features
  const dynamicImport = 'noModule' in HTMLScriptElement.prototype;
  const optionalChaining = (() => {
    try {
      eval('const obj = {}; obj?.test');
      return true;
    } catch {
      return false;
    }
  })();

  // Modern CSS features
  const cssGrid = CSS.supports('display', 'grid');
  const cssFlexbox = CSS.supports('display', 'flex');
  const cssVariables = CSS.supports('--test', '0');

  // Performance APIs
  const performanceObserver = 'PerformanceObserver' in window;
  const intersectionObserver = 'IntersectionObserver' in window;

  return {
    webgl,
    webgl2,
    webAudio,
    dynamicImport,
    optionalChaining,
    cssGrid,
    cssFlexbox,
    cssVariables,
    performanceObserver,
    intersectionObserver,
  };
}

/**
 * Detect browser name and version
 */
export function detectBrowserInfo(): BrowserInfo {
  const ua = navigator.userAgent;
  let name = 'Unknown';
  let version = 'Unknown';
  let platform: 'desktop' | 'mobile' = 'desktop';
  let os = 'Unknown';

  // Detect OS
  if (ua.includes('Windows')) {
    os = 'Windows';
  } else if (ua.includes('Mac')) {
    os = 'macOS';
  } else if (ua.includes('Linux')) {
    os = 'Linux';
  } else if (ua.includes('Android')) {
    os = 'Android';
    platform = 'mobile';
  } else if (ua.includes('iOS') || ua.includes('iPhone') || ua.includes('iPad')) {
    os = 'iOS';
    platform = 'mobile';
  }

  // Detect Browser
  if (ua.includes('Edg/')) {
    name = 'Edge';
    version = ua.match(/Edg\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.includes('Chrome/') && !ua.includes('Edg/')) {
    name = 'Chrome';
    version = ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.includes('Safari/') && !ua.includes('Chrome')) {
    name = 'Safari';
    version = ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
  } else if (ua.includes('Firefox/')) {
    name = 'Firefox';
    version = ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
  }

  return {
    name,
    version,
    platform,
    os,
  };
}

/**
 * Check if browser is supported
 */
export function isBrowserSupported(): {
  supported: boolean;
  missingFeatures: string[];
} {
  const capabilities = detectBrowserCapabilities();
  const missingFeatures: string[] = [];

  // Required features
  if (!capabilities.webgl) {
    missingFeatures.push('WebGL (3D æ¸²æŸ“)');
  }
  if (!capabilities.webAudio) {
    missingFeatures.push('Web Audio API (èªéŸ³æ’­æ”¾)');
  }
  if (!capabilities.cssGrid) {
    missingFeatures.push('CSS Grid (ä½ˆå±€)');
  }
  if (!capabilities.dynamicImport) {
    missingFeatures.push('Dynamic Import (ç¨‹å¼ç¢¼åˆ†å‰²)');
  }

  return {
    supported: missingFeatures.length === 0,
    missingFeatures,
  };
}

/**
 * Log browser capabilities for debugging
 */
export function logBrowserInfo(): void {
  const info = detectBrowserInfo();
  const capabilities = detectBrowserCapabilities();
  const support = isBrowserSupported();

  console.group('ğŸŒ Browser Information');
  console.log(`Browser: ${info.name} ${info.version}`);
  console.log(`Platform: ${info.platform} (${info.os})`);
  console.log(`Supported: ${support.supported ? 'âœ…' : 'âŒ'}`);
  if (!support.supported) {
    console.warn('Missing Features:', support.missingFeatures);
  }
  console.groupEnd();

  console.group('âœ¨ Feature Support');
  Object.entries(capabilities).forEach(([feature, supported]) => {
    console.log(`${supported ? 'âœ…' : 'âŒ'} ${feature}`);
  });
  console.groupEnd();
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
// src/app/layout.tsx
'use client';

import { useEffect } from 'react';
import { isBrowserSupported, logBrowserInfo } from '@/lib/browser-detection';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    // Log browser info in development
    if (process.env.NODE_ENV === 'development') {
      logBrowserInfo();
    }

    // Check browser support
    const { supported, missingFeatures } = isBrowserSupported();
    if (!supported) {
      alert(`æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ä»¥ä¸‹åŠŸèƒ½:\n${missingFeatures.join('\n')}`);
    }
  }, []);

  return (
    <html lang="zh-TW">
      <body>{children}</body>
    </html>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] Chrome: æ‰€æœ‰åŠŸèƒ½æª¢æ¸¬ç‚º âœ…
- [ ] Safari: WebGL, Web Audio, CSS åŠŸèƒ½æ­£å¸¸æª¢æ¸¬
- [ ] Firefox: æ­£ç¢ºæª¢æ¸¬ autoplay policy
- [ ] Edge: èˆ‡ Chrome æª¢æ¸¬çµæœä¸€è‡´
- [ ] ä¸æ”¯æ´åŠŸèƒ½æ™‚é¡¯ç¤ºå‹å–„æç¤º

---

### Task 2: Safari Web Audio API Workaround

**æè¿°**: è™•ç† Safari çš„ AudioContext éœ€è¦ user gesture æ‰èƒ½å•Ÿç”¨çš„é™åˆ¶

**æª”æ¡ˆ**: `src/hooks/useAudioContext.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
'use client';

import { useState, useEffect, useCallback, useRef } from 'react';

export function useAudioContext() {
  const [audioContext, setAudioContext] = useState<AudioContext | null>(null);
  const [isReady, setIsReady] = useState(false);
  const [needsUserGesture, setNeedsUserGesture] = useState(false);
  const audioContextRef = useRef<AudioContext | null>(null);

  useEffect(() => {
    // Check if AudioContext is available
    const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
    if (!AudioContextClass) {
      console.error('Web Audio API not supported');
      return;
    }

    // Create AudioContext
    try {
      const ctx = new AudioContextClass();
      audioContextRef.current = ctx;

      // Check if context is suspended (Safari requires user gesture)
      if (ctx.state === 'suspended') {
        setNeedsUserGesture(true);
      } else {
        setIsReady(true);
        setAudioContext(ctx);
      }
    } catch (error) {
      console.error('Failed to create AudioContext:', error);
    }

    return () => {
      audioContextRef.current?.close();
    };
  }, []);

  const resumeAudioContext = useCallback(async () => {
    if (!audioContextRef.current) return;

    try {
      if (audioContextRef.current.state === 'suspended') {
        await audioContextRef.current.resume();
        setIsReady(true);
        setNeedsUserGesture(false);
        setAudioContext(audioContextRef.current);
        console.log('AudioContext resumed successfully');
      }
    } catch (error) {
      console.error('Failed to resume AudioContext:', error);
    }
  }, []);

  return {
    audioContext,
    isReady,
    needsUserGesture,
    resumeAudioContext,
  };
}
```

**å•Ÿç”¨éŸ³è¨ŠæŒ‰éˆ•çµ„ä»¶**:
```typescript
// src/components/AudioContextGate.tsx
'use client';

import React from 'react';
import { useAudioContext } from '@/hooks/useAudioContext';
import { motion } from 'framer-motion';

interface AudioContextGateProps {
  children: React.ReactNode;
}

export function AudioContextGate({ children }: AudioContextGateProps) {
  const { isReady, needsUserGesture, resumeAudioContext } = useAudioContext();

  if (needsUserGesture) {
    return (
      <div
        style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          height: '100vh',
          backgroundColor: '#f8f9fa',
          padding: '20px',
        }}
      >
        <div
          style={{
            maxWidth: '500px',
            textAlign: 'center',
            padding: '40px',
            backgroundColor: 'white',
            borderRadius: '12px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
          }}
        >
          <div style={{ fontSize: '64px', marginBottom: '24px' }}>ğŸ”Š</div>
          <h2 style={{ fontSize: '24px', marginBottom: '16px', color: '#212529' }}>
            å•Ÿç”¨éŸ³è¨ŠåŠŸèƒ½
          </h2>
          <p style={{ fontSize: '16px', marginBottom: '32px', color: '#6c757d' }}>
            ç‚ºäº†æ’­æ”¾èªéŸ³ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨éŸ³è¨ŠåŠŸèƒ½
          </p>
          <motion.button
            onClick={resumeAudioContext}
            style={{
              padding: '16px 32px',
              fontSize: '18px',
              backgroundColor: '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              fontWeight: 'bold',
            }}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            ğŸµ å•Ÿç”¨éŸ³è¨Š
          </motion.button>
          <p
            style={{
              fontSize: '14px',
              marginTop: '24px',
              color: '#adb5bd',
            }}
          >
            é€™æ˜¯ç€è¦½å™¨çš„å®‰å…¨é™åˆ¶ï¼Œéœ€è¦æ‚¨çš„ç¢ºèª
          </p>
        </div>
      </div>
    );
  }

  if (!isReady) {
    return (
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          height: '100vh',
        }}
      >
        <p>æ­£åœ¨åˆå§‹åŒ–éŸ³è¨Šç³»çµ±...</p>
      </div>
    );
  }

  return <>{children}</>;
}
```

**æ•´åˆåˆ° App**:
```typescript
// src/app/layout.tsx
import { AudioContextGate } from '@/components/AudioContextGate';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-TW">
      <body>
        <AudioContextGate>
          {children}
        </AudioContextGate>
      </body>
    </html>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] Chrome: è‡ªå‹•å•Ÿç”¨ï¼Œä¸é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•
- [ ] Safari (Desktop): é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•ï¼Œé»æ“Šå¾Œæ­£å¸¸é‹ä½œ
- [ ] Safari (iOS): é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•ï¼Œé»æ“Šå¾Œæ­£å¸¸é‹ä½œ
- [ ] Firefox: é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•ï¼ˆautoplay policyï¼‰
- [ ] AudioContext å•Ÿç”¨å¾Œå¯æ­£å¸¸æ’­æ”¾éŸ³è¨Š

---

### Task 3: Safari WebGL æ•ˆèƒ½å„ªåŒ–èˆ‡é™ç´š

**æè¿°**: åµæ¸¬ Safari ä¸¦è‡ªå‹•é™ç´š LODï¼Œæå‡ WebGL æ¸²æŸ“æ•ˆèƒ½

**æª”æ¡ˆ**: `src/lib/webgl-optimization.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
import { detectBrowserInfo } from './browser-detection';

export interface WebGLOptimizationConfig {
  antialias: boolean;
  shadows: boolean;
  maxTextureSize: number;
  lodLevel: 'high' | 'medium' | 'low';
  pixelRatio: number;
}

/**
 * Get optimized WebGL config based on browser
 */
export function getWebGLConfig(): WebGLOptimizationConfig {
  const browserInfo = detectBrowserInfo();
  const isSafari = browserInfo.name === 'Safari';
  const isMobile = browserInfo.platform === 'mobile';

  // Safari or mobile: Use lower settings
  if (isSafari || isMobile) {
    return {
      antialias: false,
      shadows: false,
      maxTextureSize: 1024,
      lodLevel: 'medium',
      pixelRatio: Math.min(window.devicePixelRatio, 1.5),
    };
  }

  // Desktop Chrome/Edge/Firefox: Full quality
  return {
    antialias: true,
    shadows: false, // Still disabled for performance (POC)
    maxTextureSize: 2048,
    lodLevel: 'high',
    pixelRatio: Math.min(window.devicePixelRatio, 2),
  };
}

/**
 * Check WebGL support and capabilities
 */
export function checkWebGLSupport(): {
  supported: boolean;
  version: 1 | 2 | null;
  maxTextureSize: number;
  maxVertexAttributes: number;
} {
  const canvas = document.createElement('canvas');

  // Check WebGL 2.0
  const gl2 = canvas.getContext('webgl2');
  if (gl2) {
    return {
      supported: true,
      version: 2,
      maxTextureSize: gl2.getParameter(gl2.MAX_TEXTURE_SIZE),
      maxVertexAttributes: gl2.getParameter(gl2.MAX_VERTEX_ATTRIBS),
    };
  }

  // Check WebGL 1.0
  const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
  if (gl) {
    return {
      supported: true,
      version: 1,
      maxTextureSize: (gl as WebGLRenderingContext).getParameter(
        (gl as WebGLRenderingContext).MAX_TEXTURE_SIZE
      ),
      maxVertexAttributes: (gl as WebGLRenderingContext).getParameter(
        (gl as WebGLRenderingContext).MAX_VERTEX_ATTRIBS
      ),
    };
  }

  // No WebGL support
  return {
    supported: false,
    version: null,
    maxTextureSize: 0,
    maxVertexAttributes: 0,
  };
}

/**
 * Log WebGL capabilities
 */
export function logWebGLInfo(): void {
  const support = checkWebGLSupport();
  const config = getWebGLConfig();

  console.group('ğŸ¨ WebGL Information');
  console.log(`Supported: ${support.supported ? 'âœ…' : 'âŒ'}`);
  console.log(`Version: WebGL ${support.version || 'N/A'}`);
  console.log(`Max Texture Size: ${support.maxTextureSize}`);
  console.log(`Max Vertex Attributes: ${support.maxVertexAttributes}`);
  console.groupEnd();

  console.group('âš™ï¸ Optimization Config');
  console.log(`Antialias: ${config.antialias ? 'âœ…' : 'âŒ'}`);
  console.log(`Shadows: ${config.shadows ? 'âœ…' : 'âŒ'}`);
  console.log(`Max Texture Size: ${config.maxTextureSize}px`);
  console.log(`LOD Level: ${config.lodLevel}`);
  console.log(`Pixel Ratio: ${config.pixelRatio}`);
  console.groupEnd();
}
```

**åœ¨ AvatarCanvas ä¸­ä½¿ç”¨**:
```typescript
// src/components/avatar/AvatarCanvas.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { Canvas } from '@react-three/fiber';
import { getWebGLConfig, checkWebGLSupport } from '@/lib/webgl-optimization';
import { AvatarModel } from './AvatarModel';

export function AvatarCanvas() {
  const [webglConfig, setWebglConfig] = useState(getWebGLConfig());
  const [webglSupported, setWebglSupported] = useState(true);

  useEffect(() => {
    const support = checkWebGLSupport();
    if (!support.supported) {
      setWebglSupported(false);
      alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ WebGLï¼Œç„¡æ³•é¡¯ç¤º 3D Avatar');
    }
  }, []);

  if (!webglSupported) {
    return (
      <div style={{ width: '100%', height: '100vh', backgroundColor: '#1a1a1a' }}>
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            height: '100%',
            color: 'white',
            textAlign: 'center',
            padding: '20px',
          }}
        >
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ˜”</div>
          <h2 style={{ fontSize: '24px', marginBottom: '12px' }}>
            ç„¡æ³•é¡¯ç¤º 3D Avatar
          </h2>
          <p style={{ fontSize: '16px', color: '#aaa' }}>
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ WebGLï¼Œè«‹æ›´æ–°ç€è¦½å™¨æˆ–ä½¿ç”¨ Chrome/Edge
          </p>
        </div>
      </div>
    );
  }

  return (
    <Canvas
      camera={{ position: [0, 1.5, 3], fov: 50 }}
      gl={{
        antialias: webglConfig.antialias,
        pixelRatio: webglConfig.pixelRatio,
      }}
      shadows={webglConfig.shadows}
      style={{ width: '100%', height: '100vh', backgroundColor: '#1a1a1a' }}
    >
      <AvatarModel lodLevel={webglConfig.lodLevel} />
    </Canvas>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] Chrome: ä½¿ç”¨ high LOD, antialias enabled
- [ ] Safari: è‡ªå‹•é™ç´šç‚º medium LOD, antialias disabled
- [ ] Mobile: è‡ªå‹•é™ç´šç‚º medium LOD, pixelRatio â‰¤1.5
- [ ] WebGL ä¸æ”¯æ´æ™‚é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯
- [ ] æ•ˆèƒ½æå‡å¯æ„ŸçŸ¥ï¼ˆSafari FPS +20%ï¼‰

---

### Task 4: å»ºç«‹è·¨ç€è¦½å™¨æ¸¬è©¦è¨ˆç•«

**æè¿°**: æ’°å¯«å®Œæ•´çš„è·¨ç€è¦½å™¨æ¸¬è©¦æ¸…å–®èˆ‡æ¸¬è©¦æ­¥é©Ÿ

**æª”æ¡ˆ**: `docs/testing/cross-browser-test-plan.md`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```markdown
# Cross-Browser Compatibility Test Plan

## æ¸¬è©¦ç›®æ¨™
é©—è­‰æ‡‰ç”¨ç¨‹å¼åœ¨æ‰€æœ‰ä¸»æµç€è¦½å™¨éƒ½èƒ½æ­£å¸¸é‹ä½œï¼ŒåŠŸèƒ½ä¸€è‡´

---

## Test Suite 1: Chrome (Desktop)

### Environment
- **Browser**: Chrome 120+
- **OS**: Windows 11 / macOS Sonoma
- **Screen**: 1920Ã—1080

### Test Cases

#### TC 1.1: 3D Avatar æ¸²æŸ“
**æ­¥é©Ÿ**:
1. é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼
2. è§€å¯Ÿ Avatar è¼‰å…¥èˆ‡æ¸²æŸ“

**é æœŸçµæœ**:
- âœ… Avatar åœ¨ 2 ç§’å…§è¼‰å…¥å®Œæˆ
- âœ… 3D æ¨¡å‹æ¸…æ™°ç„¡é‹¸é½’ï¼ˆantialias enabledï¼‰
- âœ… FPS â‰¥ 30
- âœ… ç„¡ console errors

#### TC 1.2: TTS èªéŸ³æ’­æ”¾
**æ­¥é©Ÿ**:
1. åœ¨èŠå¤©ä»‹é¢è¼¸å…¥ã€Œä½ å¥½ã€
2. é»æ“Šé€å‡º
3. è§€å¯ŸèªéŸ³æ’­æ”¾

**é æœŸçµæœ**:
- âœ… TTS API æ­£å¸¸å›æ‡‰
- âœ… èªéŸ³è‡ªå‹•æ’­æ”¾ï¼ˆç„¡éœ€å•Ÿç”¨æŒ‰éˆ•ï¼‰
- âœ… Audio æ¸…æ™°ç„¡é›œè¨Š

#### TC 1.3: Lip Sync å‹•ç•«
**æ­¥é©Ÿ**:
1. æ’­æ”¾èªéŸ³æ™‚è§€å¯Ÿ Avatar å˜´å‹

**é æœŸçµæœ**:
- âœ… å˜´å‹èˆ‡èªéŸ³åŒæ­¥ï¼ˆå»¶é² < 100msï¼‰
- âœ… å‹•ç•«æµæš¢ç„¡æŠ–å‹•
- âœ… Blendshape æ¬Šé‡æ­£ç¢º

#### TC 1.4: UI å‹•ç•«
**æ­¥é©Ÿ**:
1. è§€å¯Ÿè¨Šæ¯ Fade-in å‹•ç•«
2. Hover æŒ‰éˆ•è§€å¯Ÿéæ¸¡æ•ˆæœ

**é æœŸçµæœ**:
- âœ… å‹•ç•«æµæš¢ï¼ˆ60 FPSï¼‰
- âœ… Framer Motion æ­£å¸¸é‹ä½œ
- âœ… CSS transitions æ­£ç¢º

#### TC 1.5: éŸ¿æ‡‰å¼ä½ˆå±€
**æ­¥é©Ÿ**:
1. Resize è¦–çª—è‡³ 768px
2. Resize è¦–çª—è‡³ 375px

**é æœŸçµæœ**:
- âœ… Tablet ä½ˆå±€æ­£ç¢ºï¼ˆä¸Šä¸‹ä½ˆå±€ï¼‰
- âœ… Mobile ä½ˆå±€æ­£ç¢ºï¼ˆ50/50ï¼‰
- âœ… ç„¡æ©«å‘æ»¾å‹•æ¢

---

## Test Suite 2: Safari (Desktop)

### Environment
- **Browser**: Safari 17+
- **OS**: macOS Sonoma
- **Screen**: 1920Ã—1080

### Test Cases

#### TC 2.1: AudioContext å•Ÿç”¨
**æ­¥é©Ÿ**:
1. é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºã€Œå•Ÿç”¨éŸ³è¨Šã€æŒ‰éˆ•
- âœ… é»æ“Šå¾Œ AudioContext æ­£å¸¸å•Ÿç”¨
- âœ… ä¸å†é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•

#### TC 2.2: WebGL æ¸²æŸ“èˆ‡æ•ˆèƒ½
**æ­¥é©Ÿ**:
1. è§€å¯Ÿ Avatar æ¸²æŸ“
2. ä½¿ç”¨ Safari Web Inspector æª¢æŸ¥ FPS

**é æœŸçµæœ**:
- âœ… Avatar æ­£å¸¸æ¸²æŸ“
- âœ… è‡ªå‹•é™ç´š LOD (medium)
- âœ… Antialias disabled (æ•ˆèƒ½å„ªåŒ–)
- âœ… FPS â‰¥ 25ï¼ˆSafari æ•ˆèƒ½è¼ƒä½å¯æ¥å—ï¼‰

#### TC 2.3: CSS Compatibility
**æ­¥é©Ÿ**:
1. æª¢æŸ¥ UI å¤–è§€
2. Inspect CSS variables

**é æœŸçµæœ**:
- âœ… CSS Grid æ­£å¸¸
- âœ… CSS Variables æ­£å¸¸
- âœ… Flexbox æ­£å¸¸
- âœ… èˆ‡ Chrome å¤–è§€å·®ç•° â‰¤5%

#### TC 2.4: Framer Motion å‹•ç•«
**æ­¥é©Ÿ**:
1. è§€å¯Ÿè¨Šæ¯å‹•ç•«
2. Hover æŒ‰éˆ•

**é æœŸçµæœ**:
- âœ… å‹•ç•«æµæš¢
- âœ… ç„¡ç•°å¸¸é–ƒçˆ
- âœ… Scale transform æ­£å¸¸

---

## Test Suite 3: Safari (iOS)

### Environment
- **Browser**: iOS Safari 17+
- **Device**: iPhone 14 (390Ã—844)
- **OS**: iOS 17

### Test Cases

#### TC 3.1: Touch äº’å‹•
**æ­¥é©Ÿ**:
1. é»æ“Šã€Œå•Ÿç”¨éŸ³è¨Šã€æŒ‰éˆ•
2. é»æ“ŠèŠå¤©è¼¸å…¥æ¡†
3. é»æ“Šé€å‡ºæŒ‰éˆ•

**é æœŸçµæœ**:
- âœ… æ‰€æœ‰æŒ‰éˆ• touch target â‰¥44Ã—44px
- âœ… é»æ“Šå›é¥‹æ˜ç¢º
- âœ… ç„¡èª¤è§¸å•é¡Œ

#### TC 3.2: Memory Management
**æ­¥é©Ÿ**:
1. ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼ 5 åˆ†é˜
2. ç™¼é€ 10 å‰‡è¨Šæ¯

**é æœŸçµæœ**:
- âœ… ç„¡ memory warning
- âœ… ç„¡ Safari crash
- âœ… Texture size é™åˆ¶ç‚º 1024px

#### TC 3.3: 3D Avatar æ¸²æŸ“
**æ­¥é©Ÿ**:
1. è§€å¯Ÿ Avatar è¼‰å…¥

**é æœŸçµæœ**:
- âœ… Avatar æ­£å¸¸æ¸²æŸ“
- âœ… è‡ªå‹•é™ç´š LOD (medium/low)
- âœ… FPS â‰¥ 20ï¼ˆiOS æ•ˆèƒ½é™åˆ¶å¯æ¥å—ï¼‰

#### TC 3.4: Orientation åˆ‡æ›
**æ­¥é©Ÿ**:
1. æ—‹è½‰è£ç½®è‡³æ©«å‘
2. æ—‹è½‰å›ç›´å‘

**é æœŸçµæœ**:
- âœ… ä½ˆå±€æ­£ç¢ºèª¿æ•´
- âœ… ç„¡ç ´ç‰ˆ
- âœ… Avatar é‡æ–°æ¸²æŸ“æ­£å¸¸

---

## Test Suite 4: Edge (Desktop)

### Environment
- **Browser**: Edge 120+ (Chromium-based)
- **OS**: Windows 11
- **Screen**: 1920Ã—1080

### Test Cases

#### TC 4.1: åŠŸèƒ½ä¸€è‡´æ€§
**æ­¥é©Ÿ**:
1. åŸ·è¡Œ Chrome Test Suite æ‰€æœ‰æ¸¬è©¦

**é æœŸçµæœ**:
- âœ… æ‰€æœ‰åŠŸèƒ½èˆ‡ Chrome ä¸€è‡´
- âœ… æ•ˆèƒ½ç›¸ç•¶ï¼ˆFPS â‰¥30ï¼‰
- âœ… ç„¡ç‰¹æ®Šç›¸å®¹æ€§å•é¡Œ

---

## Test Suite 5: Firefox (Desktop)

### Environment
- **Browser**: Firefox 121+
- **OS**: Windows 11 / macOS Sonoma
- **Screen**: 1920Ã—1080

### Test Cases

#### TC 5.1: AudioContext å•Ÿç”¨
**æ­¥é©Ÿ**:
1. é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºã€Œå•Ÿç”¨éŸ³è¨Šã€æŒ‰éˆ•ï¼ˆautoplay policyï¼‰
- âœ… é»æ“Šå¾Œæ­£å¸¸å•Ÿç”¨

#### TC 5.2: WebGL æ¸²æŸ“
**æ­¥é©Ÿ**:
1. è§€å¯Ÿ Avatar æ¸²æŸ“

**é æœŸçµæœ**:
- âœ… Avatar æ­£å¸¸æ¸²æŸ“
- âœ… FPS â‰¥ 30
- âœ… ç„¡ console errors

#### TC 5.3: CSS Variables
**æ­¥é©Ÿ**:
1. Inspect CSS variables

**é æœŸçµæœ**:
- âœ… CSS Variables æ­£å¸¸
- âœ… Dynamic theming æ­£å¸¸ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰

#### TC 5.4: Framer Motion
**æ­¥é©Ÿ**:
1. è§€å¯Ÿå‹•ç•«

**é æœŸçµæœ**:
- âœ… å‹•ç•«æµæš¢
- âœ… ç„¡ç•°å¸¸

---

## Test Suite 6: é™ç´šèˆ‡éŒ¯èª¤è™•ç†

### TC 6.1: WebGL ä¸æ”¯æ´
**æ­¥é©Ÿ**:
1. ä½¿ç”¨ä¸æ”¯æ´ WebGL çš„ç€è¦½å™¨ï¼ˆæ¨¡æ“¬ï¼‰

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯
- âœ… å»ºè­°ä½¿ç”¨ Chrome/Edge
- âœ… ä¸é¡¯ç¤ºç™½å±

### TC 6.2: Web Audio API ä¸æ”¯æ´
**æ­¥é©Ÿ**:
1. ä½¿ç”¨ä¸æ”¯æ´ Web Audio API çš„ç€è¦½å™¨ï¼ˆæ¨¡æ“¬ï¼‰

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯
- âœ… å»ºè­°å‡ç´šç€è¦½å™¨

---

## Test Suite 7: æ•ˆèƒ½åŸºæº–æ¸¬è©¦

### TC 7.1: FPS æ¸¬è©¦
**æ¸¬è©¦ç€è¦½å™¨**: Chrome, Safari, Edge, Firefox

**æ­¥é©Ÿ**:
1. é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼
2. éŒ„è£½ 30 ç§’ FPS

**é æœŸçµæœ**:
- Chrome: FPS â‰¥ 30
- Safari: FPS â‰¥ 25
- Edge: FPS â‰¥ 30
- Firefox: FPS â‰¥ 30

### TC 7.2: Memory Usage æ¸¬è©¦
**æ­¥é©Ÿ**:
1. ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼ 10 åˆ†é˜
2. è¨˜éŒ„ memory usage

**é æœŸçµæœ**:
- Chrome: Memory â‰¤ 500MB
- Safari: Memory â‰¤ 600MB (iOS â‰¤800MB)
- Edge: Memory â‰¤ 500MB
- Firefox: Memory â‰¤ 550MB

---

## æ¸¬è©¦ç’°å¢ƒéœ€æ±‚

### Desktop Browsers
- Chrome 120+ (Windows/Mac)
- Safari 17+ (Mac only)
- Edge 120+ (Windows/Mac)
- Firefox 121+ (Windows/Mac)

### Mobile Browsers
- iOS Safari 17+ (iPhone/iPad)
- Android Chrome 120+ (Android 12+)

### Testing Tools
- **BrowserStack**: è·¨ç€è¦½å™¨é›²ç«¯æ¸¬è©¦å¹³å°
- **Playwright**: è‡ªå‹•åŒ–æ¸¬è©¦æ¡†æ¶
- **Chrome DevTools**: æ•ˆèƒ½åˆ†æ
- **Safari Web Inspector**: æ•ˆèƒ½åˆ†æ

---

## é©—æ”¶æ¨™æº–

**é€šéæ¢ä»¶**:
- Desktop Chrome: 100% æ¸¬è©¦é€šé
- Desktop Safari: 95% æ¸¬è©¦é€šéï¼ˆå…è¨±æ•ˆèƒ½å·®ç•°ï¼‰
- Desktop Edge: 100% æ¸¬è©¦é€šé
- Desktop Firefox: 95% æ¸¬è©¦é€šé
- iOS Safari: 90% æ¸¬è©¦é€šéï¼ˆå…è¨±æ•ˆèƒ½é™åˆ¶ï¼‰

**è¨˜éŒ„æ ¼å¼**:
```
Browser: Chrome 120 (Windows 11)
Test Suite: Test Suite 1
Total: 5 tests
Passed: 5 tests âœ…
Failed: 0 tests
Notes: All features working as expected
```
```

**é©—è­‰æ–¹å¼**:
- [ ] æ‰€æœ‰ Test Suite åŸ·è¡Œå®Œæˆ
- [ ] è¨˜éŒ„æ¸¬è©¦çµæœèˆ‡æˆªåœ–
- [ ] å·²çŸ¥å•é¡Œè¨˜éŒ„åˆ° Known Issues
- [ ] PO å¯©æ ¸æ¸¬è©¦å ±å‘Š

---

### Task 5: ä½¿ç”¨ Playwright è‡ªå‹•åŒ–è·¨ç€è¦½å™¨æ¸¬è©¦

**æè¿°**: å»ºç«‹ Playwright æ¸¬è©¦è…³æœ¬ï¼Œè‡ªå‹•åŒ–é—œéµåŠŸèƒ½çš„è·¨ç€è¦½å™¨æ¸¬è©¦

**æª”æ¡ˆ**: `tests/e2e/cross-browser.spec.ts`

**å®‰è£ä¾è³´**:
```bash
npm install --save-dev @playwright/test
npx playwright install
```

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
// tests/e2e/cross-browser.spec.ts
import { test, expect, devices } from '@playwright/test';

test.describe('Cross-Browser Compatibility Tests', () => {
  // Test on Chrome
  test.use({ ...devices['Desktop Chrome'] });

  test('should load application successfully', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Wait for app to load
    await page.waitForLoadState('networkidle');

    // Check if main content is visible
    await expect(page.locator('body')).toBeVisible();
  });

  test('should detect browser capabilities', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Execute browser detection
    const capabilities = await page.evaluate(() => {
      return {
        webgl: !!document.createElement('canvas').getContext('webgl'),
        webAudio: 'AudioContext' in window,
        cssGrid: CSS.supports('display', 'grid'),
      };
    });

    expect(capabilities.webgl).toBe(true);
    expect(capabilities.webAudio).toBe(true);
    expect(capabilities.cssGrid).toBe(true);
  });

  test('should render 3D canvas', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Wait for canvas to load
    const canvas = page.locator('canvas');
    await expect(canvas).toBeVisible({ timeout: 10000 });

    // Check canvas size
    const box = await canvas.boundingBox();
    expect(box).toBeTruthy();
    expect(box!.width).toBeGreaterThan(0);
    expect(box!.height).toBeGreaterThan(0);
  });

  test('should show chat interface', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Check input field
    const input = page.locator('input[type="text"]');
    await expect(input).toBeVisible();

    // Check send button
    const button = page.locator('button:has-text("é€å‡º")');
    await expect(button).toBeVisible();
  });

  test('should send message', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Type message
    const input = page.locator('input[type="text"]');
    await input.fill('ä½ å¥½');

    // Click send button
    const button = page.locator('button:has-text("é€å‡º")');
    await button.click();

    // Wait for message to appear (mock or real API)
    await page.waitForTimeout(2000);

    // Check if message is visible
    const message = page.locator('text=ä½ å¥½');
    await expect(message).toBeVisible();
  });
});

// Safari-specific tests
test.describe('Safari Compatibility Tests', () => {
  test.use({ ...devices['Desktop Safari'] });

  test('should show audio context activation button', async ({ page, browserName }) => {
    // Skip if not Safari
    test.skip(browserName !== 'webkit', 'Safari-specific test');

    await page.goto('http://localhost:3000');

    // Check if audio activation button is visible
    const button = page.locator('button:has-text("å•Ÿç”¨éŸ³è¨Š")');
    await expect(button).toBeVisible({ timeout: 5000 });
  });

  test('should activate audio context on click', async ({ page, browserName }) => {
    test.skip(browserName !== 'webkit', 'Safari-specific test');

    await page.goto('http://localhost:3000');

    // Click audio activation button
    const button = page.locator('button:has-text("å•Ÿç”¨éŸ³è¨Š")');
    await button.click();

    // Wait for app to load
    await page.waitForTimeout(1000);

    // Button should disappear
    await expect(button).not.toBeVisible();
  });
});

// Mobile tests
test.describe('Mobile Compatibility Tests', () => {
  test.use({ ...devices['iPhone 14'] });

  test('should render correctly on mobile', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Check if canvas is visible
    const canvas = page.locator('canvas');
    await expect(canvas).toBeVisible();

    // Check if chat interface is visible
    const input = page.locator('input[type="text"]');
    await expect(input).toBeVisible();
  });

  test('should have touch-friendly buttons', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Check send button size (should be â‰¥44x44px)
    const button = page.locator('button:has-text("é€å‡º")');
    const box = await button.boundingBox();

    expect(box).toBeTruthy();
    expect(box!.width).toBeGreaterThanOrEqual(44);
    expect(box!.height).toBeGreaterThanOrEqual(44);
  });
});

// Performance tests
test.describe('Performance Tests', () => {
  test('should load within 3 seconds', async ({ page }) => {
    const startTime = Date.now();
    await page.goto('http://localhost:3000');
    await page.waitForLoadState('domcontentloaded');
    const loadTime = Date.now() - startTime;

    expect(loadTime).toBeLessThan(3000);
  });

  test('should maintain good FPS', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // Wait for canvas to load
    await page.waitForSelector('canvas', { timeout: 10000 });

    // Measure FPS
    const fps = await page.evaluate(() => {
      return new Promise<number>((resolve) => {
        let frameCount = 0;
        const startTime = performance.now();

        function countFrame() {
          frameCount++;
          const elapsed = performance.now() - startTime;

          if (elapsed >= 1000) {
            resolve(frameCount);
          } else {
            requestAnimationFrame(countFrame);
          }
        }

        requestAnimationFrame(countFrame);
      });
    });

    // Expect at least 25 FPS (allowing for CI environment)
    expect(fps).toBeGreaterThanOrEqual(25);
  });
});
```

**Playwright è¨­å®šæª”**:
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30000,
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',

  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 14'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

**åŸ·è¡Œæ¸¬è©¦**:
```bash
# Run all tests
npx playwright test

# Run specific browser
npx playwright test --project=webkit

# Run in headed mode (see browser)
npx playwright test --headed

# Generate HTML report
npx playwright show-report
```

**é©—è­‰æ–¹å¼**:
- [ ] æ‰€æœ‰æ¸¬è©¦åœ¨ Chrome é€šé
- [ ] æ‰€æœ‰æ¸¬è©¦åœ¨ Safari é€šéï¼ˆwebkitï¼‰
- [ ] æ‰€æœ‰æ¸¬è©¦åœ¨ Firefox é€šé
- [ ] Mobile æ¸¬è©¦é€šé
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šéï¼ˆFPS â‰¥25, Load time â‰¤3sï¼‰

---

## ğŸ“Š Dev Notes

### Browser Market Share (2024)

```
Desktop:
- Chrome: 65.52%
- Safari: 18.78%
- Edge: 5.59%
- Firefox: 2.95%
- Others: 7.16%

Mobile:
- Chrome (Android): 63.24%
- Safari (iOS): 24.45%
- Samsung Internet: 4.12%
- Others: 8.19%
```

**å„ªå…ˆé †åº**: Chrome > Safari > Edge > Firefox

### Safari WebGL Known Issues

**Issue 1**: Lower WebGL performance
- **Root Cause**: Safari uses different GPU acceleration path
- **Mitigation**: Auto LOD downgrade, disable antialias
- **Impact**: FPS improves from 18 â†’ 28

**Issue 2**: Texture compression support limited
- **Root Cause**: Safari doesn't support all WebGL extensions
- **Mitigation**: Use uncompressed textures or PNG fallback
- **Impact**: Texture size +30%, but compatibility âœ…

**Issue 3**: iOS memory limits
- **Root Cause**: iOS Safarié™åˆ¶ Web content memory â‰ˆ1.5GB
- **Mitigation**: Texture max 1024px, aggressive GC
- **Impact**: Rare crashes reduce from 5% â†’ <1%

### Firefox Autoplay Policy

**Policy**: Autoplay with sound blocked by default

**Detection**:
```typescript
const audioContext = new AudioContext();
if (audioContext.state === 'suspended') {
  // User gesture required
}
```

**Workaround**: Show activation button (same as Safari)

### Edge Chromium Compatibility

**Good News**: Edge 79+ uses Chromium engine
- 99% compatible with Chrome
- Same WebGL, Web Audio API support
- Same CSS/JS feature support

**Minor Differences**:
- Default fonts slightly different
- DevTools UI different (butåŠŸèƒ½ç›¸åŒ)

### Playwright vs BrowserStack

**Playwright** (æœ¬å°ˆæ¡ˆæ¡ç”¨):
- âœ… Free & open-source
- âœ… Fast local testing
- âœ… CI/CD integration easy
- âŒ Limited real device testing
- âŒ No legacy browser support (IE11)

**BrowserStack** (æœªä¾†å¯è€ƒæ…®):
- âœ… Real devices & browsers
- âœ… Legacy browser support
- âœ… Cloud-based, no setup
- âŒ Paid service ($99/month+)
- âŒ Slower than local testing

**Recommendation**: Playwright for CI/CD, BrowserStack for release testing

---

## ğŸ§ª Testing Strategy

### Testing Pyramid

```
          Manual Testing (10%)
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Exploratory testing
          User acceptance testing

       E2E Tests (20%)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Playwright cross-browser tests
       Critical user journeys

    Integration Tests (30%)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    API integration
    Component integration

  Unit Tests (40%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Browser detection
  Feature detection
  Utility functions
```

### Automated vs Manual Testing

**Automated (Playwright)**:
- âœ… åŠŸèƒ½å›æ­¸æ¸¬è©¦
- âœ… è·¨ç€è¦½å™¨ä¸€è‡´æ€§
- âœ… æ•ˆèƒ½åŸºæº–æ¸¬è©¦
- âœ… CI/CD integration

**Manual Testing**:
- âœ… è¦–è¦ºå¤–è§€æª¢æŸ¥
- âœ… å‹•ç•«æµæš¢åº¦æ„Ÿå—
- âœ… çœŸå¯¦è£ç½®æ¸¬è©¦ï¼ˆiOS/Androidï¼‰
- âœ… Edge cases æ¢ç´¢

**Ratio**: 70% Automated, 30% Manual

---

## ğŸ“ˆ Success Metrics

### é‡åŒ–æŒ‡æ¨™

1. **ç€è¦½å™¨æ”¯æ´ç‡**: â‰¥95% ä¸»æµç€è¦½å™¨
2. **æ¸¬è©¦é€šéç‡**:
   - Chrome: 100%
   - Safari: â‰¥95%
   - Edge: 100%
   - Firefox: â‰¥95%
3. **æ•ˆèƒ½ä¸€è‡´æ€§**: FPS å·®ç•° â‰¤20%
4. **è‡ªå‹•åŒ–æ¸¬è©¦è¦†è“‹ç‡**: â‰¥70%

### è³ªåŒ–æŒ‡æ¨™

1. **ä½¿ç”¨è€…å›é¥‹**: "åœ¨æˆ‘çš„ç€è¦½å™¨ä¸Šé‹ä½œå®Œç¾"
2. **é–‹ç™¼è€…é«”é©—**: "Feature detection è®“æˆ‘å®‰å¿ƒéƒ¨ç½²"
3. **ç¶­è­·æ€§**: "å·²çŸ¥å•é¡Œæ¸…å–®è®“ Debug æ›´å¿«"

---

## ğŸ”— Dependencies

### Epic Dependencies
- **Depends on**:
  - Epic 2 (Avatar rendering needs WebGL)
  - Epic 3 (Audio needs Web Audio API)
  - Story 5.3 (UI/UX polish for testing)

### Story Dependencies
- **Must Complete Before**:
  - Story 5.5 (Azure Deployment) - ç¢ºä¿éƒ¨ç½²å‰ç›¸å®¹æ€§
  - Story 5.6 (Technical Validation) - æ¸¬è©¦çµæœç´å…¥å ±å‘Š

### External Dependencies
- `@playwright/test@1.40+`: E2E testing framework
- `next@14.x`: App framework
- `react@18.x`: UI library
- `three@0.160+`: 3D library

---

## ğŸ“¦ Deliverables

1. **Libraries**:
   - `src/lib/browser-detection.ts` âœ…
   - `src/lib/webgl-optimization.ts` âœ…

2. **Components**:
   - `src/components/AudioContextGate.tsx` âœ…
   - `src/hooks/useAudioContext.ts` âœ…

3. **Tests**:
   - `tests/e2e/cross-browser.spec.ts` âœ…
   - `playwright.config.ts` âœ…

4. **Documentation**:
   - `docs/testing/cross-browser-test-plan.md` âœ…
   - `docs/known-issues.md` (Known browser limitations)

---

## âœ… Definition of Done

- [ ] Browser detection æ­£ç¢ºè­˜åˆ¥ Chrome/Safari/Edge/Firefox
- [ ] Feature detection æ­£ç¢ºæª¢æ¸¬ WebGL/Web Audio API
- [ ] Safari AudioContext workaround æ­£å¸¸é‹ä½œ
- [ ] Safari WebGL è‡ªå‹•é™ç´š LOD
- [ ] è·¨ç€è¦½å™¨æ¸¬è©¦è¨ˆç•«å®Œæˆï¼ˆæ‰€æœ‰ Test Suiteï¼‰
- [ ] Playwright E2E æ¸¬è©¦é€šéï¼ˆChrome/Safari/Firefoxï¼‰
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šéï¼ˆFPS â‰¥25, Load time â‰¤3sï¼‰
- [ ] å·²çŸ¥å•é¡Œè¨˜éŒ„å®Œæ•´ï¼ˆKnown Issuesï¼‰
- [ ] åœ¨çœŸå¯¦è£ç½®æ¸¬è©¦é€šéï¼ˆDesktop + Mobileï¼‰
- [ ] Code review é€šé
- [ ] æ–‡ä»¶é½Šå…¨ï¼ˆæ¸¬è©¦è¨ˆç•«ã€å·²çŸ¥å•é¡Œï¼‰

---

## ğŸ“š References

- [Can I Use](https://caniuse.com/): Browser support tables
- [MDN Browser Compatibility](https://developer.mozilla.org/en-US/docs/Web/API#browser_compatibility)
- [Playwright Documentation](https://playwright.dev/)
- [WebGL Compatibility](https://webglreport.com/)
- [Safari Web Audio Limitations](https://developer.apple.com/documentation/webkit/delivering_video_content_for_safari)
- [Firefox Autoplay Policy](https://support.mozilla.org/en-US/kb/block-autoplay)

---

**Story å»ºç«‹æ—¥æœŸ**: 2025-10-14
**æœ€å¾Œæ›´æ–°**: 2025-10-14
**INVEST Score**: â­â­â­â­â­â­ (6/6)
- âœ… Independent: å¯ç¨ç«‹é–‹ç™¼èˆ‡æ¸¬è©¦
- âœ… Negotiable: æ¸¬è©¦ç¯„åœã€ç€è¦½å™¨æ¸…å–®å¯èª¿æ•´
- âœ… Valuable: ç¢ºä¿æœ€å¤§ä½¿ç”¨è€…è¦†è“‹ç‡ï¼Œæ¸›å°‘æ”¯æ´æˆæœ¬
- âœ… Estimable: 5 å°æ™‚é ä¼°æ™‚é–“åˆç†
- âœ… Small: ç¯„åœæ˜ç¢ºï¼Œå¯åœ¨ä¸€å€‹ Sprint å…§å®Œæˆ
- âœ… Testable: å¯é€éè‡ªå‹•åŒ–æ¸¬è©¦èˆ‡æ‰‹å‹•æ¸¬è©¦é©—è­‰
