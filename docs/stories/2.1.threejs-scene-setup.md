# Story 2.1: Three.js 場景初始化與 React Three Fiber 整合

## Status
Approved

---

## Story

**As a** 開發者,
**I want** 在 Next.js 中整合 Three.js 與 React Three Fiber，建立基本 3D 渲染場景，
**so that** 可以開始載入與顯示 3D Avatar 模型。

---

## Acceptance Criteria

1. 安裝依賴: `pnpm add three @react-three/fiber @react-three/drei`
2. 建立 `components/avatar/AvatarCanvas.tsx`，使用 `<Canvas>` 建立 Three.js 場景
3. 場景包含基本燈光設定：Ambient Light + Directional Light
4. 設定相機位置 `[0, 1.5, 2]`，FOV 50，模擬視訊通話視角
5. 加入 OrbitControls（開發用，可用滑鼠旋轉相機）
6. 在場景中放置測試立方體（`<Box>`），驗證 3D 渲染正常
7. 在 `app/page.tsx` 引入 `<AvatarCanvas>`，立方體在頁面中正常顯示並可旋轉
8. 渲染效能 ≥ 30 FPS（使用 Chrome DevTools 檢查）

---

## Tasks / Subtasks

- [ ] **Task 1: 安裝 Three.js 相關依賴** (AC: 1)
  - [ ] 執行 `pnpm add three` (Three.js 核心函式庫 r160+)
  - [ ] 執行 `pnpm add @react-three/fiber` (React 的 Three.js 渲染器 8.15+)
  - [ ] 執行 `pnpm add @react-three/drei` (Three.js 實用工具組 9.95+)
  - [ ] 執行 `pnpm add -D @types/three` (TypeScript 型別定義)
  - [ ] 驗證 `package.json` 中已新增所有依賴
  - [ ] 執行 `pnpm install` 確保依賴正確安裝

- [ ] **Task 2: 建立 AvatarCanvas 組件與基本場景結構** (AC: 2, 7)
  - [ ] 建立目錄 `components/avatar/`（如尚未存在）
  - [ ] 建立 `components/avatar/AvatarCanvas.tsx` 檔案
  - [ ] 實作基本 Canvas 組件架構：
    ```typescript
    'use client';

    import { Canvas } from '@react-three/fiber';

    export default function AvatarCanvas() {
      return (
        <div className="w-full h-screen bg-gradient-to-b from-slate-900 to-slate-800">
          <Canvas
            shadows
            camera={{ position: [0, 1.5, 2], fov: 50 }}
            gl={{
              antialias: true,
              alpha: true,
              powerPreference: 'high-performance'
            }}
          >
            {/* 場景內容將在後續 Task 加入 */}
          </Canvas>
        </div>
      );
    }
    ```
  - [ ] 加入 TypeScript 型別定義
  - [ ] 加入 JSDoc 註解說明用途

- [ ] **Task 3: 配置場景燈光** (AC: 3)
  - [ ] 在 Canvas 內加入 Ambient Light：
    ```typescript
    <ambientLight intensity={0.5} />
    ```
  - [ ] 加入 Directional Light 模擬主光源：
    ```typescript
    <directionalLight
      position={[5, 5, 5]}
      intensity={1}
      castShadow
      shadow-mapSize={[1024, 1024]}
    />
    ```
  - [ ] 測試不同光源強度，確保場景明亮度適中
  - [ ] 加入註解說明燈光配置原理

- [ ] **Task 4: 配置相機與 OrbitControls** (AC: 4, 5)
  - [ ] 從 @react-three/drei 引入 OrbitControls：
    ```typescript
    import { OrbitControls } from '@react-three/drei';
    ```
  - [ ] 在 Canvas 內加入 OrbitControls：
    ```typescript
    <OrbitControls
      enableZoom={true}
      enablePan={false}
      enableRotate={true}
      minDistance={1}
      maxDistance={5}
      target={[0, 1, 0]}
    />
    ```
  - [ ] 驗證相機位置 `[0, 1.5, 2]` 與 FOV 50 設定正確（已在 Canvas props 設定）
  - [ ] 測試滑鼠控制：左鍵旋轉、滾輪縮放
  - [ ] 加入註解說明相機視角模擬視訊通話場景

- [ ] **Task 5: 加入測試立方體驗證渲染** (AC: 6)
  - [ ] 從 @react-three/drei 引入 Box：
    ```typescript
    import { Box } from '@react-three/drei';
    ```
  - [ ] 在場景中加入測試立方體：
    ```typescript
    <Box args={[1, 1, 1]} position={[0, 1, 0]}>
      <meshStandardMaterial color="hotpink" />
    </Box>
    ```
  - [ ] 驗證立方體在場景中正確顯示
  - [ ] 測試 OrbitControls 旋轉視角，立方體應保持在視野中
  - [ ] 加入註解說明此為臨時測試物件，後續將替換為 Avatar 模型

- [ ] **Task 6: 整合 AvatarCanvas 至主頁面** (AC: 7)
  - [ ] 開啟 `app/page.tsx`
  - [ ] 引入 AvatarCanvas 組件：
    ```typescript
    import AvatarCanvas from '@/components/avatar/AvatarCanvas';
    ```
  - [ ] 在頁面中使用 AvatarCanvas：
    ```typescript
    export default function Home() {
      return (
        <main className="flex min-h-screen flex-col items-center justify-center">
          <AvatarCanvas />
        </main>
      );
    }
    ```
  - [ ] 執行 `pnpm dev` 啟動開發伺服器
  - [ ] 開啟 `http://localhost:3000` 驗證場景正常顯示
  - [ ] 測試互動功能（旋轉、縮放）正常運作

- [ ] **Task 7: FPS 效能驗證與優化** (AC: 8)
  - [ ] 開啟 Chrome DevTools (F12)
  - [ ] 切換到 Performance 面板
  - [ ] 點擊 Record 按鈕，記錄 5-10 秒渲染效能
  - [ ] 停止記錄，檢視 FPS 曲線圖
  - [ ] 驗證平均 FPS ≥ 30（目標 60 FPS）
  - [ ] 如效能不佳，檢查以下項目：
    - Canvas 的 `powerPreference` 設為 `high-performance`
    - Shadow map 解析度是否過高（調整為 1024x1024）
    - 是否啟用不必要的後處理效果
  - [ ] 記錄效能數據於 QA Results 區段

---

## Dev Notes

### 相關來源樹（Source Tree）

根據架構文件，Epic 2 的檔案結構應如下：

```
avatar-chat-poc/
├── components/
│   └── avatar/
│       ├── AvatarCanvas.tsx        # Three.js 場景容器 (本 Story)
│       ├── AvatarModel.tsx         # Avatar 模型組件 (Story 2.2)
│       ├── AvatarSelector.tsx      # Avatar 選擇器 (Story 2.5)
│       └── hooks/
│           └── useAvatarAnimation.ts  # 動畫 Hook (Story 2.3, 2.4)
├── lib/
│   └── avatar/
│       ├── loaders.ts              # GLB 模型載入器 (Story 2.2)
│       └── animations.ts           # 動畫控制邏輯 (Story 2.3)
├── types/
│   └── avatar.ts                   # Avatar 相關型別定義
├── stores/
│   └── avatarStore.ts              # Zustand Avatar 狀態管理 (Story 2.5)
└── app/
    └── page.tsx                    # 主頁面整合
```

### 技術實作細節

**React Three Fiber 基本概念**:
- `<Canvas>` 是 R3F 的根組件，建立 WebGL 渲染器與場景
- Canvas 內所有組件都是 Three.js 物件的 React 包裝
- 使用 `@react-three/drei` 提供的快捷組件（如 Box, OrbitControls）簡化開發

**Canvas 配置說明**:
```typescript
<Canvas
  shadows                              // 啟用陰影渲染
  camera={{
    position: [0, 1.5, 2],            // 相機位置：水平居中，高度1.5m，距離2m
    fov: 50                            // 視野角度50度，模擬自然視訊通話視角
  }}
  gl={{
    antialias: true,                   // 啟用抗鋸齒，提升邊緣平滑度
    alpha: true,                       // 啟用透明背景，可與 CSS 背景搭配
    powerPreference: 'high-performance' // 優先使用高效能 GPU
  }}
>
```

**燈光配置原理**:
1. **Ambient Light（環境光）**:
   - 均勻照亮場景所有物體
   - Intensity 0.5：提供基礎亮度，避免過暗
   - 無方向性，不產生陰影

2. **Directional Light（方向光）**:
   - 模擬太陽光或主光源
   - Position [5, 5, 5]：從右上方照射
   - Intensity 1.0：主要光源強度
   - 啟用陰影：提供深度感與立體感

**OrbitControls 配置**:
```typescript
<OrbitControls
  enableZoom={true}        // 允許滾輪縮放（開發用）
  enablePan={false}        // 禁用平移（保持 Avatar 在中心）
  enableRotate={true}      // 允許旋轉視角
  minDistance={1}          // 最近距離 1m（避免過度靠近）
  maxDistance={5}          // 最遠距離 5m（保持 Avatar 可見）
  target={[0, 1, 0]}       // 控制中心點：Avatar 頭部高度
/>
```

### 重要架構決策

1. **為何選擇 React Three Fiber？**
   - ✅ 與 React 生態系統完美整合
   - ✅ 聲明式語法，易於維護與測試
   - ✅ 自動處理記憶體管理與清理
   - ✅ 支援 React Hooks，狀態管理簡單
   - ✅ 豐富的社群生態（drei, postprocessing）

2. **為何使用 OrbitControls？**
   - ✅ 開發階段：方便檢視 Avatar 各角度
   - ✅ 除錯工具：驗證模型載入與動畫
   - ⚠️ 注意：正式版可能移除或限制功能（依 PRD 決定）

3. **Canvas 位置決策**:
   - 選擇：將 Canvas 作為獨立組件，而非內嵌於複雜佈局
   - 原因：
     - WebGL 渲染需要固定尺寸容器
     - 避免 CSS Transform 影響 Three.js 座標系統
     - 便於後續加入全螢幕模式或響應式調整

4. **效能優先配置**:
   - `powerPreference: 'high-performance'`：優先使用獨立 GPU
   - Shadow map 1024x1024：平衡品質與效能
   - Antialias：提升視覺品質，現代 GPU 成本可接受

### Testing

**測試框架**: 手動測試 + Chrome DevTools（POC 階段）

**測試範圍**:
1. ✅ Three.js 依賴正確安裝
2. ✅ AvatarCanvas 組件正常渲染
3. ✅ 測試立方體在場景中顯示
4. ✅ 燈光照明效果正確（物體有陰影與明暗）
5. ✅ OrbitControls 互動功能正常
6. ✅ 渲染效能達標（≥30 FPS）

**測試執行方式**:
```bash
# 啟動開發伺服器
pnpm dev

# 瀏覽器開啟
http://localhost:3000

# 測試項目
1. 視覺檢查：粉紅色立方體顯示在畫面中央
2. 互動測試：滑鼠左鍵拖曳旋轉視角
3. 縮放測試：滑鼠滾輪放大/縮小
4. FPS 檢查：開啟 DevTools > Performance > Record > 檢視 FPS
```

**驗證清單**:
- [ ] `pnpm dev` 啟動無錯誤
- [ ] 立方體正確顯示並有陰影
- [ ] OrbitControls 互動順暢無延遲
- [ ] Chrome DevTools 顯示 FPS ≥ 30
- [ ] Console 無錯誤或警告訊息
- [ ] 不同瀏覽器視窗大小下場景正常渲染

### 效能考量

**FPS 目標**:
- 最低要求：30 FPS（流暢基準）
- 理想目標：60 FPS（現代瀏覽器標準）

**效能影響因素**:
1. **Shadow Mapping**:
   - 1024x1024 適合 POC 階段
   - 正式版可調整為 2048x2048（更高品質）或 512x512（更高效能）

2. **Antialias**:
   - 現代 GPU 成本低，建議啟用
   - 低階裝置可考慮關閉

3. **WebGL Context**:
   - `powerPreference: 'high-performance'` 關鍵設定
   - 確保使用獨立 GPU 而非整合顯示卡

**效能監控**:
```typescript
// 開發階段可加入 FPS 顯示（選用）
import { Stats } from '@react-three/drei';

<Canvas>
  <Stats />  {/* 顯示即時 FPS */}
  {/* ... 其他場景內容 */}
</Canvas>
```

### 安全性考量

**WebGL 安全性**:
- ✅ React Three Fiber 自動處理 WebGL Context 管理
- ✅ 無使用者輸入渲染（避免 XSS 風險）
- ✅ 使用 Three.js 官方建議配置

**依賴安全**:
- ✅ 使用 pnpm 管理依賴，減少供應鏈攻擊風險
- ✅ Three.js 為成熟穩定函式庫（r160+ 版本）

### 依賴關係

**前置條件**:
- ✅ Story 1.1 已完成（Next.js 專案已建立）
- ✅ Story 1.3 已完成（Tailwind CSS 已配置，提供背景樣式）
- ✅ Node.js 18+ 與 pnpm 已安裝

**後續 Story 依賴**:
- Story 2.2: 會在此 AvatarCanvas 場景中載入 Avatar 模型（替換測試立方體）
- Story 2.3: 會在此場景中實作 Avatar 待機動畫
- Story 2.4: 會在此場景中實作表情與動作控制
- Story 2.5: 會使用此 Canvas 顯示不同 Avatar

**關鍵路徑**:
- 本 Story 是 Epic 2 的基礎，必須優先完成
- 所有後續 3D 相關功能都依賴此場景設定

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 建立 Story 2.1 草稿 | SM Agent |

---

## Dev Agent Record

*(此部分由 Dev Agent 在實作時填寫)*

### Agent Model Used
_待填寫_

### Debug Log References
_待填寫_

### Completion Notes List
_待填寫_

### File List
_待填寫_

---

## QA Results

*(此部分由 QA Agent 在審核時填寫)*

_待填寫_
