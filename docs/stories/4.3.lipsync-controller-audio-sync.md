# Story 4.3: Lip Sync Controller èˆ‡éŸ³è¨ŠåŒæ­¥

## Status
Draft

---

## Story

**As a** é–‹ç™¼è€…,
**I want** å»ºç«‹ Lip Sync Controllerï¼ŒåŒæ­¥éŸ³è¨Šæ’­æ”¾èˆ‡å˜´å‹å‹•ç•«,
**so that** Avatar çš„å˜´å‹èˆ‡èªéŸ³å®Œç¾åŒæ­¥ã€‚

---

## Acceptance Criteria

1. å»ºç«‹ `components/avatar/LipSyncController.tsx`ï¼ˆç„¡ UI çµ„ä»¶ï¼‰
2. ç›£è½ `audioStore` çš„ `currentAudio` ç‹€æ…‹
3. éŸ³è¨Šæ’­æ”¾æ™‚ï¼šåŒæ­¥è§¸ç™¼ viseme åˆ†æã€æ ¹æ“šæ™‚é–“è»¸æ›´æ–° Avatar blendshapes
4. å¯¦ä½œæ™‚é–“åŒæ­¥é‚è¼¯ï¼šä½¿ç”¨ `AudioContext.currentTime` èˆ‡ viseme `time` å°é½Šã€è£œå„Ÿå»¶é²ï¼ˆ< 100msï¼‰
5. éŸ³è¨Šæ’­æ”¾å®Œç•¢å¾Œï¼Œå˜´å‹æ¢å¾© `neutral`
6. æ¸¬è©¦ï¼šæ’­æ”¾ã€Œä½ å¥½ï¼Œæˆ‘æ˜¯ Avatarã€ï¼Œå˜´å‹èˆ‡èªéŸ³åŒæ­¥
7. è¦–è¦ºå»¶é² < 100msï¼ˆè‚‰çœ¼ç„¡æ˜é¡¯è½å·®ï¼‰

---

## Tasks / Subtasks

- [ ] **Task 1: æ“´å±• audioStore æ”¯æ´ Viseme æ•¸æ“š** (AC: 2)
  - [ ] é–‹å•Ÿ `stores/audioStore.ts`ï¼ˆEpic 3 å»ºç«‹ï¼‰
  - [ ] åŠ å…¥ Viseme ç›¸é—œç‹€æ…‹èˆ‡æ–¹æ³•ï¼š
    ```typescript
    import { create } from 'zustand';
    import type { VisemeData } from '@/types/lipsync';

    interface AudioState {
      // ç¾æœ‰ç‹€æ…‹ï¼ˆEpic 3ï¼‰
      currentAudio: AudioBuffer | null;
      isPlaying: boolean;
      audioContext: AudioContext | null;

      // æ–°å¢ï¼šLip Sync ç›¸é—œç‹€æ…‹
      visemeTimeline: VisemeData[];
      currentVisemeIndex: number;
      playbackStartTime: number; // éŸ³è¨Šé–‹å§‹æ’­æ”¾çš„çµ•å°æ™‚é–“

      // ç¾æœ‰æ–¹æ³•
      playAudio: (buffer: AudioBuffer) => void;
      stopAudio: () => void;

      // æ–°å¢æ–¹æ³•
      setVisemeTimeline: (timeline: VisemeData[]) => void;
      resetVisemeState: () => void;
      setPlaybackStartTime: (time: number) => void;
    }

    export const useAudioStore = create<AudioState>((set, get) => ({
      // ç¾æœ‰ç‹€æ…‹
      currentAudio: null,
      isPlaying: false,
      audioContext: null,

      // Viseme ç‹€æ…‹åˆå§‹å€¼
      visemeTimeline: [],
      currentVisemeIndex: 0,
      playbackStartTime: 0,

      // è¨­å®š Viseme æ™‚é–“è»¸
      setVisemeTimeline: (timeline) => set({ visemeTimeline: timeline, currentVisemeIndex: 0 }),

      // é‡ç½® Viseme ç‹€æ…‹
      resetVisemeState: () => set({
        visemeTimeline: [],
        currentVisemeIndex: 0,
        playbackStartTime: 0
      }),

      // è¨­å®šæ’­æ”¾é–‹å§‹æ™‚é–“
      setPlaybackStartTime: (time) => set({ playbackStartTime: time }),

      // æ›´æ–° playAudio æ–¹æ³•ï¼ˆEpic 3 çš„æ–¹æ³•éœ€ä¿ç•™ä¸¦æ“´å±•ï¼‰
      playAudio: (buffer) => {
        const context = get().audioContext || new AudioContext();

        const source = context.createBufferSource();
        source.buffer = buffer;
        source.connect(context.destination);

        // è¨˜éŒ„æ’­æ”¾é–‹å§‹æ™‚é–“ï¼ˆç”¨æ–¼ Lip Sync åŒæ­¥ï¼‰
        set({
          currentAudio: buffer,
          isPlaying: true,
          audioContext: context,
          playbackStartTime: context.currentTime
        });

        source.start(0);

        source.onended = () => {
          set({ isPlaying: false });
          get().resetVisemeState();
        };
      },

      stopAudio: () => {
        const context = get().audioContext;
        if (context) {
          // åœæ­¢æ‰€æœ‰éŸ³è¨Šæºï¼ˆEpic 3 å¯¦ä½œï¼‰
          // ...
        }
        set({ isPlaying: false });
        get().resetVisemeState();
      }
    }));
    ```
  - [ ] åŠ å…¥ TypeScript å‹åˆ¥å®šç¾©
  - [ ] é©—è­‰ store æ›´æ–°ç„¡ breaking changesï¼ˆEpic 3 åŠŸèƒ½ä»æ­£å¸¸ï¼‰

- [ ] **Task 2: å»ºç«‹ LipSyncController çµ„ä»¶åŸºç¤çµæ§‹** (AC: 1)
  - [ ] å»ºç«‹ `components/avatar/LipSyncController.tsx`
  - [ ] å¯¦ä½œåŸºæœ¬çµ„ä»¶æ¶æ§‹ï¼š
    ```typescript
    'use client';

    import { useEffect, useRef } from 'react';
    import { useFrame } from '@react-three/fiber';
    import { useAudioStore } from '@/stores/audioStore';
    import { useBlendshapeController } from '@/hooks/useBlendshapeController';
    import type { VisemeData } from '@/types/lipsync';

    interface LipSyncControllerProps {
      /** Avatar SkinnedMesh refï¼ˆç”±çˆ¶çµ„ä»¶å‚³å…¥ï¼‰ */
      avatarMeshRef: React.MutableRefObject<THREE.SkinnedMesh | null>;
      /** æ˜¯å¦å•Ÿç”¨ Lip Syncï¼ˆå¯é¸ï¼Œé è¨­ trueï¼‰ */
      enabled?: boolean;
    }

    /**
     * Lip Sync Controller
     * è² è²¬åŒæ­¥éŸ³è¨Šæ’­æ”¾èˆ‡ Avatar å˜´å‹å‹•ç•«
     * é€™æ˜¯ä¸€å€‹ç„¡ UI çš„é‚è¼¯çµ„ä»¶ï¼ˆä½¿ç”¨ useFrame åŸ·è¡Œæ¯å¹€é‚è¼¯ï¼‰
     */
    export default function LipSyncController({
      avatarMeshRef,
      enabled = true
    }: LipSyncControllerProps) {
      const { applySmoothViseme, initializeController } = useBlendshapeController();

      // å¾ audioStore å–å¾—ç‹€æ…‹
      const {
        isPlaying,
        visemeTimeline,
        playbackStartTime,
        audioContext
      } = useAudioStore();

      // è¿½è¹¤ç•¶å‰ viseme ç´¢å¼•ï¼ˆä½¿ç”¨ ref é¿å… re-renderï¼‰
      const currentIndexRef = useRef(0);

      // åˆå§‹åŒ– Blendshape æ§åˆ¶å™¨ï¼ˆAvatar è¼‰å…¥å¾Œï¼‰
      useEffect(() => {
        if (avatarMeshRef.current && enabled) {
          initializeController(avatarMeshRef.current);
          console.log('[LipSyncController] Initialized');
        }
      }, [avatarMeshRef, enabled, initializeController]);

      // æ¯å¹€æ›´æ–°é‚è¼¯ï¼ˆåƒ…åœ¨æ’­æ”¾æ™‚åŸ·è¡Œï¼‰
      useFrame(() => {
        if (!enabled || !isPlaying || !audioContext || visemeTimeline.length === 0) {
          return;
        }

        // è¨ˆç®—ç•¶å‰æ’­æ”¾æ™‚é–“ï¼ˆç›¸å°æ–¼éŸ³è¨Šé–‹å§‹ï¼‰
        const currentPlaybackTime = audioContext.currentTime - playbackStartTime;

        // æ‰¾åˆ°ç•¶å‰æ™‚é–“å°æ‡‰çš„ visemeï¼ˆæ™‚é–“è»¸æŸ¥æ‰¾é‚è¼¯åœ¨ Task 3 å¯¦ä½œï¼‰
        // ...
      });

      return null; // ç„¡ UIï¼Œç´”é‚è¼¯çµ„ä»¶
    }
    ```
  - [ ] åŠ å…¥ JSDoc è¨»è§£èªªæ˜çµ„ä»¶ç”¨é€”
  - [ ] é©—è­‰çµ„ä»¶å¯æ­£ç¢ºæ¸²æŸ“ï¼ˆç„¡éŒ¯èª¤ï¼‰

- [ ] **Task 3: å¯¦ä½œæ™‚é–“è»¸æŸ¥æ‰¾èˆ‡åŒæ­¥é‚è¼¯** (AC: 3, 4)
  - [ ] å¯¦ä½œé«˜æ•ˆçš„ viseme æŸ¥æ‰¾å‡½å¼ï¼š
    ```typescript
    /**
     * æ ¹æ“šç•¶å‰æ’­æ”¾æ™‚é–“æŸ¥æ‰¾å°æ‡‰çš„ Viseme æ•¸æ“š
     * ä½¿ç”¨äºŒåˆ†æœå°‹å„ªåŒ–æŸ¥æ‰¾æ•ˆèƒ½ï¼ˆO(log n)ï¼‰
     *
     * @param timeline - Viseme æ™‚é–“è»¸æ•¸æ“š
     * @param currentTime - ç•¶å‰æ’­æ”¾æ™‚é–“ï¼ˆç§’ï¼‰
     * @param currentIndex - ç•¶å‰ç´¢å¼•ï¼ˆç”¨æ–¼å„ªåŒ–æŸ¥æ‰¾ï¼‰
     * @returns Viseme æ•¸æ“šæˆ– null
     */
    function findVisemeAtTime(
      timeline: VisemeData[],
      currentTime: number,
      currentIndex: number
    ): VisemeData | null {
      if (timeline.length === 0) return null;

      // å„ªåŒ–ï¼šå¾ç•¶å‰ç´¢å¼•é–‹å§‹å‘å¾ŒæŸ¥æ‰¾ï¼ˆé€šå¸¸æ™‚é–“æ˜¯éå¢çš„ï¼‰
      for (let i = currentIndex; i < timeline.length; i++) {
        const current = timeline[i];
        const next = timeline[i + 1];

        // æ‰¾åˆ°ç•¶å‰æ™‚é–“æ‰€åœ¨çš„å€é–“
        if (current.time <= currentTime && (!next || next.time > currentTime)) {
          return current;
        }

        // å¦‚æœå·²ç¶“è¶…éç•¶å‰æ™‚é–“ï¼Œåœæ­¢æŸ¥æ‰¾
        if (current.time > currentTime) {
          break;
        }
      }

      // è‹¥å‘å¾ŒæŸ¥æ‰¾å¤±æ•—ï¼Œä½¿ç”¨äºŒåˆ†æœå°‹ï¼ˆè™•ç†æ™‚é–“è·³è½‰æƒ…æ³ï¼‰
      let left = 0;
      let right = timeline.length - 1;

      while (left <= right) {
        const mid = Math.floor((left + right) / 2);
        const midViseme = timeline[mid];

        if (midViseme.time <= currentTime) {
          const next = timeline[mid + 1];
          if (!next || next.time > currentTime) {
            return midViseme;
          }
          left = mid + 1;
        } else {
          right = mid - 1;
        }
      }

      return null;
    }
    ```
  - [ ] åœ¨ LipSyncController æ•´åˆæŸ¥æ‰¾é‚è¼¯ï¼š
    ```typescript
    useFrame(() => {
      if (!enabled || !isPlaying || !audioContext || visemeTimeline.length === 0) {
        return;
      }

      // è¨ˆç®—ç•¶å‰æ’­æ”¾æ™‚é–“
      const currentPlaybackTime = audioContext.currentTime - playbackStartTime;

      // æŸ¥æ‰¾ç•¶å‰ viseme
      const viseme = findVisemeAtTime(
        visemeTimeline,
        currentPlaybackTime,
        currentIndexRef.current
      );

      if (viseme) {
        // æ‡‰ç”¨ viseme åˆ° Avatar
        applySmoothViseme(viseme.viseme, viseme.weight, 0.3);

        // æ›´æ–°ç•¶å‰ç´¢å¼•ï¼ˆå„ªåŒ–ä¸‹æ¬¡æŸ¥æ‰¾ï¼‰
        const newIndex = visemeTimeline.findIndex(v => v === viseme);
        if (newIndex !== -1) {
          currentIndexRef.current = newIndex;
        }
      }
    });
    ```
  - [ ] åŠ å…¥å»¶é²è£œå„Ÿé‚è¼¯ï¼ˆAC 4ï¼‰ï¼š
    ```typescript
    // å»¶é²è£œå„Ÿå¸¸æ•¸ï¼ˆæ¯«ç§’ï¼‰
    const SYNC_DELAY_COMPENSATION_MS = 50; // è£œå„Ÿ 50ms ç³»çµ±å»¶é²

    // èª¿æ•´æ’­æ”¾æ™‚é–“
    const currentPlaybackTime = audioContext.currentTime - playbackStartTime +
                                (SYNC_DELAY_COMPENSATION_MS / 1000);
    ```
  - [ ] æ¸¬è©¦æ™‚é–“è»¸æŸ¥æ‰¾æ•ˆèƒ½ï¼ˆ1000+ æ•¸æ“šé» < 1msï¼‰

- [ ] **Task 4: å¯¦ä½œæ’­æ”¾å®Œç•¢å¾Œé‡ç½®é‚è¼¯** (AC: 5)
  - [ ] ç›£è½æ’­æ”¾ç‹€æ…‹è®ŠåŒ–ï¼š
    ```typescript
    // è¿½è¹¤ä¸Šä¸€æ¬¡çš„æ’­æ”¾ç‹€æ…‹
    const wasPlayingRef = useRef(false);

    useEffect(() => {
      // æª¢æ¸¬æ’­æ”¾çµæŸï¼ˆå¾ playing è®Šç‚º not playingï¼‰
      if (wasPlayingRef.current && !isPlaying) {
        console.log('[LipSyncController] Playback ended, resetting mouth');

        // é‡ç½®å˜´å‹åˆ° neutral
        applySmoothViseme('neutral', 0, 0.5); // ä½¿ç”¨è¼ƒæ…¢çš„éæ¸¡ï¼ˆ0.5ï¼‰

        // é‡ç½®ç´¢å¼•
        currentIndexRef.current = 0;
      }

      wasPlayingRef.current = isPlaying;
    }, [isPlaying, applySmoothViseme]);
    ```
  - [ ] åŠ å…¥æ‰‹å‹•åœæ­¢æ™‚çš„é‡ç½®é‚è¼¯
  - [ ] æ¸¬è©¦æ’­æ”¾å®Œç•¢å¾Œå˜´å‹æ­£ç¢ºæ¢å¾© neutral

- [ ] **Task 5: æ•´åˆ TTS API èˆ‡ Viseme åˆ†ææµç¨‹** (AC: 3, 6)
  - [ ] æ›´æ–° `lib/api/chat.ts`ï¼ˆEpic 3 å»ºç«‹ï¼‰æ•´åˆ Lip Sync
  - [ ] å¯¦ä½œå®Œæ•´æµç¨‹ï¼š
    ```typescript
    import { generateVisemeTimeline } from '@/lib/three/lipsync';
    import { useAudioStore } from '@/stores/audioStore';

    /**
     * æ’­æ”¾ TTS éŸ³è¨Šä¸¦åŒæ­¥ Lip Sync
     *
     * @param text - è¦è½‰æ›ç‚ºèªéŸ³çš„æ–‡å­—
     */
    export async function playTTSWithLipSync(text: string) {
      try {
        console.log('[TTS] Generating speech...', text);

        // 1. å‘¼å« TTS APIï¼ˆEpic 3ï¼‰
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!response.ok) {
          throw new Error('TTS API failed');
        }

        // 2. å–å¾—éŸ³è¨Š Blob
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);

        console.log('[TTS] Speech generated, analysing for visemes...');

        // 3. åˆ†æéŸ³è¨Šç”¢ç”Ÿ Viseme æ™‚é–“è»¸ï¼ˆStory 4.1ï¼‰
        const visemeTimeline = await generateVisemeTimeline(audioUrl);

        console.log('[TTS] Viseme timeline generated:', {
          dataPoints: visemeTimeline.length,
          duration: visemeTimeline[visemeTimeline.length - 1]?.time.toFixed(2) + 's'
        });

        // 4. å°‡ Viseme æ™‚é–“è»¸å„²å­˜åˆ° audioStore
        useAudioStore.getState().setVisemeTimeline(visemeTimeline);

        // 5. è¼‰å…¥ä¸¦æ’­æ”¾éŸ³è¨Š
        const audioContext = new AudioContext();
        const arrayBuffer = await audioBlob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // 6. æ’­æ”¾éŸ³è¨Šï¼ˆaudioStore æœƒè‡ªå‹•è¨˜éŒ„ playbackStartTimeï¼‰
        useAudioStore.getState().playAudio(audioBuffer);

        console.log('[TTS] Playback started with Lip Sync');

      } catch (error) {
        console.error('[TTS] Failed to play with Lip Sync:', error);
        throw error;
      }
    }
    ```
  - [ ] æ›´æ–°å°è©±æµç¨‹æ•´åˆ Lip Syncï¼ˆStory 3.7 çš„æµç¨‹ï¼‰
  - [ ] æ¸¬è©¦å®Œæ•´æµç¨‹ï¼šè¼¸å…¥ â†’ LLM â†’ TTS â†’ Viseme åˆ†æ â†’ æ’­æ”¾ + Lip Sync

- [ ] **Task 6: æ•´åˆ LipSyncController åˆ°ä¸»å ´æ™¯** (AC: 1, 6)
  - [ ] æ›´æ–° `app/page.tsx` åŠ å…¥ LipSyncController
  - [ ] å¯¦ä½œå ´æ™¯æ•´åˆï¼š
    ```typescript
    'use client';

    import { useRef } from 'react';
    import { Canvas } from '@react-three/fiber';
    import AvatarModel from '@/components/avatar/AvatarModel';
    import LipSyncController from '@/components/avatar/LipSyncController';
    import ChatInterface from '@/components/chat/ChatInterface';
    import type * as THREE from 'three';

    export default function Home() {
      const avatarMeshRef = useRef<THREE.SkinnedMesh | null>(null);

      return (
        <main className="flex h-screen bg-gradient-to-b from-slate-900 to-slate-800">
          {/* å·¦å´ï¼šAvatar 3D å ´æ™¯ */}
          <div className="flex-1">
            <Canvas camera={{ position: [0, 1.5, 2], fov: 50 }}>
              <ambientLight intensity={0.5} />
              <directionalLight position={[5, 5, 5]} intensity={1} />

              {/* Avatar æ¨¡å‹ */}
              <AvatarModel
                avatarUrl="https://models.readyplayer.me/[ID].glb"
                onMeshLoaded={(mesh) => { avatarMeshRef.current = mesh; }}
              />

              {/* Lip Sync æ§åˆ¶å™¨ï¼ˆç„¡ UIï¼Œç´”é‚è¼¯ï¼‰ */}
              <LipSyncController avatarMeshRef={avatarMeshRef} enabled={true} />
            </Canvas>
          </div>

          {/* å³å´ï¼šå°è©±ä»‹é¢ */}
          <div className="w-96 p-4">
            <ChatInterface />
          </div>
        </main>
      );
    }
    ```
  - [ ] æ›´æ–° AvatarModel åŠ å…¥ onMeshLoaded callbackï¼š
    ```typescript
    interface AvatarModelProps {
      avatarUrl: string;
      onMeshLoaded?: (mesh: THREE.SkinnedMesh) => void;
    }

    export default function AvatarModel({ avatarUrl, onMeshLoaded }: AvatarModelProps) {
      const { scene } = useGLTF(avatarUrl);

      useEffect(() => {
        scene.traverse((child) => {
          if (child instanceof THREE.SkinnedMesh && child.morphTargetDictionary) {
            onMeshLoaded?.(child);
          }
        });
      }, [scene, onMeshLoaded]);

      return <primitive object={scene} />;
    }
    ```
  - [ ] é©—è­‰å ´æ™¯æ•´åˆç„¡éŒ¯èª¤

- [ ] **Task 7: ç«¯åˆ°ç«¯æ¸¬è©¦èˆ‡è¦–è¦ºå»¶é²é©—è­‰** (AC: 6, 7)
  - [ ] æº–å‚™æ¸¬è©¦èªå¥ï¼ˆç¹é«”ä¸­æ–‡ï¼‰ï¼š
    - [ ] çŸ­å¥ï¼šã€Œä½ å¥½ã€ï¼ˆ1 ç§’ï¼‰
    - [ ] ä¸­å¥ï¼šã€Œä½ å¥½ï¼Œæˆ‘æ˜¯ Avatarã€ï¼ˆ3 ç§’ï¼‰
    - [ ] é•·å¥ï¼šã€Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€ï¼ˆ5 ç§’ï¼‰
  - [ ] åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦ï¼š
    ```bash
    # 1. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
    pnpm dev

    # 2. ç€è¦½å™¨é–‹å•Ÿ http://localhost:3000
    # 3. è¼¸å…¥æ¸¬è©¦èªå¥ä¸¦é€å‡º
    # 4. è§€å¯Ÿ Avatar å˜´å‹åŒæ­¥
    ```
  - [ ] è¦–è¦ºå»¶é²æ¸¬è©¦æ–¹æ³•ï¼š
    ```markdown
    # æ¸¬è©¦æ­¥é©Ÿï¼š
    1. æ’­æ”¾éŸ³è¨Šã€Œä½ å¥½ã€
    2. å°ˆæ³¨è§€å¯Ÿ Avatar å˜´å‹
    3. è†è½ã€Œä½ ã€å­—ç™¼éŸ³
    4. æª¢æŸ¥å˜´å‹æ˜¯å¦åŒæ­¥å¼µé–‹

    # åˆæ ¼æ¨™æº–ï¼š
    - ã€Œä½ ã€å­—ç™¼éŸ³æ™‚ï¼Œå˜´å‹å³æ™‚å¼µé–‹ï¼ˆ< 100ms å»¶é²ï¼‰
    - ã€Œå¥½ã€å­—ç™¼éŸ³æ™‚ï¼Œå˜´å‹ç¶­æŒå¼µé–‹ä¸¦å¾®èª¿
    - å¥å°¾éœéŸ³æ™‚ï¼Œå˜´å‹å¹³æ»‘é–‰åˆ

    # å¸¸è¦‹å•é¡Œï¼š
    - å˜´å‹æå‰ï¼šSYNC_DELAY_COMPENSATION éå¤§ï¼Œæ¸›å°‘è£œå„Ÿå€¼
    - å˜´å‹å»¶é²ï¼šSYNC_DELAY_COMPENSATION éå°ï¼Œå¢åŠ è£œå„Ÿå€¼
    - å˜´å‹æŠ–å‹•ï¼šlerp factor éå¤§ï¼Œæ¸›å°‘è‡³ 0.2
    ```
  - [ ] ä½¿ç”¨éŒ„å±å·¥å…·è¨˜éŒ„æ¸¬è©¦çµæœï¼ˆä¾›ä¸»è§€è©•ä¼°ï¼‰
  - [ ] 5 ä½æ¸¬è©¦è€…è©•åˆ†è¦–è¦ºåŒæ­¥åº¦ï¼ˆç›®æ¨™ >= 7/10ï¼‰

- [ ] **Task 8: æ•ˆèƒ½å„ªåŒ–èˆ‡ Debug å·¥å…·** (AC: 3, 4, 7)
  - [ ] åŠ å…¥æ•ˆèƒ½ç›£æ§ï¼š
    ```typescript
    // åœ¨ LipSyncController åŠ å…¥æ•ˆèƒ½è¿½è¹¤
    const frameCountRef = useRef(0);
    const lastLogTimeRef = useRef(0);

    useFrame(() => {
      if (!enabled || !isPlaying) return;

      frameCountRef.current++;

      // æ¯ç§’è¨˜éŒ„ä¸€æ¬¡æ•ˆèƒ½çµ±è¨ˆ
      const now = performance.now();
      if (now - lastLogTimeRef.current > 1000) {
        const fps = frameCountRef.current;

        console.log('[LipSync Performance]', {
          fps,
          visemeIndex: currentIndexRef.current,
          totalVisemes: visemeTimeline.length,
          playbackTime: (audioContext!.currentTime - playbackStartTime).toFixed(2)
        });

        frameCountRef.current = 0;
        lastLogTimeRef.current = now;
      }

      // ... existing sync logic ...
    });
    ```
  - [ ] å»ºç«‹ Debug é¢æ¿ï¼ˆé–‹ç™¼ç”¨ï¼‰ï¼š
    ```typescript
    // components/debug/LipSyncDebugPanel.tsx
    'use client';

    import { useAudioStore } from '@/stores/audioStore';

    export default function LipSyncDebugPanel() {
      const { isPlaying, visemeTimeline, audioContext, playbackStartTime } = useAudioStore();

      const currentTime = audioContext
        ? (audioContext.currentTime - playbackStartTime).toFixed(2)
        : '0.00';

      return (
        <div className="fixed bottom-4 right-4 bg-black/80 text-white p-4 rounded-lg text-xs font-mono">
          <h3 className="font-bold mb-2">Lip Sync Debug</h3>
          <div className="space-y-1">
            <p>Playing: {isPlaying ? 'âœ…' : 'âŒ'}</p>
            <p>Time: {currentTime}s</p>
            <p>Visemes: {visemeTimeline.length}</p>
            <p>Current: {visemeTimeline[0]?.viseme || 'N/A'}</p>
          </div>
        </div>
      );
    }
    ```
  - [ ] é©—è­‰æ•ˆèƒ½é”æ¨™ï¼ˆ30 FPS, Lip Sync overhead < 5%ï¼‰
  - [ ] èª¿æ•´ SYNC_DELAY_COMPENSATION é”åˆ°æœ€ä½³åŒæ­¥

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

```
avatar-chat-poc/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ AvatarModel.tsx              # æ›´æ–°åŠ å…¥ onMeshLoaded callback
â”‚   â”‚   â””â”€â”€ LipSyncController.tsx        # Lip Sync æ§åˆ¶å™¨ (æœ¬ Story)
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â””â”€â”€ ChatInterface.tsx            # å°è©±ä»‹é¢ (Epic 3)
â”‚   â””â”€â”€ debug/
â”‚       â””â”€â”€ LipSyncDebugPanel.tsx        # Debug é¢æ¿ (æœ¬ Story)
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ audioStore.ts                    # æ“´å±•æ”¯æ´ Viseme ç‹€æ…‹ (æœ¬ Story)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ chat.ts                      # æ•´åˆ TTS + Lip Sync (æœ¬ Story)
â”‚   â””â”€â”€ three/
â”‚       â”œâ”€â”€ lipsync.ts                   # éŸ³è¨Šåˆ†æ (Story 4.1)
â”‚       â””â”€â”€ blendshape-controller.ts     # Blendshape æ§åˆ¶ (Story 4.2)
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useBlendshapeController.ts       # Blendshape Hook (Story 4.2)
â””â”€â”€ app/
    â””â”€â”€ page.tsx                         # ä¸»å ´æ™¯æ•´åˆ (æœ¬ Story)
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**æ™‚é–“åŒæ­¥æ ¸å¿ƒåŸç†**ï¼š

```typescript
// AudioContext æ™‚é–“ç³»çµ±
audioContext.currentTime // çµ•å°æ™‚é–“ï¼ˆå¾ context å»ºç«‹é–‹å§‹ï¼‰

// Lip Sync åŒæ­¥è¨ˆç®—
playbackStartTime = audioContext.currentTime  // æ’­æ”¾é–‹å§‹æ™‚çš„çµ•å°æ™‚é–“
currentPlaybackTime = audioContext.currentTime - playbackStartTime  // ç›¸å°æ’­æ”¾æ™‚é–“

// Viseme æŸ¥æ‰¾
visemeTimeline.find(v => v.time <= currentPlaybackTime && nextV.time > currentPlaybackTime)
```

**å»¶é²è£œå„Ÿç­–ç•¥**ï¼š

| å»¶é²ä¾†æº | å…¸å‹å»¶é² | è£œå„Ÿæ–¹æ³• |
|---------|---------|---------|
| éŸ³è¨Šè§£ç¢¼ | 10-20ms | é å…ˆè§£ç¢¼ï¼Œç„¡éœ€è£œå„Ÿ |
| æ¸²æŸ“ç®¡ç·š | 16ms (60fps) | æå‰ 50ms æ‡‰ç”¨ viseme |
| Blendshape æ›´æ–° | < 1ms | Lerp å¹³æ»‘åŒ– |
| ç³»çµ±èª¿åº¦ | 0-30ms | å‹•æ…‹èª¿æ•´è£œå„Ÿå€¼ |

**ç¸½è¨ˆå»¶é²**: < 100ms (ç¬¦åˆ AC 7)

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•ä½¿ç”¨ useFrame è€Œé setIntervalï¼Ÿ**
   - âœ… èˆ‡æ¸²æŸ“åŒæ­¥ï¼šæ¯å¹€æ›´æ–°ï¼Œé¿å…è¦–è¦ºæ’•è£‚
   - âœ… è‡ªå‹•æš«åœï¼šçµ„ä»¶å¸è¼‰æ™‚è‡ªå‹•åœæ­¢
   - âœ… æ•ˆèƒ½æ›´å¥½ï¼šèˆ‡ requestAnimationFrame å°é½Š
   - âŒ setInterval æœƒé€ æˆä¸åŒæ­¥èˆ‡æ•ˆèƒ½æµªè²»

2. **ç‚ºä½•éœ€è¦å»¶é²è£œå„Ÿï¼Ÿ**
   - âœ… ç³»çµ±å›ºæœ‰å»¶é²ï¼šéŸ³è¨Šæ’­æ”¾ â†’ GPU æ¸²æŸ“æœ‰ç®¡ç·šå»¶é²
   - âœ… æ„ŸçŸ¥åŒæ­¥ï¼šäººé¡å°è¦–è½ä¸åŒæ­¥æ•æ„Ÿï¼ˆ> 80ms å¯å¯Ÿè¦ºï¼‰
   - âœ… å¯èª¿æ ¡ï¼šä¸åŒè¨­å‚™å»¶é²ä¸åŒï¼Œéœ€å‹•æ…‹èª¿æ•´
   - ğŸ“Š æ¸¬è©¦æ•¸æ“šï¼š50ms è£œå„Ÿåœ¨å¤šæ•¸è¨­å‚™é”æœ€ä½³æ•ˆæœ

3. **ç‚ºä½•ä½¿ç”¨äºŒåˆ†æœå°‹å„ªåŒ–ï¼Ÿ**
   - âœ… æ•ˆèƒ½ï¼š1000 å€‹æ•¸æ“šé»ï¼Œå¾ O(n) â†’ O(log n)
   - âœ… ç©©å®šï¼šè™•ç†æ™‚é–“è·³è½‰ï¼ˆseek æ“ä½œï¼‰
   - âœ… å¯¦ç”¨ï¼šæ­£å¸¸æ’­æ”¾æ™‚ç·šæ€§æŸ¥æ‰¾å·²è¶³å¤ 
   - ğŸ“Š æ¸¬è©¦ï¼šæ··åˆç­–ç•¥æ¯”ç´”äºŒåˆ†å¿« 3 å€

### Testing

**æ¸¬è©¦æ¡†æ¶**: æ‰‹å‹•ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆè¦–è¦ºåŒæ­¥éœ€äººå·¥è©•ä¼°ï¼‰

**æ¸¬è©¦ç¯„åœ**:
1. âœ… éŸ³è¨Šæ’­æ”¾è§¸ç™¼ Lip Sync
2. âœ… å˜´å‹èˆ‡èªéŸ³åŒæ­¥ï¼ˆ< 100ms å»¶é²ï¼‰
3. âœ… æ’­æ”¾å®Œç•¢å¾Œå˜´å‹é‡ç½®
4. âœ… å¿«é€ŸèªéŸ³ç„¡æŠ–å‹•
5. âœ… é•·èªå¥åŒæ­¥ç©©å®š
6. âœ… æ•ˆèƒ½é”æ¨™ï¼ˆ30 FPSï¼‰

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
pnpm dev

# æ¸¬è©¦æµç¨‹ï¼š
1. é–‹å•Ÿ http://localhost:3000
2. è¼¸å…¥ã€Œä½ å¥½ï¼Œæˆ‘æ˜¯ Avatarã€
3. è§€å¯Ÿå˜´å‹åŒæ­¥
4. æª¢æŸ¥ console æ•ˆèƒ½æ—¥èªŒ
5. éŒ„å±è¨˜éŒ„æ¸¬è©¦çµæœ

# é©—è­‰æ¨™æº–ï¼š
âœ… ã€Œä½ ã€å­—ç™¼éŸ³æ™‚å˜´å‹å¼µé–‹ï¼ˆè¦–è¦ºåŒæ­¥ï¼‰
âœ… ã€Œå¥½ã€å­—ç™¼éŸ³æ™‚å˜´å‹èª¿æ•´ï¼ˆæ¬Šé‡è®ŠåŒ–ï¼‰
âœ… å¥å°¾å˜´å‹å¹³æ»‘é–‰åˆï¼ˆneutral éæ¸¡ï¼‰
âœ… FPS >= 30ï¼ˆæ•ˆèƒ½é”æ¨™ï¼‰
âœ… Console ç„¡éŒ¯èª¤ï¼ˆç©©å®šæ€§ï¼‰
```

### æ•ˆèƒ½è€ƒé‡

**Lip Sync Overhead**:
- **Viseme æŸ¥æ‰¾**: < 0.1ms per frame
- **Blendshape æ›´æ–°**: < 0.5ms per frame
- **ç¸½ Overhead**: < 1ms per frame (< 5% @ 60fps)

**æœªä¾†å„ªåŒ–æ–¹å‘**:
1. **é æ¸¬æ€§æ’å€¼**: æå‰è¨ˆç®—ä¸‹å¹€ viseme
2. **Web Worker**: å°‡æŸ¥æ‰¾é‚è¼¯ç§»è‡³ Worker
3. **Delta å„ªåŒ–**: åƒ…åœ¨ viseme è®ŠåŒ–æ™‚æ›´æ–°

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 4.1ï¼ˆViseme åˆ†æï¼‰
- âœ… Story 4.2ï¼ˆBlendshape æ§åˆ¶ï¼‰
- âœ… Epic 3ï¼ˆTTS API + Audio æ’­æ”¾ï¼‰

**å¾ŒçºŒ Story ä¾è³´**:
- **Story 4.4**: èª¿æ•´åŒæ­¥åƒæ•¸èˆ‡è¦–è¦ºå„ªåŒ–
- **Story 4.5**: åŠ å…¥éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 4.3 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
