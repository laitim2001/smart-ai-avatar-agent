# Story 5.2: éŒ¯èª¤è™•ç†èˆ‡ä½¿ç”¨è€…é«”é©—å®Œå–„

**Epic**: Epic 5 - Polish & Deployment
**Story ID**: 5.2
**Story åç¨±**: éŒ¯èª¤è™•ç†èˆ‡ä½¿ç”¨è€…é«”é©—å®Œå–„
**å„ªå…ˆé †åº**: High
**é ä¼°æ™‚é–“**: 6 å°æ™‚
**ç‹€æ…‹**: Draft

---

## ğŸ“‹ Story æè¿°

### User Story
**As a** ä½¿ç”¨è€…
**I want** é‡åˆ°éŒ¯èª¤æ™‚èƒ½çœ‹åˆ°å‹å–„çš„éŒ¯èª¤è¨Šæ¯ä¸¦æœ‰é‡è©¦é¸é …
**So that** æˆ‘èƒ½ç†è§£ç™¼ç”Ÿäº†ä»€éº¼å•é¡Œï¼Œä¸¦æœ‰æ©Ÿæœƒæ¢å¾©æ‡‰ç”¨ç¨‹å¼é‹ä½œï¼Œè€Œä¸æ˜¯çœ‹åˆ°æŠ€è¡“æ€§éŒ¯èª¤æˆ–ç™½å±

### Business Value
- **ä½¿ç”¨è€…é«”é©—ä¿è­‰**: ä»»ä½•éŒ¯èª¤éƒ½ä¸æœƒå°è‡´æ‡‰ç”¨ç¨‹å¼å´©æ½°æˆ–ç™½å±
- **éŒ¯èª¤å¯æ¢å¾©æ€§**: æä¾›é‡è©¦æ©Ÿåˆ¶ï¼Œè®“æš«æ™‚æ€§éŒ¯èª¤ï¼ˆç¶²è·¯æ³¢å‹•ã€API timeoutï¼‰å¯è‡ªå‹•æ¢å¾©
- **é€æ˜åº¦**: ä½¿ç”¨è€…æ¸…æ¥šçŸ¥é“ç™¼ç”Ÿäº†ä»€éº¼å•é¡Œï¼Œè€ŒéæŠ€è¡“æ€§éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚ "Error 500"ï¼‰
- **é™ä½æµå¤±ç‡**: è‰¯å¥½çš„éŒ¯èª¤è™•ç†å¯æ¸›å°‘ä½¿ç”¨è€…å› æŒ«æŠ˜è€Œé›¢é–‹æ‡‰ç”¨ç¨‹å¼

### Technical Context
- **Error Boundary Pattern**: React 16+ æä¾›çš„å…¨åŸŸéŒ¯èª¤æ•æ‰æ©Ÿåˆ¶
- **Graceful Degradation**: éŒ¯èª¤ç™¼ç”Ÿæ™‚é™ç´šåŠŸèƒ½ï¼Œè€Œéå®Œå…¨åœæ­¢
- **Retry Strategy**: é‡å°æš«æ™‚æ€§éŒ¯èª¤ï¼ˆ500 errors, network timeoutï¼‰è‡ªå‹•é‡è©¦ä¸€æ¬¡
- **Loading States**: æä¾›è¦–è¦ºå›é¥‹ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç³»çµ±æ­£åœ¨è™•ç†è«‹æ±‚

---

## âœ… Acceptance Criteria

### Functional Requirements
1. **å…¨åŸŸ Error Boundary**:
   - [ ] æ‡‰ç”¨ç¨‹å¼æœ€å¤–å±¤åŒ…è£¹ ErrorBoundary çµ„ä»¶
   - [ ] æ•æ‰æ‰€æœ‰æœªè™•ç†çš„ React æ¸²æŸ“éŒ¯èª¤
   - [ ] é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤ç•«é¢ï¼ˆéæŠ€è¡“æ€§éŒ¯èª¤è¨Šæ¯ï¼‰
   - [ ] æä¾›ã€Œé‡æ–°è¼‰å…¥ã€æŒ‰éˆ•è®“ä½¿ç”¨è€…æ¢å¾©æ‡‰ç”¨ç¨‹å¼

2. **å‹å–„éŒ¯èª¤è¨Šæ¯æ˜ å°„**:
   - [ ] Azure TTS API éŒ¯èª¤ â†’ "æŠ±æ­‰ï¼ŒèªéŸ³ç”Ÿæˆæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦"
   - [ ] ç¶²è·¯éŒ¯èª¤ â†’ "ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š"
   - [ ] 3D Model è¼‰å…¥å¤±æ•— â†’ "Avatar æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦..."
   - [ ] æœªçŸ¥éŒ¯èª¤ â†’ "ç™¼ç”Ÿäº†ä¸€äº›å•é¡Œï¼Œæˆ‘å€‘æ­£åœ¨åŠªåŠ›ä¿®å¾©"

3. **é‡è©¦æ©Ÿåˆ¶**:
   - [ ] Azure API 500 éŒ¯èª¤è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆå»¶é² 2 ç§’ï¼‰
   - [ ] ç¶²è·¯ timeout è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆå»¶é² 3 ç§’ï¼‰
   - [ ] 3D Model è¼‰å…¥å¤±æ•—è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆå»¶é² 1 ç§’ï¼‰
   - [ ] é‡è©¦å¤±æ•—å¾Œé¡¯ç¤ºæ‰‹å‹•é‡è©¦æŒ‰éˆ•

4. **Loading States å„ªåŒ–**:
   - [ ] Avatar è¼‰å…¥æ™‚é¡¯ç¤º Skeleton ç•«é¢æˆ–é€²åº¦æ¢
   - [ ] TTS èªéŸ³ç”Ÿæˆæ™‚é¡¯ç¤º "æ­£åœ¨ç”ŸæˆèªéŸ³..." æç¤º
   - [ ] å°è©±é€å‡ºæ™‚é¡¯ç¤º "å‚³é€ä¸­..." ç‹€æ…‹
   - [ ] æ‰€æœ‰ç•°æ­¥æ“ä½œéƒ½æœ‰è¦–è¦ºè¼‰å…¥å›é¥‹

### Non-Functional Requirements
1. **æ•ˆèƒ½**: éŒ¯èª¤è™•ç†ä¸æ‡‰å¢åŠ è¶…é 50ms çš„å»¶é²
2. **ä½¿ç”¨è€…é«”é©—**: éŒ¯èª¤è¨Šæ¯åœ¨ 500ms å…§é¡¯ç¤º
3. **å¯æ¸¬è©¦æ€§**: æ‰€æœ‰éŒ¯èª¤å ´æ™¯éƒ½å¯é€šéæ‰‹å‹•æ¸¬è©¦æˆ– Mock é©—è­‰
4. **ç„¡éšœç¤™**: éŒ¯èª¤è¨Šæ¯æ”¯æ´ screen readerï¼ˆARIA live regionï¼‰

---

## ğŸ—ï¸ Technical Design

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  App Component (Root)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Global Error Boundary                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚        Feature Components                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  AvatarCanvas (Local Error Handling)  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  - Try-Catch for 3D operations        â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  - Retry mechanism for model load     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  ChatInterface (Local Error Handling) â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  - Try-Catch for TTS API calls        â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  - Network error handling             â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚  Error Boundary catches:                           â”‚  â”‚
â”‚  â”‚  - Unhandled component errors                      â”‚  â”‚
â”‚  â”‚  - Rendering errors                                â”‚  â”‚
â”‚  â”‚  â†’ Shows fallback UI with retry button             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Error Handling Strategy:
1. Local Try-Catch: Handle known errors (API, network, 3D)
2. Error Boundary: Catch unexpected rendering errors
3. Retry Logic: Auto-retry once for transient errors
4. Graceful Degradation: Show friendly messages, not crashes
```

### Component Hierarchy

```typescript
<ErrorBoundary fallback={<ErrorFallback />}>
  <Layout>
    <ChatInterface
      onError={(error) => handleChatError(error)}
      isLoading={isTTSLoading}
    />
    <AvatarCanvas
      onError={(error) => handleAvatarError(error)}
      isLoading={isModelLoading}
    />
  </Layout>
</ErrorBoundary>
```

### Error Classification

```typescript
export enum ErrorCategory {
  NETWORK = 'NETWORK',           // ç¶²è·¯é€£ç·šå•é¡Œ
  API = 'API',                   // Azure API éŒ¯èª¤
  MODEL_LOADING = 'MODEL_LOADING', // 3D æ¨¡å‹è¼‰å…¥å¤±æ•—
  RENDERING = 'RENDERING',       // Three.js æ¸²æŸ“éŒ¯èª¤
  UNKNOWN = 'UNKNOWN'            // æœªçŸ¥éŒ¯èª¤
}

export interface AppError {
  category: ErrorCategory;
  message: string;            // æŠ€è¡“æ€§è¨Šæ¯ï¼ˆä¾›é–‹ç™¼è€…ï¼‰
  userMessage: string;        // å‹å–„è¨Šæ¯ï¼ˆä¾›ä½¿ç”¨è€…ï¼‰
  retryable: boolean;         // æ˜¯å¦å¯é‡è©¦
  originalError?: Error;      // åŸå§‹éŒ¯èª¤ç‰©ä»¶
}
```

---

## ğŸ“ Tasks

### Task 1: å»ºç«‹å…¨åŸŸ Error Boundary çµ„ä»¶

**æè¿°**: å¯¦ä½œ React Error Boundary åŒ…è£¹æ•´å€‹æ‡‰ç”¨ç¨‹å¼ï¼Œæ•æ‰æ‰€æœ‰æœªè™•ç†çš„æ¸²æŸ“éŒ¯èª¤

**æª”æ¡ˆ**: `src/components/ErrorBoundary.tsx`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
'use client';

import React, { Component, ReactNode } from 'react';

interface ErrorBoundaryProps {
  children: ReactNode;
  fallback?: ReactNode;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
  errorInfo: React.ErrorInfo | null;
}

export class ErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null,
    };
  }

  static getDerivedStateFromError(error: Error): Partial<ErrorBoundaryState> {
    // Update state so the next render will show the fallback UI
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo): void {
    // Log error to console (could send to error tracking service)
    console.error('ErrorBoundary caught an error:', error, errorInfo);

    this.setState({
      error,
      errorInfo,
    });

    // Optional: Send error to monitoring service
    // logErrorToService(error, errorInfo);
  }

  handleReset = (): void => {
    this.setState({
      hasError: false,
      error: null,
      errorInfo: null,
    });

    // Reload the page to reset application state
    window.location.reload();
  };

  render(): ReactNode {
    if (this.state.hasError) {
      // Custom fallback UI
      if (this.props.fallback) {
        return this.props.fallback;
      }

      // Default fallback UI
      return (
        <div
          style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            height: '100vh',
            padding: '20px',
            textAlign: 'center',
            backgroundColor: '#f8f9fa',
          }}
        >
          <div
            style={{
              maxWidth: '600px',
              padding: '40px',
              backgroundColor: 'white',
              borderRadius: '8px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            }}
          >
            <h1 style={{ fontSize: '24px', marginBottom: '16px', color: '#dc3545' }}>
              ğŸ˜” ç™¼ç”Ÿäº†ä¸€äº›å•é¡Œ
            </h1>
            <p style={{ fontSize: '16px', marginBottom: '24px', color: '#6c757d' }}>
              æŠ±æ­‰ï¼Œæ‡‰ç”¨ç¨‹å¼é‡åˆ°äº†æ„å¤–éŒ¯èª¤ã€‚è«‹å˜—è©¦é‡æ–°è¼‰å…¥é é¢ã€‚
            </p>
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details
                style={{
                  marginTop: '20px',
                  padding: '12px',
                  backgroundColor: '#f8f9fa',
                  borderRadius: '4px',
                  textAlign: 'left',
                  fontSize: '14px',
                }}
              >
                <summary style={{ cursor: 'pointer', fontWeight: 'bold', marginBottom: '8px' }}>
                  éŒ¯èª¤è©³æƒ… (åƒ…é–‹ç™¼ç’°å¢ƒé¡¯ç¤º)
                </summary>
                <pre
                  style={{
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word',
                    color: '#dc3545',
                  }}
                >
                  {this.state.error.toString()}
                  {this.state.errorInfo?.componentStack}
                </pre>
              </details>
            )}
            <button
              onClick={this.handleReset}
              style={{
                marginTop: '24px',
                padding: '12px 24px',
                fontSize: '16px',
                backgroundColor: '#007bff',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
              }}
              onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = '#0056b3')}
              onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = '#007bff')}
            >
              ğŸ”„ é‡æ–°è¼‰å…¥é é¢
            </button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
```

**æ•´åˆåˆ° App**:
```typescript
// src/app/layout.tsx
import { ErrorBoundary } from '@/components/ErrorBoundary';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-TW">
      <body>
        <ErrorBoundary>
          {children}
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] ErrorBoundary æˆåŠŸæ•æ‰ componentDidCatch è§¸ç™¼çš„éŒ¯èª¤
- [ ] é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤ç•«é¢ï¼ˆéç™½å±æˆ–æŠ€è¡“æ€§éŒ¯èª¤ï¼‰
- [ ] ã€Œé‡æ–°è¼‰å…¥é é¢ã€æŒ‰éˆ•å¯æ­£å¸¸é‹ä½œ
- [ ] é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºéŒ¯èª¤è©³æƒ…ï¼Œç”Ÿç”¢ç’°å¢ƒéš±è—

---

### Task 2: å»ºç«‹éŒ¯èª¤åˆ†é¡èˆ‡å‹å–„è¨Šæ¯æ˜ å°„ç³»çµ±

**æè¿°**: å®šç¾©éŒ¯èª¤åˆ†é¡æšèˆ‰èˆ‡å‹å–„è¨Šæ¯æ˜ å°„è¡¨ï¼Œå°‡æŠ€è¡“æ€§éŒ¯èª¤è½‰æ›ç‚ºä½¿ç”¨è€…å¯ç†è§£çš„è¨Šæ¯

**æª”æ¡ˆ**: `src/lib/errors.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
export enum ErrorCategory {
  NETWORK = 'NETWORK',
  API = 'API',
  MODEL_LOADING = 'MODEL_LOADING',
  RENDERING = 'RENDERING',
  AUDIO_PLAYBACK = 'AUDIO_PLAYBACK',
  UNKNOWN = 'UNKNOWN',
}

export interface AppError {
  category: ErrorCategory;
  message: string;         // Technical message for developers
  userMessage: string;     // Friendly message for users
  retryable: boolean;      // Can this error be retried?
  originalError?: Error;
}

/**
 * Error message mapping for user-friendly display
 */
export const ERROR_MESSAGES: Record<ErrorCategory, string> = {
  [ErrorCategory.NETWORK]: 'ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š',
  [ErrorCategory.API]: 'æŠ±æ­‰ï¼ŒèªéŸ³ç”Ÿæˆæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦',
  [ErrorCategory.MODEL_LOADING]: 'Avatar æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦...',
  [ErrorCategory.RENDERING]: '3D æ¸²æŸ“ç™¼ç”Ÿå•é¡Œï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†é é¢',
  [ErrorCategory.AUDIO_PLAYBACK]: 'éŸ³è¨Šæ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨éŸ³è¨Šæ¬Šé™',
  [ErrorCategory.UNKNOWN]: 'ç™¼ç”Ÿäº†ä¸€äº›å•é¡Œï¼Œæˆ‘å€‘æ­£åœ¨åŠªåŠ›ä¿®å¾©',
};

/**
 * Classify an error into a category
 */
export function classifyError(error: unknown): ErrorCategory {
  if (!error) return ErrorCategory.UNKNOWN;

  const errorMessage = error instanceof Error ? error.message : String(error);
  const errorString = errorMessage.toLowerCase();

  // Network errors
  if (
    errorString.includes('network') ||
    errorString.includes('fetch') ||
    errorString.includes('timeout') ||
    errorString.includes('econnrefused')
  ) {
    return ErrorCategory.NETWORK;
  }

  // API errors (Azure TTS)
  if (
    errorString.includes('api') ||
    errorString.includes('azure') ||
    errorString.includes('tts') ||
    errorString.includes('401') ||
    errorString.includes('403') ||
    errorString.includes('500') ||
    errorString.includes('503')
  ) {
    return ErrorCategory.API;
  }

  // Model loading errors
  if (
    errorString.includes('model') ||
    errorString.includes('gltf') ||
    errorString.includes('load') ||
    errorString.includes('vrm')
  ) {
    return ErrorCategory.MODEL_LOADING;
  }

  // Rendering errors (Three.js)
  if (
    errorString.includes('webgl') ||
    errorString.includes('three') ||
    errorString.includes('render') ||
    errorString.includes('canvas')
  ) {
    return ErrorCategory.RENDERING;
  }

  // Audio errors
  if (
    errorString.includes('audio') ||
    errorString.includes('mediastream') ||
    errorString.includes('audiocontext')
  ) {
    return ErrorCategory.AUDIO_PLAYBACK;
  }

  return ErrorCategory.UNKNOWN;
}

/**
 * Check if an error is retryable
 */
export function isRetryableError(category: ErrorCategory): boolean {
  return [
    ErrorCategory.NETWORK,
    ErrorCategory.API,
    ErrorCategory.MODEL_LOADING,
  ].includes(category);
}

/**
 * Convert any error to AppError with friendly message
 */
export function createAppError(error: unknown): AppError {
  const category = classifyError(error);
  const userMessage = ERROR_MESSAGES[category];
  const retryable = isRetryableError(category);

  return {
    category,
    message: error instanceof Error ? error.message : String(error),
    userMessage,
    retryable,
    originalError: error instanceof Error ? error : undefined,
  };
}

/**
 * Get retry delay based on error category (milliseconds)
 */
export function getRetryDelay(category: ErrorCategory): number {
  switch (category) {
    case ErrorCategory.NETWORK:
      return 3000; // 3 seconds for network errors
    case ErrorCategory.API:
      return 2000; // 2 seconds for API errors
    case ErrorCategory.MODEL_LOADING:
      return 1000; // 1 second for model loading
    default:
      return 0; // No retry for non-retryable errors
  }
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
try {
  await fetchTTSAudio(text);
} catch (error) {
  const appError = createAppError(error);
  console.error('Technical error:', appError.message);
  toast.error(appError.userMessage); // Show to user

  if (appError.retryable) {
    const delay = getRetryDelay(appError.category);
    setTimeout(() => retryOperation(), delay);
  }
}
```

**é©—è­‰æ–¹å¼**:
- [ ] ç¶²è·¯éŒ¯èª¤æ­£ç¢ºåˆ†é¡ç‚º NETWORK
- [ ] Azure API éŒ¯èª¤æ­£ç¢ºåˆ†é¡ç‚º API
- [ ] 3D æ¨¡å‹è¼‰å…¥éŒ¯èª¤æ­£ç¢ºåˆ†é¡ç‚º MODEL_LOADING
- [ ] æ‰€æœ‰éŒ¯èª¤éƒ½æœ‰å°æ‡‰çš„å‹å–„è¨Šæ¯

---

### Task 3: å¯¦ä½œé‡è©¦æ©Ÿåˆ¶ (useRetry Hook)

**æè¿°**: å»ºç«‹å¯é‡è¤‡ä½¿ç”¨çš„ useRetry Hookï¼Œè™•ç†è‡ªå‹•é‡è©¦é‚è¼¯

**æª”æ¡ˆ**: `src/hooks/useRetry.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
import { useState, useCallback, useRef } from 'react';
import { ErrorCategory, getRetryDelay } from '@/lib/errors';

export interface RetryOptions {
  maxRetries?: number;        // Maximum retry attempts (default: 1)
  onRetry?: (attempt: number) => void;  // Callback on retry
  onSuccess?: () => void;     // Callback on success
  onFailure?: (error: unknown) => void; // Callback on final failure
}

export interface RetryState {
  isRetrying: boolean;
  retryCount: number;
  lastError: unknown | null;
}

export function useRetry<T>(
  asyncFn: () => Promise<T>,
  errorCategory: ErrorCategory,
  options: RetryOptions = {}
) {
  const { maxRetries = 1, onRetry, onSuccess, onFailure } = options;

  const [state, setState] = useState<RetryState>({
    isRetrying: false,
    retryCount: 0,
    lastError: null,
  });

  const abortControllerRef = useRef<AbortController | null>(null);

  const execute = useCallback(async (): Promise<T | null> => {
    // Cancel any ongoing retry
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }

    abortControllerRef.current = new AbortController();
    const signal = abortControllerRef.current.signal;

    setState({
      isRetrying: false,
      retryCount: 0,
      lastError: null,
    });

    let attempt = 0;

    while (attempt <= maxRetries) {
      try {
        const result = await asyncFn();

        // Success
        setState({
          isRetrying: false,
          retryCount: attempt,
          lastError: null,
        });

        onSuccess?.();
        return result;
      } catch (error) {
        attempt++;

        // Check if aborted
        if (signal.aborted) {
          return null;
        }

        // Last attempt failed
        if (attempt > maxRetries) {
          setState({
            isRetrying: false,
            retryCount: attempt - 1,
            lastError: error,
          });

          onFailure?.(error);
          throw error; // Propagate error
        }

        // Retry
        setState({
          isRetrying: true,
          retryCount: attempt,
          lastError: error,
        });

        onRetry?.(attempt);

        // Wait before retry
        const delay = getRetryDelay(errorCategory);
        await new Promise((resolve) => setTimeout(resolve, delay));
      }
    }

    return null;
  }, [asyncFn, errorCategory, maxRetries, onRetry, onSuccess, onFailure]);

  const cancel = useCallback(() => {
    abortControllerRef.current?.abort();
    setState((prev) => ({
      ...prev,
      isRetrying: false,
    }));
  }, []);

  return {
    execute,
    cancel,
    ...state,
  };
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
import { useRetry } from '@/hooks/useRetry';
import { ErrorCategory } from '@/lib/errors';

function ChatInterface() {
  const fetchTTS = async () => {
    const response = await fetch('/api/tts', {
      method: 'POST',
      body: JSON.stringify({ text: 'Hello' }),
    });
    if (!response.ok) throw new Error('TTS API failed');
    return response.json();
  };

  const { execute, isRetrying, retryCount } = useRetry(
    fetchTTS,
    ErrorCategory.API,
    {
      maxRetries: 1,
      onRetry: (attempt) => console.log(`Retrying... (${attempt})`),
      onSuccess: () => console.log('TTS success'),
      onFailure: (error) => toast.error('TTS failed after retry'),
    }
  );

  const handleSubmit = async () => {
    try {
      const result = await execute();
      console.log('TTS audio:', result);
    } catch (error) {
      // Handle final failure
    }
  };

  return (
    <div>
      <button onClick={handleSubmit} disabled={isRetrying}>
        {isRetrying ? `é‡è©¦ä¸­... (${retryCount})` : 'ç”ŸæˆèªéŸ³'}
      </button>
    </div>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] ç¬¬ä¸€æ¬¡å¤±æ•—å¾Œè‡ªå‹•é‡è©¦ä¸€æ¬¡
- [ ] é‡è©¦å»¶é²æ­£ç¢ºï¼ˆNetwork: 3s, API: 2s, Model: 1s)
- [ ] é‡è©¦æˆåŠŸå¾Œè§¸ç™¼ onSuccess
- [ ] é‡è©¦å¤±æ•—å¾Œè§¸ç™¼ onFailure
- [ ] cancel() å¯ä¸­æ­¢é€²è¡Œä¸­çš„é‡è©¦

---

### Task 4: å»ºç«‹ Toast é€šçŸ¥ç³»çµ±

**æè¿°**: å¯¦ä½œ Toast é€šçŸ¥ç³»çµ±ï¼Œé¡¯ç¤ºéŒ¯èª¤ã€æˆåŠŸã€è³‡è¨Šè¨Šæ¯

**æª”æ¡ˆ**: `src/components/Toast.tsx`, `src/hooks/useToast.ts`

**ç¨‹å¼ç¢¼å¯¦ä½œ (Toast Component)**:
```typescript
'use client';

import React, { useEffect } from 'react';

export type ToastType = 'success' | 'error' | 'info' | 'warning';

export interface ToastProps {
  id: string;
  type: ToastType;
  message: string;
  duration?: number; // milliseconds
  onClose: (id: string) => void;
}

export function Toast({ id, type, message, duration = 5000, onClose }: ToastProps) {
  useEffect(() => {
    const timer = setTimeout(() => {
      onClose(id);
    }, duration);

    return () => clearTimeout(timer);
  }, [id, duration, onClose]);

  const getIcon = () => {
    switch (type) {
      case 'success':
        return 'âœ…';
      case 'error':
        return 'âŒ';
      case 'warning':
        return 'âš ï¸';
      case 'info':
        return 'â„¹ï¸';
    }
  };

  const getBackgroundColor = () => {
    switch (type) {
      case 'success':
        return '#28a745';
      case 'error':
        return '#dc3545';
      case 'warning':
        return '#ffc107';
      case 'info':
        return '#17a2b8';
    }
  };

  return (
    <div
      role="alert"
      aria-live="assertive"
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        padding: '16px 20px',
        marginBottom: '12px',
        backgroundColor: getBackgroundColor(),
        color: 'white',
        borderRadius: '8px',
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
        minWidth: '300px',
        maxWidth: '500px',
        animation: 'slideInRight 0.3s ease-out',
      }}
    >
      <span style={{ fontSize: '20px' }}>{getIcon()}</span>
      <span style={{ flex: 1, fontSize: '14px' }}>{message}</span>
      <button
        onClick={() => onClose(id)}
        style={{
          background: 'transparent',
          border: 'none',
          color: 'white',
          cursor: 'pointer',
          fontSize: '18px',
          padding: '0',
        }}
        aria-label="é—œé–‰é€šçŸ¥"
      >
        Ã—
      </button>
    </div>
  );
}

export function ToastContainer({ toasts }: { toasts: ToastProps[] }) {
  return (
    <>
      <style>{`
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
      `}</style>
      <div
        style={{
          position: 'fixed',
          top: '20px',
          right: '20px',
          zIndex: 9999,
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'flex-end',
        }}
      >
        {toasts.map((toast) => (
          <Toast key={toast.id} {...toast} />
        ))}
      </div>
    </>
  );
}
```

**ç¨‹å¼ç¢¼å¯¦ä½œ (useToast Hook)**:
```typescript
// src/hooks/useToast.ts
import { useState, useCallback } from 'react';
import { ToastType, ToastProps } from '@/components/Toast';

let toastId = 0;

export function useToast() {
  const [toasts, setToasts] = useState<ToastProps[]>([]);

  const addToast = useCallback((type: ToastType, message: string, duration?: number) => {
    const id = `toast-${toastId++}`;
    const newToast: ToastProps = {
      id,
      type,
      message,
      duration,
      onClose: (toastId) => {
        setToasts((prev) => prev.filter((t) => t.id !== toastId));
      },
    };

    setToasts((prev) => [...prev, newToast]);
  }, []);

  const success = useCallback(
    (message: string, duration?: number) => addToast('success', message, duration),
    [addToast]
  );

  const error = useCallback(
    (message: string, duration?: number) => addToast('error', message, duration),
    [addToast]
  );

  const info = useCallback(
    (message: string, duration?: number) => addToast('info', message, duration),
    [addToast]
  );

  const warning = useCallback(
    (message: string, duration?: number) => addToast('warning', message, duration),
    [addToast]
  );

  return {
    toasts,
    success,
    error,
    info,
    warning,
  };
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
// src/app/layout.tsx
'use client';

import { useToast } from '@/hooks/useToast';
import { ToastContainer } from '@/components/Toast';

export default function Layout({ children }: { children: React.ReactNode }) {
  const { toasts } = useToast();

  return (
    <html>
      <body>
        {children}
        <ToastContainer toasts={toasts} />
      </body>
    </html>
  );
}

// In any component
import { useToast } from '@/hooks/useToast';

function MyComponent() {
  const toast = useToast();

  const handleError = () => {
    toast.error('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯');
  };

  const handleSuccess = () => {
    toast.success('èªéŸ³ç”ŸæˆæˆåŠŸï¼');
  };

  return <button onClick={handleSuccess}>æ¸¬è©¦ Toast</button>;
}
```

**é©—è­‰æ–¹å¼**:
- [ ] Toast è¨Šæ¯æ­£ç¢ºé¡¯ç¤ºï¼ˆæˆåŠŸã€éŒ¯èª¤ã€è­¦å‘Šã€è³‡è¨Šï¼‰
- [ ] è‡ªå‹•åœ¨ 5 ç§’å¾Œæ¶ˆå¤±
- [ ] å¯æ‰‹å‹•é»æ“Š Ã— é—œé–‰
- [ ] æ”¯æ´ç„¡éšœç¤™ï¼ˆARIA live regionï¼‰
- [ ] å¤šå€‹ Toast å¯åŒæ™‚é¡¯ç¤ºï¼ˆå †ç–Šï¼‰

---

### Task 5: Avatar è¼‰å…¥ç‹€æ…‹èˆ‡éŒ¯èª¤è™•ç†

**æè¿°**: åœ¨ AvatarCanvas çµ„ä»¶ä¸­åŠ å…¥è¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶

**æª”æ¡ˆ**: `src/components/avatar/AvatarCanvas.tsx`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
'use client';

import React, { Suspense, useState } from 'react';
import { Canvas } from '@react-three/fiber';
import { OrbitControls, Environment } from '@react-three/drei';
import { ErrorBoundary } from '@/components/ErrorBoundary';
import { useRetry } from '@/hooks/useRetry';
import { ErrorCategory, createAppError } from '@/lib/errors';
import { useToast } from '@/hooks/useToast';
import { AvatarModel } from './AvatarModel';

export function AvatarCanvas() {
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const toast = useToast();

  const loadModel = async () => {
    // Simulate model loading (replace with actual loading logic)
    setIsLoading(true);
    setError(null);

    // In real implementation, this would load VRM model
    // For now, simulate with a timeout
    await new Promise((resolve) => setTimeout(resolve, 2000));

    // Simulate random failure for testing
    if (Math.random() < 0.3) {
      throw new Error('Model loading failed');
    }

    setIsLoading(false);
  };

  const { execute: retryLoad, isRetrying, retryCount } = useRetry(
    loadModel,
    ErrorCategory.MODEL_LOADING,
    {
      maxRetries: 1,
      onRetry: (attempt) => {
        toast.info(`Avatar æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦... (${attempt}/1)`);
      },
      onSuccess: () => {
        toast.success('Avatar æ¨¡å‹è¼‰å…¥æˆåŠŸï¼');
      },
      onFailure: (err) => {
        const appError = createAppError(err);
        setError(appError.userMessage);
        toast.error(appError.userMessage);
      },
    }
  );

  const handleManualRetry = () => {
    setError(null);
    retryLoad();
  };

  // Loading state
  if (isLoading || isRetrying) {
    return (
      <div
        style={{
          width: '100%',
          height: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: '#1a1a1a',
        }}
      >
        <div
          style={{
            width: '60px',
            height: '60px',
            border: '6px solid #333',
            borderTop: '6px solid #007bff',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
          }}
        />
        <style>{`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `}</style>
        <p style={{ marginTop: '20px', color: 'white', fontSize: '16px' }}>
          {isRetrying ? `è¼‰å…¥ä¸­... (é‡è©¦ ${retryCount})` : 'æ­£åœ¨è¼‰å…¥ Avatar æ¨¡å‹...'}
        </p>
        <div
          style={{
            marginTop: '10px',
            width: '200px',
            height: '4px',
            backgroundColor: '#333',
            borderRadius: '2px',
            overflow: 'hidden',
          }}
        >
          <div
            style={{
              width: '100%',
              height: '100%',
              backgroundColor: '#007bff',
              animation: 'progress 1.5s ease-in-out infinite',
            }}
          />
        </div>
        <style>{`
          @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
          }
        `}</style>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div
        style={{
          width: '100%',
          height: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: '#1a1a1a',
          padding: '20px',
        }}
      >
        <div
          style={{
            maxWidth: '500px',
            padding: '40px',
            backgroundColor: '#2a2a2a',
            borderRadius: '12px',
            textAlign: 'center',
          }}
        >
          <div style={{ fontSize: '48px', marginBottom: '20px' }}>ğŸ˜”</div>
          <h2 style={{ fontSize: '20px', marginBottom: '12px', color: 'white' }}>
            Avatar è¼‰å…¥å¤±æ•—
          </h2>
          <p style={{ fontSize: '14px', marginBottom: '24px', color: '#aaa' }}>
            {error}
          </p>
          <button
            onClick={handleManualRetry}
            style={{
              padding: '12px 24px',
              fontSize: '16px',
              backgroundColor: '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
            }}
          >
            ğŸ”„ é‡è©¦
          </button>
        </div>
      </div>
    );
  }

  // Success state - render Canvas
  return (
    <ErrorBoundary
      fallback={
        <div style={{ width: '100%', height: '100vh', backgroundColor: '#1a1a1a' }}>
          <p style={{ color: 'white', padding: '20px' }}>3D æ¸²æŸ“ç™¼ç”ŸéŒ¯èª¤</p>
        </div>
      }
    >
      <Canvas
        camera={{ position: [0, 1.5, 3], fov: 50 }}
        style={{ width: '100%', height: '100vh', backgroundColor: '#1a1a1a' }}
      >
        <Suspense fallback={null}>
          <AvatarModel onLoadComplete={() => setIsLoading(false)} />
          <OrbitControls
            target={[0, 1.2, 0]}
            enablePan={false}
            minDistance={2}
            maxDistance={5}
          />
          <Environment preset="studio" />
        </Suspense>
      </Canvas>
    </ErrorBoundary>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] æ¨¡å‹è¼‰å…¥æ™‚é¡¯ç¤º Spinner èˆ‡é€²åº¦æ¢
- [ ] æ¨¡å‹è¼‰å…¥å¤±æ•—è‡ªå‹•é‡è©¦ä¸€æ¬¡
- [ ] é‡è©¦å¤±æ•—å¾Œé¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯èˆ‡æ‰‹å‹•é‡è©¦æŒ‰éˆ•
- [ ] æ‰‹å‹•é‡è©¦æŒ‰éˆ•å¯æ­£å¸¸é‹ä½œ
- [ ] éŒ¯èª¤è¨Šæ¯æ¸…æ¥šæ˜“æ‡‚ï¼ˆéæŠ€è¡“æ€§éŒ¯èª¤ï¼‰

---

### Task 6: TTS API éŒ¯èª¤è™•ç†èˆ‡è¼‰å…¥ç‹€æ…‹

**æè¿°**: åœ¨ ChatInterface çµ„ä»¶ä¸­åŠ å…¥ TTS API éŒ¯èª¤è™•ç†ã€è¼‰å…¥ç‹€æ…‹èˆ‡é‡è©¦æ©Ÿåˆ¶

**æª”æ¡ˆ**: `src/components/chat/ChatInterface.tsx`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```typescript
'use client';

import React, { useState } from 'react';
import { useRetry } from '@/hooks/useRetry';
import { ErrorCategory, createAppError } from '@/lib/errors';
import { useToast } from '@/hooks/useToast';

export function ChatInterface() {
  const [input, setInput] = useState('');
  const [isSending, setIsSending] = useState(false);
  const toast = useToast();

  const sendMessage = async (text: string): Promise<void> => {
    setIsSending(true);

    try {
      // Call TTS API
      const response = await fetch('/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });

      if (!response.ok) {
        throw new Error(`TTS API failed: ${response.status}`);
      }

      const data = await response.json();
      console.log('TTS audio URL:', data.audioUrl);

      // Success - play audio
      toast.success('èªéŸ³ç”ŸæˆæˆåŠŸï¼');
    } catch (error) {
      // Convert to AppError
      const appError = createAppError(error);
      throw appError; // Propagate for retry logic
    } finally {
      setIsSending(false);
    }
  };

  const { execute: retrySend, isRetrying, retryCount } = useRetry(
    () => sendMessage(input),
    ErrorCategory.API,
    {
      maxRetries: 1,
      onRetry: (attempt) => {
        toast.info(`èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œæ­£åœ¨é‡è©¦... (${attempt}/1)`);
      },
      onSuccess: () => {
        setInput(''); // Clear input on success
      },
      onFailure: (error) => {
        const appError = createAppError(error);
        toast.error(appError.userMessage);
      },
    }
  );

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim()) return;

    retrySend();
  };

  const isProcessing = isSending || isRetrying;

  return (
    <div
      style={{
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        width: '90%',
        maxWidth: '600px',
        backgroundColor: 'white',
        borderRadius: '12px',
        boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
        padding: '20px',
      }}
    >
      <form onSubmit={handleSubmit}>
        <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="è¼¸å…¥è¨Šæ¯..."
            disabled={isProcessing}
            style={{
              flex: 1,
              padding: '12px 16px',
              fontSize: '16px',
              border: '1px solid #ddd',
              borderRadius: '8px',
              outline: 'none',
            }}
          />
          <button
            type="submit"
            disabled={isProcessing || !input.trim()}
            style={{
              padding: '12px 24px',
              fontSize: '16px',
              backgroundColor: isProcessing ? '#6c757d' : '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: isProcessing ? 'not-allowed' : 'pointer',
              minWidth: '120px',
            }}
          >
            {isProcessing ? (
              <span>
                {isRetrying ? `é‡è©¦ä¸­ (${retryCount})` : 'ç”Ÿæˆä¸­...'}
              </span>
            ) : (
              'é€å‡º'
            )}
          </button>
        </div>

        {isProcessing && (
          <div style={{ marginTop: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
            <div
              style={{
                width: '16px',
                height: '16px',
                border: '2px solid #ddd',
                borderTop: '2px solid #007bff',
                borderRadius: '50%',
                animation: 'spin 1s linear infinite',
              }}
            />
            <span style={{ fontSize: '14px', color: '#6c757d' }}>
              {isRetrying
                ? `æ­£åœ¨é‡è©¦èªéŸ³ç”Ÿæˆ... (${retryCount}/1)`
                : 'æ­£åœ¨ç”ŸæˆèªéŸ³...'}
            </span>
          </div>
        )}
      </form>
    </div>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] é€å‡ºè¨Šæ¯æ™‚é¡¯ç¤ºã€Œç”Ÿæˆä¸­...ã€ç‹€æ…‹
- [ ] TTS API å¤±æ•—è‡ªå‹•é‡è©¦ä¸€æ¬¡
- [ ] é‡è©¦æ™‚é¡¯ç¤ºã€Œé‡è©¦ä¸­ (1/1)ã€
- [ ] é‡è©¦æˆåŠŸå¾Œæ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é¡¯ç¤ºæˆåŠŸ Toast
- [ ] é‡è©¦å¤±æ•—å¾Œé¡¯ç¤ºå‹å–„éŒ¯èª¤ Toast
- [ ] è™•ç†ä¸­æ™‚ç¦ç”¨è¼¸å…¥æ¡†èˆ‡é€å‡ºæŒ‰éˆ•

---

### Task 7: ç¶²è·¯éŒ¯èª¤è™•ç†

**æè¿°**: åŠ å…¥å…¨åŸŸç¶²è·¯ç‹€æ…‹ç›£è½ï¼Œç•¶ç¶²è·¯æ–·ç·šæ™‚é¡¯ç¤ºæç¤º

**æª”æ¡ˆ**: `src/hooks/useNetworkStatus.ts`, `src/components/NetworkStatus.tsx`

**ç¨‹å¼ç¢¼å¯¦ä½œ (useNetworkStatus Hook)**:
```typescript
'use client';

import { useState, useEffect } from 'react';

export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {
    // Initial status
    setIsOnline(navigator.onLine);

    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return { isOnline };
}
```

**ç¨‹å¼ç¢¼å¯¦ä½œ (NetworkStatus Component)**:
```typescript
'use client';

import React, { useEffect } from 'react';
import { useNetworkStatus } from '@/hooks/useNetworkStatus';
import { useToast } from '@/hooks/useToast';

export function NetworkStatus() {
  const { isOnline } = useNetworkStatus();
  const toast = useToast();

  useEffect(() => {
    if (!isOnline) {
      toast.error('ç¶²è·¯é€£ç·šå·²ä¸­æ–·ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š', 0); // 0 = no auto-close
    }
  }, [isOnline, toast]);

  if (isOnline) return null;

  return (
    <div
      role="alert"
      style={{
        position: 'fixed',
        top: '0',
        left: '0',
        right: '0',
        zIndex: 10000,
        backgroundColor: '#dc3545',
        color: 'white',
        padding: '12px 20px',
        textAlign: 'center',
        fontSize: '14px',
        fontWeight: 'bold',
      }}
    >
      âš ï¸ ç¶²è·¯é€£ç·šå·²ä¸­æ–·ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š
    </div>
  );
}
```

**æ•´åˆåˆ° Layout**:
```typescript
// src/app/layout.tsx
import { NetworkStatus } from '@/components/NetworkStatus';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <body>
        <ErrorBoundary>
          <NetworkStatus />
          {children}
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

**é©—è­‰æ–¹å¼**:
- [ ] ç¶²è·¯æ–·ç·šæ™‚ç«‹å³é¡¯ç¤ºé ‚éƒ¨æ©«å¹…è­¦å‘Š
- [ ] ç¶²è·¯æ¢å¾©æ™‚è‡ªå‹•ç§»é™¤è­¦å‘Š
- [ ] æ”¯æ´ Chrome DevTools çš„ "Go offline" æ¸¬è©¦
- [ ] è­¦å‘Šæ©«å¹…åœ¨æ‰€æœ‰é é¢éƒ½å¯è¦‹ï¼ˆFixed positioningï¼‰

---

### Task 8: éŒ¯èª¤å ´æ™¯æ•´åˆæ¸¬è©¦

**æè¿°**: æ’°å¯«æ¸¬è©¦æŒ‡å—ï¼Œæ¶µè“‹æ‰€æœ‰éŒ¯èª¤å ´æ™¯çš„æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ

**æª”æ¡ˆ**: `docs/testing/error-handling-test-plan.md`

**ç¨‹å¼ç¢¼å¯¦ä½œ**:
```markdown
# Error Handling & UX Test Plan

## æ¸¬è©¦ç›®æ¨™
é©—è­‰æ‰€æœ‰éŒ¯èª¤å ´æ™¯éƒ½èƒ½è¢«æ­£ç¢ºè™•ç†ï¼Œä½¿ç”¨è€…é«”é©—æµæš¢ç„¡å´©æ½°

---

## Test Suite 1: å…¨åŸŸ Error Boundary

### Test Case 1.1: æ•æ‰æ¸²æŸ“éŒ¯èª¤
**æ­¥é©Ÿ**:
1. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· Console
2. æ‰‹å‹•åœ¨ä»»æ„çµ„ä»¶æ‹‹å‡ºéŒ¯èª¤ï¼ˆä¾‹å¦‚åœ¨ useEffect åŠ å…¥ `throw new Error('Test error')`ï¼‰
3. è§€å¯Ÿæ‡‰ç”¨ç¨‹å¼æ˜¯å¦é¡¯ç¤º ErrorBoundary fallback UI

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºå‹å–„éŒ¯èª¤ç•«é¢ï¼ˆéç™½å±ï¼‰
- âœ… éŒ¯èª¤è¨Šæ¯: "ç™¼ç”Ÿäº†ä¸€äº›å•é¡Œï¼Œè«‹å˜—è©¦é‡æ–°è¼‰å…¥é é¢"
- âœ… é¡¯ç¤ºã€Œé‡æ–°è¼‰å…¥é é¢ã€æŒ‰éˆ•
- âœ… é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºéŒ¯èª¤è©³æƒ…ï¼Œç”Ÿç”¢ç’°å¢ƒéš±è—

### Test Case 1.2: é‡æ–°è¼‰å…¥æŒ‰éˆ•
**æ­¥é©Ÿ**:
1. è§¸ç™¼ ErrorBoundaryï¼ˆåŒä¸Šï¼‰
2. é»æ“Šã€Œé‡æ–°è¼‰å…¥é é¢ã€æŒ‰éˆ•
3. è§€å¯Ÿæ‡‰ç”¨ç¨‹å¼æ˜¯å¦æ¢å¾©æ­£å¸¸

**é æœŸçµæœ**:
- âœ… é é¢é‡æ–°è¼‰å…¥
- âœ… æ‡‰ç”¨ç¨‹å¼æ¢å¾©æ­£å¸¸é‹ä½œ

---

## Test Suite 2: å‹å–„éŒ¯èª¤è¨Šæ¯

### Test Case 2.1: Azure TTS API éŒ¯èª¤
**æ­¥é©Ÿ**:
1. æš«æ™‚ä¿®æ”¹ Azure API Key ç‚ºç„¡æ•ˆå€¼ï¼ˆæˆ–è¨»è§£ API Keyï¼‰
2. åœ¨èŠå¤©ä»‹é¢è¼¸å…¥è¨Šæ¯ä¸¦é€å‡º
3. è§€å¯ŸéŒ¯èª¤è¨Šæ¯

**é æœŸçµæœ**:
- âœ… é¡¯ç¤º Toast: "æŠ±æ­‰,èªéŸ³ç”Ÿæˆæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨,è«‹ç¨å¾Œå†è©¦"
- âœ… ä¸é¡¯ç¤ºæŠ€è¡“æ€§éŒ¯èª¤ï¼ˆå¦‚ "401 Unauthorized"ï¼‰
- âœ… è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆ2 ç§’å¾Œï¼‰
- âœ… é‡è©¦å¤±æ•—å¾Œé¡¯ç¤ºæ‰‹å‹•é‡è©¦é¸é …

### Test Case 2.2: ç¶²è·¯éŒ¯èª¤
**æ­¥é©Ÿ**:
1. é–‹å•Ÿ Chrome DevTools â†’ Network tab
2. é¸æ“‡ "Offline" æ¨¡å¼
3. åœ¨èŠå¤©ä»‹é¢è¼¸å…¥è¨Šæ¯ä¸¦é€å‡º
4. è§€å¯ŸéŒ¯èª¤è¨Šæ¯

**é æœŸçµæœ**:
- âœ… é ‚éƒ¨é¡¯ç¤ºç´…è‰²æ©«å¹…: "âš ï¸ ç¶²è·¯é€£ç·šå·²ä¸­æ–·"
- âœ… Toast é¡¯ç¤º: "ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œ,è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š"
- âœ… è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆ3 ç§’å¾Œï¼‰
- âœ… ç¶²è·¯æ¢å¾©å¾Œæ©«å¹…è‡ªå‹•æ¶ˆå¤±

### Test Case 2.3: 3D æ¨¡å‹è¼‰å…¥å¤±æ•—
**æ­¥é©Ÿ**:
1. æš«æ™‚ä¿®æ”¹ Avatar æ¨¡å‹è·¯å¾‘ç‚ºéŒ¯èª¤è·¯å¾‘
2. é‡æ–°è¼‰å…¥é é¢
3. è§€å¯ŸéŒ¯èª¤è¨Šæ¯

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºéŒ¯èª¤ç•«é¢: "Avatar è¼‰å…¥å¤±æ•—"
- âœ… å‹å–„è¨Šæ¯: "Avatar æ¨¡å‹è¼‰å…¥å¤±æ•—,æ­£åœ¨é‡è©¦..."
- âœ… è‡ªå‹•é‡è©¦ä¸€æ¬¡ï¼ˆ1 ç§’å¾Œï¼‰
- âœ… é‡è©¦å¤±æ•—å¾Œé¡¯ç¤ºæ‰‹å‹•é‡è©¦æŒ‰éˆ•

---

## Test Suite 3: é‡è©¦æ©Ÿåˆ¶

### Test Case 3.1: è‡ªå‹•é‡è©¦ (TTS API)
**æ­¥é©Ÿ**:
1. ä½¿ç”¨ Mock API æ¨¡æ“¬ç¬¬ä¸€æ¬¡å¤±æ•—,ç¬¬äºŒæ¬¡æˆåŠŸ
2. é€å‡ºèŠå¤©è¨Šæ¯
3. è§€å¯Ÿé‡è©¦è¡Œç‚º

**é æœŸçµæœ**:
- âœ… ç¬¬ä¸€æ¬¡å¤±æ•—å¾Œé¡¯ç¤º Toast: "èªéŸ³ç”Ÿæˆå¤±æ•—,æ­£åœ¨é‡è©¦... (1/1)"
- âœ… å»¶é² 2 ç§’å¾Œè‡ªå‹•é‡è©¦
- âœ… ç¬¬äºŒæ¬¡æˆåŠŸå¾Œé¡¯ç¤º Toast: "èªéŸ³ç”ŸæˆæˆåŠŸï¼"
- âœ… è¼¸å…¥æ¡†æ¸…ç©º

### Test Case 3.2: é‡è©¦å¤±æ•—
**æ­¥é©Ÿ**:
1. ä½¿ç”¨ Mock API æ¨¡æ“¬å…©æ¬¡éƒ½å¤±æ•—
2. é€å‡ºèŠå¤©è¨Šæ¯
3. è§€å¯Ÿé‡è©¦è¡Œç‚º

**é æœŸçµæœ**:
- âœ… ç¬¬ä¸€æ¬¡å¤±æ•—å¾Œè‡ªå‹•é‡è©¦
- âœ… ç¬¬äºŒæ¬¡å¤±æ•—å¾Œé¡¯ç¤ºæœ€çµ‚éŒ¯èª¤è¨Šæ¯
- âœ… ä¸å†è‡ªå‹•é‡è©¦
- âœ… è¼¸å…¥æ¡†ä¿ç•™åŸå§‹å…§å®¹ï¼ˆå¯å†æ¬¡é€å‡ºï¼‰

### Test Case 3.3: æ‰‹å‹•é‡è©¦ (Avatar è¼‰å…¥)
**æ­¥é©Ÿ**:
1. æ¨¡æ“¬ Avatar è¼‰å…¥å¤±æ•—ï¼ˆå…©æ¬¡éƒ½å¤±æ•—ï¼‰
2. è§€å¯ŸéŒ¯èª¤ç•«é¢
3. é»æ“Šã€Œé‡è©¦ã€æŒ‰éˆ•

**é æœŸçµæœ**:
- âœ… é¡¯ç¤ºæ‰‹å‹•é‡è©¦æŒ‰éˆ•
- âœ… é»æ“Šå¾Œé‡æ–°å˜—è©¦è¼‰å…¥
- âœ… é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼ˆSpinnerï¼‰

---

## Test Suite 4: Loading States

### Test Case 4.1: Avatar è¼‰å…¥ç‹€æ…‹
**æ­¥é©Ÿ**:
1. é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼
2. è§€å¯Ÿ Avatar è¼‰å…¥éç¨‹

**é æœŸçµæœ**:
- âœ… é¡¯ç¤º Spinner å‹•ç•«
- âœ… é¡¯ç¤ºæ–‡å­—: "æ­£åœ¨è¼‰å…¥ Avatar æ¨¡å‹..."
- âœ… é¡¯ç¤ºé€²åº¦æ¢å‹•ç•«
- âœ… è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æ¶ˆå¤±

### Test Case 4.2: TTS ç”Ÿæˆç‹€æ…‹
**æ­¥é©Ÿ**:
1. åœ¨èŠå¤©ä»‹é¢è¼¸å…¥è¨Šæ¯ä¸¦é€å‡º
2. è§€å¯Ÿè¼‰å…¥ç‹€æ…‹

**é æœŸçµæœ**:
- âœ… é€å‡ºæŒ‰éˆ•æ–‡å­—è®Šæ›´ç‚º "ç”Ÿæˆä¸­..."
- âœ… è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•è¢«ç¦ç”¨
- âœ… é¡¯ç¤ºå°å‹ Spinner èˆ‡æ–‡å­—: "æ­£åœ¨ç”ŸæˆèªéŸ³..."
- âœ… å®Œæˆå¾Œæ¢å¾©æ­£å¸¸ç‹€æ…‹

### Test Case 4.3: é‡è©¦è¼‰å…¥ç‹€æ…‹
**æ­¥é©Ÿ**:
1. æ¨¡æ“¬ TTS API ç¬¬ä¸€æ¬¡å¤±æ•—
2. è§€å¯Ÿé‡è©¦æ™‚çš„è¼‰å…¥ç‹€æ…‹

**é æœŸçµæœ**:
- âœ… é¡¯ç¤º: "é‡è©¦ä¸­ (1/1)"
- âœ… Spinner æŒçºŒé¡¯ç¤º
- âœ… æŒ‰éˆ•ä¿æŒç¦ç”¨

---

## Test Suite 5: Toast é€šçŸ¥ç³»çµ±

### Test Case 5.1: Toast é¡¯ç¤ºèˆ‡è‡ªå‹•æ¶ˆå¤±
**æ­¥é©Ÿ**:
1. è§¸ç™¼æˆåŠŸæ“ä½œï¼ˆä¾‹å¦‚ TTS ç”ŸæˆæˆåŠŸï¼‰
2. è§€å¯Ÿ Toast è¡Œç‚º

**é æœŸçµæœ**:
- âœ… Toast å¾å³å´æ»‘å…¥
- âœ… é¡¯ç¤ºæˆåŠŸåœ–ç¤º (âœ…) èˆ‡è¨Šæ¯
- âœ… 5 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±

### Test Case 5.2: æ‰‹å‹•é—œé–‰ Toast
**æ­¥é©Ÿ**:
1. è§¸ç™¼ Toast
2. é»æ“Š Ã— é—œé–‰æŒ‰éˆ•

**é æœŸçµæœ**:
- âœ… Toast ç«‹å³æ¶ˆå¤±

### Test Case 5.3: å¤šå€‹ Toast å †ç–Š
**æ­¥é©Ÿ**:
1. å¿«é€Ÿè§¸ç™¼å¤šå€‹æ“ä½œï¼ˆæˆåŠŸ/éŒ¯èª¤æ··åˆï¼‰
2. è§€å¯Ÿ Toast å †ç–Šè¡Œç‚º

**é æœŸçµæœ**:
- âœ… å¤šå€‹ Toast å‚ç›´å †ç–Š
- âœ… æœ€æ–°çš„ Toast åœ¨æœ€ä¸Šæ–¹
- âœ… å„è‡ªç¨ç«‹å€’æ•¸æ¶ˆå¤±

---

## Test Suite 6: ç„¡éšœç¤™æ¸¬è©¦

### Test Case 6.1: Screen Reader æ”¯æ´
**æ­¥é©Ÿ**:
1. å•Ÿç”¨ screen readerï¼ˆWindows: Narrator, Mac: VoiceOverï¼‰
2. è§¸ç™¼éŒ¯èª¤è¨Šæ¯
3. ç¢ºèª screen reader æ˜¯å¦è®€å‡ºè¨Šæ¯

**é æœŸçµæœ**:
- âœ… Toast ä½¿ç”¨ `role="alert"` èˆ‡ `aria-live="assertive"`
- âœ… Screen reader è‡ªå‹•è®€å‡ºéŒ¯èª¤è¨Šæ¯
- âœ… é—œé–‰æŒ‰éˆ•æœ‰ `aria-label="é—œé–‰é€šçŸ¥"`

### Test Case 6.2: éµç›¤å°èˆª
**æ­¥é©Ÿ**:
1. ä½¿ç”¨ Tab éµå°èˆª
2. ç¢ºèªæ‰€æœ‰æŒ‰éˆ•ï¼ˆé‡è©¦ã€é—œé–‰ï¼‰å¯é€šééµç›¤å­˜å–

**é æœŸçµæœ**:
- âœ… æ‰€æœ‰äº’å‹•å…ƒç´ å¯ç”¨ Tab éµèšç„¦
- âœ… Enter/Space éµå¯è§¸ç™¼æŒ‰éˆ•
- âœ… èšç„¦æ™‚æœ‰æ˜é¡¯çš„è¦–è¦ºæç¤º

---

## æ¸¬è©¦ç’°å¢ƒéœ€æ±‚

### ç€è¦½å™¨
- Chrome (æœ€æ–°ç‰ˆæœ¬)
- Edge (æœ€æ–°ç‰ˆæœ¬)
- Safari (æœ€æ–°ç‰ˆæœ¬)
- Firefox (æœ€æ–°ç‰ˆæœ¬)

### æ¸¬è©¦è¨­å‚™
- Desktop (1920Ã—1080)
- Tablet (768Ã—1024)
- Mobile (375Ã—667)

### ç¶²è·¯æ¨¡æ“¬
- Fast 3G
- Slow 3G
- Offline

---

## é©—æ”¶æ¨™æº–

æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹é€šéç‡: **100%**
- ç„¡ç™½å±å´©æ½°
- æ‰€æœ‰éŒ¯èª¤è¨Šæ¯å‹å–„æ˜“æ‡‚
- é‡è©¦æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- Loading states æ­£ç¢ºé¡¯ç¤º
- Toast é€šçŸ¥ç³»çµ±ç©©å®š
- ç„¡éšœç¤™æ”¯æ´å®Œæ•´
```

**é©—è­‰æ–¹å¼**:
- [ ] æ‰€æœ‰ Test Suite åŸ·è¡Œå®Œç•¢
- [ ] æ‰€æœ‰ Test Case é€šéç‡ 100%
- [ ] è¨˜éŒ„æ¸¬è©¦çµæœèˆ‡æˆªåœ–
- [ ] ç¢ºèªæ‰€æœ‰ç€è¦½å™¨ç›¸å®¹æ€§

---

## ğŸ“Š Dev Notes

### Error Handling Strategy

**ä¸‰å±¤éŒ¯èª¤è™•ç†æ¶æ§‹**:

1. **Local Try-Catch** (ç¬¬ä¸€å±¤):
   - åœ¨å·²çŸ¥å¯èƒ½å¤±æ•—çš„æ“ä½œåŠ ä¸Š try-catch
   - ä¾‹å¦‚: API calls, 3D model loading, audio playback
   - å„ªé»: å¯ç²¾ç¢ºè™•ç†ç‰¹å®šéŒ¯èª¤,æä¾›å®¢è£½åŒ–éŒ¯èª¤è¨Šæ¯

2. **Error Boundary** (ç¬¬äºŒå±¤):
   - æ•æ‰æ‰€æœ‰æœªè™•ç†çš„ React æ¸²æŸ“éŒ¯èª¤
   - é˜²æ­¢æ‡‰ç”¨ç¨‹å¼ç™½å±å´©æ½°
   - å„ªé»: å…¨åŸŸä¿è­·,ç¢ºä¿ä½¿ç”¨è€…æ°¸é çœ‹åˆ°å‹å–„ä»‹é¢

3. **Global Error Handler** (ç¬¬ä¸‰å±¤):
   - æ•æ‰ window.onerror, unhandledrejection äº‹ä»¶
   - è¨˜éŒ„åˆ° error tracking service (optional)
   - å„ªé»: æ•æ‰æ‰€æœ‰éºæ¼çš„éŒ¯èª¤,åŒ…æ‹¬é React éŒ¯èª¤

### Retry Strategy

**æŒ‡æ•¸é€€é¿ (Exponential Backoff) vs å›ºå®šå»¶é²**:

æœ¬å°ˆæ¡ˆæ¡ç”¨ **å›ºå®šå»¶é²** ç­–ç•¥:
- Network errors: 3 ç§’å»¶é²
- API errors: 2 ç§’å»¶é²
- Model loading: 1 ç§’å»¶é²

**åŸå› **:
- POC éšæ®µé‡è©¦æ¬¡æ•¸å°‘ (maxRetries = 1),æŒ‡æ•¸é€€é¿å¢ç›Šä¸å¤§
- å›ºå®šå»¶é²å¯¦ä½œç°¡å–®,ç¨‹å¼ç¢¼æ˜“ç¶­è­·
- MVP éšæ®µå¯å‡ç´šç‚ºæŒ‡æ•¸é€€é¿ï¼ˆ2s â†’ 4s â†’ 8sï¼‰

**ä½•æ™‚ä¸é‡è©¦**:
- 401/403 é©—è­‰éŒ¯èª¤ (ä¸æœƒå› ç‚ºé‡è©¦è€ŒæˆåŠŸ)
- 400 åƒæ•¸éŒ¯èª¤ (åƒæ•¸éŒ¯èª¤é‡è©¦ç„¡æ„ç¾©)
- ä½¿ç”¨è€…ä¸»å‹•å–æ¶ˆæ“ä½œ

### Toast vs Modal vs Inline Error

**Toast (æœ¬å°ˆæ¡ˆæ¡ç”¨)**:
- å„ªé»: éä¾µå…¥å¼,ä¸ä¸­æ–·ä½¿ç”¨è€…æµç¨‹,è‡ªå‹•æ¶ˆå¤±
- é©åˆ: æš«æ™‚æ€§é€šçŸ¥,æˆåŠŸ/éŒ¯èª¤è¨Šæ¯,ä¸éœ€è¦ä½¿ç”¨è€…ç«‹å³å›æ‡‰
- ç¼ºé»: ä½¿ç”¨è€…å¯èƒ½éŒ¯éè¨Šæ¯

**Modal**:
- å„ªé»: å¼·åˆ¶ä½¿ç”¨è€…æ³¨æ„,ç¢ºä¿è¨Šæ¯è¢«çœ‹åˆ°
- é©åˆ: åš´é‡éŒ¯èª¤,éœ€è¦ä½¿ç”¨è€…ç¢ºèªçš„æ“ä½œ
- ç¼ºé»: ä¾µå…¥æ€§å¼·,ä¸­æ–·ä½¿ç”¨è€…æµç¨‹

**Inline Error**:
- å„ªé»: ç›´æ¥é¡¯ç¤ºåœ¨éŒ¯èª¤ä¾†æºæ—,æƒ…å¢ƒæ˜ç¢º
- é©åˆ: è¡¨å–®é©—è­‰éŒ¯èª¤
- ç¼ºé»: éœ€è¦ç‚ºæ¯å€‹å…ƒä»¶è¨­è¨ˆéŒ¯èª¤é¡¯ç¤ºä½ç½®

### Error Monitoring (MVP éšæ®µ)

**å»ºè­°æ•´åˆ Error Tracking Service**:
- **Sentry**: æœ€å—æ­¡è¿,åŠŸèƒ½å¼·å¤§,å…è²»æ–¹æ¡ˆè¶³å¤ 
- **LogRocket**: å¯éŒ„è£½ä½¿ç”¨è€…æ“ä½œå½±ç‰‡,é‡ç¾éŒ¯èª¤æƒ…å¢ƒ
- **Rollbar**: è¼•é‡ç´š,å°ˆæ³¨æ–¼éŒ¯èª¤è¿½è¹¤

**æ•´åˆæ–¹å¼** (ä»¥ Sentry ç‚ºä¾‹):
```bash
npm install @sentry/nextjs
```

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
});
```

```typescript
// ErrorBoundary.tsx - åŠ å…¥ Sentry logging
componentDidCatch(error: Error, errorInfo: React.ErrorInfo): void {
  console.error('ErrorBoundary caught an error:', error, errorInfo);

  // Send to Sentry
  Sentry.captureException(error, {
    contexts: {
      react: {
        componentStack: errorInfo.componentStack,
      },
    },
  });
}
```

### UX Best Practices

1. **éŒ¯èª¤è¨Šæ¯æ’°å¯«åŸå‰‡**:
   - âŒ "Error 500: Internal Server Error"
   - âœ… "æŠ±æ­‰,èªéŸ³ç”Ÿæˆæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨,è«‹ç¨å¾Œå†è©¦"

   **åŸå‰‡**:
   - é¿å…æŠ€è¡“è¡“èªï¼ˆ500, API, timeoutï¼‰
   - èªªæ˜ç™¼ç”Ÿäº†ä»€éº¼ï¼ˆèªéŸ³ç”Ÿæˆå¤±æ•—ï¼‰
   - æä¾›è§£æ±ºæ–¹æ¡ˆï¼ˆè«‹ç¨å¾Œå†è©¦ï¼‰
   - èªæ°£å‹å–„ã€åŒç†å¿ƒï¼ˆæŠ±æ­‰ï¼‰

2. **Loading States è¨­è¨ˆåŸå‰‡**:
   - **ç«‹å³å›é¥‹**: é»æ“Šå¾Œ 100ms å…§é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
   - **é€²åº¦æç¤º**: é•·æ™‚é–“æ“ä½œï¼ˆ>3 ç§’ï¼‰é¡¯ç¤ºé€²åº¦æ¢æˆ–ç™¾åˆ†æ¯”
   - **å–æ¶ˆé¸é …**: é•·æ™‚é–“æ“ä½œæä¾›å–æ¶ˆæŒ‰éˆ•
   - **éª¨æ¶å±**: Avatar è¼‰å…¥æ™‚é¡¯ç¤ºéª¨æ¶å±,è€Œéç©ºç™½

3. **é‡è©¦ UX**:
   - **è‡ªå‹•é‡è©¦**: æš«æ™‚æ€§éŒ¯èª¤ï¼ˆç¶²è·¯æ³¢å‹•ï¼‰è‡ªå‹•é‡è©¦,ä¸æ‰“æ“¾ä½¿ç”¨è€…
   - **æ‰‹å‹•é‡è©¦**: æŒçºŒæ€§éŒ¯èª¤é¡¯ç¤ºé‡è©¦æŒ‰éˆ•,ç”±ä½¿ç”¨è€…æ±ºå®š
   - **é‡è©¦æ¬¡æ•¸é€æ˜**: é¡¯ç¤ºã€Œé‡è©¦ (1/1)ã€,è®“ä½¿ç”¨è€…çŸ¥é“é€²åº¦

---

## ğŸ§ª Testing Strategy

### Unit Testing

**æ¸¬è©¦ç›®æ¨™**: Error classification, retry logic, toast system

**æ¸¬è©¦æ¡†æ¶**: Jest + React Testing Library

**æ¸¬è©¦æ¡ˆä¾‹**:

```typescript
// __tests__/lib/errors.test.ts
import { classifyError, isRetryableError, createAppError, ErrorCategory } from '@/lib/errors';

describe('Error Classification', () => {
  it('should classify network errors correctly', () => {
    const error = new Error('Network request failed');
    expect(classifyError(error)).toBe(ErrorCategory.NETWORK);
  });

  it('should classify API errors correctly', () => {
    const error = new Error('Azure TTS API returned 500');
    expect(classifyError(error)).toBe(ErrorCategory.API);
  });

  it('should classify model loading errors correctly', () => {
    const error = new Error('Failed to load GLTF model');
    expect(classifyError(error)).toBe(ErrorCategory.MODEL_LOADING);
  });

  it('should return UNKNOWN for unrecognized errors', () => {
    const error = new Error('Random error');
    expect(classifyError(error)).toBe(ErrorCategory.UNKNOWN);
  });
});

describe('Retryable Errors', () => {
  it('should mark NETWORK errors as retryable', () => {
    expect(isRetryableError(ErrorCategory.NETWORK)).toBe(true);
  });

  it('should mark API errors as retryable', () => {
    expect(isRetryableError(ErrorCategory.API)).toBe(true);
  });

  it('should mark UNKNOWN errors as non-retryable', () => {
    expect(isRetryableError(ErrorCategory.UNKNOWN)).toBe(false);
  });
});

describe('AppError Creation', () => {
  it('should create AppError with friendly message', () => {
    const error = new Error('Network timeout');
    const appError = createAppError(error);

    expect(appError.category).toBe(ErrorCategory.NETWORK);
    expect(appError.userMessage).toBe('ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š');
    expect(appError.retryable).toBe(true);
  });
});
```

```typescript
// __tests__/hooks/useRetry.test.tsx
import { renderHook, act, waitFor } from '@testing-library/react';
import { useRetry } from '@/hooks/useRetry';
import { ErrorCategory } from '@/lib/errors';

describe('useRetry Hook', () => {
  it('should execute function successfully on first attempt', async () => {
    const mockFn = jest.fn().mockResolvedValue('success');
    const { result } = renderHook(() => useRetry(mockFn, ErrorCategory.API));

    let response: string | null = null;
    await act(async () => {
      response = await result.current.execute();
    });

    expect(response).toBe('success');
    expect(mockFn).toHaveBeenCalledTimes(1);
    expect(result.current.retryCount).toBe(0);
  });

  it('should retry once on failure then succeed', async () => {
    const mockFn = jest
      .fn()
      .mockRejectedValueOnce(new Error('First fail'))
      .mockResolvedValueOnce('success');

    const onRetry = jest.fn();
    const { result } = renderHook(() =>
      useRetry(mockFn, ErrorCategory.API, { maxRetries: 1, onRetry })
    );

    await act(async () => {
      await result.current.execute();
    });

    await waitFor(() => {
      expect(mockFn).toHaveBeenCalledTimes(2);
      expect(onRetry).toHaveBeenCalledWith(1);
      expect(result.current.retryCount).toBe(1);
    });
  });

  it('should call onFailure after max retries', async () => {
    const mockFn = jest.fn().mockRejectedValue(new Error('Fail'));
    const onFailure = jest.fn();

    const { result } = renderHook(() =>
      useRetry(mockFn, ErrorCategory.API, { maxRetries: 1, onFailure })
    );

    await act(async () => {
      try {
        await result.current.execute();
      } catch (error) {
        // Expected
      }
    });

    await waitFor(() => {
      expect(mockFn).toHaveBeenCalledTimes(2);
      expect(onFailure).toHaveBeenCalledTimes(1);
    });
  });
});
```

### Integration Testing

**æ¸¬è©¦ç›®æ¨™**: Error Boundary, Toast system, network status

**æ¸¬è©¦æ¡ˆä¾‹**:

```typescript
// __tests__/components/ErrorBoundary.test.tsx
import { render, screen } from '@testing-library/react';
import { ErrorBoundary } from '@/components/ErrorBoundary';

const ThrowError = () => {
  throw new Error('Test error');
};

describe('ErrorBoundary', () => {
  it('should catch errors and show fallback UI', () => {
    const { container } = render(
      <ErrorBoundary>
        <ThrowError />
      </ErrorBoundary>
    );

    expect(screen.getByText('ğŸ˜” ç™¼ç”Ÿäº†ä¸€äº›å•é¡Œ')).toBeInTheDocument();
    expect(screen.getByText(/æŠ±æ­‰,æ‡‰ç”¨ç¨‹å¼é‡åˆ°äº†æ„å¤–éŒ¯èª¤/)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /é‡æ–°è¼‰å…¥é é¢/ })).toBeInTheDocument();
  });

  it('should show error details in development mode', () => {
    const originalEnv = process.env.NODE_ENV;
    process.env.NODE_ENV = 'development';

    render(
      <ErrorBoundary>
        <ThrowError />
      </ErrorBoundary>
    );

    expect(screen.getByText(/éŒ¯èª¤è©³æƒ…/)).toBeInTheDocument();

    process.env.NODE_ENV = originalEnv;
  });
});
```

### Manual Testing

**æ¸¬è©¦æ¸…å–®**: åƒè€ƒ Task 8 çš„å®Œæ•´æ¸¬è©¦è¨ˆç•«

**æ¸¬è©¦é‡é»**:
- [ ] æ‰€æœ‰éŒ¯èª¤å ´æ™¯éƒ½æœ‰å‹å–„è¨Šæ¯
- [ ] é‡è©¦æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- [ ] Loading states æ­£ç¢ºé¡¯ç¤º
- [ ] Toast é€šçŸ¥ç³»çµ±ç©©å®š
- [ ] ç¶²è·¯ç‹€æ…‹ç›£è½æ­£å¸¸
- [ ] ç„¡éšœç¤™æ”¯æ´å®Œæ•´

---

## ğŸ“ˆ Success Metrics

### é‡åŒ–æŒ‡æ¨™

1. **éŒ¯èª¤æ•æ‰ç‡**: 100% (ç„¡ç™½å±å´©æ½°)
2. **é‡è©¦æˆåŠŸç‡**: â‰¥ 40% (æš«æ™‚æ€§éŒ¯èª¤é‡è©¦æˆåŠŸ)
3. **éŒ¯èª¤å›æ‡‰æ™‚é–“**: â‰¤ 500ms (é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯)
4. **ä½¿ç”¨è€…æµå¤±ç‡**: é™ä½ 20% (ç›¸æ¯”ç„¡éŒ¯èª¤è™•ç†ç‰ˆæœ¬)

### è³ªåŒ–æŒ‡æ¨™

1. **ä½¿ç”¨è€…å›é¥‹**: "éŒ¯èª¤è¨Šæ¯æ¸…æ¥šæ˜“æ‡‚"
2. **é–‹ç™¼è€…é«”é©—**: "å®¹æ˜“åŠ å…¥æ–°éŒ¯èª¤é¡å‹èˆ‡è™•ç†é‚è¼¯"
3. **å¯ç¶­è­·æ€§**: "éŒ¯èª¤è™•ç†é‚è¼¯é›†ä¸­ç®¡ç†,æ˜“æ–¼æ“´å±•"

---

## ğŸ”— Dependencies

### Epic Dependencies
- **Depends on**:
  - Epic 2 (Avatar è¼‰å…¥éœ€è¦éŒ¯èª¤è™•ç†)
  - Epic 3 (TTS API éœ€è¦éŒ¯èª¤è™•ç†)
  - Epic 4 (Lip Sync éœ€è¦éŒ¯èª¤è™•ç†)

### Story Dependencies
- **Must Complete Before**:
  - Story 5.3 (UI/UX ç´°ç¯€æ‰“ç£¨) - Toast ç³»çµ±å¯é‡è¤‡ä½¿ç”¨
  - Story 5.6 (æŠ€è¡“é©—è­‰å ±å‘Š) - éœ€è¦éŒ¯èª¤è™•ç†æ¸¬è©¦çµæœ

### External Dependencies
- `react@18.x`: Error Boundary support
- `next@14.x`: App Router, client components

---

## ğŸ“¦ Deliverables

1. **Components**:
   - `src/components/ErrorBoundary.tsx` âœ…
   - `src/components/Toast.tsx` âœ…
   - `src/components/NetworkStatus.tsx` âœ…

2. **Hooks**:
   - `src/hooks/useRetry.ts` âœ…
   - `src/hooks/useToast.ts` âœ…
   - `src/hooks/useNetworkStatus.ts` âœ…

3. **Utilities**:
   - `src/lib/errors.ts` âœ…

4. **Documentation**:
   - `docs/testing/error-handling-test-plan.md` âœ…

5. **Tests**:
   - `__tests__/lib/errors.test.ts`
   - `__tests__/hooks/useRetry.test.tsx`
   - `__tests__/components/ErrorBoundary.test.tsx`

---

## âœ… Definition of Done

- [ ] å…¨åŸŸ ErrorBoundary æˆåŠŸæ•æ‰æ‰€æœ‰æ¸²æŸ“éŒ¯èª¤
- [ ] æ‰€æœ‰éŒ¯èª¤åˆ†é¡æ­£ç¢º,å‹å–„è¨Šæ¯æ˜ å°„å®Œæ•´
- [ ] é‡è©¦æ©Ÿåˆ¶é‹ä½œæ­£å¸¸ (è‡ªå‹•é‡è©¦ 1 æ¬¡)
- [ ] Toast é€šçŸ¥ç³»çµ±ç©©å®š,æ”¯æ´å¤šç¨®é¡å‹ (success/error/info/warning)
- [ ] Avatar è¼‰å…¥ç‹€æ…‹èˆ‡éŒ¯èª¤è™•ç†å®Œæ•´
- [ ] TTS API éŒ¯èª¤è™•ç†èˆ‡è¼‰å…¥ç‹€æ…‹å®Œæ•´
- [ ] ç¶²è·¯ç‹€æ…‹ç›£è½æ­£å¸¸,æ–·ç·šæ™‚é¡¯ç¤ºè­¦å‘Š
- [ ] æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹é€šé (Unit + Integration + Manual)
- [ ] ç„¡éšœç¤™æ”¯æ´å®Œæ•´ (ARIA, screen reader, keyboard navigation)
- [ ] æ–‡ä»¶é½Šå…¨ (æ¸¬è©¦è¨ˆç•«, éŒ¯èª¤è™•ç†ç­–ç•¥)
- [ ] Code review é€šé
- [ ] åœ¨ Chrome, Edge, Safari, Firefox æ¸¬è©¦é€šé

---

## ğŸ“š References

- [React Error Boundaries](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)
- [Web API: Navigator.onLine](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/onLine)
- [ARIA Live Regions](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Live_Regions)
- [UX Writing Best Practices](https://uxplanet.org/error-message-best-practices-6c39b3d8e0f6)
- [Exponential Backoff Algorithm](https://en.wikipedia.org/wiki/Exponential_backoff)

---

**Story å»ºç«‹æ—¥æœŸ**: 2025-10-14
**æœ€å¾Œæ›´æ–°**: 2025-10-14
**INVEST Score**: â­â­â­â­â­â­ (6/6)
- âœ… Independent: å¯ç¨ç«‹é–‹ç™¼èˆ‡æ¸¬è©¦
- âœ… Negotiable: é‡è©¦æ¬¡æ•¸ã€å»¶é²æ™‚é–“å¯èª¿æ•´
- âœ… Valuable: å¤§å¹…æå‡ä½¿ç”¨è€…é«”é©—,é™ä½æµå¤±ç‡
- âœ… Estimable: 6 å°æ™‚é ä¼°æ™‚é–“åˆç†
- âœ… Small: ç¯„åœæ˜ç¢º,å¯åœ¨ä¸€å€‹ Sprint å…§å®Œæˆ
- âœ… Testable: å¯é€éå–®å…ƒæ¸¬è©¦ã€æ•´åˆæ¸¬è©¦èˆ‡æ‰‹å‹•æ¸¬è©¦é©—è­‰
