# Story 1.2: Azure 服務註冊與 SDK 整合

## Status
Draft

---

## Story

**As a** 開發者,  
**I want** 註冊並配置 Azure OpenAI 與 Azure Speech Services，並整合相關 SDK，  
**so that** 後續可以直接呼叫 LLM 與 TTS 功能。

---

## Acceptance Criteria

1. 在 Azure Portal 建立 Azure OpenAI 資源（東美區，GPT-4 Turbo 部署）
2. 在 Azure Portal 建立 Azure Cognitive Services Speech 資源（東亞區）
3. 安裝 Azure SDK: `npm install @azure/openai microsoft-cognitiveservices-speech-sdk`
4. 在 `lib/azure/openai.ts` 建立 Azure OpenAI 客戶端初始化函式，使用環境變數
5. 在 `lib/azure/speech.ts` 建立 Azure Speech 客戶端初始化函式
6. 在 `.env.local` 配置所有必要環境變數（API Key, Endpoint, Region）
7. 建立簡單的測試腳本，驗證 Azure 服務連線正常（console.log 成功訊息）

---

## Tasks / Subtasks

- [ ] **Task 1: Azure OpenAI 服務註冊與部署** (AC: 1, 6)
  - [ ] 登入 Azure Portal (https://portal.azure.com)
  - [ ] 建立 Azure OpenAI 資源：
    - 資源名稱：`avatar-chat-openai-poc`
    - 區域：**East US**（GPT-4 Turbo 可用區域）
    - 定價層：Standard S0
  - [ ] 部署 GPT-4 Turbo 模型：
    - 模型：`gpt-4` (1106-Preview)
    - 部署名稱：`gpt-4-turbo`
  - [ ] 取得 API Key 與 Endpoint：
    - 前往 "Keys and Endpoint" 頁面
    - 複製 Key 1 與 Endpoint URL
  - [ ] 將金鑰加入 `.env.local`：
    ```
    AZURE_OPENAI_API_KEY=<your_key>
    AZURE_OPENAI_ENDPOINT=https://<your-resource>.openai.azure.com/
    AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo
    ```

- [ ] **Task 2: Azure Speech Services 註冊** (AC: 2, 6)
  - [ ] 在 Azure Portal 建立 Azure Cognitive Services (Speech) 資源：
    - 資源名稱：`avatar-chat-speech-poc`
    - 區域：**East Asia**（繁中語音品質最佳）
    - 定價層：Free F0（POC 階段）或 Standard S0
  - [ ] 取得 Speech Key 與 Region：
    - 前往 "Keys and Endpoint" 頁面
    - 複製 Key 1 與 Location/Region
  - [ ] 將金鑰加入 `.env.local`：
    ```
    AZURE_SPEECH_KEY=<your_speech_key>
    AZURE_SPEECH_REGION=eastasia
    ```

- [ ] **Task 3: 安裝 Azure SDK 依賴** (AC: 3)
  - [ ] 執行 `npm install @azure/openai`（Azure OpenAI SDK）
  - [ ] 執行 `npm install microsoft-cognitiveservices-speech-sdk`（Azure Speech SDK）
  - [ ] 驗證 `package.json` 已新增兩個依賴
  - [ ] 執行 `npm install` 確保依賴安裝成功

- [ ] **Task 4: 建立 Azure OpenAI 客戶端** (AC: 4)
  - [ ] 建立目錄 `lib/azure/`（如尚未存在）
  - [ ] 建立 `lib/azure/openai.ts` 檔案
  - [ ] 實作 OpenAI 客戶端初始化邏輯：
    ```typescript
    import { OpenAIClient, AzureKeyCredential } from '@azure/openai';

    export function getOpenAIClient(): OpenAIClient {
      const endpoint = process.env.AZURE_OPENAI_ENDPOINT!;
      const apiKey = process.env.AZURE_OPENAI_API_KEY!;
      
      if (!endpoint || !apiKey) {
        throw new Error('Azure OpenAI credentials not configured');
      }
      
      return new OpenAIClient(endpoint, new AzureKeyCredential(apiKey));
    }

    export const DEPLOYMENT_NAME = process.env.AZURE_OPENAI_DEPLOYMENT || 'gpt-4-turbo';
    ```
  - [ ] 加入型別定義與錯誤處理
  - [ ] 加入 JSDoc 註解說明用法

- [ ] **Task 5: 建立 Azure Speech 客戶端** (AC: 5)
  - [ ] 建立 `lib/azure/speech.ts` 檔案
  - [ ] 實作 Speech 客戶端初始化邏輯：
    ```typescript
    import * as sdk from 'microsoft-cognitiveservices-speech-sdk';

    export function getSpeechConfig(): sdk.SpeechConfig {
      const subscriptionKey = process.env.AZURE_SPEECH_KEY!;
      const region = process.env.AZURE_SPEECH_REGION!;
      
      if (!subscriptionKey || !region) {
        throw new Error('Azure Speech credentials not configured');
      }
      
      const speechConfig = sdk.SpeechConfig.fromSubscription(subscriptionKey, region);
      speechConfig.speechSynthesisVoiceName = 'zh-TW-HsiaoChenNeural'; // 繁中女聲
      
      return speechConfig;
    }

    export const DEFAULT_VOICE = 'zh-TW-HsiaoChenNeural';
    ```
  - [ ] 加入型別定義與錯誤處理
  - [ ] 加入 JSDoc 註解說明用法

- [ ] **Task 6: 環境變數配置與驗證** (AC: 6)
  - [ ] 更新 `.env.local.example`，加入所有 Azure 環境變數：
    ```
    # Azure OpenAI
    AZURE_OPENAI_API_KEY=your_key_here
    AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
    AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo
    
    # Azure Speech Services
    AZURE_SPEECH_KEY=your_speech_key_here
    AZURE_SPEECH_REGION=eastasia
    ```
  - [ ] 確認 `.env.local` 包含實際金鑰（不提交至 Git）
  - [ ] 驗證 `.gitignore` 包含 `.env.local`

- [ ] **Task 7: 建立 Azure 服務連線測試腳本** (AC: 7)
  - [ ] 建立 `scripts/test-azure.ts` 測試腳本
  - [ ] 測試 Azure OpenAI 連線：
    ```typescript
    import { getOpenAIClient, DEPLOYMENT_NAME } from '@/lib/azure/openai';

    async function testOpenAI() {
      const client = getOpenAIClient();
      const response = await client.getChatCompletions(
        DEPLOYMENT_NAME,
        [{ role: 'user', content: 'Hello, Azure OpenAI!' }]
      );
      console.log('✅ Azure OpenAI Test:', response.choices[0].message?.content);
    }
    ```
  - [ ] 測試 Azure Speech 連線：
    ```typescript
    import { getSpeechConfig } from '@/lib/azure/speech';
    import * as sdk from 'microsoft-cognitiveservices-speech-sdk';

    async function testSpeech() {
      const speechConfig = getSpeechConfig();
      const synthesizer = new sdk.SpeechSynthesizer(speechConfig);
      
      synthesizer.speakTextAsync(
        '你好，Azure Speech',
        result => {
          if (result.reason === sdk.ResultReason.SynthesizingAudioCompleted) {
            console.log('✅ Azure Speech Test: Success');
          }
          synthesizer.close();
        },
        error => {
          console.error('❌ Azure Speech Test Failed:', error);
          synthesizer.close();
        }
      );
    }
    ```
  - [ ] 在 `package.json` 加入測試腳本：
    ```json
    "scripts": {
      "test:azure": "tsx scripts/test-azure.ts"
    }
    ```
  - [ ] 執行 `npm run test:azure` 驗證服務正常
  - [ ] 確認終端機輸出成功訊息

---

## Dev Notes

### 相關來源樹（Source Tree）

根據架構文件，Azure 整合的檔案結構應如下：

```
avatar-chat-poc/
├── lib/
│   ├── azure/
│   │   ├── openai.ts           # Azure OpenAI 客戶端初始化
│   │   └── speech.ts           # Azure Speech 客戶端初始化
│   └── utils/
│       └── errorHandler.ts     # 錯誤處理（後續建立）
├── scripts/
│   └── test-azure.ts           # Azure 服務測試腳本
├── .env.local                  # 本地環境變數（含實際金鑰，不提交）
├── .env.local.example          # 環境變數範例（可提交）
└── package.json                # 已安裝 Azure SDK
```

### Azure 服務配置詳細資訊

**Azure OpenAI Service**:
- **區域**: East US（GPT-4 Turbo 可用區域）
- **部署模型**: GPT-4 (1106-Preview)
- **部署名稱**: `gpt-4-turbo`
- **用途**: LLM 對話處理
- **SDK**: `@azure/openai` (v1.0.0-beta.11+)
- **環境變數**:
  - `AZURE_OPENAI_API_KEY`: API 金鑰
  - `AZURE_OPENAI_ENDPOINT`: 服務端點 URL
  - `AZURE_OPENAI_DEPLOYMENT`: 模型部署名稱

**Azure Cognitive Services (Speech)**:
- **區域**: East Asia（繁中語音品質最佳）
- **語音**: zh-TW-HsiaoChenNeural（繁中女聲）
- **用途**: TTS（文字轉語音）+ STT（語音轉文字，選做）
- **SDK**: `microsoft-cognitiveservices-speech-sdk` (v1.34+)
- **環境變數**:
  - `AZURE_SPEECH_KEY`: Speech 服務金鑰
  - `AZURE_SPEECH_REGION`: 服務區域（eastasia）

### 重要架構決策

1. **區域選擇**:
   - **OpenAI → East US**: GPT-4 Turbo 僅在特定區域可用
   - **Speech → East Asia**: 繁中語音品質最佳，延遲最低

2. **環境變數管理**:
   - 使用 `.env.local` 儲存實際金鑰（本地開發）
   - 使用 `.env.local.example` 提供範本（版控）
   - Azure 部署時使用 Azure Static Web Apps 環境變數

3. **客戶端初始化模式**:
   - 使用工廠函式 (`getOpenAIClient()`, `getSpeechConfig()`)
   - 集中管理金鑰驗證與錯誤處理
   - 支援環境變數自動載入

4. **成本控制**:
   - POC 階段使用 Speech Free F0 tier（500,000 字元/月免費）
   - OpenAI 按使用量計費（監控 Token 用量）
   - 部署前設定 Azure Cost Alert

### 技術實作細節

**Azure OpenAI SDK 使用**:
```typescript
// 基本 Chat Completion
const client = getOpenAIClient();
const response = await client.getChatCompletions(
  DEPLOYMENT_NAME,
  [
    { role: 'system', content: 'You are a helpful assistant.' },
    { role: 'user', content: 'Hello!' }
  ]
);
```

**Azure Speech SDK 使用**:
```typescript
// TTS (文字轉語音)
const speechConfig = getSpeechConfig();
const audioConfig = sdk.AudioConfig.fromDefaultSpeakerOutput();
const synthesizer = new sdk.SpeechSynthesizer(speechConfig, audioConfig);

synthesizer.speakTextAsync(
  'Hello, world!',
  result => {
    // 處理成功結果
  },
  error => {
    // 處理錯誤
  }
);
```

### 錯誤處理策略

**OpenAI 常見錯誤**:
- ❌ `401 Unauthorized`: API Key 錯誤
- ❌ `404 Not Found`: Deployment 名稱錯誤
- ❌ `429 Too Many Requests`: 超過 Rate Limit
- ❌ `500 Internal Server Error`: Azure 服務暫時性錯誤

**Speech 常見錯誤**:
- ❌ `InvalidSubscriptionKey`: Speech Key 錯誤
- ❌ `InvalidServiceRegion`: Region 配置錯誤
- ❌ `ConnectionFailure`: 網路連線問題

**處理原則**:
1. 啟動時驗證必要環境變數存在
2. API 呼叫時捕捉並記錄詳細錯誤
3. 提供友善的錯誤訊息給使用者
4. 支援重試機制（Rate Limit、暫時性錯誤）

### Testing

**測試框架**: Node.js Script（POC 階段簡化）

**測試範圍**:
1. ✅ Azure OpenAI 客戶端初始化成功
2. ✅ Azure Speech 客戶端初始化成功
3. ✅ OpenAI Chat Completion API 可正常呼叫
4. ✅ Speech TTS 可正常生成語音
5. ✅ 環境變數正確載入
6. ✅ 錯誤處理機制正常運作

**測試執行方式**:
```bash
# 執行 Azure 服務測試
npm run test:azure

# 預期輸出
✅ Azure OpenAI Test: [GPT-4 回應內容]
✅ Azure Speech Test: Success
```

**驗證清單**:
- [ ] 測試腳本執行無錯誤
- [ ] OpenAI API 返回正確回應
- [ ] Speech TTS 成功生成音訊
- [ ] 環境變數全部正確配置
- [ ] 錯誤情境（缺少金鑰）正確拋出異常

### 安全性考量

**金鑰管理**:
- ✅ `.env.local` 已加入 `.gitignore`
- ✅ 絕不在程式碼中硬編碼金鑰
- ✅ 使用環境變數管理敏感資訊
- ✅ Azure Portal 啟用 Key Rotation（定期更換金鑰）

**成本控制**:
- ✅ 設定 Azure Cost Alert（預算 NT$7,000/3個月）
- ✅ 監控 OpenAI Token 用量
- ✅ 監控 Speech TTS 字元數
- ✅ POC 階段限制測試次數

### 依賴關係

**前置條件**:
- ✅ Story 1.1 已完成（Next.js 專案已初始化）
- ✅ Azure 帳號已註冊並可存取 Azure Portal
- ✅ 信用卡已綁定（或 Azure 試用額度）

**後續 Story 依賴**:
- Story 1.3: 會使用 Azure 客戶端（基本連線測試）
- Story 1.4: Health Check API 會驗證 Azure 服務狀態
- Epic 3: LLM 對話功能直接使用 `lib/azure/openai.ts`
- Epic 3: TTS 功能直接使用 `lib/azure/speech.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | 建立 Story 1.2 草稿 | SM Agent |

---

## Dev Agent Record

*(此部分由 Dev Agent 在實作時填寫)*

### Agent Model Used
_待填寫_

### Debug Log References
_待填寫_

### Completion Notes List
_待填寫_

### File List
_待填寫_

---

## QA Results

*(此部分由 QA Agent 在審核時填寫)*

_待填寫_

