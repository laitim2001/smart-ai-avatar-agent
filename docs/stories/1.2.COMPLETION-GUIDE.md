# Story 1.2 完成指南

**Story 狀態**: ✅ 程式碼實施完成
**待用戶操作**: Azure Portal 註冊與金鑰配置
**最後更新**: 2025-10-15

---

## 📋 已完成項目

### ✅ 1. Azure SDK 安裝

已安裝以下套件：

```json
{
  "@azure/openai": "^2.0.0",
  "microsoft-cognitiveservices-speech-sdk": "^1.46.0",
  "dotenv": "^17.2.3",
  "tsx": "^4.20.6"
}
```

### ✅ 2. Azure 客戶端封裝

#### `lib/azure/openai.ts`
- ✅ OpenAI 客戶端工廠函數：`getOpenAIClient()`
- ✅ 配置驗證：`isConfigured()`
- ✅ 安全配置摘要：`getConfigSummary()`
- ✅ 環境變數檢查與友好錯誤訊息
- ✅ JSDoc 完整文檔註釋

#### `lib/azure/speech.ts`
- ✅ Speech SDK 配置函數：`getSpeechConfig()`
- ✅ TTS 配置：`getTTSConfig()`
- ✅ STT 配置：`getSTTConfig()`
- ✅ 預設繁體中文語音：`zh-TW-HsiaoChenNeural`
- ✅ 可用語音列表：`AVAILABLE_ZH_TW_VOICES`
- ✅ 配置驗證與摘要功能

### ✅ 3. 環境變數配置

#### `.env.local.example`
- ✅ 完整的環境變數範例
- ✅ 詳細的取得方式說明
- ✅ 配置檢查清單
- ✅ 安全提示

**必填環境變數**：
```bash
# Azure OpenAI
AZURE_OPENAI_ENDPOINT=https://your-resource-name.openai.azure.com/
AZURE_OPENAI_API_KEY=your_openai_api_key_here
AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo

# Azure Speech Services
AZURE_SPEECH_KEY=your_speech_api_key_here
AZURE_SPEECH_REGION=eastasia
```

### ✅ 4. 測試工具

#### `scripts/test-azure.ts`
- ✅ 環境變數完整性檢查
- ✅ Azure OpenAI 連接測試
- ✅ Azure Speech Services 配置驗證
- ✅ 友好的錯誤訊息和除錯提示

**執行方式**：
```bash
npm run test:azure
```

#### `app/api/health/route.ts`
- ✅ 健康檢查 API 端點
- ✅ 配置狀態檢查（不暴露敏感資訊）

**測試方式**：
```bash
curl http://localhost:3004/api/health
```

### ✅ 5. NPM 腳本

已添加到 `package.json`：
```json
{
  "scripts": {
    "test:azure": "tsx scripts/test-azure.ts"
  }
}
```

---

## 🎯 用戶待完成操作

### 步驟 1: Azure OpenAI 註冊

1. 前往 [Azure Portal](https://portal.azure.com)
2. 創建 Azure OpenAI 資源
   - 區域：**East US**（GPT-4 Turbo 可用性最佳）
   - 定價層：Standard S0
3. 部署模型：
   - 前往 Azure OpenAI Studio
   - 創建部署：`gpt-4-turbo`
4. 獲取憑證：
   - 前往「金鑰和端點」頁面
   - 複製「端點」和「金鑰 1」

### 步驟 2: Azure Speech Services 註冊

1. 前往 [Azure Portal](https://portal.azure.com)
2. 創建 Azure 認知服務 Speech 資源
   - 區域：**East Asia**（最佳繁體中文語音質量）
   - 定價層：Standard S0
3. 獲取憑證：
   - 前往「金鑰和端點」頁面
   - 複製「區域」和「金鑰 1」

### 步驟 3: 配置環境變數

1. 複製範例檔案：
   ```bash
   cp .env.local.example .env.local
   ```

2. 編輯 `.env.local`，填入你的 Azure 憑證：
   ```bash
   AZURE_OPENAI_ENDPOINT=https://your-actual-resource.openai.azure.com/
   AZURE_OPENAI_API_KEY=你的實際金鑰
   AZURE_OPENAI_DEPLOYMENT=gpt-4-turbo

   AZURE_SPEECH_KEY=你的實際金鑰
   AZURE_SPEECH_REGION=eastasia
   ```

### 步驟 4: 驗證配置

1. 重啟開發伺服器：
   ```bash
   npm run dev
   ```

2. 測試 Azure 連接：
   ```bash
   npm run test:azure
   ```

   **預期輸出**：
   ```
   🚀 開始測試 Azure 服務連接...

   ✅ 所有環境變數已配置
   ✅ Azure OpenAI 連接成功！
   ✅ Azure Speech Services 配置成功！

   🎉 所有 Azure 服務測試通過！
   ```

3. 檢查健康檢查 API：
   ```bash
   curl http://localhost:3004/api/health
   ```

   **預期輸出**：
   ```json
   {
     "status": "ok",
     "services": {
       "openai": { "configured": true },
       "speech": { "configured": true }
     }
   }
   ```

---

## 📚 使用範例

### Azure OpenAI 使用

```typescript
import { getOpenAIClient, DEPLOYMENT_NAME } from '@/lib/azure/openai'

// 初始化客戶端
const client = getOpenAIClient()

// 發送對話請求
const response = await client.getChatCompletions(DEPLOYMENT_NAME, [
  {
    role: 'system',
    content: '你是一個友善的 AI 助手。請用繁體中文回答。'
  },
  {
    role: 'user',
    content: '你好！'
  }
])

const reply = response.choices[0]?.message?.content
console.log(reply)
```

### Azure Speech 使用

```typescript
import { getSpeechConfig, DEFAULT_VOICE } from '@/lib/azure/speech'
import * as sdk from 'microsoft-cognitiveservices-speech-sdk'

// TTS（文字轉語音）
const config = getSpeechConfig()
const synthesizer = new sdk.SpeechSynthesizer(config)

await synthesizer.speakTextAsync('你好，我是 AI Avatar！')

// STT（語音轉文字）
const recognizer = new sdk.SpeechRecognizer(config)
// ... 語音識別邏輯
```

---

## ✅ Story 1.2 驗收標準檢查

| 驗收標準 | 狀態 | 說明 |
|---------|------|------|
| Azure OpenAI 資源創建 | ⏳ 待用戶操作 | 需在 Azure Portal 註冊 |
| Azure Speech 資源創建 | ⏳ 待用戶操作 | 需在 Azure Portal 註冊 |
| Azure SDK 安裝 | ✅ 完成 | @azure/openai, speech-sdk |
| OpenAI 客戶端封裝 | ✅ 完成 | lib/azure/openai.ts |
| Speech 客戶端封裝 | ✅ 完成 | lib/azure/speech.ts |
| 環境變數配置 | ✅ 完成 | .env.local.example |
| 測試腳本 | ✅ 完成 | scripts/test-azure.ts |
| 健康檢查 API | ✅ 完成 | /api/health |

---

## 🔧 故障排除

### 問題 1: 測試腳本顯示「配置不完整」

**原因**：`.env.local` 檔案未創建或環境變數未正確填入

**解決方案**：
1. 確認 `.env.local` 檔案存在
2. 檢查所有必填變數是否已填入
3. 確認沒有多餘的空格或引號

### 問題 2: OpenAI API 返回 401 錯誤

**原因**：API 金鑰無效或端點錯誤

**解決方案**：
1. 確認 API 金鑰複製正確（32 字元十六進制）
2. 確認端點格式：`https://resource-name.openai.azure.com/`
3. 檢查 Azure 訂閱是否處於活動狀態
4. 嘗試在 Azure Portal 重新生成金鑰

### 問題 3: Speech SDK 初始化失敗

**原因**：區域設定錯誤或訂閱金鑰無效

**解決方案**：
1. 確認區域為小寫英文（例如：`eastasia`，不是 `East Asia`）
2. 確認訂閱金鑰複製正確
3. 檢查網路連接

---

## 📝 下一步

Story 1.2 程式碼實施完成後，用戶需要：

1. **立即**：註冊 Azure 服務並填入金鑰（本 Story）
2. **Story 1.3**：UI 組件開發（可並行進行）
3. **Story 1.4**：專案文檔完善

---

**維護者**: AI Assistant
**最後更新**: 2025-10-15
**相關文檔**:
- [Story 1.2 需求](./1.2.azure-services-setup.md)
- [環境變數範例](../../.env.local.example)
- [AI Assistant Guide](../../AI_ASSISTANT_GUIDE.md)
