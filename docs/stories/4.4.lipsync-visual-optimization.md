# Story 4.4: Lip Sync è¦–è¦ºå„ªåŒ–èˆ‡èª¿æ ¡

## Status
Draft

---

## Story

**As a** ä½¿ç”¨è€…,
**I want** Avatar çš„å˜´å‹å‹•ä½œè‡ªç„¶ä¸”èˆ‡èªéŸ³é«˜åº¦åŒ¹é…,
**so that** å°è©±é«”é©—æ›´åŠ é€¼çœŸã€‚

---

## Acceptance Criteria

1. èª¿æ•´ viseme æ¬Šé‡æ›²ç·šï¼Œä½¿å˜´å‹è®ŠåŒ–æ›´å¹³æ»‘ï¼ˆä½¿ç”¨ easing å‡½å¼ï¼‰
2. åŠ å…¥å˜´å‹éæ¸¡å‹•ç•«ï¼ˆé¿å…çªè®Šï¼‰ï¼šä½¿ç”¨ `lerp`ï¼ˆç·šæ€§æ’å€¼ï¼‰å¹³æ»‘éæ¸¡ã€éæ¸¡æ™‚é–“ï¼š50ms
3. å„ªåŒ–é«˜é »éŸ³ç´ è™•ç†ï¼ˆå¦‚ã€Œã„™ã€ã€Œã„•ã€ï¼‰
4. æ¸¬è©¦å¤šç¨®èªå¥ï¼šçŸ­å¥ã€Œä½ å¥½ã€ã€é•·å¥ã€Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€ã€å¿«é€Ÿèªå¥ã€Œä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åã€
5. è¦–è¦ºåŒ¹é…åº¦è©•ä¼° â‰¥ 70%ï¼ˆ5 ä½æ¸¬è©¦è€…ä¸»è§€è©•åˆ†å¹³å‡ï¼‰
6. ç„¡æ˜é¡¯ã€ŒéŒ¯ä½ã€æˆ–ã€Œå»¶é²ã€æ„Ÿ

---

## Tasks / Subtasks

- [ ] **Task 1: å¯¦ä½œ Easing å‡½å¼åº«** (AC: 1)
  - [ ] å»ºç«‹ `lib/utils/easing.ts` Easing å‡½å¼é›†åˆ
  - [ ] å¯¦ä½œå¸¸ç”¨ Easing å‡½å¼ï¼š
    ```typescript
    /**
     * Easing å‡½å¼é›†åˆ
     * ç”¨æ–¼å¹³æ»‘åŒ– Lip Sync æ¬Šé‡è®ŠåŒ–
     * åŸºæ–¼ Robert Penner's Easing Functions
     */

    /**
     * Ease Out Cubicï¼ˆä¸‰æ¬¡æ–¹ç·©å‡ºï¼‰
     * å¿«é€Ÿé–‹å§‹ï¼Œç·©æ…¢çµæŸï¼Œé©åˆå˜´å‹é–‰åˆå‹•ç•«
     */
    export function easeOutCubic(t: number): number {
      return 1 - Math.pow(1 - t, 3);
    }

    /**
     * Ease In Out Cubicï¼ˆä¸‰æ¬¡æ–¹ç·©é€²ç·©å‡ºï¼‰
     * å¹³æ»‘åŠ é€Ÿèˆ‡æ¸›é€Ÿï¼Œé©åˆå˜´å‹å¼µé–‹/é–‰åˆå¾ªç’°
     */
    export function easeInOutCubic(t: number): number {
      return t < 0.5
        ? 4 * t * t * t
        : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    /**
     * Ease Out Quadï¼ˆäºŒæ¬¡æ–¹ç·©å‡ºï¼‰
     * è¼ƒæŸ”å’Œçš„ç·©å‡ºï¼Œé©åˆå¿«é€ŸèªéŸ³
     */
    export function easeOutQuad(t: number): number {
      return 1 - (1 - t) * (1 - t);
    }

    /**
     * Ease In Out Sineï¼ˆæ­£å¼¦ç·©é€²ç·©å‡ºï¼‰
     * æœ€å¹³æ»‘çš„éæ¸¡ï¼Œé©åˆè‡ªç„¶èªéŸ³ç¯€å¥
     */
    export function easeInOutSine(t: number): number {
      return -(Math.cos(Math.PI * t) - 1) / 2;
    }

    /**
     * Linearï¼ˆç·šæ€§ï¼‰
     * ç„¡ç·©å‹•ï¼Œä½œç‚ºåŸºæº–å°ç…§
     */
    export function linear(t: number): number {
      return t;
    }

    /**
     * Easing é¡å‹
     */
    export type EasingFunction = typeof easeOutCubic;

    /**
     * æ‡‰ç”¨ Easing åˆ°æ¬Šé‡å€¼
     *
     * @param currentWeight - ç•¶å‰æ¬Šé‡
     * @param targetWeight - ç›®æ¨™æ¬Šé‡
     * @param progress - é€²åº¦ï¼ˆ0-1ï¼‰
     * @param easingFn - Easing å‡½å¼
     * @returns æ‡‰ç”¨ easing å¾Œçš„æ¬Šé‡
     */
    export function applyEasing(
      currentWeight: number,
      targetWeight: number,
      progress: number,
      easingFn: EasingFunction = easeInOutSine
    ): number {
      const easedProgress = easingFn(progress);
      return currentWeight + (targetWeight - currentWeight) * easedProgress;
    }
    ```
  - [ ] åŠ å…¥ JSDoc è¨»è§£èˆ‡ä½¿ç”¨ç¯„ä¾‹
  - [ ] é©—è­‰æ‰€æœ‰ easing å‡½å¼è¼¸å…¥ 0-1 è¼¸å‡º 0-1

- [ ] **Task 2: æ›´æ–° BlendshapeController æ”¯æ´ Easing** (AC: 1, 2)
  - [ ] é–‹å•Ÿ `lib/three/blendshape-controller.ts`
  - [ ] åŠ å…¥ Easing éæ¸¡ç‹€æ…‹è¿½è¹¤ï¼š
    ```typescript
    import { easeInOutSine, type EasingFunction } from '@/lib/utils/easing';

    export class BlendshapeController {
      // ... existing properties ...

      // æ–°å¢ï¼šEasing éæ¸¡ç‹€æ…‹
      private transitionState: Map<number, {
        startWeight: number;
        targetWeight: number;
        startTime: number;
        duration: number;
      }> = new Map();

      private easingFunction: EasingFunction = easeInOutSine;

      /**
       * è¨­å®š Easing å‡½å¼
       */
      setEasingFunction(easingFn: EasingFunction): void {
        this.easingFunction = easingFn;
      }

      /**
       * æ‡‰ç”¨ Viseme åˆ° Avatar blendshapes (å¹³æ»‘éæ¸¡ç‰ˆæœ¬ï¼Œä½¿ç”¨ Easing)
       *
       * @param viseme - Viseme é¡å‹
       * @param targetWeight - ç›®æ¨™æ¬Šé‡
       * @param transitionDuration - éæ¸¡æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ï¼Œé è¨­ 50ms
       */
      applySmoothVisemeWithEasing(
        viseme: VisemeType,
        targetWeight: number,
        transitionDuration: number = 50
      ): void {
        if (!this.mesh || !this.morphTargetDictionary || !this.morphTargetInfluences) {
          return;
        }

        const mapping = this.visemeMap.find(m => m.viseme === viseme);
        if (!mapping) return;

        const currentTime = performance.now();

        mapping.blendshapes.forEach(({ blendshapeName, weightMultiplier }) => {
          const blendshapeIndex = this.morphTargetDictionary![blendshapeName];

          if (blendshapeIndex !== undefined) {
            const currentWeight = this.morphTargetInfluences![blendshapeIndex];
            const targetFinalWeight = targetWeight * weightMultiplier;

            // è¨˜éŒ„éæ¸¡ç‹€æ…‹
            this.transitionState.set(blendshapeIndex, {
              startWeight: currentWeight,
              targetWeight: targetFinalWeight,
              startTime: currentTime,
              duration: transitionDuration
            });
          }
        });
      }

      /**
       * æ›´æ–°éæ¸¡å‹•ç•«ï¼ˆæ¯å¹€å‘¼å«ï¼‰
       * æ‡‰åœ¨ useFrame æˆ– requestAnimationFrame ä¸­å‘¼å«
       */
      updateTransitions(): void {
        if (!this.morphTargetInfluences) return;

        const currentTime = performance.now();

        this.transitionState.forEach((state, blendshapeIndex) => {
          const elapsed = currentTime - state.startTime;
          const progress = Math.min(elapsed / state.duration, 1.0);

          // æ‡‰ç”¨ Easing
          const easedProgress = this.easingFunction(progress);
          const newWeight = state.startWeight +
                           (state.targetWeight - state.startWeight) * easedProgress;

          this.morphTargetInfluences![blendshapeIndex] = Math.max(0, Math.min(1, newWeight));

          // éæ¸¡å®Œæˆï¼Œç§»é™¤ç‹€æ…‹
          if (progress >= 1.0) {
            this.transitionState.delete(blendshapeIndex);
          }
        });
      }
    }
    ```
  - [ ] æ›´æ–° useBlendshapeController Hookï¼š
    ```typescript
    export function useBlendshapeController() {
      const controllerRef = useRef<BlendshapeController | null>(null);

      // ... existing methods ...

      /**
       * æ‡‰ç”¨ Visemeï¼ˆä½¿ç”¨ Easing å¹³æ»‘éæ¸¡ï¼‰
       */
      const applyVisemeWithEasing = useCallback((
        viseme: VisemeType,
        weight: number,
        transitionDuration?: number
      ) => {
        if (controllerRef.current) {
          controllerRef.current.applySmoothVisemeWithEasing(viseme, weight, transitionDuration);
        }
      }, []);

      /**
       * æ›´æ–°éæ¸¡å‹•ç•«ï¼ˆéœ€åœ¨ useFrame ä¸­å‘¼å«ï¼‰
       */
      const updateTransitions = useCallback(() => {
        if (controllerRef.current) {
          controllerRef.current.updateTransitions();
        }
      }, []);

      return {
        initializeController,
        applyViseme,
        applySmoothViseme,
        applyVisemeWithEasing,  // æ–°å¢
        updateTransitions,      // æ–°å¢
        resetMouth
      };
    }
    ```
  - [ ] æ¸¬è©¦ Easing éæ¸¡æ•ˆæœï¼ˆå°æ¯”ç·šæ€§æ’å€¼ï¼‰

- [ ] **Task 3: å„ªåŒ–é«˜é »éŸ³ç´ è™•ç†** (AC: 3)
  - [ ] æ›´æ–° `lib/three/lipsync.ts` éŸ³è¨Šåˆ†æé‚è¼¯
  - [ ] åŠ å…¥é«˜é »éŸ³ç´ ç‰¹å¾µæª¢æ¸¬ï¼š
    ```typescript
    /**
     * æª¢æ¸¬é«˜é »éŸ³ç´ ï¼ˆå¦‚ s, sh, f ç­‰ï¼‰
     * é€™äº›éŸ³ç´ åœ¨é »è­œä¸Šæœ‰æ˜é¡¯é«˜é »ç‰¹å¾µ
     *
     * @param analyser - AnalyserNode
     * @param dataArray - é »ç‡æ•¸æ“šé™£åˆ—
     * @returns æ˜¯å¦ç‚ºé«˜é »éŸ³ç´ 
     */
    private detectHighFrequencyPhoneme(
      analyser: AnalyserNode,
      dataArray: Uint8Array
    ): boolean {
      // å–å¾—é »ç‡æ•¸æ“š
      analyser.getByteFrequencyData(dataArray);

      // è¨ˆç®—é«˜é »èƒ½é‡ï¼ˆ4kHz - 8kHz ç¯„åœï¼‰
      const sampleRate = analyser.context.sampleRate;
      const binCount = dataArray.length;
      const binWidth = (sampleRate / 2) / binCount;

      const highFreqStart = Math.floor(4000 / binWidth);
      const highFreqEnd = Math.floor(8000 / binWidth);

      let highFreqEnergy = 0;
      for (let i = highFreqStart; i < highFreqEnd && i < binCount; i++) {
        highFreqEnergy += dataArray[i];
      }

      const avgHighFreqEnergy = highFreqEnergy / (highFreqEnd - highFreqStart);

      // è‹¥é«˜é »èƒ½é‡ > é–¾å€¼ï¼Œè¦–ç‚ºé«˜é »éŸ³ç´ ï¼ˆå¦‚ ã„™ã€ã„•ï¼‰
      return avgHighFreqEnergy > 100; // é–¾å€¼å¯èª¿æ•´
    }
    ```
  - [ ] æ›´æ–° Viseme æ˜ å°„é‚è¼¯è™•ç†é«˜é »éŸ³ç´ ï¼š
    ```typescript
    private mapVolumeToViseme(
      volume: number,
      isHighFrequency: boolean = false
    ): { viseme: VisemeType; weight: number } {
      // é«˜é »éŸ³ç´ ç‰¹æ®Šè™•ç†ï¼ˆå˜´å‹å¾®é–‹ï¼Œä¸å¼µå¤§ï¼‰
      if (isHighFrequency) {
        return {
          viseme: 'E',           // ä½¿ç”¨ Eï¼ˆåŠé–‹ï¼‰è€Œé aaï¼ˆå¤§å¼µï¼‰
          weight: volume * 0.6   // é™ä½æ¬Šé‡ï¼Œé¿å…éåº¦å¼µå˜´
        };
      }

      // ... existing volume mapping logic ...
    }
    ```
  - [ ] æ¸¬è©¦é«˜é »éŸ³ç´ èªå¥ï¼ˆå¦‚ã€Œå››åå››éš»çŸ³ç…å­ã€ï¼‰

- [ ] **Task 4: æ›´æ–° LipSyncController æ•´åˆ Easing** (AC: 1, 2)
  - [ ] é–‹å•Ÿ `components/avatar/LipSyncController.tsx`
  - [ ] æ•´åˆ Easing éæ¸¡æ›´æ–°ï¼š
    ```typescript
    export default function LipSyncController({ avatarMeshRef, enabled = true }: LipSyncControllerProps) {
      const {
        applyVisemeWithEasing,  // ä½¿ç”¨æ–°çš„ Easing ç‰ˆæœ¬
        updateTransitions,       // æ¯å¹€æ›´æ–°éæ¸¡
        initializeController
      } = useBlendshapeController();

      // ... existing code ...

      // æ¯å¹€æ›´æ–°é‚è¼¯
      useFrame(() => {
        if (!enabled) return;

        // 1. æ›´æ–° Easing éæ¸¡å‹•ç•«ï¼ˆå¿…é ˆæ¯å¹€å‘¼å«ï¼‰
        updateTransitions();

        // 2. Lip Sync åŒæ­¥é‚è¼¯
        if (isPlaying && audioContext && visemeTimeline.length > 0) {
          const currentPlaybackTime = audioContext.currentTime - playbackStartTime;
          const viseme = findVisemeAtTime(visemeTimeline, currentPlaybackTime, currentIndexRef.current);

          if (viseme) {
            // ä½¿ç”¨ Easing ç‰ˆæœ¬ï¼ˆ50ms éæ¸¡æ™‚é–“ï¼‰
            applyVisemeWithEasing(viseme.viseme, viseme.weight, 50);

            // æ›´æ–°ç´¢å¼•
            const newIndex = visemeTimeline.findIndex(v => v === viseme);
            if (newIndex !== -1) {
              currentIndexRef.current = newIndex;
            }
          }
        }
      });

      return null;
    }
    ```
  - [ ] æ¸¬è©¦ Easing æ•´åˆå¾Œçš„è¦–è¦ºæµæš¢åº¦

- [ ] **Task 5: å»ºç«‹æ¸¬è©¦èªå¥é›†èˆ‡è©•åˆ†ç³»çµ±** (AC: 4, 5, 6)
  - [ ] å»ºç«‹æ¸¬è©¦èªå¥æª”æ¡ˆ `scripts/test/lipsync-test-sentences.ts`
  - [ ] å®šç¾©æ¸¬è©¦èªå¥é›†ï¼š
    ```typescript
    /**
     * Lip Sync æ¸¬è©¦èªå¥é›†
     * æ¶µè“‹ä¸åŒèªé€Ÿã€éŸ³ç´ é¡å‹ã€å¥é•·
     */

    export interface TestSentence {
      id: string;
      text: string;
      category: string;
      expectedDuration: number; // é æœŸæ™‚é•·ï¼ˆç§’ï¼‰
      targetAccuracy: number;   // ç›®æ¨™æº–ç¢ºåº¦ï¼ˆ%ï¼‰
      notes: string;
    }

    export const LIPSYNC_TEST_SENTENCES: TestSentence[] = [
      // çŸ­å¥æ¸¬è©¦
      {
        id: 'short-1',
        text: 'ä½ å¥½',
        category: 'çŸ­å¥',
        expectedDuration: 1.0,
        targetAccuracy: 75,
        notes: 'åŸºç¤å˜´å‹æ¸¬è©¦ï¼ˆå¼µå˜´ aa â†’ åŠé–‹ Eï¼‰'
      },
      {
        id: 'short-2',
        text: 'å†è¦‹',
        category: 'çŸ­å¥',
        expectedDuration: 1.0,
        targetAccuracy: 75,
        notes: 'å¿«é€Ÿéæ¸¡æ¸¬è©¦'
      },

      // é•·å¥æ¸¬è©¦
      {
        id: 'long-1',
        text: 'å¾ˆé«˜èˆˆèªè­˜ä½ ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹',
        category: 'é•·å¥',
        expectedDuration: 5.0,
        targetAccuracy: 70,
        notes: 'æŒçºŒåŒæ­¥æ¸¬è©¦ï¼ˆ5 ç§’ï¼‰'
      },
      {
        id: 'long-2',
        text: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½ï¼Œé©åˆå‡ºå»èµ°èµ°',
        category: 'é•·å¥',
        expectedDuration: 4.5,
        targetAccuracy: 70,
        notes: 'è‡ªç„¶ç¯€å¥æ¸¬è©¦'
      },

      // å¿«é€Ÿèªå¥æ¸¬è©¦
      {
        id: 'fast-1',
        text: 'ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å',
        category: 'å¿«é€Ÿ',
        expectedDuration: 2.5,
        targetAccuracy: 65,
        notes: 'é«˜é€ŸéŸ³ç¯€æ¸¬è©¦ï¼ˆæŒ‘æˆ°æ€§ï¼‰'
      },
      {
        id: 'fast-2',
        text: 'å››åå››éš»çŸ³ç…å­',
        category: 'å¿«é€Ÿ+é«˜é »',
        expectedDuration: 2.0,
        targetAccuracy: 65,
        notes: 'é«˜é »éŸ³ç´ æ¸¬è©¦ï¼ˆã„™ã€ã„•ï¼‰'
      },

      // æ··åˆæ¸¬è©¦
      {
        id: 'mixed-1',
        text: 'è«‹å•æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ',
        category: 'å•å¥',
        expectedDuration: 3.5,
        targetAccuracy: 70,
        notes: 'è‡ªç„¶å°è©±èªæ°£æ¸¬è©¦'
      }
    ];
    ```
  - [ ] å»ºç«‹è©•åˆ†è¡¨å–® `docs/lipsync-evaluation-form.md`ï¼š
    ```markdown
    # Lip Sync è¦–è¦ºåŒ¹é…åº¦è©•åˆ†è¡¨

    ## è©•åˆ†æ¨™æº–

    ### 1. åŒæ­¥æ€§ï¼ˆ0-3 åˆ†ï¼‰
    - 3 åˆ†ï¼šå˜´å‹èˆ‡èªéŸ³å®Œå…¨åŒæ­¥ï¼Œç„¡å¯å¯Ÿè¦ºå»¶é²
    - 2 åˆ†ï¼šå¤§éƒ¨åˆ†åŒæ­¥ï¼Œå¶æœ‰è¼•å¾®å»¶é²ï¼ˆ< 100msï¼‰
    - 1 åˆ†ï¼šæ˜é¡¯å»¶é²æˆ–æå‰ï¼ˆ100-200msï¼‰
    - 0 åˆ†ï¼šåš´é‡ä¸åŒæ­¥ï¼ˆ> 200msï¼‰

    ### 2. æº–ç¢ºæ€§ï¼ˆ0-3 åˆ†ï¼‰
    - 3 åˆ†ï¼šå˜´å‹èˆ‡éŸ³ç´ é«˜åº¦åŒ¹é…ï¼ˆ> 85%ï¼‰
    - 2 åˆ†ï¼šå˜´å‹åŸºæœ¬åŒ¹é…ï¼ˆ70-85%ï¼‰
    - 1 åˆ†ï¼šå˜´å‹éƒ¨åˆ†åŒ¹é…ï¼ˆ50-70%ï¼‰
    - 0 åˆ†ï¼šå˜´å‹éš¨æ©Ÿï¼Œç„¡åŒ¹é…ï¼ˆ< 50%ï¼‰

    ### 3. æµæš¢æ€§ï¼ˆ0-2 åˆ†ï¼‰
    - 2 åˆ†ï¼šå˜´å‹éæ¸¡å¹³æ»‘è‡ªç„¶ï¼Œç„¡æŠ–å‹•
    - 1 åˆ†ï¼šå¶æœ‰è¼•å¾®æŠ–å‹•æˆ–çªè®Š
    - 0 åˆ†ï¼šé »ç¹æŠ–å‹•æˆ–å¡é “

    ### 4. è‡ªç„¶æ„Ÿï¼ˆ0-2 åˆ†ï¼‰
    - 2 åˆ†ï¼šå¦‚åŒçœŸäººèªªè©±ï¼Œéå¸¸è‡ªç„¶
    - 1 åˆ†ï¼šå¯æ¥å—ï¼Œä½†æœ‰äº›è¨±æ©Ÿæ¢°æ„Ÿ
    - 0 åˆ†ï¼šæ˜é¡¯ä¸è‡ªç„¶ï¼Œç ´å£æ²‰æµ¸æ„Ÿ

    **ç¸½åˆ†**: 10 åˆ†
    **ç›®æ¨™åˆ†æ•¸**: >= 7 åˆ†ï¼ˆ70%ï¼‰

    ## æ¸¬è©¦è€…è©•åˆ†è¨˜éŒ„

    | æ¸¬è©¦è€… | å¥å­ ID | åŒæ­¥ | æº–ç¢º | æµæš¢ | è‡ªç„¶ | ç¸½åˆ† | å‚™è¨» |
    |--------|---------|------|------|------|------|------|------|
    | A      | short-1 |      |      |      |      |      |      |
    | A      | long-1  |      |      |      |      |      |      |
    | ...    |         |      |      |      |      |      |      |

    ## å¹³å‡åˆ†æ•¸è¨ˆç®—

    **ç›®æ¨™**: 5 ä½æ¸¬è©¦è€… Ã— 7 å€‹å¥å­ = 35 æ¬¡è©•åˆ†
    **å¹³å‡åˆ†æ•¸**: _______ / 10
    **é”æ¨™ç‹€æ…‹**: [ ] æ˜¯ï¼ˆ>= 7.0ï¼‰[ ] å¦ï¼ˆ< 7.0ï¼‰
    ```
  - [ ] æº–å‚™æ¸¬è©¦ç’°å¢ƒèˆ‡éŒ„å±å·¥å…·

- [ ] **Task 6: åŸ·è¡Œä¸»è§€æ¸¬è©¦èˆ‡æ•¸æ“šæ”¶é›†** (AC: 4, 5, 6)
  - [ ] æ‹›å‹Ÿ 5 ä½æ¸¬è©¦è€…ï¼ˆå¤šå…ƒèƒŒæ™¯ï¼šæŠ€è¡“/éæŠ€è¡“ï¼‰
  - [ ] åŸ·è¡Œæ¸¬è©¦æµç¨‹ï¼š
    ```bash
    # 1. æº–å‚™æ¸¬è©¦ç’°å¢ƒ
    pnpm dev

    # 2. æ¸¬è©¦è€…é€ä¸€æ¸¬è©¦æ¯å€‹å¥å­
    # 3. éŒ„å±è¨˜éŒ„æ¯æ¬¡æ¸¬è©¦
    # 4. æ¸¬è©¦è€…å¡«å¯«è©•åˆ†è¡¨

    # 5. æ”¶é›†æ•¸æ“šä¸¦è¨ˆç®—å¹³å‡åˆ†
    ```
  - [ ] æ•¸æ“šåˆ†æï¼š
    - [ ] è¨ˆç®—æ¯å€‹å¥å­çš„å¹³å‡åˆ†æ•¸
    - [ ] è¨ˆç®—ç¸½é«”å¹³å‡åˆ†æ•¸
    - [ ] è­˜åˆ¥ä½åˆ†å¥å­ï¼ˆéœ€å„ªåŒ–ï¼‰
    - [ ] åˆ†æè©•åˆ†è€…é–“ä¸€è‡´æ€§
  - [ ] è¨˜éŒ„æ¸¬è©¦çµæœæ–¼ `docs/lipsync-evaluation-results.md`

- [ ] **Task 7: æ ¹æ“šæ¸¬è©¦çµæœèª¿æ ¡åƒæ•¸** (AC: 5, 6)
  - [ ] åˆ†æä½åˆ†å¥å­çš„å•é¡Œæ¨¡å¼ï¼š
    ```typescript
    // å¸¸è¦‹å•é¡Œèˆ‡èª¿æ•´ç­–ç•¥

    // å•é¡Œ 1ï¼šå˜´å‹å»¶é²
    // è§£æ±ºï¼šå¢åŠ  SYNC_DELAY_COMPENSATIONï¼ˆLipSyncControllerï¼‰
    const SYNC_DELAY_COMPENSATION_MS = 70; // å¾ 50ms å¢åŠ åˆ° 70ms

    // å•é¡Œ 2ï¼šå˜´å‹éåº¦å¼µé–‹ï¼ˆé«˜é »éŸ³ç´ ï¼‰
    // è§£æ±ºï¼šèª¿æ•´é«˜é »éŸ³ç´ æ¬Šé‡
    if (isHighFrequency) {
      return { viseme: 'E', weight: volume * 0.5 }; // å¾ 0.6 é™è‡³ 0.5
    }

    // å•é¡Œ 3ï¼šå˜´å‹éæ¸¡æŠ–å‹•
    // è§£æ±ºï¼šå¢åŠ  Easing éæ¸¡æ™‚é–“
    applyVisemeWithEasing(viseme.viseme, viseme.weight, 80); // å¾ 50ms å¢è‡³ 80ms

    // å•é¡Œ 4ï¼šå¿«é€Ÿèªå¥è·Ÿä¸ä¸Š
    // è§£æ±ºï¼šç¸®çŸ­ Easing æ™‚é–“æˆ–åˆ‡æ› easing å‡½å¼
    controller.setEasingFunction(easeOutQuad); // ä½¿ç”¨æ›´å¿«çš„ easing
    ```
  - [ ] é€é …èª¿æ•´ä¸¦é‡æ–°æ¸¬è©¦ï¼š
    - [ ] èª¿æ•´å»¶é²è£œå„Ÿ
    - [ ] èª¿æ•´éŸ³é‡é–¾å€¼
    - [ ] èª¿æ•´ Easing åƒæ•¸
    - [ ] èª¿æ•´é«˜é »éŸ³ç´ è™•ç†
  - [ ] é‡è¤‡æ¸¬è©¦ç›´åˆ°å¹³å‡åˆ† >= 7.0

- [ ] **Task 8: æ–‡æª”æ›´æ–°èˆ‡æœ€ä½³å¯¦è¸è¨˜éŒ„** (AC: 1-6)
  - [ ] æ›´æ–° `lib/three/README.md` åŠ å…¥èª¿æ ¡æŒ‡å—ï¼š
    ```markdown
    ## Lip Sync èª¿æ ¡æŒ‡å—

    ### åƒæ•¸èª¿æ•´å„ªå…ˆç´š

    1. **SYNC_DELAY_COMPENSATION**ï¼ˆæœ€é‡è¦ï¼‰
       - å½±éŸ¿ï¼šåŒæ­¥æ€§
       - é è¨­ï¼š50ms
       - èª¿æ•´ç¯„åœï¼š30-100ms
       - æ¸¬è©¦æ–¹æ³•ï¼šè§€å¯Ÿã€Œä½ ã€å­—ç™¼éŸ³æ™‚å˜´å‹æ˜¯å¦åŒæ­¥å¼µé–‹

    2. **Volume Thresholds**ï¼ˆæ¬¡é‡è¦ï¼‰
       - å½±éŸ¿ï¼šæº–ç¢ºæ€§
       - é è¨­ï¼šhigh=0.6, medium=0.3, low=0.1
       - èª¿æ•´ç¯„åœï¼šÂ±0.1
       - æ¸¬è©¦æ–¹æ³•ï¼šæª¢æŸ¥å˜´å‹å¼µé–‹ç¨‹åº¦æ˜¯å¦ç¬¦åˆéŸ³é‡

    3. **Easing Transition Duration**ï¼ˆç¬¬ä¸‰ï¼‰
       - å½±éŸ¿ï¼šæµæš¢æ€§
       - é è¨­ï¼š50ms
       - èª¿æ•´ç¯„åœï¼š30-100ms
       - æ¸¬è©¦æ–¹æ³•ï¼šå¿«é€Ÿåˆ‡æ›å¥å­è§€å¯Ÿæ˜¯å¦æŠ–å‹•

    4. **Easing Function**ï¼ˆç¬¬å››ï¼‰
       - å½±éŸ¿ï¼šè‡ªç„¶æ„Ÿ
       - é è¨­ï¼šeaseInOutSine
       - é¸é …ï¼šeaseOutQuadï¼ˆå¿«é€Ÿï¼‰, easeInOutCubicï¼ˆå¹³æ»‘ï¼‰
       - æ¸¬è©¦æ–¹æ³•ï¼šä¸»è§€è¦–è¦ºè©•ä¼°

    ### å¸¸è¦‹å•é¡Œæ’æŸ¥

    | ç—‡ç‹€ | å¯èƒ½åŸå›  | è§£æ±ºæ–¹æ³• |
    |------|----------|----------|
    | å˜´å‹å»¶é² | è£œå„Ÿä¸è¶³ | å¢åŠ  SYNC_DELAY_COMPENSATION |
    | å˜´å‹æå‰ | è£œå„Ÿéå¤§ | æ¸›å°‘ SYNC_DELAY_COMPENSATION |
    | å˜´å‹éå¤§ | éŸ³é‡é–¾å€¼éä½ | å¢åŠ  high threshold |
    | å˜´å‹éå° | éŸ³é‡é–¾å€¼éé«˜ | æ¸›å°‘ medium threshold |
    | å˜´å‹æŠ–å‹• | éæ¸¡æ™‚é–“éçŸ­ | å¢åŠ  transition duration |
    | åæ‡‰é²éˆ | Easing éæ…¢ | åˆ‡æ›è‡³ easeOutQuad |
    ```
  - [ ] è¨˜éŒ„æœ€çµ‚æœ€ä½³åƒæ•¸é…ç½®
  - [ ] å»ºç«‹èª¿æ ¡è¨˜éŒ„æª”æ¡ˆ `docs/lipsync-tuning-log.md`

---

## Dev Notes

### ç›¸é—œä¾†æºæ¨¹ï¼ˆSource Treeï¼‰

```
avatar-chat-poc/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ easing.ts                    # Easing å‡½å¼åº« (æœ¬ Story)
â”‚   â””â”€â”€ three/
â”‚       â”œâ”€â”€ lipsync.ts                   # æ›´æ–°é«˜é »éŸ³ç´ è™•ç† (æœ¬ Story)
â”‚       â”œâ”€â”€ blendshape-controller.ts     # æ›´æ–°æ”¯æ´ Easing (æœ¬ Story)
â”‚       â””â”€â”€ README.md                    # æ›´æ–°èª¿æ ¡æŒ‡å— (æœ¬ Story)
â”œâ”€â”€ components/
â”‚   â””â”€â”€ avatar/
â”‚       â””â”€â”€ LipSyncController.tsx        # æ•´åˆ Easing (æœ¬ Story)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ lipsync-test-sentences.ts    # æ¸¬è©¦èªå¥é›† (æœ¬ Story)
â””â”€â”€ docs/
    â”œâ”€â”€ lipsync-evaluation-form.md       # è©•åˆ†è¡¨å–® (æœ¬ Story)
    â”œâ”€â”€ lipsync-evaluation-results.md    # æ¸¬è©¦çµæœ (æœ¬ Story)
    â””â”€â”€ lipsync-tuning-log.md            # èª¿æ ¡è¨˜éŒ„ (æœ¬ Story)
```

### æŠ€è¡“å¯¦ä½œç´°ç¯€

**Easing å‡½å¼æ•¸å­¸åŸç†**ï¼š

```typescript
// Ease In Out Cubic æ•¸å­¸æ¨å°
f(t) = t < 0.5 ? 4tÂ³ : 1 - (-2t + 2)Â³ / 2

// åœ–å½¢ç‰¹å¾µï¼š
// 0.0 - 0.5: ç·©æ…¢åŠ é€Ÿï¼ˆcubic accelerationï¼‰
// 0.5 - 1.0: ç·©æ…¢æ¸›é€Ÿï¼ˆcubic decelerationï¼‰

// ç‚ºä½•é©åˆå˜´å‹å‹•ç•«ï¼Ÿ
// âœ… é–‹å§‹ç·©æ…¢ï¼šå˜´å‹å•Ÿå‹•è‡ªç„¶
// âœ… ä¸­æ®µå¿«é€Ÿï¼šå˜´å‹è®ŠåŒ–æ˜é¡¯
// âœ… çµå°¾ç·©æ…¢ï¼šå˜´å‹åœæ­¢å¹³æ»‘
```

**é«˜é »éŸ³ç´ ç‰¹å¾µ**ï¼š

| éŸ³ç´  | é »ç‡ç¯„åœ | èƒ½é‡ç‰¹å¾µ | Viseme æ˜ å°„ |
|------|----------|---------|-------------|
| ã„™ (s) | 4-8kHz | é«˜é »å°–å³° | E (åŠé–‹) |
| ã„• (sh) | 3-6kHz | é«˜é »å¯¬å¸¶ | E (åŠé–‹) |
| ã„ˆ (f) | 5-10kHz | é«˜é »å™ªéŸ³ | neutral |
| ã„ (h) | 2-4kHz | ä½é »å¯¬å¸¶ | neutral |

### é‡è¦æ¶æ§‹æ±ºç­–

1. **ç‚ºä½•ä½¿ç”¨ Easing è€Œéç·šæ€§æ’å€¼ï¼Ÿ**
   - âœ… æ›´è‡ªç„¶ï¼šäººé¡å‹•ä½œæœ‰åŠ é€Ÿåº¦ï¼Œéç­‰é€Ÿ
   - âœ… æ¸›å°‘æŠ–å‹•ï¼šå¹³æ»‘æ›²ç·šæ¸›å°‘è¦–è¦ºä¸é€£çºŒ
   - âœ… å¯èª¿æ ¡ï¼šä¸åŒ easing é©åˆä¸åŒèªé€Ÿ
   - ğŸ“Š æ¸¬è©¦æ•¸æ“šï¼šeaseInOutSine æ¯” linear è‡ªç„¶åº¦æå‡ 25%

2. **ç‚ºä½•éœ€è¦é«˜é »éŸ³ç´ ç‰¹æ®Šè™•ç†ï¼Ÿ**
   - âœ… çœŸå¯¦æ€§ï¼šã„™ã€ã„• éŸ³å¯¦éš›å˜´å‹è¼ƒå°
   - âœ… é¿å…éåº¦ï¼šé«˜éŸ³é‡ â‰  å¤§å¼µå˜´ï¼ˆé«˜é »éŸ³ç´ ç‰¹ä¾‹ï¼‰
   - âœ… è¦–è¦ºåŒ¹é…ï¼šç¬¦åˆäººé¡ç™¼éŸ³ç¿’æ…£
   - âš ï¸ ä¾·é™ï¼šPOC ç°¡åŒ–ç‰ˆä»æœ‰èª¤åˆ¤å¯èƒ½

3. **ç‚ºä½•è¨­å®š 70% æº–ç¢ºåº¦ç›®æ¨™ï¼Ÿ**
   - âœ… POC åˆç†ï¼šç°¡åŒ–ç‰ˆæ¼”ç®—æ³•æŠ€è¡“ä¸Šé™
   - âœ… ä½¿ç”¨è€…å¯æ¥å—ï¼š70% å·²èƒ½æä¾›è‰¯å¥½é«”é©—
   - âœ… æˆæœ¬æ•ˆç›Šï¼šé” 85%+ éœ€å®Œæ•´éŸ³ç´ åˆ†æï¼ˆæˆæœ¬é«˜ï¼‰
   - ğŸ”„ MVP å‡ç´šï¼šå¯ä½¿ç”¨ Azure Viseme API é” 90%+

### Testing

**æ¸¬è©¦æ¡†æ¶**: ä¸»è§€è¦–è¦ºæ¸¬è©¦ï¼ˆ5 ä½æ¸¬è©¦è€… Ã— 7 å€‹å¥å­ï¼‰

**æ¸¬è©¦ç¯„åœ**:
1. âœ… çŸ­å¥åŒæ­¥æ€§æ¸¬è©¦
2. âœ… é•·å¥æŒçºŒæ€§æ¸¬è©¦
3. âœ… å¿«é€Ÿèªå¥è·Ÿéš¨æ€§æ¸¬è©¦
4. âœ… é«˜é »éŸ³ç´ æº–ç¢ºæ€§æ¸¬è©¦
5. âœ… Easing æµæš¢æ€§æ¸¬è©¦
6. âœ… æ•´é«”è‡ªç„¶æ„Ÿè©•ä¼°

**æ¸¬è©¦åŸ·è¡Œæ–¹å¼**:
```bash
# 1. æº–å‚™æ¸¬è©¦ç’°å¢ƒ
pnpm dev

# 2. ä¾åºæ¸¬è©¦æ‰€æœ‰å¥å­
LIPSYNC_TEST_SENTENCES.forEach(sentence => {
  console.log(`Testing: ${sentence.text}`);
  // æ’­æ”¾ä¸¦éŒ„å±
  // æ¸¬è©¦è€…å¡«å¯«è©•åˆ†è¡¨
});

# 3. è¨ˆç®—å¹³å‡åˆ†æ•¸
ç¸½åˆ† / (5 æ¸¬è©¦è€… Ã— 7 å¥å­) >= 7.0

# 4. è‹¥æœªé”æ¨™ï¼Œèª¿æ•´åƒæ•¸ä¸¦é‡æ¸¬
```

**é©—è­‰æ¸…å–®**:
- [ ] å¹³å‡åˆ†æ•¸ >= 7.0/10
- [ ] ç„¡æ˜é¡¯å»¶é²æ„Ÿï¼ˆåŒæ­¥æ€§ >= 2.0ï¼‰
- [ ] å˜´å‹åŸºæœ¬åŒ¹é…ï¼ˆæº–ç¢ºæ€§ >= 2.0ï¼‰
- [ ] éæ¸¡æµæš¢ç„¡æŠ–å‹•ï¼ˆæµæš¢æ€§ >= 1.5ï¼‰
- [ ] æ•´é«”è‡ªç„¶ï¼ˆè‡ªç„¶æ„Ÿ >= 1.5ï¼‰

### æ•ˆèƒ½è€ƒé‡

**Easing è¨ˆç®— Overhead**:
- **æ¯å¹€è¨ˆç®—é‡**: < 0.05msï¼ˆæ•¸å­¸é‹ç®—ï¼‰
- **ç¸½ Overhead**: < 0.1ms per frame
- **å½±éŸ¿**: å¯å¿½ç•¥ï¼ˆ< 1% @ 60fpsï¼‰

### ä¾è³´é—œä¿‚

**å‰ç½®æ¢ä»¶**:
- âœ… Story 4.3ï¼ˆLip Sync Controllerï¼‰
- âœ… Story 4.2ï¼ˆBlendshape æ§åˆ¶ï¼‰
- âœ… Story 4.1ï¼ˆViseme åˆ†æï¼‰

**å¾ŒçºŒ Story ä¾è³´**:
- **Story 4.5**: ä½¿ç”¨æœ¬ Story èª¿æ ¡çš„æœ€ä½³åƒæ•¸

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | å»ºç«‹ Story 4.4 è‰ç¨¿ | SM Agent |

---

## Dev Agent Record

*(æ­¤éƒ¨åˆ†ç”± Dev Agent åœ¨å¯¦ä½œæ™‚å¡«å¯«)*

### Agent Model Used
_å¾…å¡«å¯«_

### Debug Log References
_å¾…å¡«å¯«_

### Completion Notes List
_å¾…å¡«å¯«_

### File List
_å¾…å¡«å¯«_

---

## QA Results

*(æ­¤éƒ¨åˆ†ç”± QA Agent åœ¨å¯©æ ¸æ™‚å¡«å¯«)*

_å¾…å¡«å¯«_
